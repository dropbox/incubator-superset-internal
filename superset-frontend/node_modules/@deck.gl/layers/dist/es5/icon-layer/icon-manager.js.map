{"version":3,"sources":["../../../src/icon-layer/icon-manager.js"],"names":["DEFAULT_CANVAS_WIDTH","DEFAULT_BUFFER","noop","DEFAULT_TEXTURE_PARAMETERS","nextPowOfTwo","number","Math","pow","ceil","log2","resizeImage","ctx","imageData","width","height","canvas","clearRect","drawImage","getIconId","icon","id","url","resizeTexture","gl","texture","oldWidth","oldHeight","newTexture","targetY","delete","buildRowMapping","mapping","columns","yOffset","i","length","xOffset","x","y","buildMapping","icons","buffer","rowHeight","canvasWidth","push","max","canvasHeight","getDiffIcons","data","getIcon","cachedIcons","iterable","objectInfo","object","index","Error","source","sourceIndex","IconManager","onUpdate","onError","_loadOptions","_getIcon","_texture","_externalTexture","_mapping","_pendingCount","_autoPacking","_xOffset","_yOffset","_rowHeight","_buffer","_canvasWidth","_canvasHeight","_canvas","loadOptions","autoPacking","iconAtlas","iconMapping","undefined","_updateIconAtlas","document","createElement","_updateAutoPacking","Object","values","Texture2D","parameters","_loadIcons","getContext","ImageLoader","then","setSubImageData","generateMipmap","catch","error","finally"],"mappings":"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","sourcesContent":["/* global document */\nimport GL from '@luma.gl/constants';\nimport {Texture2D, copyToTexture, cloneTextureFrom} from '@luma.gl/core';\nimport {ImageLoader} from '@loaders.gl/images';\nimport {load} from '@loaders.gl/core';\nimport {createIterable} from '@deck.gl/core';\n\nconst DEFAULT_CANVAS_WIDTH = 1024;\nconst DEFAULT_BUFFER = 4;\n\nconst noop = () => {};\n\nconst DEFAULT_TEXTURE_PARAMETERS = {\n  [GL.TEXTURE_MIN_FILTER]: GL.LINEAR_MIPMAP_LINEAR,\n  // GL.LINEAR is the default value but explicitly set it here\n  [GL.TEXTURE_MAG_FILTER]: GL.LINEAR,\n  // for texture boundary artifact\n  [GL.TEXTURE_WRAP_S]: GL.CLAMP_TO_EDGE,\n  [GL.TEXTURE_WRAP_T]: GL.CLAMP_TO_EDGE\n};\n\nfunction nextPowOfTwo(number) {\n  return Math.pow(2, Math.ceil(Math.log2(number)));\n}\n\n// update comment to create a new texture and copy original data.\nfunction resizeImage(ctx, imageData, width, height) {\n  if (width === imageData.width && height === imageData.height) {\n    return imageData;\n  }\n\n  ctx.canvas.height = height;\n  ctx.canvas.width = width;\n\n  ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n\n  // image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight\n  ctx.drawImage(imageData, 0, 0, imageData.width, imageData.height, 0, 0, width, height);\n\n  return ctx.canvas;\n}\n\nfunction getIconId(icon) {\n  return icon && (icon.id || icon.url);\n}\n\n// resize texture without losing original data\nfunction resizeTexture(gl, texture, width, height) {\n  const oldWidth = texture.width;\n  const oldHeight = texture.height;\n\n  const newTexture = cloneTextureFrom(texture, {width, height});\n  copyToTexture(texture, newTexture, {\n    targetY: 0,\n    width: oldWidth,\n    height: oldHeight\n  });\n\n  texture.delete();\n  return newTexture;\n}\n\n// traverse icons in a row of icon atlas\n// extend each icon with left-top coordinates\nfunction buildRowMapping(mapping, columns, yOffset) {\n  for (let i = 0; i < columns.length; i++) {\n    const {icon, xOffset} = columns[i];\n    const id = getIconId(icon);\n    mapping[id] = {\n      ...icon,\n      x: xOffset,\n      y: yOffset\n    };\n  }\n}\n\n/**\n * Generate coordinate mapping to retrieve icon left-top position from an icon atlas\n * @param icons {Array<Object>} list of icons, each icon requires url, width, height\n * @param buffer {Number} add buffer to the right and bottom side of the image\n * @param xOffset {Number} right position of last icon in old mapping\n * @param yOffset {Number} top position in last icon in old mapping\n * @param rowHeight {Number} rowHeight of the last icon's row\n * @param canvasWidth {Number} max width of canvas\n * @param mapping {object} old mapping\n * @returns {{mapping: {'/icon/1': {url, width, height, ...}},, canvasHeight: {Number}}}\n */\nexport function buildMapping({\n  icons,\n  buffer,\n  mapping = {},\n  xOffset = 0,\n  yOffset = 0,\n  rowHeight = 0,\n  canvasWidth\n}) {\n  let columns = [];\n  // Strategy to layout all the icons into a texture:\n  // traverse the icons sequentially, layout the icons from left to right, top to bottom\n  // when the sum of the icons width is equal or larger than canvasWidth,\n  // move to next row starting from total height so far plus max height of the icons in previous row\n  // row width is equal to canvasWidth\n  // row height is decided by the max height of the icons in that row\n  // mapping coordinates of each icon is its left-top position in the texture\n  for (let i = 0; i < icons.length; i++) {\n    const icon = icons[i];\n    const id = getIconId(icon);\n\n    if (!mapping[id]) {\n      const {height, width} = icon;\n\n      // fill one row\n      if (xOffset + width + buffer > canvasWidth) {\n        buildRowMapping(mapping, columns, yOffset);\n\n        xOffset = 0;\n        yOffset = rowHeight + yOffset + buffer;\n        rowHeight = 0;\n        columns = [];\n      }\n\n      columns.push({\n        icon,\n        xOffset\n      });\n\n      xOffset = xOffset + width + buffer;\n      rowHeight = Math.max(rowHeight, height);\n    }\n  }\n\n  if (columns.length > 0) {\n    buildRowMapping(mapping, columns, yOffset);\n  }\n\n  return {\n    mapping,\n    rowHeight,\n    xOffset,\n    yOffset,\n    canvasWidth,\n    canvasHeight: nextPowOfTwo(rowHeight + yOffset + buffer)\n  };\n}\n\n// extract icons from data\n// return icons should be unique, and not cached or cached but url changed\nexport function getDiffIcons(data, getIcon, cachedIcons) {\n  if (!data || !getIcon) {\n    return null;\n  }\n\n  cachedIcons = cachedIcons || {};\n  const icons = {};\n  const {iterable, objectInfo} = createIterable(data);\n  for (const object of iterable) {\n    objectInfo.index++;\n    const icon = getIcon(object, objectInfo);\n    const id = getIconId(icon);\n\n    if (!icon) {\n      throw new Error('Icon is missing.');\n    }\n\n    if (!icon.url) {\n      throw new Error('Icon url is missing.');\n    }\n\n    if (!icons[id] && (!cachedIcons[id] || icon.url !== cachedIcons[id].url)) {\n      icons[id] = {...icon, source: object, sourceIndex: objectInfo.index};\n    }\n  }\n  return icons;\n}\n\nexport default class IconManager {\n  constructor(\n    gl,\n    {\n      onUpdate = noop, // notify IconLayer when icon texture update\n      onError = noop\n    }\n  ) {\n    this.gl = gl;\n    this.onUpdate = onUpdate;\n    this.onError = onError;\n\n    // load options used for loading images\n    this._loadOptions = null;\n    this._getIcon = null;\n\n    this._texture = null;\n    this._externalTexture = null;\n    this._mapping = {};\n    // count of pending requests to fetch icons\n    this._pendingCount = 0;\n\n    this._autoPacking = false;\n\n    // internal props used when autoPacking applied\n    // right position of last icon\n    this._xOffset = 0;\n    // top position of last icon\n    this._yOffset = 0;\n    this._rowHeight = 0;\n    this._buffer = DEFAULT_BUFFER;\n    this._canvasWidth = DEFAULT_CANVAS_WIDTH;\n    this._canvasHeight = 0;\n    this._canvas = null;\n  }\n\n  finalize() {\n    this._texture?.delete();\n  }\n\n  getTexture() {\n    return this._texture || this._externalTexture;\n  }\n\n  getIconMapping(icon) {\n    const id = this._autoPacking ? getIconId(icon) : icon;\n    return this._mapping[id] || {};\n  }\n\n  setProps({loadOptions, autoPacking, iconAtlas, iconMapping, data, getIcon}) {\n    if (loadOptions) {\n      this._loadOptions = loadOptions;\n    }\n\n    if (autoPacking !== undefined) {\n      this._autoPacking = autoPacking;\n    }\n\n    if (getIcon) {\n      this._getIcon = getIcon;\n    }\n\n    if (iconMapping) {\n      this._mapping = iconMapping;\n    }\n\n    if (iconAtlas) {\n      this._updateIconAtlas(iconAtlas);\n    }\n\n    if (this._autoPacking && (data || getIcon) && typeof document !== 'undefined') {\n      this._canvas = this._canvas || document.createElement('canvas');\n\n      this._updateAutoPacking(data);\n    }\n  }\n\n  get isLoaded() {\n    return this._pendingCount === 0;\n  }\n\n  _updateIconAtlas(iconAtlas) {\n    this._texture?.delete();\n    this._texture = null;\n    this._externalTexture = iconAtlas;\n    this.onUpdate();\n  }\n\n  _updateAutoPacking(data) {\n    const icons = Object.values(getDiffIcons(data, this._getIcon, this._mapping) || {});\n\n    if (icons.length > 0) {\n      // generate icon mapping\n      const {mapping, xOffset, yOffset, rowHeight, canvasHeight} = buildMapping({\n        icons,\n        buffer: this._buffer,\n        canvasWidth: this._canvasWidth,\n        mapping: this._mapping,\n        rowHeight: this._rowHeight,\n        xOffset: this._xOffset,\n        yOffset: this._yOffset\n      });\n\n      this._rowHeight = rowHeight;\n      this._mapping = mapping;\n      this._xOffset = xOffset;\n      this._yOffset = yOffset;\n      this._canvasHeight = canvasHeight;\n\n      // create new texture\n      if (!this._texture) {\n        this._texture = new Texture2D(this.gl, {\n          width: this._canvasWidth,\n          height: this._canvasHeight,\n          parameters: DEFAULT_TEXTURE_PARAMETERS\n        });\n      }\n\n      if (this._texture.height !== this._canvasHeight) {\n        this._texture = resizeTexture(\n          this.gl,\n          this._texture,\n          this._canvasWidth,\n          this._canvasHeight\n        );\n      }\n\n      this.onUpdate();\n\n      // load images\n      this._loadIcons(icons);\n    }\n  }\n\n  _loadIcons(icons) {\n    const ctx = this._canvas.getContext('2d');\n\n    for (const icon of icons) {\n      this._pendingCount++;\n      load(icon.url, ImageLoader, this._loadOptions)\n        .then(imageData => {\n          const id = getIconId(icon);\n          const {x, y, width, height} = this._mapping[id];\n\n          const data = resizeImage(ctx, imageData, width, height);\n\n          this._texture.setSubImageData({\n            data,\n            x,\n            y,\n            width,\n            height\n          });\n\n          // Call to regenerate mipmaps after modifying texture(s)\n          this._texture.generateMipmap();\n\n          this.onUpdate();\n        })\n        .catch(error => {\n          this.onError({\n            url: icon.url,\n            source: icon.source,\n            sourceIndex: icon.sourceIndex,\n            loadOptions: this._loadOptions,\n            error\n          });\n        })\n        .finally(() => {\n          this._pendingCount--;\n        });\n    }\n  }\n}\n"],"file":"icon-manager.js"}