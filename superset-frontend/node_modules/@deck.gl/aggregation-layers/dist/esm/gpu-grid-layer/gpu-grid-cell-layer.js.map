{"version":3,"sources":["../../../src/gpu-grid-layer/gpu-grid-cell-layer.js"],"names":["Layer","fp64LowPart","project32","gouraudLighting","picking","Model","CubeGeometry","fp64arithmetic","defaultColorRange","colorRangeToFlatArray","vs","fs","COLOR_DATA_UBO_INDEX","ELEVATION_DATA_UBO_INDEX","defaultProps","colorDomain","colorRange","elevationDomain","elevationRange","elevationScale","type","min","value","gridSize","gridOrigin","gridOffset","cellSize","max","offset","coverage","extruded","material","GPUGridCellLayer","getShaders","modules","initializeState","gl","context","attributeManager","getAttributeManager","addInstanced","colors","size","noAlloc","elevations","model","_getModel","_setupUniformBuffer","setState","id","props","geometry","isInstanced","draw","uniforms","colorMaxMinBuffer","elevationMaxMinBuffer","gridOriginLow","gridOffsetLow","domainUniforms","getDomainUniforms","bindUniformBuffers","state","setUniforms","unbindUniformBuffers","bind","target","index","unbind","colorDomainValid","elevationDomainValid","programHandle","program","handle","colorIndex","getUniformBlockIndex","elevationIndex","uniformBlockBinding","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {Layer, fp64LowPart, project32, gouraudLighting, picking} from '@deck.gl/core';\nimport GL from '@luma.gl/constants';\nimport {Model, CubeGeometry} from '@luma.gl/core';\nimport {fp64arithmetic} from '@luma.gl/shadertools';\nimport {defaultColorRange, colorRangeToFlatArray} from '../utils/color-utils';\n\nimport vs from './gpu-grid-cell-layer-vertex.glsl';\nimport fs from './gpu-grid-cell-layer-fragment.glsl';\n\nconst COLOR_DATA_UBO_INDEX = 0;\nconst ELEVATION_DATA_UBO_INDEX = 1;\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  elevationScale: {type: 'number', min: 0, value: 1},\n\n  // grid\n  gridSize: {type: 'array', min: 0, value: [1, 1]},\n  gridOrigin: {type: 'array', min: 0, value: [0, 0]},\n  gridOffset: {type: 'array', min: 0, value: [0, 0]},\n\n  cellSize: {type: 'number', min: 0, max: 1000, value: 1000},\n  offset: {type: 'array', min: 0, value: [1, 1]},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  extruded: true,\n\n  material: true // Use lighting module defaults\n};\n\nexport default class GPUGridCellLayer extends Layer {\n  getShaders() {\n    return super.getShaders({\n      vs,\n      fs,\n      modules: [project32, gouraudLighting, picking, fp64arithmetic]\n    });\n  }\n\n  initializeState() {\n    const {gl} = this.context;\n    const attributeManager = this.getAttributeManager();\n    attributeManager.addInstanced({\n      colors: {\n        size: 4,\n        noAlloc: true\n      },\n      elevations: {\n        size: 4,\n        noAlloc: true\n      }\n    });\n    const model = this._getModel(gl);\n    this._setupUniformBuffer(model);\n    this.setState({model});\n  }\n\n  _getModel(gl) {\n    return new Model(gl, {\n      ...this.getShaders(),\n      id: this.props.id,\n      geometry: new CubeGeometry(),\n      isInstanced: true\n    });\n  }\n\n  draw({uniforms}) {\n    const {\n      cellSize,\n      offset,\n      extruded,\n      elevationScale,\n      coverage,\n      gridSize,\n      gridOrigin,\n      gridOffset,\n      elevationRange,\n      colorMaxMinBuffer,\n      elevationMaxMinBuffer\n    } = this.props;\n\n    const gridOriginLow = [fp64LowPart(gridOrigin[0]), fp64LowPart(gridOrigin[1])];\n    const gridOffsetLow = [fp64LowPart(gridOffset[0]), fp64LowPart(gridOffset[1])];\n    const domainUniforms = this.getDomainUniforms();\n    const colorRange = colorRangeToFlatArray(this.props.colorRange);\n    this.bindUniformBuffers(colorMaxMinBuffer, elevationMaxMinBuffer);\n    this.state.model\n      .setUniforms(uniforms)\n      .setUniforms(domainUniforms)\n      .setUniforms({\n        cellSize,\n        offset,\n        extruded,\n        elevationScale,\n        coverage,\n        gridSize,\n        gridOrigin,\n        gridOriginLow,\n        gridOffset,\n        gridOffsetLow,\n        colorRange,\n        elevationRange\n      })\n      .draw();\n    this.unbindUniformBuffers(colorMaxMinBuffer, elevationMaxMinBuffer);\n  }\n\n  bindUniformBuffers(colorMaxMinBuffer, elevationMaxMinBuffer) {\n    colorMaxMinBuffer.bind({target: GL.UNIFORM_BUFFER, index: COLOR_DATA_UBO_INDEX});\n    elevationMaxMinBuffer.bind({target: GL.UNIFORM_BUFFER, index: ELEVATION_DATA_UBO_INDEX});\n  }\n\n  unbindUniformBuffers(colorMaxMinBuffer, elevationMaxMinBuffer) {\n    colorMaxMinBuffer.unbind({target: GL.UNIFORM_BUFFER, index: COLOR_DATA_UBO_INDEX});\n    elevationMaxMinBuffer.unbind({target: GL.UNIFORM_BUFFER, index: ELEVATION_DATA_UBO_INDEX});\n  }\n\n  getDomainUniforms() {\n    const {colorDomain, elevationDomain} = this.props;\n    const domainUniforms = {};\n    if (colorDomain !== null) {\n      domainUniforms.colorDomainValid = true;\n      domainUniforms.colorDomain = colorDomain;\n    } else {\n      domainUniforms.colorDomainValid = false;\n    }\n    if (elevationDomain !== null) {\n      domainUniforms.elevationDomainValid = true;\n      domainUniforms.elevationDomain = elevationDomain;\n    } else {\n      domainUniforms.elevationDomainValid = false;\n    }\n    return domainUniforms;\n  }\n\n  _setupUniformBuffer(model) {\n    const gl = this.context.gl;\n    const programHandle = model.program.handle;\n\n    const colorIndex = gl.getUniformBlockIndex(programHandle, 'ColorData');\n    const elevationIndex = gl.getUniformBlockIndex(programHandle, 'ElevationData');\n    gl.uniformBlockBinding(programHandle, colorIndex, COLOR_DATA_UBO_INDEX);\n    gl.uniformBlockBinding(programHandle, elevationIndex, ELEVATION_DATA_UBO_INDEX);\n  }\n}\n\nGPUGridCellLayer.layerName = 'GPUGridCellLayer';\nGPUGridCellLayer.defaultProps = defaultProps;\n"],"file":"gpu-grid-cell-layer.js"}