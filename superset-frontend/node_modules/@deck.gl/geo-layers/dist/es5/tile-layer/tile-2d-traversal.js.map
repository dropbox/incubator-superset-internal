{"version":3,"sources":["../../../src/tile-layer/tile-2d-traversal.js"],"names":["TILE_SIZE","MAX_MAPS","OSMNode","x","y","z","params","viewport","cullingVolume","elevationBounds","minZ","maxZ","offset","project","boundingVolume","getBoundingVolume","isInside","computeVisibility","childVisible","distance","distanceTo","cameraPosition","scale","height","Math","floor","log2","selected","children","child","update","result","push","_children","node","getSelected","zRange","worldOffset","corner0","corner1","center","cornerPos0","cornerPos1","centerPos","Vector3","R","max","BoundingSphere","pow","extent","originX","originY","AxisAlignedBoundingBox","getOSMTileIndices","resolution","projectPosition","planes","Object","values","getFrustumPlanes","map","normal","Plane","clone","negate","CullingVolume","unitsPerMeter","distanceScales","elevationMin","elevationMax","pitch","root","traversalParams","subViewports","length"],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport {CullingVolume, Plane, AxisAlignedBoundingBox, BoundingSphere} from '@math.gl/culling';\nimport {Vector3} from 'math.gl';\nimport {osmTile2lngLat} from './utils';\n\nconst TILE_SIZE = 512;\n// number of world copies to check\nconst MAX_MAPS = 3;\n\nclass OSMNode {\n  constructor(x, y, z) {\n    this.x = x;\n    this.y = y;\n    this.z = z;\n  }\n\n  get children() {\n    if (!this._children) {\n      const x = this.x * 2;\n      const y = this.y * 2;\n      const z = this.z + 1;\n      this._children = [\n        new OSMNode(x, y, z),\n        new OSMNode(x, y + 1, z),\n        new OSMNode(x + 1, y, z),\n        new OSMNode(x + 1, y + 1, z)\n      ];\n    }\n    return this._children;\n  }\n\n  update(params) {\n    const {viewport, cullingVolume, elevationBounds, minZ, maxZ, offset, project} = params;\n    const boundingVolume = this.getBoundingVolume(elevationBounds, offset, project);\n\n    // First, check if this tile is visible\n    const isInside = cullingVolume.computeVisibility(boundingVolume);\n    if (isInside < 0) {\n      return false;\n    }\n\n    // Avoid loading overlapping tiles - if a descendant is requested, do not request the ancester\n    if (!this.childVisible) {\n      let {z} = this;\n      if (z < maxZ && z >= minZ) {\n        // Adjust LOD\n        // If the tile is far enough from the camera, accept a lower zoom level\n        const distance =\n          (boundingVolume.distanceTo(viewport.cameraPosition) * viewport.scale) / viewport.height;\n        z += Math.floor(Math.log2(distance));\n      }\n      if (z >= maxZ) {\n        // LOD is acceptable\n        this.selected = true;\n        return true;\n      }\n    }\n\n    // LOD is not enough, recursively test child tiles\n    this.selected = false;\n    this.childVisible = true;\n    for (const child of this.children) {\n      child.update(params);\n    }\n    return true;\n  }\n\n  getSelected(result = []) {\n    if (this.selected) {\n      result.push(this);\n    }\n    if (this._children) {\n      for (const node of this._children) {\n        node.getSelected(result);\n      }\n    }\n    return result;\n  }\n\n  getBoundingVolume(zRange, worldOffset, project) {\n    if (project) {\n      // Custom projection\n      const corner0 = osmTile2lngLat(this.x, this.y, this.z);\n      const corner1 = osmTile2lngLat(this.x + 1, this.y + 1, this.z);\n      const center = osmTile2lngLat(this.x + 0.5, this.y + 0.5, this.z);\n      corner0.z = zRange[1];\n      corner1.z = zRange[1];\n      center.z = zRange[0];\n\n      const cornerPos0 = project(corner0);\n      const cornerPos1 = project(corner1);\n      const centerPos = new Vector3(project(center));\n      const R = Math.max(centerPos.distance(cornerPos0), centerPos.distance(cornerPos1));\n\n      return new BoundingSphere(centerPos, R);\n    }\n\n    // Use WebMercator projection\n    const scale = Math.pow(2, this.z);\n    const extent = TILE_SIZE / scale;\n    const originX = this.x * extent + worldOffset * TILE_SIZE;\n    // deck's common space is y-flipped\n    const originY = TILE_SIZE - (this.y + 1) * extent;\n\n    return new AxisAlignedBoundingBox(\n      [originX, originY, zRange[0]],\n      [originX + extent, originY + extent, zRange[1]]\n    );\n  }\n}\n\nexport function getOSMTileIndices(viewport, maxZ, zRange) {\n  const project = viewport.resolution ? viewport.projectPosition : null;\n\n  // Get the culling volume of the current camera\n  const planes = Object.values(viewport.getFrustumPlanes()).map(\n    ({normal, distance}) => new Plane(normal.clone().negate(), distance)\n  );\n  const cullingVolume = new CullingVolume(planes);\n\n  // Project zRange from meters to common space\n  const unitsPerMeter = viewport.distanceScales.unitsPerMeter[2];\n  const elevationMin = (zRange && zRange[0] * unitsPerMeter) || 0;\n  const elevationMax = (zRange && zRange[1] * unitsPerMeter) || 0;\n\n  // Always load at the current zoom level if pitch is small\n  const minZ = viewport.pitch <= 60 ? maxZ : 0;\n\n  const root = new OSMNode(0, 0, 0);\n  const traversalParams = {\n    viewport,\n    project,\n    cullingVolume,\n    elevationBounds: [elevationMin, elevationMax],\n    minZ,\n    maxZ,\n    // num. of worlds from the center. For repeated maps\n    offset: 0\n  };\n\n  root.update(traversalParams);\n\n  if (viewport.subViewports && viewport.subViewports.length > 1) {\n    // Check worlds in repeated maps\n    traversalParams.offset = -1;\n    while (root.update(traversalParams)) {\n      if (--traversalParams.offset < -MAX_MAPS) {\n        break;\n      }\n    }\n    traversalParams.offset = 1;\n    while (root.update(traversalParams)) {\n      if (++traversalParams.offset > MAX_MAPS) {\n        break;\n      }\n    }\n  }\n\n  return root.getSelected();\n}\n"],"file":"tile-2d-traversal.js"}