{"version":3,"sources":["../../../src/layers/carto-layer.js"],"names":["defaultProps","data","type","onDataLoad","value","compare","onDataError","optional","credentials","connection","CartoLayer","state","apiVersion","props","localCreds","log","assert","Object","values","API_VERSIONS","includes","V1","V2","MAP_TYPES","QUERY","TILESET","V3","oldProps","changeFlags","_checkProps","shouldUpdateData","dataChanged","JSON","stringify","setState","_updateData","source","localConfig","updateTriggers","layer","MVTLayer","GeoJsonLayer","getSubLayerProps","id","layerName","getSubLayers","length","CompositeLayer"],"mappings":"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","sourcesContent":["import {CompositeLayer, log} from '@deck.gl/core';\nimport {MVTLayer} from '@deck.gl/geo-layers';\nimport {GeoJsonLayer} from '@deck.gl/layers';\nimport {getData, getDataV2, API_VERSIONS} from '../api';\nimport {MAP_TYPES} from '../api/maps-api-common';\nimport {getDefaultCredentials} from '../config';\n\nconst defaultProps = {\n  // (String, required): data resource to load. table name, sql query or tileset name.\n  data: null,\n  // (Enum (MAP_TYPES), required)\n  type: null,\n  onDataLoad: {type: 'function', value: data => {}, compare: false},\n  onDataError: {type: 'function', value: null, compare: false, optional: true},\n\n  // override carto credentials for the layer, set to null to read from default\n  credentials: null,\n\n  /*********************/\n  /* API v3 PARAMETERS */\n  /**********************/\n  // (String, required): connection name at CARTO platform\n  connection: null\n};\n\nexport default class CartoLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      data: null,\n      apiVersion: null\n    };\n  }\n\n  get isLoaded() {\n    return this.getSubLayers().length > 0 && super.isLoaded;\n  }\n\n  _checkProps(props) {\n    const {type, credentials, connection} = props;\n    const localCreds = {...getDefaultCredentials(), ...credentials};\n    const {apiVersion} = localCreds;\n\n    log.assert(\n      Object.values(API_VERSIONS).includes(apiVersion),\n      `Invalid apiVersion ${apiVersion}. Use API_VERSIONS enum.`\n    );\n\n    if (apiVersion === API_VERSIONS.V1 || apiVersion === API_VERSIONS.V2) {\n      log.assert(\n        type === MAP_TYPES.QUERY || type === MAP_TYPES.TILESET,\n        `Invalid type ${type}. Use type MAP_TYPES.QUERY or MAP_TYPES.TILESET for apiVersion ${apiVersion}`\n      );\n      log.assert(!connection, `Connection prop is not supported for apiVersion ${apiVersion}`);\n    } else if (apiVersion === API_VERSIONS.V3) {\n      log.assert(connection, 'Missing mandatory connection parameter');\n      log.assert(\n        Object.values(MAP_TYPES).includes(type),\n        `Invalid type ${type}. Use MAP_TYPES enum.`\n      );\n    }\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    this._checkProps(props);\n    const shouldUpdateData =\n      changeFlags.dataChanged ||\n      props.connection !== oldProps.connection ||\n      props.type !== oldProps.type ||\n      JSON.stringify(props.credentials) !== JSON.stringify(oldProps.credentials);\n\n    if (shouldUpdateData) {\n      this.setState({data: null, apiVersion: null});\n      this._updateData();\n    }\n  }\n\n  async _updateData() {\n    try {\n      const {type, data: source, connection, credentials} = this.props;\n      const localConfig = {...getDefaultCredentials(), ...credentials};\n      const {apiVersion} = localConfig;\n\n      let data;\n\n      if (apiVersion === API_VERSIONS.V3) {\n        data = await getData({\n          type,\n          source,\n          connection,\n          credentials\n        });\n      } else if (apiVersion === API_VERSIONS.V1 || apiVersion === API_VERSIONS.V2) {\n        data = await getDataV2({type, source, credentials});\n      } else {\n        log.assert(`Unknow apiVersion ${apiVersion}. Use API_VERSIONS enum.`);\n      }\n\n      this.setState({data, apiVersion});\n      this.props.onDataLoad(data);\n    } catch (err) {\n      if (this.props.onDataError) {\n        this.props.onDataError(err);\n      } else {\n        throw err;\n      }\n    }\n  }\n\n  renderLayers() {\n    const {data, apiVersion} = this.state;\n    const {type} = this.props;\n\n    if (!data) return null;\n\n    const {updateTriggers} = this.props;\n\n    let layer;\n\n    if (\n      apiVersion === API_VERSIONS.V1 ||\n      apiVersion === API_VERSIONS.V2 ||\n      type === MAP_TYPES.TILESET\n    ) {\n      layer = MVTLayer;\n    } else {\n      layer = GeoJsonLayer;\n    }\n\n    const props = {...this.props};\n    delete props.data;\n\n    // eslint-disable-next-line new-cap\n    return new layer(\n      props,\n      this.getSubLayerProps({\n        id: `carto-${layer.layerName}`,\n        data,\n        updateTriggers\n      })\n    );\n  }\n}\n\nCartoLayer.layerName = 'CartoLayer';\nCartoLayer.defaultProps = defaultProps;\n"],"file":"carto-layer.js"}