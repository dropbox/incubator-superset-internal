{"ast":null,"code":"import _isEqualWith from \"lodash/isEqualWith\";import _isEqual from \"lodash/isEqual\"; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';\nimport { Behavior, FeatureFlag, getChartMetadataRegistry, styled, SuperChart, t } from '@superset-ui/core';\nimport { useDispatch, useSelector } from 'react-redux';\n\nimport { getChartDataRequest } from 'src/components/Chart/chartAction';\nimport Loading from 'src/components/Loading';\nimport BasicErrorAlert from 'src/components/ErrorMessage/BasicErrorAlert';\nimport { isFeatureEnabled } from 'src/featureFlags';\nimport { waitForAsyncData } from 'src/middleware/asyncEvent';\nimport { FilterBarOrientation } from 'src/dashboard/types';\nimport { onFiltersRefreshSuccess, setDirectPathToChild } from 'src/dashboard/actions/dashboardState';\nimport { FAST_DEBOUNCE } from 'src/constants';\nimport { dispatchHoverAction, dispatchFocusAction } from './utils';\nimport { getFormData } from '../../utils';\nimport { useFilterDependencies } from './state';\nimport { checkIsMissingRequiredValue } from '../utils';\nimport { useFilterOutlined } from '../useFilterOutlined';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst HEIGHT = 32;\n// Overrides superset-ui height with min-height\nconst StyledDiv = styled.div`\n  & > div {\n    height: auto !important;\n    min-height: ${HEIGHT}px;\n  }\n`;\nconst queriesDataPlaceholder = [{ data: [{}] }];\nconst behaviors = [Behavior.NATIVE_FILTER];\nconst useShouldFilterRefresh = () => {\n  const isDashboardRefreshing = useSelector((state) => state.dashboardState.isRefreshing);\n  const isFilterRefreshing = useSelector((state) => state.dashboardState.isFiltersRefreshing);\n  // trigger filter requests only after charts requests were triggered\n  return !isDashboardRefreshing && isFilterRefreshing;\n};\nconst FilterValue = (_ref) => {var _filter$dataMask2, _filter$dataMask4, _filter$dataMask5;let { dataMaskSelected, filter, onFilterSelectionChange, inView = true, showOverflow, parentRef, setFilterActive, orientation = FilterBarOrientation.VERTICAL, overflow = false } = _ref;\n  const { id, targets, filterType, adhoc_filters, time_range } = filter;\n  const metadata = getChartMetadataRegistry().get(filterType);\n  const dependencies = useFilterDependencies(id, dataMaskSelected);\n  const shouldRefresh = useShouldFilterRefresh();\n  const [state, setState] = useState([]);\n  const [error, setError] = useState('');\n  const [formData, setFormData] = useState({\n    inView: false });\n\n  const [ownState, setOwnState] = useState({});\n  const [inViewFirstTime, setInViewFirstTime] = useState(inView);\n  const inputRef = useRef(null);\n  const [target] = targets;\n  const { datasetId, column = {} } = target;\n  const { name: groupby } = column;\n  const hasDataSource = !!datasetId;\n  const [isLoading, setIsLoading] = useState(hasDataSource);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const dispatch = useDispatch();\n  const { outlinedFilterId, lastUpdated } = useFilterOutlined();\n  const handleFilterLoadFinish = useCallback(() => {\n    setIsRefreshing(false);\n    setIsLoading(false);\n    if (shouldRefresh) {\n      dispatch(onFiltersRefreshSuccess());\n    }\n  }, [dispatch, shouldRefresh]);\n  useEffect(() => {\n    if (!inViewFirstTime && inView) {\n      setInViewFirstTime(true);\n    }\n  }, [inView, inViewFirstTime, setInViewFirstTime]);\n  useEffect(() => {var _filter$dataMask;\n    if (!inViewFirstTime) {\n      return;\n    }\n    const newFormData = getFormData({\n      ...filter,\n      datasetId,\n      dependencies,\n      groupby,\n      adhoc_filters,\n      time_range });\n\n    const filterOwnState = ((_filter$dataMask = filter.dataMask) == null ? void 0 : _filter$dataMask.ownState) || {};\n    // TODO: We should try to improve our useEffect hooks to depend more on\n    // granular information instead of big objects that require deep comparison.\n    const customizer = (objValue, othValue, key) => key === 'url_params' ? true : undefined;\n    if (!isRefreshing && (\n    !_isEqualWith(formData, newFormData, customizer) ||\n    !_isEqual(ownState, filterOwnState) ||\n    shouldRefresh)) {\n      setFormData(newFormData);\n      setOwnState(filterOwnState);\n      if (!hasDataSource) {\n        return;\n      }\n      setIsRefreshing(true);\n      getChartDataRequest({\n        formData: newFormData,\n        force: false,\n        requestParams: { dashboardId: 0 },\n        ownState: filterOwnState }).\n\n      then((_ref2) => {let { response, json } = _ref2;\n        if (isFeatureEnabled(FeatureFlag.GLOBAL_ASYNC_QUERIES)) {\n          // deal with getChartDataRequest transforming the response data\n          const result = 'result' in json ? json.result[0] : json;\n          if (response.status === 200) {\n            setState([result]);\n            handleFilterLoadFinish();\n          } else\n          if (response.status === 202) {\n            waitForAsyncData(result).\n            then((asyncResult) => {\n              setState(asyncResult);\n              handleFilterLoadFinish();\n            }).\n            catch((error) => {\n              setError(error.message || error.error || t('Check configuration'));\n              handleFilterLoadFinish();\n            });\n          } else\n          {\n            throw new Error(`Received unexpected response status (${response.status}) while fetching chart data`);\n          }\n        } else\n        {\n          setState(json.result);\n          setError('');\n          handleFilterLoadFinish();\n        }\n      }).\n      catch((error) => {\n        setError(error.statusText);\n        handleFilterLoadFinish();\n      });\n    }\n  }, [\n  inViewFirstTime,\n  dependencies,\n  datasetId,\n  groupby,\n  handleFilterLoadFinish,\n  JSON.stringify(filter),\n  hasDataSource,\n  isRefreshing,\n  shouldRefresh]);\n\n  useEffect(() => {\n    if (outlinedFilterId && outlinedFilterId === filter.id) {\n      setTimeout(() => {var _inputRef$current;\n        inputRef == null ? void 0 : (_inputRef$current = inputRef.current) == null ? void 0 : _inputRef$current.focus();\n      }, overflow ? FAST_DEBOUNCE : 0);\n    }\n  }, [inputRef, outlinedFilterId, lastUpdated, filter.id, overflow]);\n  const setDataMask = useCallback((dataMask) => onFilterSelectionChange(filter, dataMask), [filter, onFilterSelectionChange]);\n  const setFocusedFilter = useCallback(() => {\n    // don't highlight charts in scope if filter was focused programmatically\n    if (outlinedFilterId !== id) {\n      dispatchFocusAction(dispatch, id);\n    }\n  }, [dispatch, id, outlinedFilterId]);\n  const unsetFocusedFilter = useCallback(() => {\n    dispatchFocusAction(dispatch);\n    if (outlinedFilterId === id) {\n      dispatch(setDirectPathToChild([]));\n    }\n  }, [dispatch, id, outlinedFilterId]);\n  const setHoveredFilter = useCallback(() => dispatchHoverAction(dispatch, id), [dispatch, id]);\n  const unsetHoveredFilter = useCallback(() => dispatchHoverAction(dispatch), [dispatch]);\n  const hooks = useMemo(() => ({\n    setDataMask,\n    setHoveredFilter,\n    unsetHoveredFilter,\n    setFocusedFilter,\n    unsetFocusedFilter,\n    setFilterActive }),\n  [\n  setDataMask,\n  setFilterActive,\n  setHoveredFilter,\n  unsetHoveredFilter,\n  setFocusedFilter,\n  unsetFocusedFilter]);\n\n  const isMissingRequiredValue = checkIsMissingRequiredValue(filter, (_filter$dataMask2 = filter.dataMask) == null ? void 0 : _filter$dataMask2.filterState);\n  const filterState = useMemo(() => {var _filter$dataMask3;return {\n      ...((_filter$dataMask3 = filter.dataMask) == null ? void 0 : _filter$dataMask3.filterState),\n      validateStatus: isMissingRequiredValue && 'error' };},\n  [(_filter$dataMask4 = filter.dataMask) == null ? void 0 : _filter$dataMask4.filterState, isMissingRequiredValue]);\n  const displaySettings = useMemo(() => ({\n    filterBarOrientation: orientation,\n    isOverflowingFilterBar: overflow }),\n  [orientation, overflow]);\n  if (error) {\n    return ___EmotionJSX(BasicErrorAlert, { title: t('Cannot load filter'), body: error, level: \"error\" });\n  }\n  return ___EmotionJSX(StyledDiv, null,\n  isLoading ? ___EmotionJSX(Loading, { position: \"inline-centered\" }) : ___EmotionJSX(SuperChart, { height: HEIGHT, width: \"100%\", showOverflow: showOverflow, formData: formData, displaySettings: displaySettings, parentRef: parentRef, inputRef: inputRef\n    // For charts that don't have datasource we need workaround for empty placeholder\n    , queriesData: hasDataSource ? state : queriesDataPlaceholder, chartType: filterType, behaviors: behaviors, filterState: filterState, ownState: (_filter$dataMask5 = filter.dataMask) == null ? void 0 : _filter$dataMask5.ownState, enableNoResults: metadata == null ? void 0 : metadata.enableNoResults, isRefreshing: isRefreshing, hooks: hooks }));\n\n};\nexport default /*#__PURE__*/React.memo(FilterValue);","map":{"version":3,"mappings":"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","names":["React","useCallback","useEffect","useMemo","useRef","useState","Behavior","FeatureFlag","getChartMetadataRegistry","styled","SuperChart","t","useDispatch","useSelector","getChartDataRequest","Loading","BasicErrorAlert","isFeatureEnabled","waitForAsyncData","FilterBarOrientation","onFiltersRefreshSuccess","setDirectPathToChild","FAST_DEBOUNCE","dispatchHoverAction","dispatchFocusAction","getFormData","useFilterDependencies","checkIsMissingRequiredValue","useFilterOutlined","HEIGHT","StyledDiv","div","queriesDataPlaceholder","data","behaviors","NATIVE_FILTER","useShouldFilterRefresh","isDashboardRefreshing","state","dashboardState","isRefreshing","isFilterRefreshing","isFiltersRefreshing","FilterValue","dataMaskSelected","filter","onFilterSelectionChange","inView","showOverflow","parentRef","setFilterActive","orientation","VERTICAL","overflow","id","targets","filterType","adhoc_filters","time_range","metadata","get","dependencies","shouldRefresh","setState","error","setError","formData","setFormData","ownState","setOwnState","inViewFirstTime","setInViewFirstTime","inputRef","target","datasetId","column","name","groupby","hasDataSource","isLoading","setIsLoading","setIsRefreshing","dispatch","outlinedFilterId","lastUpdated","handleFilterLoadFinish","newFormData","filterOwnState","dataMask","customizer","objValue","othValue","key","undefined","force","requestParams","dashboardId","then","response","json","GLOBAL_ASYNC_QUERIES","result","status","asyncResult","catch","message","Error","statusText","JSON","stringify","setTimeout","current","focus","setDataMask","setFocusedFilter","unsetFocusedFilter","setHoveredFilter","unsetHoveredFilter","hooks","isMissingRequiredValue","filterState","validateStatus","displaySettings","filterBarOrientation","isOverflowingFilterBar","enableNoResults","memo"],"sourceRoot":"","sources":["/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/FilterControls/FilterValue.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, {\n  useCallback,\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\nimport {\n  ChartDataResponseResult,\n  Behavior,\n  DataMask,\n  FeatureFlag,\n  getChartMetadataRegistry,\n  JsonObject,\n  QueryFormData,\n  styled,\n  SuperChart,\n  t,\n} from '@superset-ui/core';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { isEqual, isEqualWith } from 'lodash';\nimport { getChartDataRequest } from 'src/components/Chart/chartAction';\nimport Loading from 'src/components/Loading';\nimport BasicErrorAlert from 'src/components/ErrorMessage/BasicErrorAlert';\nimport { isFeatureEnabled } from 'src/featureFlags';\nimport { waitForAsyncData } from 'src/middleware/asyncEvent';\nimport { ClientErrorObject } from 'src/utils/getClientErrorObject';\nimport { FilterBarOrientation, RootState } from 'src/dashboard/types';\nimport {\n  onFiltersRefreshSuccess,\n  setDirectPathToChild,\n} from 'src/dashboard/actions/dashboardState';\nimport { FAST_DEBOUNCE } from 'src/constants';\nimport { dispatchHoverAction, dispatchFocusAction } from './utils';\nimport { FilterControlProps } from './types';\nimport { getFormData } from '../../utils';\nimport { useFilterDependencies } from './state';\nimport { checkIsMissingRequiredValue } from '../utils';\nimport { useFilterOutlined } from '../useFilterOutlined';\n\nconst HEIGHT = 32;\n\n// Overrides superset-ui height with min-height\nconst StyledDiv = styled.div`\n  & > div {\n    height: auto !important;\n    min-height: ${HEIGHT}px;\n  }\n`;\n\nconst queriesDataPlaceholder = [{ data: [{}] }];\nconst behaviors = [Behavior.NATIVE_FILTER];\n\nconst useShouldFilterRefresh = () => {\n  const isDashboardRefreshing = useSelector<RootState, boolean>(\n    state => state.dashboardState.isRefreshing,\n  );\n  const isFilterRefreshing = useSelector<RootState, boolean>(\n    state => state.dashboardState.isFiltersRefreshing,\n  );\n\n  // trigger filter requests only after charts requests were triggered\n  return !isDashboardRefreshing && isFilterRefreshing;\n};\n\nconst FilterValue: React.FC<FilterControlProps> = ({\n  dataMaskSelected,\n  filter,\n  onFilterSelectionChange,\n  inView = true,\n  showOverflow,\n  parentRef,\n  setFilterActive,\n  orientation = FilterBarOrientation.VERTICAL,\n  overflow = false,\n}) => {\n  const { id, targets, filterType, adhoc_filters, time_range } = filter;\n  const metadata = getChartMetadataRegistry().get(filterType);\n  const dependencies = useFilterDependencies(id, dataMaskSelected);\n  const shouldRefresh = useShouldFilterRefresh();\n  const [state, setState] = useState<ChartDataResponseResult[]>([]);\n  const [error, setError] = useState<string>('');\n  const [formData, setFormData] = useState<Partial<QueryFormData>>({\n    inView: false,\n  });\n  const [ownState, setOwnState] = useState<JsonObject>({});\n  const [inViewFirstTime, setInViewFirstTime] = useState(inView);\n  const inputRef = useRef<HTMLInputElement>(null);\n  const [target] = targets;\n  const {\n    datasetId,\n    column = {},\n  }: Partial<{ datasetId: number; column: { name?: string } }> = target;\n  const { name: groupby } = column;\n  const hasDataSource = !!datasetId;\n  const [isLoading, setIsLoading] = useState<boolean>(hasDataSource);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const dispatch = useDispatch();\n\n  const { outlinedFilterId, lastUpdated } = useFilterOutlined();\n\n  const handleFilterLoadFinish = useCallback(() => {\n    setIsRefreshing(false);\n    setIsLoading(false);\n    if (shouldRefresh) {\n      dispatch(onFiltersRefreshSuccess());\n    }\n  }, [dispatch, shouldRefresh]);\n\n  useEffect(() => {\n    if (!inViewFirstTime && inView) {\n      setInViewFirstTime(true);\n    }\n  }, [inView, inViewFirstTime, setInViewFirstTime]);\n\n  useEffect(() => {\n    if (!inViewFirstTime) {\n      return;\n    }\n    const newFormData = getFormData({\n      ...filter,\n      datasetId,\n      dependencies,\n      groupby,\n      adhoc_filters,\n      time_range,\n    });\n    const filterOwnState = filter.dataMask?.ownState || {};\n    // TODO: We should try to improve our useEffect hooks to depend more on\n    // granular information instead of big objects that require deep comparison.\n    const customizer = (\n      objValue: Partial<QueryFormData>,\n      othValue: Partial<QueryFormData>,\n      key: string,\n    ) => (key === 'url_params' ? true : undefined);\n    if (\n      !isRefreshing &&\n      (!isEqualWith(formData, newFormData, customizer) ||\n        !isEqual(ownState, filterOwnState) ||\n        shouldRefresh)\n    ) {\n      setFormData(newFormData);\n      setOwnState(filterOwnState);\n      if (!hasDataSource) {\n        return;\n      }\n      setIsRefreshing(true);\n      getChartDataRequest({\n        formData: newFormData,\n        force: false,\n        requestParams: { dashboardId: 0 },\n        ownState: filterOwnState,\n      })\n        .then(({ response, json }) => {\n          if (isFeatureEnabled(FeatureFlag.GLOBAL_ASYNC_QUERIES)) {\n            // deal with getChartDataRequest transforming the response data\n            const result = 'result' in json ? json.result[0] : json;\n\n            if (response.status === 200) {\n              setState([result]);\n              handleFilterLoadFinish();\n            } else if (response.status === 202) {\n              waitForAsyncData(result)\n                .then((asyncResult: ChartDataResponseResult[]) => {\n                  setState(asyncResult);\n                  handleFilterLoadFinish();\n                })\n                .catch((error: ClientErrorObject) => {\n                  setError(\n                    error.message || error.error || t('Check configuration'),\n                  );\n                  handleFilterLoadFinish();\n                });\n            } else {\n              throw new Error(\n                `Received unexpected response status (${response.status}) while fetching chart data`,\n              );\n            }\n          } else {\n            setState(json.result);\n            setError('');\n            handleFilterLoadFinish();\n          }\n        })\n        .catch((error: Response) => {\n          setError(error.statusText);\n          handleFilterLoadFinish();\n        });\n    }\n  }, [\n    inViewFirstTime,\n    dependencies,\n    datasetId,\n    groupby,\n    handleFilterLoadFinish,\n    JSON.stringify(filter),\n    hasDataSource,\n    isRefreshing,\n    shouldRefresh,\n  ]);\n\n  useEffect(() => {\n    if (outlinedFilterId && outlinedFilterId === filter.id) {\n      setTimeout(\n        () => {\n          inputRef?.current?.focus();\n        },\n        overflow ? FAST_DEBOUNCE : 0,\n      );\n    }\n  }, [inputRef, outlinedFilterId, lastUpdated, filter.id, overflow]);\n\n  const setDataMask = useCallback(\n    (dataMask: DataMask) => onFilterSelectionChange(filter, dataMask),\n    [filter, onFilterSelectionChange],\n  );\n\n  const setFocusedFilter = useCallback(() => {\n    // don't highlight charts in scope if filter was focused programmatically\n    if (outlinedFilterId !== id) {\n      dispatchFocusAction(dispatch, id);\n    }\n  }, [dispatch, id, outlinedFilterId]);\n\n  const unsetFocusedFilter = useCallback(() => {\n    dispatchFocusAction(dispatch);\n    if (outlinedFilterId === id) {\n      dispatch(setDirectPathToChild([]));\n    }\n  }, [dispatch, id, outlinedFilterId]);\n\n  const setHoveredFilter = useCallback(\n    () => dispatchHoverAction(dispatch, id),\n    [dispatch, id],\n  );\n  const unsetHoveredFilter = useCallback(\n    () => dispatchHoverAction(dispatch),\n    [dispatch],\n  );\n\n  const hooks = useMemo(\n    () => ({\n      setDataMask,\n      setHoveredFilter,\n      unsetHoveredFilter,\n      setFocusedFilter,\n      unsetFocusedFilter,\n      setFilterActive,\n    }),\n    [\n      setDataMask,\n      setFilterActive,\n      setHoveredFilter,\n      unsetHoveredFilter,\n      setFocusedFilter,\n      unsetFocusedFilter,\n    ],\n  );\n\n  const isMissingRequiredValue = checkIsMissingRequiredValue(\n    filter,\n    filter.dataMask?.filterState,\n  );\n\n  const filterState = useMemo(\n    () => ({\n      ...filter.dataMask?.filterState,\n      validateStatus: isMissingRequiredValue && 'error',\n    }),\n    [filter.dataMask?.filterState, isMissingRequiredValue],\n  );\n\n  const displaySettings = useMemo(\n    () => ({\n      filterBarOrientation: orientation,\n      isOverflowingFilterBar: overflow,\n    }),\n    [orientation, overflow],\n  );\n\n  if (error) {\n    return (\n      <BasicErrorAlert\n        title={t('Cannot load filter')}\n        body={error}\n        level=\"error\"\n      />\n    );\n  }\n\n  return (\n    <StyledDiv data-test=\"form-item-value\">\n      {isLoading ? (\n        <Loading position=\"inline-centered\" />\n      ) : (\n        <SuperChart\n          height={HEIGHT}\n          width=\"100%\"\n          showOverflow={showOverflow}\n          formData={formData}\n          displaySettings={displaySettings}\n          parentRef={parentRef}\n          inputRef={inputRef}\n          // For charts that don't have datasource we need workaround for empty placeholder\n          queriesData={hasDataSource ? state : queriesDataPlaceholder}\n          chartType={filterType}\n          behaviors={behaviors}\n          filterState={filterState}\n          ownState={filter.dataMask?.ownState}\n          enableNoResults={metadata?.enableNoResults}\n          isRefreshing={isRefreshing}\n          hooks={hooks}\n        />\n      )}\n    </StyledDiv>\n  );\n};\nexport default React.memo(FilterValue);\n"]},"metadata":{},"sourceType":"module"}