{"ast":null,"code":"/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { lazy, Suspense } from 'react';\nimport ReactDOM from 'react-dom';\nimport { BrowserRouter as Router, Route } from 'react-router-dom';\nimport { makeApi, t, logging } from '@superset-ui/core';\nimport Switchboard from '@superset-ui/switchboard';\nimport getBootstrapData from 'src/utils/getBootstrapData';\nimport setupClient from 'src/setup/setupClient';\nimport { RootContextProviders } from 'src/views/RootContextProviders';\nimport { store, USER_LOADED } from 'src/views/store';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport Loading from 'src/components/Loading';\nimport { addDangerToast } from 'src/components/MessageToasts/actions';\nimport ToastContainer from 'src/components/MessageToasts/ToastContainer';\nimport { embeddedApi } from './api';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst debugMode = process.env.WEBPACK_MODE === 'development';\nconst bootstrapData = getBootstrapData();\nfunction log() {\n  if (debugMode) {for (var _len = arguments.length, info = new Array(_len), _key = 0; _key < _len; _key++) {info[_key] = arguments[_key];}\n    logging.debug(`[superset]`, ...info);\n  }\n}\nconst LazyDashboardPage = /*#__PURE__*/lazy(() => import(\n/* webpackChunkName: \"DashboardPage\" */'src/dashboard/containers/DashboardPage'));\nconst EmbeddedRoute = () => ___EmotionJSX(Suspense, { fallback: ___EmotionJSX(Loading, null) },\n___EmotionJSX(RootContextProviders, null,\n___EmotionJSX(ErrorBoundary, null,\n___EmotionJSX(LazyDashboardPage, { idOrSlug: bootstrapData.embedded.dashboard_id })),\n\n___EmotionJSX(ToastContainer, { position: \"top\" })));\n\n\nconst EmbeddedApp = () => ___EmotionJSX(Router, null,\n\n___EmotionJSX(Route, { path: \"/dashboard/:idOrSlug/embedded/\", component: EmbeddedRoute }),\n___EmotionJSX(Route, { path: \"/embedded/:uuid/\", component: EmbeddedRoute }));\n\nconst appMountPoint = document.getElementById('app');\nconst MESSAGE_TYPE = '__embedded_comms__';\nfunction showFailureMessage(message) {\n  appMountPoint.innerHTML = message;\n}\nif (!window.parent || window.parent === window) {\n  showFailureMessage('This page is intended to be embedded in an iframe, but it looks like that is not the case.');\n}\n// if the page is embedded in an origin that hasn't\n// been authorized by the curator, we forbid access entirely.\n// todo: check the referrer on the route serving this page instead\n// const ALLOW_ORIGINS = ['http://127.0.0.1:9001', 'http://localhost:9001'];\n// const parentOrigin = new URL(document.referrer).origin;\n// if (!ALLOW_ORIGINS.includes(parentOrigin)) {\n//   throw new Error(\n//     `[superset] iframe parent ${parentOrigin} is not in the list of allowed origins`,\n//   );\n// }\nlet displayedUnauthorizedToast = false;\n/**\n * If there is a problem with the guest token, we will start getting\n * 401 errors from the api and SupersetClient will call this function.\n */\nfunction guestUnauthorizedHandler() {\n  if (displayedUnauthorizedToast)\n  return; // no need to display this message every time we get another 401\n  displayedUnauthorizedToast = true;\n  // If a guest user were sent to a login screen on 401, they would have no valid login to use.\n  // For embedded it makes more sense to just display a message\n  // and let them continue accessing the page, to whatever extent they can.\n  store.dispatch(addDangerToast(t('This session has encountered an interruption, and some controls may not work as intended. If you are the developer of this app, please check that the guest token is being generated correctly.'), {\n    duration: -1,\n    noDuplicate: true }));\n\n}\nfunction start() {\n  const getMeWithRole = makeApi({\n    method: 'GET',\n    endpoint: '/api/v1/me/roles/' });\n\n  return getMeWithRole().then((_ref) => {let { result } = _ref;\n    // fill in some missing bootstrap data\n    // (because at pageload, we don't have any auth yet)\n    // this allows the frontend's permissions checks to work.\n    bootstrapData.user = result;\n    store.dispatch({\n      type: USER_LOADED,\n      user: result });\n\n    ReactDOM.render(___EmotionJSX(EmbeddedApp, null), appMountPoint);\n  }, (err) => {\n    // something is most likely wrong with the guest token\n    logging.error(err);\n    showFailureMessage('Something went wrong with embedded authentication. Check the dev console for details.');\n  });\n}\n/**\n * Configures SupersetClient with the correct settings for the embedded dashboard page.\n */\nfunction setupGuestClient(guestToken) {var _bootstrapData$config;\n  setupClient({\n    guestToken,\n    guestTokenHeaderName: (_bootstrapData$config = bootstrapData.config) == null ? void 0 : _bootstrapData$config.GUEST_TOKEN_HEADER_NAME,\n    unauthorizedHandler: guestUnauthorizedHandler });\n\n}\nfunction validateMessageEvent(event) {\n  // if (!ALLOW_ORIGINS.includes(event.origin)) {\n  //   throw new Error('Message origin is not in the allowed list');\n  // }\n  if (typeof event.data !== 'object' || event.data.type !== MESSAGE_TYPE) {\n    throw new Error(`Message type does not match type used for embedded comms`);\n  }\n}\nwindow.addEventListener('message', function embeddedPageInitializer(event) {var _event$ports;\n  try {\n    validateMessageEvent(event);\n  }\n  catch (err) {\n    log('ignoring message unrelated to embedded comms', err, event);\n    return;\n  }\n  const port = (_event$ports = event.ports) == null ? void 0 : _event$ports[0];\n  if (event.data.handshake === 'port transfer' && port) {\n    log('message port received', event);\n    Switchboard.init({\n      port,\n      name: 'superset',\n      debug: debugMode });\n\n    let started = false;\n    Switchboard.defineMethod('guestToken', (_ref2) => {let { guestToken } = _ref2;\n      setupGuestClient(guestToken);\n      if (!started) {\n        start();\n        started = true;\n      }\n    });\n    Switchboard.defineMethod('getScrollSize', embeddedApi.getScrollSize);\n    Switchboard.defineMethod('getDashboardPermalink', embeddedApi.getDashboardPermalink);\n    Switchboard.defineMethod('getActiveTabs', embeddedApi.getActiveTabs);\n    Switchboard.start();\n  }\n});\nlog('embed page is ready to receive messages');","map":{"version":3,"mappings":"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","names":["React","lazy","Suspense","ReactDOM","BrowserRouter","Router","Route","makeApi","t","logging","Switchboard","getBootstrapData","setupClient","RootContextProviders","store","USER_LOADED","ErrorBoundary","Loading","addDangerToast","ToastContainer","embeddedApi","debugMode","process","env","WEBPACK_MODE","bootstrapData","log","info","debug","LazyDashboardPage","EmbeddedRoute","embedded","dashboard_id","EmbeddedApp","appMountPoint","document","getElementById","MESSAGE_TYPE","showFailureMessage","message","innerHTML","window","parent","displayedUnauthorizedToast","guestUnauthorizedHandler","dispatch","duration","noDuplicate","start","getMeWithRole","method","endpoint","then","result","user","type","render","error","err","setupGuestClient","guestToken","guestTokenHeaderName","config","GUEST_TOKEN_HEADER_NAME","unauthorizedHandler","validateMessageEvent","event","data","Error","addEventListener","embeddedPageInitializer","port","ports","handshake","init","name","started","defineMethod","getScrollSize","getDashboardPermalink","getActiveTabs"],"sourceRoot":"","sources":["/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/embedded/index.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { lazy, Suspense } from 'react';\nimport ReactDOM from 'react-dom';\nimport { BrowserRouter as Router, Route } from 'react-router-dom';\nimport { makeApi, t, logging } from '@superset-ui/core';\nimport Switchboard from '@superset-ui/switchboard';\nimport getBootstrapData from 'src/utils/getBootstrapData';\nimport setupClient from 'src/setup/setupClient';\nimport { RootContextProviders } from 'src/views/RootContextProviders';\nimport { store, USER_LOADED } from 'src/views/store';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport Loading from 'src/components/Loading';\nimport { addDangerToast } from 'src/components/MessageToasts/actions';\nimport ToastContainer from 'src/components/MessageToasts/ToastContainer';\nimport { UserWithPermissionsAndRoles } from 'src/types/bootstrapTypes';\nimport { embeddedApi } from './api';\n\nconst debugMode = process.env.WEBPACK_MODE === 'development';\nconst bootstrapData = getBootstrapData();\n\nfunction log(...info: unknown[]) {\n  if (debugMode) {\n    logging.debug(`[superset]`, ...info);\n  }\n}\n\nconst LazyDashboardPage = lazy(\n  () =>\n    import(\n      /* webpackChunkName: \"DashboardPage\" */ 'src/dashboard/containers/DashboardPage'\n    ),\n);\n\nconst EmbeddedRoute = () => (\n  <Suspense fallback={<Loading />}>\n    <RootContextProviders>\n      <ErrorBoundary>\n        <LazyDashboardPage idOrSlug={bootstrapData.embedded!.dashboard_id} />\n      </ErrorBoundary>\n      <ToastContainer position=\"top\" />\n    </RootContextProviders>\n  </Suspense>\n);\n\nconst EmbeddedApp = () => (\n  <Router>\n    {/* todo (embedded) remove this line after uuids are deployed */}\n    <Route path=\"/dashboard/:idOrSlug/embedded/\" component={EmbeddedRoute} />\n    <Route path=\"/embedded/:uuid/\" component={EmbeddedRoute} />\n  </Router>\n);\n\nconst appMountPoint = document.getElementById('app')!;\n\nconst MESSAGE_TYPE = '__embedded_comms__';\n\nfunction showFailureMessage(message: string) {\n  appMountPoint.innerHTML = message;\n}\n\nif (!window.parent || window.parent === window) {\n  showFailureMessage(\n    'This page is intended to be embedded in an iframe, but it looks like that is not the case.',\n  );\n}\n\n// if the page is embedded in an origin that hasn't\n// been authorized by the curator, we forbid access entirely.\n// todo: check the referrer on the route serving this page instead\n// const ALLOW_ORIGINS = ['http://127.0.0.1:9001', 'http://localhost:9001'];\n// const parentOrigin = new URL(document.referrer).origin;\n// if (!ALLOW_ORIGINS.includes(parentOrigin)) {\n//   throw new Error(\n//     `[superset] iframe parent ${parentOrigin} is not in the list of allowed origins`,\n//   );\n// }\n\nlet displayedUnauthorizedToast = false;\n\n/**\n * If there is a problem with the guest token, we will start getting\n * 401 errors from the api and SupersetClient will call this function.\n */\nfunction guestUnauthorizedHandler() {\n  if (displayedUnauthorizedToast) return; // no need to display this message every time we get another 401\n  displayedUnauthorizedToast = true;\n  // If a guest user were sent to a login screen on 401, they would have no valid login to use.\n  // For embedded it makes more sense to just display a message\n  // and let them continue accessing the page, to whatever extent they can.\n  store.dispatch(\n    addDangerToast(\n      t(\n        'This session has encountered an interruption, and some controls may not work as intended. If you are the developer of this app, please check that the guest token is being generated correctly.',\n      ),\n      {\n        duration: -1, // stay open until manually closed\n        noDuplicate: true,\n      },\n    ),\n  );\n}\n\nfunction start() {\n  const getMeWithRole = makeApi<void, { result: UserWithPermissionsAndRoles }>({\n    method: 'GET',\n    endpoint: '/api/v1/me/roles/',\n  });\n  return getMeWithRole().then(\n    ({ result }) => {\n      // fill in some missing bootstrap data\n      // (because at pageload, we don't have any auth yet)\n      // this allows the frontend's permissions checks to work.\n      bootstrapData.user = result;\n      store.dispatch({\n        type: USER_LOADED,\n        user: result,\n      });\n      ReactDOM.render(<EmbeddedApp />, appMountPoint);\n    },\n    err => {\n      // something is most likely wrong with the guest token\n      logging.error(err);\n      showFailureMessage(\n        'Something went wrong with embedded authentication. Check the dev console for details.',\n      );\n    },\n  );\n}\n\n/**\n * Configures SupersetClient with the correct settings for the embedded dashboard page.\n */\nfunction setupGuestClient(guestToken: string) {\n  setupClient({\n    guestToken,\n    guestTokenHeaderName: bootstrapData.config?.GUEST_TOKEN_HEADER_NAME,\n    unauthorizedHandler: guestUnauthorizedHandler,\n  });\n}\n\nfunction validateMessageEvent(event: MessageEvent) {\n  // if (!ALLOW_ORIGINS.includes(event.origin)) {\n  //   throw new Error('Message origin is not in the allowed list');\n  // }\n\n  if (typeof event.data !== 'object' || event.data.type !== MESSAGE_TYPE) {\n    throw new Error(`Message type does not match type used for embedded comms`);\n  }\n}\n\nwindow.addEventListener('message', function embeddedPageInitializer(event) {\n  try {\n    validateMessageEvent(event);\n  } catch (err) {\n    log('ignoring message unrelated to embedded comms', err, event);\n    return;\n  }\n\n  const port = event.ports?.[0];\n  if (event.data.handshake === 'port transfer' && port) {\n    log('message port received', event);\n\n    Switchboard.init({\n      port,\n      name: 'superset',\n      debug: debugMode,\n    });\n\n    let started = false;\n\n    Switchboard.defineMethod(\n      'guestToken',\n      ({ guestToken }: { guestToken: string }) => {\n        setupGuestClient(guestToken);\n        if (!started) {\n          start();\n          started = true;\n        }\n      },\n    );\n\n    Switchboard.defineMethod('getScrollSize', embeddedApi.getScrollSize);\n    Switchboard.defineMethod(\n      'getDashboardPermalink',\n      embeddedApi.getDashboardPermalink,\n    );\n    Switchboard.defineMethod('getActiveTabs', embeddedApi.getActiveTabs);\n    Switchboard.start();\n  }\n});\n\nlog('embed page is ready to receive messages');\n"]},"metadata":{},"sourceType":"module"}