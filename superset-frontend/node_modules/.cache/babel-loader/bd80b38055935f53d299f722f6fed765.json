{"ast":null,"code":"// [LICENSE TBD]\n/* Copied and altered from http://cal-heatmap.com/ , alterations around:\n * - tuning tooltips\n * - supporting multi-colors scales\n * - legend format\n * - UTC handling\n */\n\n/* eslint-disable */\n\nimport d3tip from 'd3-tip';\nimport { getContrastingColor, t } from '@superset-ui/core';\n\nvar d3 = typeof require === 'function' ? require('d3') : window.d3;\n\nvar d3 = typeof require === 'function' ? require('d3') : window.d3;\n\nvar CalHeatMap = function () {\n  'use strict';\n\n  var self = this;\n  self.tip = d3tip().\n  attr('class', 'd3-tip').\n  direction('n').\n  offset([-5, 0]).\n  html(\n  (d) => `\n      ${self.options.timeFormatter(d.t)}: <strong>${self.options.valueFormatter(\n  d.v)\n  }</strong>\n    `);\n\n  self.legendTip = d3tip().\n  attr('class', 'd3-tip').\n  direction('n').\n  offset([-5, 0]).\n  html((d) => self.options.valueFormatter(d));\n\n  this.allowedDataType = ['json', 'csv', 'tsv', 'txt'];\n\n  // Default settings\n  this.options = {\n    // selector string of the container to append the graph to\n    // Accept any string value accepted by document.querySelector or CSS3\n    // or an Element object\n    itemSelector: '#cal-heatmap',\n\n    // Whether to paint the calendar on init()\n    // Used by testsuite to reduce testing time\n    paintOnLoad: true,\n\n    // ================================================\n    // DOMAIN\n    // ================================================\n\n    // Number of domain to display on the graph\n    range: 12,\n\n    // Size of each cell, in pixel\n    cellSize: 10,\n\n    // Padding between each cell, in pixel\n    cellPadding: 2,\n\n    // For rounded subdomain rectangles, in pixels\n    cellRadius: 0,\n\n    domainGutter: 2,\n\n    domainMargin: [0, 0, 0, 0],\n\n    valueFormatter: (d) => d,\n\n    timeFormatter: (d) => d,\n\n    domain: 'hour',\n\n    subDomain: 'min',\n\n    // Number of columns to split the subDomains to\n    // If not null, will takes precedence over rowLimit\n    colLimit: null,\n\n    // Number of rows to split the subDomains to\n    // Will be ignored if colLimit is not null\n    rowLimit: null,\n\n    // First day of the week is Monday\n    // 0 to start the week on Sunday\n    weekStartOnMonday: true,\n\n    // Start date of the graph\n    // @default now\n    start: new Date(),\n\n    minDate: null,\n\n    maxDate: null,\n\n    // ================================================\n    // DATA\n    // ================================================\n\n    // Data source\n    // URL, where to fetch the original datas\n    data: '',\n\n    // Data type\n    // Default: json\n    dataType: this.allowedDataType[0],\n\n    // Payload sent when using POST http method\n    // Leave to null (default) for GET request\n    // Expect a string, formatted like \"a=b;c=d\"\n    dataPostPayload: null,\n\n    // Additional headers sent when requesting data\n    // Expect an object formatted like:\n    // { 'X-CSRF-TOKEN': 'token' }\n    dataRequestHeaders: null,\n\n    // Whether to consider missing date:value from the datasource\n    // as equal to 0, or just leave them as missing\n    considerMissingDataAsZero: false,\n\n    // Load remote data on calendar creation\n    // When false, the calendar will be left empty\n    loadOnInit: true,\n\n    // Calendar orientation\n    // false: display domains side by side\n    // true : display domains one under the other\n    verticalOrientation: false,\n\n    // Domain dynamic width/height\n    // The width on a domain depends on the number of\n    domainDynamicDimension: true,\n\n    // Domain Label properties\n    label: {\n      // valid: top, right, bottom, left\n      position: 'bottom',\n\n      // Valid: left, center, right\n      // Also valid are the direct svg values: start, middle, end\n      align: 'center',\n\n      // By default, there is no margin/padding around the label\n      offset: {\n        x: 0,\n        y: 0 },\n\n\n      rotate: null,\n\n      // Used only on vertical orientation\n      width: 100,\n\n      // Used only on horizontal orientation\n      height: null },\n\n\n    // ================================================\n    // LEGEND\n    // ================================================\n\n    // Threshold for the legend\n    legend: [10, 20, 30, 40],\n\n    // Whether to display the legend\n    displayLegend: true,\n\n    legendCellSize: 10,\n\n    legendCellPadding: 2,\n\n    legendMargin: [0, 0, 0, 0],\n\n    // Legend vertical position\n    // top: place legend above calendar\n    // bottom: place legend below the calendar\n    legendVerticalPosition: 'bottom',\n\n    // Legend horizontal position\n    // accepted values: left, center, right\n    legendHorizontalPosition: 'left',\n\n    // Legend rotation\n    // accepted values: horizontal, vertical\n    legendOrientation: 'horizontal',\n\n    // Objects holding all the heatmap different colors\n    // null to disable, and use the default css styles\n    //\n    // Examples:\n    // legendColors: {\n    //    min: \"green\",\n    //    max: \"red\",\n    //    empty: \"#ffffff\",\n    //    base: \"grey\",\n    //    overflow: \"red\",\n    //    colorScaler: null,\n    // }\n    legendColors: null,\n\n    // ================================================\n    // HIGHLIGHT\n    // ================================================\n\n    // List of dates to highlight\n    // Valid values:\n    // - []: don't highlight anything\n    // - \"now\": highlight the current date\n    // - an array of Date objects: highlight the specified dates\n    highlight: [],\n\n    // ================================================\n    // TEXT FORMATTING / i18n\n    // ================================================\n\n    // Name of the items to represent in the calendar\n    itemName: ['item', 'items'],\n\n    // Formatting of the domain label\n    // @default: null, will use the formatting according to domain type\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    domainLabelFormat: null,\n\n    // Formatting of the title displayed when hovering a subDomain cell\n    subDomainTitleFormat: {\n      empty: '{date}',\n      filled: '{count} {name} {connector} {date}' },\n\n\n    // Formatting of the {date} used in subDomainTitleFormat\n    // @default: null, will use the formatting according to subDomain type\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    subDomainDateFormat: null,\n\n    // Formatting of the text inside each subDomain cell\n    // @default: null, no text\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    subDomainTextFormat: null,\n\n    // Formatting of the title displayed when hovering a legend cell\n    legendTitleFormat: {\n      lower: t('less than {min} {name}'),\n      inner: t('between {down} and {up} {name}'),\n      upper: t('more than {max} {name}') },\n\n\n    // Animation duration, in ms\n    animationDuration: 500,\n\n    nextSelector: false,\n\n    previousSelector: false,\n\n    itemNamespace: 'cal-heatmap',\n\n    tooltip: false,\n\n    // ================================================\n    // EVENTS CALLBACK\n    // ================================================\n\n    // Callback when clicking on a time block\n    onClick: null,\n\n    // Callback after painting the empty calendar\n    // Can be used to trigger an API call, once the calendar is ready to be filled\n    afterLoad: null,\n\n    // Callback after loading the next domain in the calendar\n    afterLoadNextDomain: null,\n\n    // Callback after loading the previous domain in the calendar\n    afterLoadPreviousDomain: null,\n\n    // Callback after finishing all actions on the calendar\n    onComplete: null,\n\n    // Callback after fetching the datas, but before applying them to the calendar\n    // Used mainly to convert the datas if they're not formatted like expected\n    // Takes the fetched \"data\" object as argument, must return a json object\n    // formatted like {timestamp:count, timestamp2:count2},\n    afterLoadData: function (timestamps) {\n      // See https://github.com/wa0x6e/cal-heatmap/issues/126#issuecomment-373301803\n      const stdTimezoneOffset = (date) => {\n        const jan = new Date(date.getFullYear(), 0, 1);\n        const jul = new Date(date.getFullYear(), 6, 1);\n        return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());\n      };\n      const offset = stdTimezoneOffset(new Date()) * 60;\n      let results = {};\n      for (let timestamp in timestamps) {\n        const value = timestamps[timestamp];\n        timestamp = parseInt(timestamp, 10);\n        results[timestamp + offset] = value;\n      }\n      return results;\n    },\n\n    // Callback triggered after calling and completing update().\n    afterUpdate: null,\n\n    // Callback triggered after calling next().\n    // The `status` argument is equal to true if there is no\n    // more next domain to load\n    //\n    // This callback is also executed once, after calling previous(),\n    // only when the max domain is reached\n    onMaxDomainReached: null,\n\n    // Callback triggered after calling previous().\n    // The `status` argument is equal to true if there is no\n    // more previous domain to load\n    //\n    // This callback is also executed once, after calling next(),\n    // only when the min domain is reached\n    onMinDomainReached: null };\n\n\n  this._domainType = {\n    min: {\n      name: 'minute',\n      level: 10,\n      maxItemNumber: 60,\n      defaultRowNumber: 10,\n      defaultColumnNumber: 6,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          return Math.floor(d.getMinutes() / self._domainType.min.row(d));\n        },\n        y: function (d) {\n          return d.getMinutes() % self._domainType.min.row(d);\n        } },\n\n      format: {\n        date: '%H:%M, %A %B %-e, %Y',\n        legend: '',\n        connector: 'at' },\n\n      extractUnit: function (d) {\n        return new Date(\n        d.getFullYear(),\n        d.getMonth(),\n        d.getDate(),\n        d.getHours(),\n        d.getMinutes()).\n        getTime();\n      } },\n\n    hour: {\n      name: 'hour',\n      level: 20,\n      maxItemNumber: function (d) {\n        switch (self.options.domain) {\n          case 'day':\n            return 24;\n          case 'week':\n            return 24 * 7;\n          case 'month':\n            return (\n              24 * (\n              self.options.domainDynamicDimension ?\n              self.getDayCountInMonth(d) :\n              31));}\n\n\n      },\n      defaultRowNumber: 6,\n      defaultColumnNumber: function (d) {\n        switch (self.options.domain) {\n          case 'day':\n            return 4;\n          case 'week':\n            return 28;\n          case 'month':\n            return self.options.domainDynamicDimension ?\n            self.getDayCountInMonth(d) :\n            31;}\n\n      },\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          if (self.options.domain === 'month') {\n            if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n              return Math.floor(\n              (d.getHours() + (d.getDate() - 1) * 24) /\n              self._domainType.hour.row(d));\n\n            }\n            return (\n              Math.floor(d.getHours() / self._domainType.hour.row(d)) +\n              (d.getDate() - 1) * 4);\n\n          } else if (self.options.domain === 'week') {\n            if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n              return Math.floor(\n              (d.getHours() + self.getWeekDay(d) * 24) /\n              self._domainType.hour.row(d));\n\n            }\n            return (\n              Math.floor(d.getHours() / self._domainType.hour.row(d)) +\n              self.getWeekDay(d) * 4);\n\n          }\n          return Math.floor(d.getHours() / self._domainType.hour.row(d));\n        },\n        y: function (d) {\n          var p = d.getHours();\n          if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n            switch (self.options.domain) {\n              case 'month':\n                p += (d.getDate() - 1) * 24;\n                break;\n              case 'week':\n                p += self.getWeekDay(d) * 24;\n                break;}\n\n          }\n          return Math.floor(p % self._domainType.hour.row(d));\n        } },\n\n      format: {\n        date: '%Hh, %A %B %-e, %Y',\n        legend: '%H:00',\n        connector: 'at' },\n\n      extractUnit: function (d) {\n        return new Date(\n        d.getFullYear(),\n        d.getMonth(),\n        d.getDate(),\n        d.getHours()).\n        getTime();\n      } },\n\n    day: {\n      name: 'day',\n      level: 30,\n      maxItemNumber: function (d) {\n        switch (self.options.domain) {\n          case 'week':\n            return 7;\n          case 'month':\n            return self.options.domainDynamicDimension ?\n            self.getDayCountInMonth(d) :\n            31;\n          case 'year':\n            return self.options.domainDynamicDimension ?\n            self.getDayCountInYear(d) :\n            366;}\n\n      },\n      defaultColumnNumber: function (d) {\n        d = new Date(d);\n        switch (self.options.domain) {\n          case 'week':\n            return 1;\n          case 'month':\n            return self.options.domainDynamicDimension &&\n            !self.options.verticalOrientation ?\n            self.getWeekNumber(\n            new Date(d.getFullYear(), d.getMonth() + 1, 0)) -\n\n            self.getWeekNumber(d) +\n            1 :\n            6;\n          case 'year':\n            return self.options.domainDynamicDimension ?\n            self.getWeekNumber(new Date(d.getFullYear(), 11, 31)) -\n            self.getWeekNumber(new Date(d.getFullYear(), 0)) +\n            1 :\n            54;}\n\n      },\n      defaultRowNumber: 7,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          switch (self.options.domain) {\n            case 'week':\n              return Math.floor(\n              self.getWeekDay(d) / self._domainType.day.row(d));\n\n            case 'month':\n              if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n                return Math.floor(\n                (d.getDate() - 1) / self._domainType.day.row(d));\n\n              }\n              return (\n                self.getWeekNumber(d) -\n                self.getWeekNumber(new Date(d.getFullYear(), d.getMonth())));\n\n            case 'year':\n              if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n                return Math.floor(\n                (self.getDayOfYear(d) - 1) / self._domainType.day.row(d));\n\n              }\n              return self.getWeekNumber(d);}\n\n        },\n        y: function (d) {\n          var p = self.getWeekDay(d);\n          if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n            switch (self.options.domain) {\n              case 'year':\n                p = self.getDayOfYear(d) - 1;\n                break;\n              case 'week':\n                p = self.getWeekDay(d);\n                break;\n              case 'month':\n                p = d.getDate() - 1;\n                break;}\n\n          }\n          return Math.floor(p % self._domainType.day.row(d));\n        } },\n\n      format: {\n        date: '%A %B %-e, %Y',\n        legend: '%e %b',\n        connector: 'on' },\n\n      extractUnit: function (d) {\n        return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();\n      } },\n\n    week: {\n      name: 'week',\n      level: 40,\n      maxItemNumber: 54,\n      defaultColumnNumber: function (d) {\n        d = new Date(d);\n        switch (self.options.domain) {\n          case 'year':\n            return self._domainType.week.maxItemNumber;\n          case 'month':\n            return self.options.domainDynamicDimension ?\n            self.getWeekNumber(\n            new Date(d.getFullYear(), d.getMonth() + 1, 0)) -\n            self.getWeekNumber(d) :\n            5;}\n\n      },\n      defaultRowNumber: 1,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          switch (self.options.domain) {\n            case 'year':\n              return Math.floor(\n              self.getWeekNumber(d) / self._domainType.week.row(d));\n\n            case 'month':\n              return Math.floor(\n              self.getMonthWeekNumber(d) / self._domainType.week.row(d));}\n\n\n        },\n        y: function (d) {\n          return self.getWeekNumber(d) % self._domainType.week.row(d);\n        } },\n\n      format: {\n        date: '%B Week #%W',\n        legend: '%B Week #%W',\n        connector: 'in' },\n\n      extractUnit: function (d) {\n        var dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n        // According to ISO-8601, week number computation are based on week starting on Monday\n        var weekDay = dt.getDay() - (self.options.weekStartOnMonday ? 1 : 0);\n        if (weekDay < 0) {\n          weekDay = 6;\n        }\n        dt.setDate(dt.getDate() - weekDay);\n        return dt.getTime();\n      } },\n\n    month: {\n      name: 'month',\n      level: 50,\n      maxItemNumber: 12,\n      defaultColumnNumber: 12,\n      defaultRowNumber: 1,\n      row: function () {\n        return self.getSubDomainRowNumber();\n      },\n      column: function () {\n        return self.getSubDomainColumnNumber();\n      },\n      position: {\n        x: function (d) {\n          return Math.floor(d.getMonth() / self._domainType.month.row(d));\n        },\n        y: function (d) {\n          return d.getMonth() % self._domainType.month.row(d);\n        } },\n\n      format: {\n        date: '%B %Y',\n        legend: '%B',\n        connector: 'in' },\n\n      extractUnit: function (d) {\n        return new Date(d.getFullYear(), d.getMonth()).getTime();\n      } },\n\n    year: {\n      name: 'year',\n      level: 60,\n      row: function () {\n        return self.options.rowLimit || 1;\n      },\n      column: function () {\n        return self.options.colLimit || 1;\n      },\n      position: {\n        x: function () {\n          return 1;\n        },\n        y: function () {\n          return 1;\n        } },\n\n      format: {\n        date: '%Y',\n        legend: '%Y',\n        connector: 'in' },\n\n      extractUnit: function (d) {\n        return new Date(d.getFullYear()).getTime();\n      } } };\n\n\n\n  for (var type in this._domainType) {\n    if (this._domainType.hasOwnProperty(type)) {\n      var d = this._domainType[type];\n      this._domainType['x_' + type] = {\n        name: 'x_' + type,\n        level: d.type,\n        maxItemNumber: d.maxItemNumber,\n        defaultRowNumber: d.defaultRowNumber,\n        defaultColumnNumber: d.defaultColumnNumber,\n        row: d.column,\n        column: d.row,\n        position: {\n          x: d.position.y,\n          y: d.position.x },\n\n        format: d.format,\n        extractUnit: d.extractUnit };\n\n    }\n  }\n\n  // Record the address of the last inserted domain when browsing\n  this.lastInsertedSvg = null;\n\n  this._completed = false;\n\n  // Record all the valid domains\n  // Each domain value is a timestamp in milliseconds\n  this._domains = d3.map();\n\n  this.graphDim = {\n    width: 0,\n    height: 0 };\n\n\n  this.legendDim = {\n    width: 0,\n    height: 0 };\n\n\n  this.NAVIGATE_LEFT = 1;\n  this.NAVIGATE_RIGHT = 2;\n\n  // Various update mode when using the update() API\n  this.RESET_ALL_ON_UPDATE = 0;\n  this.RESET_SINGLE_ON_UPDATE = 1;\n  this.APPEND_ON_UPDATE = 2;\n\n  this.DEFAULT_LEGEND_MARGIN = 10;\n\n  this.root = null;\n  this.tooltip = null;\n\n  this._maxDomainReached = false;\n  this._minDomainReached = false;\n\n  this.domainPosition = new DomainPosition();\n  this.Legend = null;\n  this.legendScale = null;\n\n  // List of domains that are skipped because of DST\n  // All times belonging to these domains should be re-assigned to the previous domain\n  this.DSTDomain = [];\n\n  /**\n   * Display the graph for the first time\n   * @return bool True if the calendar is created\n   */\n  this._init = function () {\n    self.\n    getDomain(self.options.start).\n    map(function (d) {\n      return d.getTime();\n    }).\n    map(function (d) {\n      self._domains.set(\n      d,\n      self.getSubDomain(d).map(function (d) {\n        return {\n          t: self._domainType[self.options.subDomain].extractUnit(d),\n          v: null };\n\n      }));\n\n    });\n\n    self.root = d3.\n    select(self.options.itemSelector).\n    append('svg').\n    attr('class', 'cal-heatmap-container');\n\n    self.root.attr('x', 0).attr('y', 0).append('svg').attr('class', 'graph');\n\n    self.Legend = new Legend(self);\n\n    if (self.options.paintOnLoad) {\n      _initCalendar();\n    }\n    self.root.call(self.tip);\n    self.root.call(self.legendTip);\n\n    return true;\n  };\n\n  function _initCalendar() {\n    self.verticalDomainLabel =\n    self.options.label.position === 'top' ||\n    self.options.label.position === 'bottom';\n\n    self.domainVerticalLabelHeight =\n    self.options.label.height === null ?\n    Math.max(25, self.options.cellSize * 2) :\n    self.options.label.height;\n    self.domainHorizontalLabelWidth = 0;\n\n    if (\n    self.options.domainLabelFormat === '' &&\n    self.options.label.height === null)\n    {\n      self.domainVerticalLabelHeight = 0;\n    }\n\n    if (!self.verticalDomainLabel) {\n      self.domainVerticalLabelHeight = 0;\n      self.domainHorizontalLabelWidth = self.options.label.width;\n    }\n\n    self.paint();\n\n    // =========================================================================//\n    // ATTACHING DOMAIN NAVIGATION EVENT                    //\n    // =========================================================================//\n    if (self.options.nextSelector !== false) {\n      d3.select(self.options.nextSelector).on(\n      'click.' + self.options.itemNamespace,\n      function () {\n        d3.event.preventDefault();\n        return self.loadNextDomain(1);\n      });\n\n    }\n\n    if (self.options.previousSelector !== false) {\n      d3.select(self.options.previousSelector).on(\n      'click.' + self.options.itemNamespace,\n      function () {\n        d3.event.preventDefault();\n        return self.loadPreviousDomain(1);\n      });\n\n    }\n\n    self.Legend.redraw(\n    self.graphDim.width -\n    self.options.domainGutter -\n    self.options.cellPadding);\n\n    self.afterLoad();\n\n    var domains = self.getDomainKeys();\n\n    // Fill the graph with some datas\n    if (self.options.loadOnInit) {\n      self.getDatas(\n      self.options.data,\n      new Date(domains[0]),\n      self.getSubDomain(domains[domains.length - 1]).pop(),\n      function () {\n        self.fill();\n        self.onComplete();\n      });\n\n    } else {\n      self.onComplete();\n    }\n\n    self.checkIfMinDomainIsReached(domains[0]);\n    self.checkIfMaxDomainIsReached(self.getNextDomain().getTime());\n  }\n\n  // Return the width of the domain block, without the domain gutter\n  // @param int d Domain start timestamp\n  function w(d, outer) {\n    var width =\n    self.options.cellSize *\n    self._domainType[self.options.subDomain].column(d) +\n    self.options.cellPadding *\n    self._domainType[self.options.subDomain].column(d);\n    if (arguments.length === 2 && outer === true) {\n      return width +=\n      self.domainHorizontalLabelWidth +\n      self.options.domainGutter +\n      self.options.domainMargin[1] +\n      self.options.domainMargin[3];\n    }\n    return width;\n  }\n\n  // Return the height of the domain block, without the domain gutter\n  function h(d, outer) {\n    var height =\n    self.options.cellSize * self._domainType[self.options.subDomain].row(d) +\n    self.options.cellPadding *\n    self._domainType[self.options.subDomain].row(d);\n    if (arguments.length === 2 && outer === true) {\n      height +=\n      self.options.domainGutter +\n      self.domainVerticalLabelHeight +\n      self.options.domainMargin[0] +\n      self.options.domainMargin[2];\n    }\n    return height;\n  }\n\n  /**\n   *\n   *\n   * @param int navigationDir\n   */\n  this.paint = function (navigationDir) {\n    var options = self.options;\n\n    if (arguments.length === 0) {\n      navigationDir = false;\n    }\n\n    // Painting all the domains\n    var domainSvg = self.root.\n    select('.graph').\n    selectAll('.graph-domain').\n    data(\n    function () {\n      var data = self.getDomainKeys();\n      return navigationDir === self.NAVIGATE_LEFT ? data.reverse() : data;\n    },\n    function (d) {\n      return d;\n    });\n\n    var enteringDomainDim = 0;\n    var exitingDomainDim = 0;\n\n    // =========================================================================//\n    // PAINTING DOMAIN                              //\n    // =========================================================================//\n\n    var svg = domainSvg.\n    enter().\n    append('svg').\n    attr('width', function (d) {\n      return w(d, true);\n    }).\n    attr('height', function (d) {\n      return h(d, true);\n    }).\n    attr('x', function (d) {\n      if (options.verticalOrientation) {\n        self.graphDim.width = Math.max(self.graphDim.width, w(d, true));\n        return 0;\n      } else {\n        return getDomainPosition(d, self.graphDim, 'width', w(d, true));\n      }\n    }).\n    attr('y', function (d) {\n      if (options.verticalOrientation) {\n        return getDomainPosition(d, self.graphDim, 'height', h(d, true));\n      } else {\n        self.graphDim.height = Math.max(self.graphDim.height, h(d, true));\n        return 0;\n      }\n    }).\n    attr('class', function (d) {\n      var classname = 'graph-domain';\n      var date = new Date(d);\n      switch (options.domain) {\n        case 'hour':\n          classname += ' h_' + date.getHours();\n        /* falls through */\n        case 'day':\n          classname += ' d_' + date.getDate() + ' dy_' + date.getDay();\n        /* falls through */\n        case 'week':\n          classname += ' w_' + self.getWeekNumber(date);\n        /* falls through */\n        case 'month':\n          classname += ' m_' + (date.getMonth() + 1);\n        /* falls through */\n        case 'year':\n          classname += ' y_' + date.getFullYear();}\n\n      return classname;\n    });\n    self.lastInsertedSvg = svg;\n\n    function getDomainPosition(domainIndex, graphDim, axis, domainDim) {\n      var tmp = 0;\n      switch (navigationDir) {\n        case false:\n          tmp = graphDim[axis];\n\n          graphDim[axis] += domainDim;\n          self.domainPosition.setPosition(domainIndex, tmp);\n          return tmp;\n\n        case self.NAVIGATE_RIGHT:\n          self.domainPosition.setPosition(domainIndex, graphDim[axis]);\n\n          enteringDomainDim = domainDim;\n          exitingDomainDim = self.domainPosition.getPositionFromIndex(1);\n\n          self.domainPosition.shiftRightBy(exitingDomainDim);\n          return graphDim[axis];\n\n        case self.NAVIGATE_LEFT:\n          tmp = -domainDim;\n\n          enteringDomainDim = -tmp;\n          exitingDomainDim = graphDim[axis] - self.domainPosition.getLast();\n\n          self.domainPosition.setPosition(domainIndex, tmp);\n          self.domainPosition.shiftLeftBy(enteringDomainDim);\n          return tmp;}\n\n    }\n\n    svg.\n    append('rect').\n    attr('width', function (d) {\n      return w(d, true) - options.domainGutter - options.cellPadding;\n    }).\n    attr('height', function (d) {\n      return h(d, true) - options.domainGutter - options.cellPadding;\n    }).\n    attr('class', 'domain-background');\n\n    // =========================================================================//\n    // PAINTING SUBDOMAINS                            //\n    // =========================================================================//\n    var subDomainSvgGroup = svg.\n    append('svg').\n    attr('x', function () {\n      if (options.label.position === 'left') {\n        return self.domainHorizontalLabelWidth + options.domainMargin[3];\n      } else {\n        return options.domainMargin[3];\n      }\n    }).\n    attr('y', function () {\n      if (options.label.position === 'top') {\n        return self.domainVerticalLabelHeight + options.domainMargin[0];\n      } else {\n        return options.domainMargin[0];\n      }\n    }).\n    attr('class', 'graph-subdomain-group');\n    var rect = subDomainSvgGroup.\n    selectAll('g').\n    data(function (d) {\n      return self._domains.get(d);\n    }).\n    enter().\n    append('g');\n    rect.\n    append('rect').\n    attr('class', function (d) {\n      return (\n        'graph-rect' +\n        self.getHighlightClassName(d.t) + (\n        options.onClick !== null ? ' hover_cursor' : ''));\n\n    }).\n    attr('width', options.cellSize).\n    attr('height', options.cellSize).\n    attr('x', function (d) {\n      return self.positionSubDomainX(d.t);\n    }).\n    attr('y', function (d) {\n      return self.positionSubDomainY(d.t);\n    }).\n    on('click', function (d) {\n      if (options.onClick !== null) {\n        return self.onClick(new Date(d.t), d.v);\n      }\n    }).\n    call(function (selection) {\n      if (options.cellRadius > 0) {\n        selection.\n        attr('rx', options.cellRadius).\n        attr('ry', options.cellRadius);\n      }\n\n      if (\n      self.legendScale !== null &&\n      options.legendColors !== null &&\n      options.legendColors.hasOwnProperty('base'))\n      {\n        selection.attr('fill', options.legendColors.base);\n      }\n\n      if (options.tooltip) {\n        selection.\n        on('mouseover', function (d) {\n          self.tip.show(d, this);\n        }).\n        on('mouseout', function () {\n          self.tip.hide(d);\n        });\n      }\n    });\n\n    // Appending a title to each subdomain\n    if (!options.tooltip) {\n      rect.append('title').text(function (d) {\n        return self.formatDate(new Date(d.t), options.subDomainDateFormat);\n      });\n    }\n\n    // =========================================================================//\n    // PAINTING LABEL                              //\n    // =========================================================================//\n    if (options.domainLabelFormat !== '') {\n      svg.\n      append('text').\n      attr('class', 'graph-label').\n      attr('y', function (d) {\n        var y = options.domainMargin[0];\n        switch (options.label.position) {\n          case 'top':\n            y += self.domainVerticalLabelHeight / 2;\n            break;\n          case 'bottom':\n            y += h(d) + self.domainVerticalLabelHeight / 2;}\n\n\n        return (\n          y +\n          options.label.offset.y * (\n          options.label.rotate === 'right' &&\n          options.label.position === 'right' ||\n          options.label.rotate === 'left' &&\n          options.label.position === 'left' ?\n          -1 :\n          1));\n\n      }).\n      attr('x', function (d) {\n        var x = options.domainMargin[3];\n        switch (options.label.position) {\n          case 'right':\n            x += w(d);\n            break;\n          case 'bottom':\n          case 'top':\n            x += w(d) / 2;}\n\n\n        if (options.label.align === 'right') {\n          return (\n            x +\n            self.domainHorizontalLabelWidth -\n            options.label.offset.x * (\n            options.label.rotate === 'right' ? -1 : 1));\n\n        }\n        return x + options.label.offset.x;\n      }).\n      attr('text-anchor', function () {\n        switch (options.label.align) {\n          case 'start':\n          case 'left':\n            return 'start';\n          case 'end':\n          case 'right':\n            return 'end';\n          default:\n            return 'middle';}\n\n      }).\n      attr('dominant-baseline', function () {\n        return self.verticalDomainLabel ? 'middle' : 'top';\n      }).\n      text(function (d) {\n        return self.formatDate(new Date(d), options.domainLabelFormat);\n      }).\n      call(domainRotate);\n    }\n\n    function domainRotate(selection) {\n      switch (options.label.rotate) {\n        case 'right':\n          selection.attr('transform', function (d) {\n            var s = 'rotate(90), ';\n            switch (options.label.position) {\n              case 'right':\n                s += 'translate(-' + w(d) + ' , -' + w(d) + ')';\n                break;\n              case 'left':\n                s += 'translate(0, -' + self.domainHorizontalLabelWidth + ')';\n                break;}\n\n\n            return s;\n          });\n          break;\n        case 'left':\n          selection.attr('transform', function (d) {\n            var s = 'rotate(270), ';\n            switch (options.label.position) {\n              case 'right':\n                s +=\n                'translate(-' + (\n                w(d) + self.domainHorizontalLabelWidth) +\n                ' , ' +\n                w(d) +\n                ')';\n                break;\n              case 'left':\n                s +=\n                'translate(-' +\n                self.domainHorizontalLabelWidth +\n                ' , ' +\n                self.domainHorizontalLabelWidth +\n                ')';\n                break;}\n\n\n            return s;\n          });\n          break;}\n\n    }\n\n    // =========================================================================//\n    // PAINTING DOMAIN SUBDOMAIN CONTENT                    //\n    // =========================================================================//\n    if (options.subDomainTextFormat !== null) {\n      rect.\n      append('text').\n      attr('class', function (d) {\n        return 'subdomain-text' + self.getHighlightClassName(d.t);\n      }).\n      attr('x', function (d) {\n        return self.positionSubDomainX(d.t) + options.cellSize / 2;\n      }).\n      attr('y', function (d) {\n        return self.positionSubDomainY(d.t) + options.cellSize / 2;\n      }).\n      attr('text-anchor', 'middle').\n      attr('dominant-baseline', 'central').\n      text(function (d) {\n        return self.formatDate(new Date(d.t), options.subDomainTextFormat);\n      });\n    }\n\n    // =========================================================================//\n    // ANIMATION                                //\n    // =========================================================================//\n\n    if (navigationDir !== false) {\n      domainSvg.\n      transition().\n      duration(options.animationDuration).\n      attr('x', function (d) {\n        return options.verticalOrientation ?\n        0 :\n        self.domainPosition.getPosition(d);\n      }).\n      attr('y', function (d) {\n        return options.verticalOrientation ?\n        self.domainPosition.getPosition(d) :\n        0;\n      });\n    }\n\n    var tempWidth = self.graphDim.width;\n    var tempHeight = self.graphDim.height;\n\n    if (options.verticalOrientation) {\n      self.graphDim.height += enteringDomainDim - exitingDomainDim;\n    } else {\n      self.graphDim.width += enteringDomainDim - exitingDomainDim;\n    }\n\n    // At the time of exit, domainsWidth and domainsHeight already automatically shifted\n    domainSvg.\n    exit().\n    transition().\n    duration(options.animationDuration).\n    attr('x', function (d) {\n      if (options.verticalOrientation) {\n        return 0;\n      } else {\n        switch (navigationDir) {\n          case self.NAVIGATE_LEFT:\n            return Math.min(self.graphDim.width, tempWidth);\n          case self.NAVIGATE_RIGHT:\n            return -w(d, true);}\n\n      }\n    }).\n    attr('y', function (d) {\n      if (options.verticalOrientation) {\n        switch (navigationDir) {\n          case self.NAVIGATE_LEFT:\n            return Math.min(self.graphDim.height, tempHeight);\n          case self.NAVIGATE_RIGHT:\n            return -h(d, true);}\n\n      } else {\n        return 0;\n      }\n    }).\n    remove();\n\n    // Resize the root container\n    self.resize();\n  };\n};\n\nCalHeatMap.prototype = {\n  /**\n   * Validate and merge user settings with default settings\n   *\n   * @param  {object} settings User settings\n   * @return {bool} False if settings contains error\n   */\n  /* jshint maxstatements:false */\n  init: function (settings) {\n    'use strict';\n\n    var parent = this;\n\n    var options = parent.options = mergeRecursive(parent.options, settings);\n\n    // Fatal errors\n    // Stop script execution on error\n    validateDomainType();\n    validateSelector(options.itemSelector, false, 'itemSelector');\n\n    if (parent.allowedDataType.indexOf(options.dataType) === -1) {\n      throw new Error(\n      \"The data type '\" + options.dataType + \"' is not valid data type\");\n\n    }\n\n    if (d3.select(options.itemSelector)[0][0] === null) {\n      throw new Error(\n      \"The node '\" +\n      options.itemSelector +\n      \"' specified in itemSelector does not exists\");\n\n    }\n\n    try {\n      validateSelector(options.nextSelector, true, 'nextSelector');\n      validateSelector(options.previousSelector, true, 'previousSelector');\n    } catch (error) {\n      console.log(error.message);\n      return false;\n    }\n\n    // If other settings contains error, will fallback to default\n\n    if (!settings.hasOwnProperty('subDomain')) {\n      this.options.subDomain = getOptimalSubDomain(settings.domain);\n    }\n\n    if (\n    typeof options.itemNamespace !== 'string' ||\n    options.itemNamespace === '')\n    {\n      console.log(\n      'itemNamespace can not be empty, falling back to cal-heatmap');\n\n      options.itemNamespace = 'cal-heatmap';\n    }\n\n    // Don't touch these settings\n    var s = [\n    'data',\n    'onComplete',\n    'onClick',\n    'afterLoad',\n    'afterLoadData',\n    'afterLoadPreviousDomain',\n    'afterLoadNextDomain',\n    'afterUpdate'];\n\n\n    for (var k in s) {\n      if (settings.hasOwnProperty(s[k])) {\n        options[s[k]] = settings[s[k]];\n      }\n    }\n\n    options.subDomainDateFormat =\n    typeof options.subDomainDateFormat === 'string' ||\n    typeof options.subDomainDateFormat === 'function' ?\n    options.subDomainDateFormat :\n    this._domainType[options.subDomain].format.date;\n    options.domainLabelFormat =\n    typeof options.domainLabelFormat === 'string' ||\n    typeof options.domainLabelFormat === 'function' ?\n    options.domainLabelFormat :\n    this._domainType[options.domain].format.legend;\n    options.subDomainTextFormat =\n    typeof options.subDomainTextFormat === 'string' &&\n    options.subDomainTextFormat !== '' ||\n    typeof options.subDomainTextFormat === 'function' ?\n    options.subDomainTextFormat :\n    null;\n    options.domainMargin = expandMarginSetting(options.domainMargin);\n    options.legendMargin = expandMarginSetting(options.legendMargin);\n    options.highlight = parent.expandDateSetting(options.highlight);\n    options.itemName = expandItemName(options.itemName);\n    options.colLimit = parseColLimit(options.colLimit);\n    options.rowLimit = parseRowLimit(options.rowLimit);\n    if (!settings.hasOwnProperty('legendMargin')) {\n      autoAddLegendMargin();\n    }\n    autoAlignLabel();\n\n    /**\n     * Validate that a queryString is valid\n     *\n     * @param  {Element|string|bool} selector   The queryString to test\n     * @param  {bool}  canBeFalse  Whether false is an accepted and valid value\n     * @param  {string} name    Name of the tested selector\n     * @throws {Error}        If the selector is not valid\n     * @return {bool}        True if the selector is a valid queryString\n     */\n    function validateSelector(selector, canBeFalse, name) {\n      if (\n      (canBeFalse && selector === false ||\n      selector instanceof Element ||\n      typeof selector === 'string') &&\n      selector !== '')\n      {\n        return true;\n      }\n      throw new Error('The ' + name + ' is not valid');\n    }\n\n    /**\n     * Return the optimal subDomain for the specified domain\n     *\n     * @param  {string} domain a domain name\n     * @return {string}        the subDomain name\n     */\n    function getOptimalSubDomain(domain) {\n      switch (domain) {\n        case 'year':\n          return 'month';\n        case 'month':\n          return 'day';\n        case 'week':\n          return 'day';\n        case 'day':\n          return 'hour';\n        default:\n          return 'min';}\n\n    }\n\n    /**\n     * Ensure that the domain and subdomain are valid\n     *\n     * @throw {Error} when domain or subdomain are not valid\n     * @return {bool} True if domain and subdomain are valid and compatible\n     */\n    function validateDomainType() {\n      if (\n      !parent._domainType.hasOwnProperty(options.domain) ||\n      options.domain === 'min' ||\n      options.domain.substring(0, 2) === 'x_')\n      {\n        throw new Error(\"The domain '\" + options.domain + \"' is not valid\");\n      }\n\n      if (\n      !parent._domainType.hasOwnProperty(options.subDomain) ||\n      options.subDomain === 'year')\n      {\n        throw new Error(\n        \"The subDomain '\" + options.subDomain + \"' is not valid\");\n\n      }\n\n      if (\n      parent._domainType[options.domain].level <=\n      parent._domainType[options.subDomain].level)\n      {\n        throw new Error(\n        \"'\" +\n        options.subDomain +\n        \"' is not a valid subDomain to '\" +\n        options.domain +\n        \"'\");\n\n      }\n\n      return true;\n    }\n\n    /**\n     * Fine-tune the label alignement depending on its position\n     *\n     * @return void\n     */\n    function autoAlignLabel() {\n      // Auto-align label, depending on it's position\n      if (\n      !settings.hasOwnProperty('label') ||\n      settings.hasOwnProperty('label') &&\n      !settings.label.hasOwnProperty('align'))\n      {\n        switch (options.label.position) {\n          case 'left':\n            options.label.align = 'right';\n            break;\n          case 'right':\n            options.label.align = 'left';\n            break;\n          default:\n            options.label.align = 'center';}\n\n\n        if (options.label.rotate === 'left') {\n          options.label.align = 'right';\n        } else if (options.label.rotate === 'right') {\n          options.label.align = 'left';\n        }\n      }\n\n      if (\n      !settings.hasOwnProperty('label') ||\n      settings.hasOwnProperty('label') &&\n      !settings.label.hasOwnProperty('offset'))\n      {\n        if (\n        options.label.position === 'left' ||\n        options.label.position === 'right')\n        {\n          options.label.offset = {\n            x: 10,\n            y: 15 };\n\n        }\n      }\n    }\n\n    /**\n     * If not specified, add some margin around the legend depending on its position\n     *\n     * @return void\n     */\n    function autoAddLegendMargin() {\n      switch (options.legendVerticalPosition) {\n        case 'top':\n          options.legendMargin[2] = parent.DEFAULT_LEGEND_MARGIN;\n          break;\n        case 'bottom':\n          options.legendMargin[0] = parent.DEFAULT_LEGEND_MARGIN;\n          break;\n        case 'middle':\n        case 'center':\n          options.legendMargin[\n          options.legendHorizontalPosition === 'right' ? 3 : 1] =\n          parent.DEFAULT_LEGEND_MARGIN;}\n\n    }\n\n    /**\n     * Expand a number of an array of numbers to an usable 4 values array\n     *\n     * @param  {integer|array} value\n     * @return {array}        array\n     */\n    function expandMarginSetting(value) {\n      if (typeof value === 'number') {\n        value = [value];\n      }\n\n      if (!Array.isArray(value)) {\n        console.log('Margin only takes an integer or an array of integers');\n        value = [0];\n      }\n\n      switch (value.length) {\n        case 1:\n          return [value[0], value[0], value[0], value[0]];\n        case 2:\n          return [value[0], value[1], value[0], value[1]];\n        case 3:\n          return [value[0], value[1], value[2], value[1]];\n        case 4:\n          return value;\n        default:\n          return value.slice(0, 4);}\n\n    }\n\n    /**\n     * Convert a string to an array like [singular-form, plural-form]\n     *\n     * @param  {string|array} value Date to convert\n     * @return {array}       An array like [singular-form, plural-form]\n     */\n    function expandItemName(value) {\n      if (typeof value === 'string') {\n        return [value, value + (value !== '' ? 's' : '')];\n      }\n\n      if (Array.isArray(value)) {\n        if (value.length === 1) {\n          return [value[0], value[0] + 's'];\n        } else if (value.length > 2) {\n          return value.slice(0, 2);\n        }\n\n        return value;\n      }\n\n      return ['item', 'items'];\n    }\n\n    function parseColLimit(value) {\n      return value > 0 ? value : null;\n    }\n\n    function parseRowLimit(value) {\n      if (value > 0 && options.colLimit > 0) {\n        console.log(\n        'colLimit and rowLimit are mutually exclusive, rowLimit will be ignored');\n\n        return null;\n      }\n      return value > 0 ? value : null;\n    }\n\n    return this._init();\n  },\n\n  /**\n   * Convert a keyword or an array of keyword/date to an array of date objects\n   *\n   * @param  {string|array|Date} value Data to convert\n   * @return {array}       An array of Dates\n   */\n  expandDateSetting: function (value) {\n    'use strict';\n\n    if (!Array.isArray(value)) {\n      value = [value];\n    }\n\n    return value.\n    map(function (data) {\n      if (data === 'now') {\n        return new Date();\n      }\n      if (data instanceof Date) {\n        return data;\n      }\n      return false;\n    }).\n    filter(function (d) {\n      return d !== false;\n    });\n  },\n\n  /**\n   * Fill the calendar by coloring the cells\n   *\n   * @param array svg An array of html node to apply the transformation to (optional)\n   *                  It's used to limit the painting to only a subset of the calendar\n   * @return void\n   */\n  fill: function (svg) {\n    'use strict';\n\n    var parent = this;\n    var options = parent.options;\n\n    if (arguments.length === 0) {\n      svg = parent.root.selectAll('.graph-domain');\n    }\n\n    var rect = svg.\n    selectAll('svg').\n    selectAll('g').\n    data(function (d) {\n      return parent._domains.get(d);\n    });\n    /**\n     * Colorize the cell via a style attribute if enabled\n     */\n    function addStyle(element) {\n      if (parent.legendScale === null) {\n        return false;\n      }\n\n      element.attr('fill', function (d) {\n        if (\n        d.v === null &&\n        options.hasOwnProperty('considerMissingDataAsZero') &&\n        !options.considerMissingDataAsZero)\n        {\n          if (options.legendColors.hasOwnProperty('base')) {\n            return options.legendColors.base;\n          }\n        }\n\n        if (\n        options.legendColors !== null &&\n        options.legendColors.hasOwnProperty('empty') && (\n        d.v === 0 ||\n        d.v === null &&\n        options.hasOwnProperty('considerMissingDataAsZero') &&\n        options.considerMissingDataAsZero))\n        {\n          return options.legendColors.empty;\n        }\n\n        if (\n        d.v < 0 &&\n        options.legend[0] > 0 &&\n        options.legendColors !== null &&\n        options.legendColors.hasOwnProperty('overflow'))\n        {\n          return options.legendColors.overflow;\n        }\n\n        return parent.legendScale(\n        Math.min(d.v, options.legend[options.legend.length - 1]));\n\n      });\n    }\n\n    rect.\n    transition().\n    duration(options.animationDuration).\n    select('rect').\n    attr('class', function (d) {\n      var htmlClass = parent.getHighlightClassName(d.t).trim().split(' ');\n      var pastDate = parent.dateIsLessThan(d.t, new Date());\n      var sameDate = parent.dateIsEqual(d.t, new Date());\n\n      if (\n      parent.legendScale === null ||\n      d.v === null &&\n      options.hasOwnProperty('considerMissingDataAsZero') &&\n      !options.considerMissingDataAsZero &&\n      !options.legendColors.hasOwnProperty('base'))\n      {\n        htmlClass.push('graph-rect');\n      }\n\n      if (sameDate) {\n        htmlClass.push('now');\n      } else if (!pastDate) {\n        htmlClass.push('future');\n      }\n\n      if (d.v !== null) {\n        htmlClass.push(\n        parent.Legend.getClass(d.v, parent.legendScale === null));\n\n      } else if (options.considerMissingDataAsZero && pastDate) {\n        htmlClass.push(\n        parent.Legend.getClass(0, parent.legendScale === null));\n\n      }\n\n      if (options.onClick !== null) {\n        htmlClass.push('hover_cursor');\n      }\n\n      return htmlClass.join(' ');\n    }).\n    call(addStyle);\n\n    rect.\n    transition().\n    duration(options.animationDuration).\n    select('title').\n    text(function (d) {\n      return parent.getSubDomainTitle(d);\n    });\n\n    function formatSubDomainText(element) {\n      if (typeof options.subDomainTextFormat === 'function') {\n        element.text(function (d) {\n          return options.subDomainTextFormat(d.t, d.v);\n        });\n      }\n    }\n\n    /**\n     * Change the subDomainText class if necessary\n     * Also change the text, e.g when text is representing the value\n     * instead of the date\n     */\n    rect.\n    transition().\n    duration(options.animationDuration).\n    select('text').\n    attr('class', function (d) {\n      return 'subdomain-text' + parent.getHighlightClassName(d.t);\n    }).\n    call(formatSubDomainText).\n    attr('fill', (d) => {\n      if (!d.v) return '#000';\n      const rgb = parent.legendScale(\n      Math.min(d.v, options.legend[options.legend.length - 1]));\n\n      return getContrastingColor(rgb, 135);\n    });\n  },\n\n  /**\n   * Sprintf like function.\n   * Replaces placeholders {0} in string with values from provided object.\n   *\n   * @param string formatted String containing placeholders.\n   * @param object args Object with properties to replace placeholders in string.\n   *\n   * @return String\n   */\n  formatStringWithObject: function (formatted, args) {\n    'use strict';\n    for (var prop in args) {\n      if (args.hasOwnProperty(prop)) {\n        var regexp = new RegExp('\\\\{' + prop + '\\\\}', 'gi');\n        formatted = formatted.replace(regexp, args[prop]);\n      }\n    }\n    return formatted;\n  },\n\n  // =========================================================================//\n  // EVENTS CALLBACK                              //\n  // =========================================================================//\n\n  /**\n   * Helper method for triggering event callback\n   *\n   * @param  string  eventName       Name of the event to trigger\n   * @param  array  successArgs     List of argument to pass to the callback\n   * @param  boolean  skip      Whether to skip the event triggering\n   * @return mixed  True when the triggering was skipped, false on error, else the callback function\n   */\n  triggerEvent: function (eventName, successArgs, skip) {\n    'use strict';\n\n    if (arguments.length === 3 && skip || this.options[eventName] === null) {\n      return true;\n    }\n\n    if (typeof this.options[eventName] === 'function') {\n      if (typeof successArgs === 'function') {\n        successArgs = successArgs();\n      }\n      return this.options[eventName].apply(this, successArgs);\n    } else {\n      console.log('Provided callback for ' + eventName + ' is not a function.');\n      return false;\n    }\n  },\n\n  /**\n   * Event triggered on a mouse click on a subDomain cell\n   *\n   * @param  Date    d    Date of the subdomain block\n   * @param  int    itemNb  Number of items in that date\n   */\n  onClick: function (d, itemNb) {\n    'use strict';\n\n    return this.triggerEvent('onClick', [d, itemNb]);\n  },\n\n  /**\n   * Event triggered after drawing the calendar, byt before filling it with data\n   */\n  afterLoad: function () {\n    'use strict';\n\n    return this.triggerEvent('afterLoad');\n  },\n\n  /**\n   * Event triggered after completing drawing and filling the calendar\n   */\n  onComplete: function () {\n    'use strict';\n\n    var response = this.triggerEvent('onComplete', [], this._completed);\n    this._completed = true;\n    return response;\n  },\n\n  /**\n   * Event triggered after shifting the calendar one domain back\n   *\n   * @param  Date    start  Domain start date\n   * @param  Date    end    Domain end date\n   */\n  afterLoadPreviousDomain: function (start) {\n    'use strict';\n\n    var parent = this;\n    return this.triggerEvent('afterLoadPreviousDomain', function () {\n      var subDomain = parent.getSubDomain(start);\n      return [subDomain.shift(), subDomain.pop()];\n    });\n  },\n\n  /**\n   * Event triggered after shifting the calendar one domain above\n   *\n   * @param  Date    start  Domain start date\n   * @param  Date    end    Domain end date\n   */\n  afterLoadNextDomain: function (start) {\n    'use strict';\n\n    var parent = this;\n    return this.triggerEvent('afterLoadNextDomain', function () {\n      var subDomain = parent.getSubDomain(start);\n      return [subDomain.shift(), subDomain.pop()];\n    });\n  },\n\n  /**\n   * Event triggered after loading the leftmost domain allowed by minDate\n   *\n   * @param  boolean  reached True if the leftmost domain was reached\n   */\n  onMinDomainReached: function (reached) {\n    'use strict';\n\n    this._minDomainReached = reached;\n    return this.triggerEvent('onMinDomainReached', [reached]);\n  },\n\n  /**\n   * Event triggered after loading the rightmost domain allowed by maxDate\n   *\n   * @param  boolean  reached True if the rightmost domain was reached\n   */\n  onMaxDomainReached: function (reached) {\n    'use strict';\n\n    this._maxDomainReached = reached;\n    return this.triggerEvent('onMaxDomainReached', [reached]);\n  },\n\n  checkIfMinDomainIsReached: function (date, upperBound) {\n    'use strict';\n\n    if (this.minDomainIsReached(date)) {\n      this.onMinDomainReached(true);\n    }\n\n    if (arguments.length === 2) {\n      if (this._maxDomainReached && !this.maxDomainIsReached(upperBound)) {\n        this.onMaxDomainReached(false);\n      }\n    }\n  },\n\n  checkIfMaxDomainIsReached: function (date, lowerBound) {\n    'use strict';\n\n    if (this.maxDomainIsReached(date)) {\n      this.onMaxDomainReached(true);\n    }\n\n    if (arguments.length === 2) {\n      if (this._minDomainReached && !this.minDomainIsReached(lowerBound)) {\n        this.onMinDomainReached(false);\n      }\n    }\n  },\n\n  afterUpdate: function () {\n    'use strict';\n\n    return this.triggerEvent('afterUpdate');\n  },\n\n  // =========================================================================//\n  // FORMATTER                                //\n  // =========================================================================//\n\n  formatNumber: d3.format(',g'),\n\n  formatDate: function (d, format) {\n    'use strict';\n\n    if (arguments.length < 2) {\n      format = 'title';\n    }\n\n    if (typeof format === 'function') {\n      return format(d);\n    } else {\n      var f = d3.time.format(format);\n      return f(d);\n    }\n  },\n\n  getSubDomainTitle: function (d) {\n    'use strict';\n\n    if (d.v === null && !this.options.considerMissingDataAsZero) {\n      return this.formatStringWithObject(\n      this.options.subDomainTitleFormat.empty,\n      {\n        date: this.formatDate(\n        new Date(d.t),\n        this.options.subDomainDateFormat) });\n\n\n\n    } else {\n      var value = d.v;\n      // Consider null as 0\n      if (value === null && this.options.considerMissingDataAsZero) {\n        value = 0;\n      }\n\n      return this.formatStringWithObject(\n      this.options.subDomainTitleFormat.filled,\n      {\n        count: this.formatNumber(value),\n        name: this.options.itemName[value !== 1 ? 1 : 0],\n        connector: this._domainType[this.options.subDomain].format.connector,\n        date: this.formatDate(\n        new Date(d.t),\n        this.options.subDomainDateFormat) });\n\n\n\n    }\n  },\n\n  // =========================================================================//\n  // DOMAIN NAVIGATION                            //\n  // =========================================================================//\n\n  /**\n   * Shift the calendar one domain forward\n   *\n   * The new domain is loaded only if it's not beyond maxDate\n   *\n   * @param int n Number of domains to load\n   * @return bool True if the next domain was loaded, else false\n   */\n  loadNextDomain: function (n) {\n    'use strict';\n\n    if (this._maxDomainReached || n === 0) {\n      return false;\n    }\n\n    var bound = this.loadNewDomains(\n    this.NAVIGATE_RIGHT,\n    this.getDomain(this.getNextDomain(), n));\n\n\n    this.afterLoadNextDomain(bound.end);\n    this.checkIfMaxDomainIsReached(this.getNextDomain().getTime(), bound.start);\n\n    return true;\n  },\n\n  /**\n   * Shift the calendar one domain backward\n   *\n   * The previous domain is loaded only if it's not beyond the minDate\n   *\n   * @param int n Number of domains to load\n   * @return bool True if the previous domain was loaded, else false\n   */\n  loadPreviousDomain: function (n) {\n    'use strict';\n\n    if (this._minDomainReached || n === 0) {\n      return false;\n    }\n\n    var bound = this.loadNewDomains(\n    this.NAVIGATE_LEFT,\n    this.getDomain(this.getDomainKeys()[0], -n).reverse());\n\n\n    this.afterLoadPreviousDomain(bound.start);\n    this.checkIfMinDomainIsReached(bound.start, bound.end);\n\n    return true;\n  },\n\n  loadNewDomains: function (direction, newDomains) {\n    'use strict';\n\n    var parent = this;\n    var backward = direction === this.NAVIGATE_LEFT;\n    var i = -1;\n    var total = newDomains.length;\n    var domains = this.getDomainKeys();\n\n    function buildSubDomain(d) {\n      return {\n        t: parent._domainType[parent.options.subDomain].extractUnit(d),\n        v: null };\n\n    }\n\n    // Remove out of bound domains from list of new domains to prepend\n    while (++i < total) {\n      if (backward && this.minDomainIsReached(newDomains[i])) {\n        newDomains = newDomains.slice(0, i + 1);\n        break;\n      }\n      if (!backward && this.maxDomainIsReached(newDomains[i])) {\n        newDomains = newDomains.slice(0, i);\n        break;\n      }\n    }\n\n    newDomains = newDomains.slice(-this.options.range);\n\n    for (i = 0, total = newDomains.length; i < total; i += 1) {\n      this._domains.set(\n      newDomains[i].getTime(),\n      this.getSubDomain(newDomains[i]).map(buildSubDomain));\n\n\n      this._domains.remove(backward ? domains.pop() : domains.shift());\n    }\n\n    domains = this.getDomainKeys();\n\n    if (backward) {\n      newDomains = newDomains.reverse();\n    }\n\n    this.paint(direction);\n\n    this.getDatas(\n    this.options.data,\n    newDomains[0],\n    this.getSubDomain(newDomains[newDomains.length - 1]).pop(),\n    function () {\n      parent.fill(parent.lastInsertedSvg);\n    });\n\n\n    return {\n      start: newDomains[backward ? 0 : 1],\n      end: domains[domains.length - 1] };\n\n  },\n\n  /**\n   * Return whether a date is inside the scope determined by maxDate\n   *\n   * @param int datetimestamp The timestamp in ms to test\n   * @return bool True if the specified date correspond to the calendar upper bound\n   */\n  maxDomainIsReached: function (datetimestamp) {\n    'use strict';\n\n    return (\n      this.options.maxDate !== null &&\n      this.options.maxDate.getTime() < datetimestamp);\n\n  },\n\n  /**\n   * Return whether a date is inside the scope determined by minDate\n   *\n   * @param int datetimestamp The timestamp in ms to test\n   * @return bool True if the specified date correspond to the calendar lower bound\n   */\n  minDomainIsReached: function (datetimestamp) {\n    'use strict';\n\n    return (\n      this.options.minDate !== null &&\n      this.options.minDate.getTime() >= datetimestamp);\n\n  },\n\n  /**\n   * Return the list of the calendar's domain timestamp\n   *\n   * @return Array a sorted array of timestamp\n   */\n  getDomainKeys: function () {\n    'use strict';\n\n    return this._domains.\n    keys().\n    map(function (d) {\n      return parseInt(d, 10);\n    }).\n    sort(function (a, b) {\n      return a - b;\n    });\n  },\n\n  // =========================================================================//\n  // POSITIONNING                                //\n  // =========================================================================//\n\n  positionSubDomainX: function (d) {\n    'use strict';\n\n    var index = this._domainType[this.options.subDomain].position.x(\n    new Date(d));\n\n    return index * this.options.cellSize + index * this.options.cellPadding;\n  },\n\n  positionSubDomainY: function (d) {\n    'use strict';\n\n    var index = this._domainType[this.options.subDomain].position.y(\n    new Date(d));\n\n    return index * this.options.cellSize + index * this.options.cellPadding;\n  },\n\n  getSubDomainColumnNumber: function (d) {\n    'use strict';\n\n    if (this.options.rowLimit > 0) {\n      var i = this._domainType[this.options.subDomain].maxItemNumber;\n      if (typeof i === 'function') {\n        i = i(d);\n      }\n      return Math.ceil(i / this.options.rowLimit);\n    }\n\n    var j = this._domainType[this.options.subDomain].defaultColumnNumber;\n    if (typeof j === 'function') {\n      j = j(d);\n    }\n    return this.options.colLimit || j;\n  },\n\n  getSubDomainRowNumber: function (d) {\n    'use strict';\n\n    if (this.options.colLimit > 0) {\n      var i = this._domainType[this.options.subDomain].maxItemNumber;\n      if (typeof i === 'function') {\n        i = i(d);\n      }\n      return Math.ceil(i / this.options.colLimit);\n    }\n\n    var j = this._domainType[this.options.subDomain].defaultRowNumber;\n    if (typeof j === 'function') {\n      j = j(d);\n    }\n    return this.options.rowLimit || j;\n  },\n\n  /**\n   * Return a classname if the specified date should be highlighted\n   *\n   * @param  timestamp date Date of the current subDomain\n   * @return String the highlight class\n   */\n  getHighlightClassName: function (d) {\n    'use strict';\n\n    d = new Date(d);\n\n    if (this.options.highlight.length > 0) {\n      for (var i in this.options.highlight) {\n        if (this.dateIsEqual(this.options.highlight[i], d)) {\n          return this.isNow(this.options.highlight[i]) ?\n          ' highlight-now' :\n          ' highlight';\n        }\n      }\n    }\n    return '';\n  },\n\n  /**\n   * Return whether the specified date is now,\n   * according to the type of subdomain\n   *\n   * @param  Date d The date to compare\n   * @return bool True if the date correspond to a subdomain cell\n   */\n  isNow: function (d) {\n    'use strict';\n\n    return this.dateIsEqual(d, new Date());\n  },\n\n  /**\n   * Return whether 2 dates are equals\n   * This function is subdomain-aware,\n   * and dates comparison are dependent of the subdomain\n   *\n   * @param  Date dateA First date to compare\n   * @param  Date dateB Secon date to compare\n   * @return bool true if the 2 dates are equals\n   */\n  /* jshint maxcomplexity: false */\n  dateIsEqual: function (dateA, dateB) {\n    'use strict';\n\n    if (!(dateA instanceof Date)) {\n      dateA = new Date(dateA);\n    }\n\n    if (!(dateB instanceof Date)) {\n      dateB = new Date(dateB);\n    }\n\n    switch (this.options.subDomain) {\n      case 'x_min':\n      case 'min':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate() &&\n          dateA.getHours() === dateB.getHours() &&\n          dateA.getMinutes() === dateB.getMinutes());\n\n      case 'x_hour':\n      case 'hour':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate() &&\n          dateA.getHours() === dateB.getHours());\n\n      case 'x_day':\n      case 'day':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate());\n\n      case 'x_week':\n      case 'week':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          this.getWeekNumber(dateA) === this.getWeekNumber(dateB));\n\n      case 'x_month':\n      case 'month':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth());\n\n      default:\n        return false;}\n\n  },\n\n  /**\n   * Returns wether or not dateA is less than or equal to dateB. This function is subdomain aware.\n   * Performs automatic conversion of values.\n   * @param dateA may be a number or a Date\n   * @param dateB may be a number or a Date\n   * @returns {boolean}\n   */\n  dateIsLessThan: function (dateA, dateB) {\n    'use strict';\n\n    if (!(dateA instanceof Date)) {\n      dateA = new Date(dateA);\n    }\n\n    if (!(dateB instanceof Date)) {\n      dateB = new Date(dateB);\n    }\n\n    function normalizedMillis(date, subdomain) {\n      switch (subdomain) {\n        case 'x_min':\n        case 'min':\n          return new Date(\n          date.getFullYear(),\n          date.getMonth(),\n          date.getDate(),\n          date.getHours(),\n          date.getMinutes()).\n          getTime();\n        case 'x_hour':\n        case 'hour':\n          return new Date(\n          date.getFullYear(),\n          date.getMonth(),\n          date.getDate(),\n          date.getHours()).\n          getTime();\n        case 'x_day':\n        case 'day':\n          return new Date(\n          date.getFullYear(),\n          date.getMonth(),\n          date.getDate()).\n          getTime();\n        case 'x_week':\n        case 'week':\n        case 'x_month':\n        case 'month':\n          return new Date(date.getFullYear(), date.getMonth()).getTime();\n        default:\n          return date.getTime();}\n\n    }\n\n    return (\n      normalizedMillis(dateA, this.options.subDomain) <\n      normalizedMillis(dateB, this.options.subDomain));\n\n  },\n\n  // =========================================================================//\n  // DATE COMPUTATION                              //\n  // =========================================================================//\n\n  /**\n   * Return the day of the year for the date\n   * @param  Date\n   * @return  int Day of the year [1,366]\n   */\n  getDayOfYear: d3.time.format('%j'),\n\n  /**\n   * Return the week number of the year\n   * Monday as the first day of the week\n   * @return int  Week number [0-53]\n   */\n  getWeekNumber: function (d) {\n    'use strict';\n\n    var f =\n    this.options.weekStartOnMonday === true ?\n    d3.time.format('%W') :\n    d3.time.format('%U');\n    return f(d);\n  },\n\n  /**\n   * Return the week number, relative to its month\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Week number, relative to the month [0-5]\n   */\n  getMonthWeekNumber: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n\n    var monthFirstWeekNumber = this.getWeekNumber(\n    new Date(d.getFullYear(), d.getMonth()));\n\n    return this.getWeekNumber(d) - monthFirstWeekNumber - 1;\n  },\n\n  /**\n   * Return the number of weeks in the dates' year\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of weeks in the date's year\n   */\n  getWeekNumberInYear: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n  },\n\n  /**\n   * Return the number of days in the date's month\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of days in the date's month\n   */\n  getDayCountInMonth: function (d) {\n    'use strict';\n\n    return this.getEndOfMonth(d).getDate();\n  },\n\n  /**\n   * Return the number of days in the date's year\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of days in the date's year\n   */\n  getDayCountInYear: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n    return new Date(d.getFullYear(), 1, 29).getMonth() === 1 ? 366 : 365;\n  },\n\n  /**\n   * Get the weekday from a date\n   *\n   * Return the week day number (0-6) of a date,\n   * depending on whether the week start on monday or sunday\n   *\n   * @param  Date d\n   * @return int The week day number (0-6)\n   */\n  getWeekDay: function (d) {\n    'use strict';\n\n    if (this.options.weekStartOnMonday === false) {\n      return d.getDay();\n    }\n    return d.getDay() === 0 ? 6 : d.getDay() - 1;\n  },\n\n  /**\n   * Get the last day of the month\n   * @param  Date|int  d  Date or timestamp in milliseconds\n   * @return Date      Last day of the month\n   */\n  getEndOfMonth: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n    return new Date(d.getFullYear(), d.getMonth() + 1, 0);\n  },\n\n  /**\n   *\n   * @param  Date date\n   * @param  int count\n   * @param  string step\n   * @return Date\n   */\n  jumpDate: function (date, count, step) {\n    'use strict';\n\n    var d = new Date(date);\n    switch (step) {\n      case 'hour':\n        d.setHours(d.getHours() + count);\n        break;\n      case 'day':\n        d.setHours(d.getHours() + count * 24);\n        break;\n      case 'week':\n        d.setHours(d.getHours() + count * 24 * 7);\n        break;\n      case 'month':\n        d.setMonth(d.getMonth() + count);\n        break;\n      case 'year':\n        d.setFullYear(d.getFullYear() + count);}\n\n\n    return new Date(d);\n  },\n\n  // =========================================================================//\n  // DOMAIN COMPUTATION                            //\n  // =========================================================================//\n\n  /**\n   * Return all the minutes between 2 dates\n   *\n   * @param  Date  d  date  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of minutes\n   */\n  getMinuteDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(\n    d.getFullYear(),\n    d.getMonth(),\n    d.getDate(),\n    d.getHours());\n\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(\n      range.getFullYear(),\n      range.getMonth(),\n      range.getDate(),\n      range.getHours());\n\n    } else {\n      stop = new Date(+start + range * 1000 * 60);\n    }\n    return d3.time.minutes(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the hours between 2 dates\n   *\n   * @param  Date  d  A date\n   * @param  int|date  range  Number of hours in the range, or a stop date\n   * @return array  An array of hours\n   */\n  getHourDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(\n    d.getFullYear(),\n    d.getMonth(),\n    d.getDate(),\n    d.getHours());\n\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(\n      range.getFullYear(),\n      range.getMonth(),\n      range.getDate(),\n      range.getHours());\n\n    } else {\n      stop = new Date(start);\n      stop.setHours(stop.getHours() + range);\n    }\n\n    var domains = d3.time.hours(Math.min(start, stop), Math.max(start, stop));\n\n    // Passing from DST to standard time\n    // If there are 25 hours, let's compress the duplicate hours\n    var i = 0;\n    var total = domains.length;\n    for (i = 0; i < total; i += 1) {\n      if (i > 0 && domains[i].getHours() === domains[i - 1].getHours()) {\n        this.DSTDomain.push(domains[i].getTime());\n        domains.splice(i, 1);\n        break;\n      }\n    }\n\n    // d3.time.hours is returning more hours than needed when changing\n    // from DST to standard time, because there is really 2 hours between\n    // 1am and 2am!\n    if (typeof range === 'number' && domains.length > Math.abs(range)) {\n      domains.splice(domains.length - 1, 1);\n    }\n\n    return domains;\n  },\n\n  /**\n   * Return all the days between 2 dates\n   *\n   * @param  Date    d    A date\n   * @param  int|date  range  Number of days in the range, or a stop date\n   * @return array  An array of weeks\n   */\n  getDayDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), range.getMonth(), range.getDate());\n    } else {\n      stop = new Date(start);\n      stop = new Date(stop.setDate(stop.getDate() + parseInt(range, 10)));\n    }\n\n    return d3.time.days(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the weeks between 2 dates\n   *\n   * @param  Date  d  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of weeks\n   */\n  getWeekDomain: function (d, range) {\n    'use strict';\n\n    var weekStart;\n\n    if (this.options.weekStartOnMonday === false) {\n      weekStart = new Date(\n      d.getFullYear(),\n      d.getMonth(),\n      d.getDate() - d.getDay());\n\n    } else {\n      if (d.getDay() === 1) {\n        weekStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n      } else if (d.getDay() === 0) {\n        weekStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n        weekStart.setDate(weekStart.getDate() - 6);\n      } else {\n        weekStart = new Date(\n        d.getFullYear(),\n        d.getMonth(),\n        d.getDate() - d.getDay() + 1);\n\n      }\n    }\n\n    var endDate = new Date(weekStart);\n\n    var stop = range;\n    if (typeof range !== 'object') {\n      stop = new Date(endDate.setDate(endDate.getDate() + range * 7));\n    }\n\n    return this.options.weekStartOnMonday === true ?\n    d3.time.mondays(Math.min(weekStart, stop), Math.max(weekStart, stop)) :\n    d3.time.sundays(Math.min(weekStart, stop), Math.max(weekStart, stop));\n  },\n\n  /**\n   * Return all the months between 2 dates\n   *\n   * @param  Date    d    A date\n   * @param  int|date  range  Number of months in the range, or a stop date\n   * @return array  An array of months\n   */\n  getMonthDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), d.getMonth());\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), range.getMonth());\n    } else {\n      stop = new Date(start);\n      stop = stop.setMonth(stop.getMonth() + range);\n    }\n\n    return d3.time.months(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the years between 2 dates\n   *\n   * @param  Date  d  date  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of hours\n   */\n  getYearDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), 0);\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), 0);\n    } else {\n      stop = new Date(d.getFullYear() + range, 0);\n    }\n\n    return d3.time.years(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Get an array of domain start dates\n   *\n   * @param  int|Date date A random date included in the wanted domain\n   * @param  int|Date range Number of dates to get, or a stop date\n   * @return Array of dates\n   */\n  getDomain: function (date, range) {\n    'use strict';\n\n    if (typeof date === 'number') {\n      date = new Date(date);\n    }\n\n    if (arguments.length < 2) {\n      range = this.options.range;\n    }\n\n    switch (this.options.domain) {\n      case 'hour':\n        var domains = this.getHourDomain(date, range);\n\n        // Case where an hour is missing, when passing from standard time to DST\n        // Missing hour is perfectly acceptabl in subDomain, but not in domains\n        if (typeof range === 'number' && domains.length < range) {\n          if (range > 0) {\n            domains.push(this.getHourDomain(domains[domains.length - 1], 2)[1]);\n          } else {\n            domains.shift(this.getHourDomain(domains[0], -2)[0]);\n          }\n        }\n        return domains;\n      case 'day':\n        return this.getDayDomain(date, range);\n      case 'week':\n        return this.getWeekDomain(date, range);\n      case 'month':\n        return this.getMonthDomain(date, range);\n      case 'year':\n        return this.getYearDomain(date, range);}\n\n  },\n\n  /* jshint maxcomplexity: false */\n  getSubDomain: function (date) {\n    'use strict';\n\n    if (typeof date === 'number') {\n      date = new Date(date);\n    }\n\n    var parent = this;\n\n    /**\n     * @return int\n     */\n    var computeDaySubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'year':\n          return parent.getDayCountInYear(date);\n        case 'month':\n          return parent.getDayCountInMonth(date);\n        case 'week':\n          return 7;}\n\n    };\n\n    /**\n     * @return int\n     */\n    var computeMinSubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'hour':\n          return 60;\n        case 'day':\n          return 60 * 24;\n        case 'week':\n          return 60 * 24 * 7;}\n\n    };\n\n    /**\n     * @return int\n     */\n    var computeHourSubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'day':\n          return 24;\n        case 'week':\n          return 168;\n        case 'month':\n          return parent.getDayCountInMonth(date) * 24;}\n\n    };\n\n    /**\n     * @return int\n     */\n    var computeWeekSubDomainSize = function (date, domain) {\n      if (domain === 'month') {\n        var endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);\n        var endWeekNb = parent.getWeekNumber(endOfMonth);\n        var startWeekNb = parent.getWeekNumber(\n        new Date(date.getFullYear(), date.getMonth()));\n\n\n        if (startWeekNb > endWeekNb) {\n          startWeekNb = 0;\n          endWeekNb += 1;\n        }\n\n        return endWeekNb - startWeekNb + 1;\n      } else if (domain === 'year') {\n        return parent.getWeekNumber(new Date(date.getFullYear(), 11, 31));\n      }\n    };\n\n    switch (this.options.subDomain) {\n      case 'x_min':\n      case 'min':\n        return this.getMinuteDomain(\n        date,\n        computeMinSubDomainSize(date, this.options.domain));\n\n      case 'x_hour':\n      case 'hour':\n        return this.getHourDomain(\n        date,\n        computeHourSubDomainSize(date, this.options.domain));\n\n      case 'x_day':\n      case 'day':\n        return this.getDayDomain(\n        date,\n        computeDaySubDomainSize(date, this.options.domain));\n\n      case 'x_week':\n      case 'week':\n        return this.getWeekDomain(\n        date,\n        computeWeekSubDomainSize(date, this.options.domain));\n\n      case 'x_month':\n      case 'month':\n        return this.getMonthDomain(date, 12);}\n\n  },\n\n  /**\n   * Get the n-th next domain after the calendar newest (rightmost) domain\n   * @param  int n\n   * @return Date The start date of the wanted domain\n   */\n  getNextDomain: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.getDomain(\n    this.jumpDate(this.getDomainKeys().pop(), n, this.options.domain),\n    1)[\n    0];\n  },\n\n  /**\n   * Get the n-th domain before the calendar oldest (leftmost) domain\n   * @param  int n\n   * @return Date The start date of the wanted domain\n   */\n  getPreviousDomain: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.getDomain(\n    this.jumpDate(this.getDomainKeys().shift(), -n, this.options.domain),\n    1)[\n    0];\n  },\n\n  // =========================================================================//\n  // DATAS                                  //\n  // =========================================================================//\n\n  /**\n   * Fetch and interpret data from the datasource\n   *\n   * @param string|object source\n   * @param Date startDate\n   * @param Date endDate\n   * @param function callback\n   * @param function|boolean afterLoad function used to convert the data into a json object. Use true to use the afterLoad callback\n   * @param updateMode\n   *\n   * @return mixed\n   * - True if there are no data to load\n   * - False if data are loaded asynchronously\n   */\n  getDatas: function (\n  source,\n  startDate,\n  endDate,\n  callback,\n  afterLoad,\n  updateMode)\n  {\n    'use strict';\n\n    var self = this;\n    if (arguments.length < 5) {\n      afterLoad = true;\n    }\n    if (arguments.length < 6) {\n      updateMode = this.APPEND_ON_UPDATE;\n    }\n    var _callback = function (error, data) {\n      if (afterLoad !== false) {\n        if (typeof afterLoad === 'function') {\n          data = afterLoad(data);\n        } else if (typeof self.options.afterLoadData === 'function') {\n          data = self.options.afterLoadData(data);\n        } else {\n          console.log('Provided callback for afterLoadData is not a function.');\n        }\n      } else if (\n      self.options.dataType === 'csv' ||\n      self.options.dataType === 'tsv')\n      {\n        data = this.interpretCSV(data);\n      }\n      self.parseDatas(data, updateMode, startDate, endDate);\n      if (typeof callback === 'function') {\n        callback();\n      }\n    };\n\n    switch (typeof source) {\n      case 'string':\n        if (source === '') {\n          _callback(null, {});\n          return true;\n        } else {\n          var url = this.parseURI(source, startDate, endDate);\n          var requestType = 'GET';\n          if (self.options.dataPostPayload !== null) {\n            requestType = 'POST';\n          }\n          var payload = null;\n          if (self.options.dataPostPayload !== null) {\n            payload = this.parseURI(\n            self.options.dataPostPayload,\n            startDate,\n            endDate);\n\n          }\n\n          var xhr = null;\n          switch (this.options.dataType) {\n            case 'json':\n              xhr = d3.json(url);\n              break;\n            case 'csv':\n              xhr = d3.csv(url);\n              break;\n            case 'tsv':\n              xhr = d3.tsv(url);\n              break;\n            case 'txt':\n              xhr = d3.text(url, 'text/plain');\n              break;}\n\n\n          // jshint maxdepth:5\n          if (self.options.dataRequestHeaders !== null) {\n            for (var header in self.options.dataRequestHeaders) {\n              if (self.options.dataRequestHeaders.hasOwnProperty(header)) {\n                xhr.header(header, self.options.dataRequestHeaders[header]);\n              }\n            }\n          }\n\n          xhr.send(requestType, payload, _callback);\n        }\n        return false;\n      case 'object':\n        if (source === Object(source)) {\n          _callback(null, source);\n          return false;\n        }\n      /* falls through */\n      default:\n        _callback(null, {});\n        return true;}\n\n  },\n\n  /**\n   * Populate the calendar internal data\n   *\n   * @param object data\n   * @param constant updateMode\n   * @param Date startDate\n   * @param Date endDate\n   *\n   * @return void\n   */\n  parseDatas: function (data, updateMode, startDate, endDate) {\n    'use strict';\n\n    if (updateMode === this.RESET_ALL_ON_UPDATE) {\n      this._domains.forEach(function (key, value) {\n        value.forEach(function (element, index, array) {\n          array[index].v = null;\n        });\n      });\n    }\n\n    var temp = {};\n\n    var extractTime = function (d) {\n      return d.t;\n    };\n\n    /*jshint forin:false */\n    for (var d in data) {\n      var date = new Date(d * 1000);\n      var domainUnit = this.getDomain(date)[0].getTime();\n      // The current data belongs to a domain that was compressed\n      // Compress the data for the two duplicate hours into the same hour\n      if (this.DSTDomain.indexOf(domainUnit) >= 0) {\n        // Re-assign all data to the first or the second duplicate hours\n        // depending on which is visible\n        if (this._domains.has(domainUnit - 3600 * 1000)) {\n          domainUnit -= 3600 * 1000;\n        }\n      }\n\n      // Skip if data is not relevant to current domain\n      if (\n      isNaN(d) ||\n      !data.hasOwnProperty(d) ||\n      !this._domains.has(domainUnit) ||\n      !(domainUnit >= +startDate && domainUnit < +endDate))\n      {\n        continue;\n      }\n\n      var subDomainsData = this._domains.get(domainUnit);\n\n      if (!temp.hasOwnProperty(domainUnit)) {\n        temp[domainUnit] = subDomainsData.map(extractTime);\n      }\n\n      var index = temp[domainUnit].indexOf(\n      this._domainType[this.options.subDomain].extractUnit(date));\n\n\n      if (updateMode === this.RESET_SINGLE_ON_UPDATE) {\n        subDomainsData[index].v = data[d];\n      } else {\n        if (!isNaN(subDomainsData[index].v)) {\n          subDomainsData[index].v += data[d];\n        } else {\n          subDomainsData[index].v = data[d];\n        }\n      }\n    }\n  },\n\n  parseURI: function (str, startDate, endDate) {\n    'use strict';\n\n    // Use a timestamp in seconds\n    str = str.replace(/\\{\\{t:start\\}\\}/g, startDate.getTime() / 1000);\n    str = str.replace(/\\{\\{t:end\\}\\}/g, endDate.getTime() / 1000);\n\n    // Use a string date, following the ISO-8601\n    str = str.replace(/\\{\\{d:start\\}\\}/g, startDate.toISOString());\n    str = str.replace(/\\{\\{d:end\\}\\}/g, endDate.toISOString());\n\n    return str;\n  },\n\n  interpretCSV: function (data) {\n    'use strict';\n\n    var d = {};\n    var keys = Object.keys(data[0]);\n    var i, total;\n    for (i = 0, total = data.length; i < total; i += 1) {\n      d[data[i][keys[0]]] = +data[i][keys[1]];\n    }\n    return d;\n  },\n\n  /**\n   * Handle the calendar layout and dimension\n   *\n   * Expand and shrink the container depending on its children dimension\n   * Also rearrange the children position depending on their dimension,\n   * and the legend position\n   *\n   * @return void\n   */\n  resize: function () {\n    'use strict';\n\n    var parent = this;\n    var options = parent.options;\n    var legendWidth = options.displayLegend ?\n    parent.Legend.getDim('width') +\n    options.legendMargin[1] +\n    options.legendMargin[3] :\n    0;\n    var legendHeight = options.displayLegend ?\n    parent.Legend.getDim('height') +\n    options.legendMargin[0] +\n    options.legendMargin[2] :\n    0;\n\n    var graphWidth =\n    parent.graphDim.width - options.domainGutter - options.cellPadding;\n    var graphHeight =\n    parent.graphDim.height - options.domainGutter - options.cellPadding;\n\n    this.root.\n    transition().\n    duration(options.animationDuration).\n    attr('width', function () {\n      if (\n      options.legendVerticalPosition === 'middle' ||\n      options.legendVerticalPosition === 'center')\n      {\n        return graphWidth + legendWidth;\n      }\n      return Math.max(graphWidth, legendWidth);\n    }).\n    attr('height', function () {\n      if (\n      options.legendVerticalPosition === 'middle' ||\n      options.legendVerticalPosition === 'center')\n      {\n        return Math.max(graphHeight, legendHeight);\n      }\n      return graphHeight + legendHeight;\n    });\n\n    this.root.\n    select('.graph').\n    transition().\n    duration(options.animationDuration).\n    attr('y', function () {\n      if (options.legendVerticalPosition === 'top') {\n        return legendHeight;\n      }\n      return 0;\n    }).\n    attr('x', function () {\n      if (\n      (options.legendVerticalPosition === 'middle' ||\n      options.legendVerticalPosition === 'center') &&\n      options.legendHorizontalPosition === 'left')\n      {\n        return legendWidth;\n      }\n      return 0;\n    });\n  },\n\n  // =========================================================================//\n  // PUBLIC API                                //\n  // =========================================================================//\n\n  /**\n   * Shift the calendar forward\n   */\n  next: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.loadNextDomain(n);\n  },\n\n  /**\n   * Shift the calendar backward\n   */\n  previous: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.loadPreviousDomain(n);\n  },\n\n  /**\n   * Jump directly to a specific date\n   *\n   * JumpTo will scroll the calendar until the wanted domain with the specified\n   * date is visible. Unless you set reset to true, the wanted domain\n   * will not necessarily be the first (leftmost) domain of the calendar.\n   *\n   * @param Date date Jump to the domain containing that date\n   * @param bool reset Whether the wanted domain should be the first domain of the calendar\n   * @param bool True of the calendar was scrolled\n   */\n  jumpTo: function (date, reset) {\n    'use strict';\n\n    if (arguments.length < 2) {\n      reset = false;\n    }\n    var domains = this.getDomainKeys();\n    var firstDomain = domains[0];\n    var lastDomain = domains[domains.length - 1];\n\n    if (date < firstDomain) {\n      return this.loadPreviousDomain(this.getDomain(firstDomain, date).length);\n    } else {\n      if (reset) {\n        return this.loadNextDomain(this.getDomain(firstDomain, date).length);\n      }\n\n      if (date > lastDomain) {\n        return this.loadNextDomain(this.getDomain(lastDomain, date).length);\n      }\n    }\n\n    return false;\n  },\n\n  /**\n   * Navigate back to the start date\n   *\n   * @since  3.3.8\n   * @return void\n   */\n  rewind: function () {\n    'use strict';\n\n    this.jumpTo(this.options.start, true);\n  },\n\n  /**\n   * Update the calendar with new data\n   *\n   * @param  object|string    dataSource    The calendar's datasource, same type as this.options.data\n   * @param  boolean|function    afterLoad    Whether to execute afterLoad() on the data. Pass directly a function\n   * if you don't want to use the afterLoad() callback\n   */\n  update: function (dataSource, afterLoad, updateMode) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      dataSource = this.options.data;\n    }\n    if (arguments.length < 2) {\n      afterLoad = true;\n    }\n    if (arguments.length < 3) {\n      updateMode = this.RESET_ALL_ON_UPDATE;\n    }\n\n    var domains = this.getDomainKeys();\n    var self = this;\n    this.getDatas(\n    dataSource,\n    new Date(domains[0]),\n    this.getSubDomain(domains[domains.length - 1]).pop(),\n    function () {\n      self.fill();\n      self.afterUpdate();\n    },\n    afterLoad,\n    updateMode);\n\n  },\n\n  /**\n   * Set the legend\n   *\n   * @param array legend an array of integer, representing the different threshold value\n   * @param array colorRange an array of 2 hex colors, for the minimum and maximum colors\n   */\n  setLegend: function () {\n    'use strict';\n\n    var oldLegend = this.options.legend.slice(0);\n    if (arguments.length >= 1 && Array.isArray(arguments[0])) {\n      this.options.legend = arguments[0];\n    }\n    if (arguments.length >= 2) {\n      if (Array.isArray(arguments[1]) && arguments[1].length >= 2) {\n        this.options.legendColors = [arguments[1][0], arguments[1][1]];\n      } else {\n        this.options.legendColors = arguments[1];\n      }\n    }\n\n    if (\n    arguments.length > 0 && !arrayEquals(oldLegend, this.options.legend) ||\n    arguments.length >= 2)\n    {\n      this.Legend.buildColors();\n      this.fill();\n    }\n\n    this.Legend.redraw(\n    this.graphDim.width -\n    this.options.domainGutter -\n    this.options.cellPadding);\n\n  },\n\n  /**\n   * Remove the legend\n   *\n   * @return bool False if there is no legend to remove\n   */\n  removeLegend: function () {\n    'use strict';\n\n    if (!this.options.displayLegend) {\n      return false;\n    }\n    this.options.displayLegend = false;\n    this.Legend.remove();\n    return true;\n  },\n\n  /**\n   * Display the legend\n   *\n   * @return bool False if the legend was already displayed\n   */\n  showLegend: function () {\n    'use strict';\n\n    if (this.options.displayLegend) {\n      return false;\n    }\n    this.options.displayLegend = true;\n    this.Legend.redraw(\n    this.graphDim.width -\n    this.options.domainGutter -\n    this.options.cellPadding);\n\n    return true;\n  },\n\n  /**\n   * Highlight dates\n   *\n   * Add a highlight class to a set of dates\n   *\n   * @since  3.3.5\n   * @param  array Array of dates to highlight\n   * @return bool True if dates were highlighted\n   */\n  highlight: function (args) {\n    'use strict';\n\n    if ((this.options.highlight = this.expandDateSetting(args)).length > 0) {\n      this.fill();\n      return true;\n    }\n    return false;\n  },\n\n  /**\n   * Destroy the calendar\n   *\n   * Usage: cal = cal.destroy();\n   *\n   * @since  3.3.6\n   * @param function A callback function to trigger after destroying the calendar\n   * @return null\n   */\n  destroy: function (callback) {\n    'use strict';\n\n    this.root.\n    transition().\n    duration(this.options.animationDuration).\n    attr('width', 0).\n    attr('height', 0).\n    remove().\n    each('end', function () {\n      if (typeof callback === 'function') {\n        callback();\n      } else if (typeof callback !== 'undefined') {\n        console.log('Provided callback for destroy() is not a function.');\n      }\n    });\n\n    return null;\n  },\n\n  getSVG: function () {\n    'use strict';\n\n    var styles = {\n      '.cal-heatmap-container': {},\n      '.graph': {},\n      '.graph-rect': {},\n      'rect.highlight': {},\n      'rect.now': {},\n      'rect.highlight-now': {},\n      'text.highlight': {},\n      'text.now': {},\n      'text.highlight-now': {},\n      '.domain-background': {},\n      '.graph-label': {},\n      '.subdomain-text': {},\n      '.q0': {},\n      '.qi': {} };\n\n\n    for (\n    var j = 1, total = this.options.legend.length + 1;\n    j <= total;\n    j += 1)\n    {\n      styles['.q' + j] = {};\n    }\n\n    var root = this.root;\n\n    var whitelistStyles = [\n    // SVG specific properties\n    'stroke',\n    'stroke-width',\n    'stroke-opacity',\n    'stroke-dasharray',\n    'stroke-dashoffset',\n    'stroke-linecap',\n    'stroke-miterlimit',\n    'fill',\n    'fill-opacity',\n    'fill-rule',\n    'marker',\n    'marker-start',\n    'marker-mid',\n    'marker-end',\n    'alignement-baseline',\n    'baseline-shift',\n    'dominant-baseline',\n    'glyph-orientation-horizontal',\n    'glyph-orientation-vertical',\n    'kerning',\n    'text-anchor',\n    'shape-rendering',\n\n    // Text Specific properties\n    'text-transform',\n    'font-family',\n    'font',\n    'font-size',\n    'font-weight'];\n\n\n    var filterStyles = function (attribute, property, value) {\n      if (whitelistStyles.indexOf(property) !== -1) {\n        styles[attribute][property] = value;\n      }\n    };\n\n    var getElement = function (e) {\n      return root.select(e)[0][0];\n    };\n\n    /* jshint forin:false */\n    for (var element in styles) {\n      if (!styles.hasOwnProperty(element)) {\n        continue;\n      }\n\n      var dom = getElement(element);\n\n      if (dom === null) {\n        continue;\n      }\n\n      // The DOM Level 2 CSS way\n      /* jshint maxdepth: false */\n      if ('getComputedStyle' in window) {\n        var cs = getComputedStyle(dom, null);\n        if (cs.length !== 0) {\n          for (var i = 0; i < cs.length; i += 1) {\n            filterStyles(element, cs.item(i), cs.getPropertyValue(cs.item(i)));\n          }\n\n          // Opera workaround. Opera doesn\"t support `item`/`length`\n          // on CSSStyleDeclaration.\n        } else {\n          for (var k in cs) {\n            if (cs.hasOwnProperty(k)) {\n              filterStyles(element, k, cs[k]);\n            }\n          }\n        }\n\n        // The IE way\n      } else if ('currentStyle' in dom) {\n        var css = dom.currentStyle;\n        for (var p in css) {\n          filterStyles(element, p, css[p]);\n        }\n      }\n    }\n\n    var string =\n    '<svg xmlns=\"http://www.w3.org/2000/svg\" ' +\n    'xmlns:xlink=\"http://www.w3.org/1999/xlink\"><style type=\"text/css\"><![CDATA[ ';\n\n    for (var style in styles) {\n      string += style + ' {\\n';\n      for (var l in styles[style]) {\n        string += '\\t' + l + ':' + styles[style][l] + ';\\n';\n      }\n      string += '}\\n';\n    }\n\n    string += ']]></style>';\n    string += new XMLSerializer().serializeToString(this.root[0][0]);\n    string += '</svg>';\n\n    return string;\n  } };\n\n\n// =========================================================================//\n// DOMAIN POSITION COMPUTATION                        //\n// =========================================================================//\n\n/**\n * Compute the position of a domain, relative to the calendar\n */\nvar DomainPosition = function () {\n  'use strict';\n\n  this.positions = d3.map();\n};\n\nDomainPosition.prototype.getPosition = function (d) {\n  'use strict';\n\n  return this.positions.get(d);\n};\n\nDomainPosition.prototype.getPositionFromIndex = function (i) {\n  'use strict';\n\n  var domains = this.getKeys();\n  return this.positions.get(domains[i]);\n};\n\nDomainPosition.prototype.getLast = function () {\n  'use strict';\n\n  var domains = this.getKeys();\n  return this.positions.get(domains[domains.length - 1]);\n};\n\nDomainPosition.prototype.setPosition = function (d, dim) {\n  'use strict';\n\n  this.positions.set(d, dim);\n};\n\nDomainPosition.prototype.shiftRightBy = function (exitingDomainDim) {\n  'use strict';\n\n  this.positions.forEach(function (key, value) {\n    this.set(key, value - exitingDomainDim);\n  });\n\n  var domains = this.getKeys();\n  this.positions.remove(domains[0]);\n};\n\nDomainPosition.prototype.shiftLeftBy = function (enteringDomainDim) {\n  'use strict';\n\n  this.positions.forEach(function (key, value) {\n    this.set(key, value + enteringDomainDim);\n  });\n\n  var domains = this.getKeys();\n  this.positions.remove(domains[domains.length - 1]);\n};\n\nDomainPosition.prototype.getKeys = function () {\n  'use strict';\n\n  return this.positions.keys().sort(function (a, b) {\n    return parseInt(a, 10) - parseInt(b, 10);\n  });\n};\n\n// =========================================================================//\n// LEGEND                                  //\n// =========================================================================//\n\nvar Legend = function (calendar) {\n  'use strict';\n\n  this.calendar = calendar;\n  this.computeDim();\n\n  if (calendar.options.legendColors !== null) {\n    this.buildColors();\n  }\n};\n\nLegend.prototype.computeDim = function () {\n  'use strict';\n\n  var options = this.calendar.options; // Shorter accessor for variable name mangling when minifying\n  this.dim = {\n    width:\n    options.legendCellSize * (options.legend.length + 1) +\n    options.legendCellPadding * options.legend.length,\n    height: options.legendCellSize };\n\n};\n\nLegend.prototype.remove = function () {\n  'use strict';\n\n  this.calendar.root.select('.graph-legend').remove();\n  this.calendar.resize();\n};\n\nLegend.prototype.redraw = function (width) {\n  'use strict';\n\n  if (!this.calendar.options.displayLegend) {\n    return false;\n  }\n\n  var parent = this;\n  var calendar = this.calendar;\n  var legend = calendar.root;\n  var legendItem;\n  var options = calendar.options; // Shorter accessor for variable name mangling when minifying\n\n  this.computeDim();\n\n  var _legend = options.legend.slice(0);\n  _legend.push(_legend[_legend.length - 1] + 1);\n\n  var legendElement = calendar.root.select('.graph-legend');\n  if (legendElement[0][0] !== null) {\n    legend = legendElement;\n    legendItem = legend.select('g').selectAll('rect').data(_legend);\n  } else {\n    // Creating the new legend DOM if it doesn't already exist\n    legend =\n    options.legendVerticalPosition === 'top' ?\n    legend.insert('svg', '.graph') :\n    legend.append('svg');\n\n    legend.attr('x', getLegendXPosition()).attr('y', getLegendYPosition());\n\n    legendItem = legend.\n    attr('class', 'graph-legend').\n    attr('height', parent.getDim('height')).\n    attr('width', parent.getDim('width')).\n    append('g').\n    selectAll().\n    data(_legend);\n  }\n\n  legendItem.\n  enter().\n  append('rect').\n  call(legendCellLayout).\n  attr('class', function (d) {\n    return calendar.Legend.getClass(d, calendar.legendScale === null);\n  }).\n  attr('fill-opacity', 0).\n  call(function (selection) {\n    if (\n    calendar.legendScale !== null &&\n    options.legendColors !== null &&\n    options.legendColors.hasOwnProperty('base'))\n    {\n      selection.attr('fill', options.legendColors.base);\n    }\n  }).\n  append('title');\n\n  legendItem.\n  exit().\n  transition().\n  duration(options.animationDuration).\n  attr('fill-opacity', 0).\n  remove();\n\n  legendItem.\n  transition().\n  delay(function (d, i) {\n    return options.animationDuration * i / 10;\n  }).\n  call(legendCellLayout).\n  attr('fill-opacity', 1).\n  call(function (element) {\n    element.attr('fill', function (d, i) {\n      if (calendar.legendScale === null) {\n        return '';\n      }\n\n      if (i === 0) {\n        return calendar.legendScale(d - 1);\n      }\n      return calendar.legendScale(options.legend[i - 1]);\n    });\n\n    element.attr('class', function (d) {\n      return calendar.Legend.getClass(d, calendar.legendScale === null);\n    });\n  });\n\n  function legendCellLayout(selection) {\n    selection.\n    attr('width', options.legendCellSize).\n    attr('height', options.legendCellSize).\n    attr('rx', options.legendCellRadius).\n    attr('ry', options.legendCellRadius).\n    attr('x', function (d, i) {\n      return i * (options.legendCellSize + options.legendCellPadding);\n    });\n  }\n\n  legendItem.select('title').text(function (d, i) {\n    if (i === 0) {\n      return calendar.formatStringWithObject(options.legendTitleFormat.lower, {\n        min: options.legend[i],\n        name: options.itemName[1] });\n\n    } else if (i === _legend.length - 1) {\n      return calendar.formatStringWithObject(options.legendTitleFormat.upper, {\n        max: options.legend[i - 1],\n        name: options.itemName[1] });\n\n    } else {\n      return calendar.formatStringWithObject(options.legendTitleFormat.inner, {\n        down: options.legend[i - 1],\n        up: options.legend[i],\n        name: options.itemName[1] });\n\n    }\n  });\n  legendItem.\n  on('mouseover', function (d) {\n    calendar.legendTip.show(d, this);\n  }).\n  on('mouseout', function () {\n    calendar.legendTip.hide();\n  });\n\n  legend.\n  transition().\n  duration(options.animationDuration).\n  attr('x', getLegendXPosition()).\n  attr('y', getLegendYPosition()).\n  attr('width', parent.getDim('width')).\n  attr('height', parent.getDim('height'));\n\n  legend.\n  select('g').\n  transition().\n  duration(options.animationDuration).\n  attr('transform', function () {\n    if (options.legendOrientation === 'vertical') {\n      return (\n        'rotate(90 ' +\n        options.legendCellSize / 2 +\n        ' ' +\n        options.legendCellSize / 2 +\n        ')');\n\n    }\n    return '';\n  });\n\n  function getLegendXPosition() {\n    switch (options.legendHorizontalPosition) {\n      case 'right':\n        if (\n        options.legendVerticalPosition === 'center' ||\n        options.legendVerticalPosition === 'middle')\n        {\n          return width + options.legendMargin[3];\n        }\n        return width - parent.getDim('width') - options.legendMargin[1];\n      case 'middle':\n      case 'center':\n        return Math.round(width / 2 - parent.getDim('width') / 2);\n      default:\n        return options.legendMargin[3];}\n\n  }\n\n  function getLegendYPosition() {\n    if (options.legendVerticalPosition === 'bottom') {\n      return (\n        calendar.graphDim.height +\n        options.legendMargin[0] -\n        options.domainGutter -\n        options.cellPadding);\n\n    }\n    return options.legendMargin[0];\n  }\n\n  calendar.resize();\n};\n\n/**\n * Return the dimension of the legend\n *\n * Takes into account rotation\n *\n * @param  string axis Width or height\n * @return int height or width in pixels\n */\nLegend.prototype.getDim = function (axis) {\n  'use strict';\n\n  var isHorizontal = this.calendar.options.legendOrientation === 'horizontal';\n\n  switch (axis) {\n    case 'width':\n      return this.dim[isHorizontal ? 'width' : 'height'];\n    case 'height':\n      return this.dim[isHorizontal ? 'height' : 'width'];}\n\n};\n\nLegend.prototype.buildColors = function () {\n  'use strict';\n\n  var options = this.calendar.options; // Shorter accessor for variable name mangling when minifying\n\n  if (options.legendColors === null) {\n    this.calendar.legendScale = null;\n    return false;\n  }\n\n  var _colorRange = [];\n\n  if (Array.isArray(options.legendColors)) {\n    _colorRange = options.legendColors;\n  } else if (\n  options.legendColors.hasOwnProperty('min') &&\n  options.legendColors.hasOwnProperty('max'))\n  {\n    _colorRange = [options.legendColors.min, options.legendColors.max];\n  } else {\n    options.legendColors = null;\n    return false;\n  }\n\n  var _legend = options.legend.slice(0);\n\n  if (_legend[0] > 0) {\n    _legend.unshift(0);\n  } else if (_legend[0] <= 0) {\n    // Let's guess the leftmost value, it we have to add one\n    _legend.unshift(\n    _legend[0] - (_legend[_legend.length - 1] - _legend[0]) / _legend.length);\n\n  }\n  var colorScale;\n  if (options.legendColors.hasOwnProperty('colorScale')) {\n    colorScale = options.legendColors.colorScale;\n  } else {\n    colorScale = d3.scale.\n    linear().\n    range(_colorRange).\n    interpolate(d3.interpolateHcl).\n    domain([d3.min(_legend), d3.max(_legend)]);\n  }\n\n  var legendColors = _legend.map(function (element) {\n    return colorScale(element);\n  });\n  this.calendar.legendScale = d3.scale.\n  threshold().\n  domain(options.legend).\n  range(legendColors);\n\n  return true;\n};\n\n/**\n * Return the classname on the legend for the specified value\n *\n * @param integer n Value associated to a date\n * @param bool withCssClass Whether to display the css class used to style the cell.\n *                          Disabling will allow styling directly via html fill attribute\n *\n * @return string Classname according to the legend\n */\nLegend.prototype.getClass = function (n, withCssClass) {\n  'use strict';\n\n  if (n === null || isNaN(n)) {\n    return '';\n  }\n\n  var index = [this.calendar.options.legend.length + 1];\n\n  for (\n  var i = 0, total = this.calendar.options.legend.length - 1;\n  i <= total;\n  i += 1)\n  {\n    if (this.calendar.options.legend[0] > 0 && n < 0) {\n      index = ['1', 'i'];\n      break;\n    }\n\n    if (n <= this.calendar.options.legend[i]) {\n      index = [i + 1];\n      break;\n    }\n  }\n\n  if (n === 0) {\n    index.push(0);\n  }\n\n  index.unshift('');\n  return (index.join(' r') + (withCssClass ? index.join(' q') : '')).trim();\n};\n\n/**\n * #source http://stackoverflow.com/a/383245/805649\n */\nfunction mergeRecursive(obj1, obj2) {\n  'use strict';\n\n  /*jshint forin:false */\n  for (var p in obj2) {\n    try {\n      // Property in destination object set; update its value.\n      if (obj2[p].constructor === Object) {\n        obj1[p] = mergeRecursive(obj1[p], obj2[p]);\n      } else {\n        obj1[p] = obj2[p];\n      }\n    } catch (e) {\n      // Property in destination object not set; create it and set its value.\n      obj1[p] = obj2[p];\n    }\n  }\n\n  return obj1;\n}\n\n/**\n * Check if 2 arrays are equals\n *\n * @link http://stackoverflow.com/a/14853974/805649\n * @param  array array the array to compare to\n * @return bool true of the 2 arrays are equals\n */\nfunction arrayEquals(arrayA, arrayB) {\n  'use strict';\n\n  // if the other array is a falsy value, return\n  if (!arrayB || !arrayA) {\n    return false;\n  }\n\n  // compare lengths - can save a lot of time\n  if (arrayA.length !== arrayB.length) {\n    return false;\n  }\n\n  for (var i = 0; i < arrayA.length; i += 1) {\n    // Check if we have nested arrays\n    if (arrayA[i] instanceof Array && arrayB[i] instanceof Array) {\n      // recurse into the nested arrays\n      if (!arrayEquals(arrayA[i], arrayB[i])) {\n        return false;\n      }\n    } else if (arrayA[i] !== arrayB[i]) {\n      // Warning - two different object instances will never be equal: {x:20} != {x:20}\n      return false;\n    }\n  }\n  return true;\n}\n\nexport default CalHeatMap;","map":{"version":3,"names":["d3tip","getContrastingColor","t","d3","require","window","CalHeatMap","self","tip","attr","direction","offset","html","d","options","timeFormatter","valueFormatter","v","legendTip","allowedDataType","itemSelector","paintOnLoad","range","cellSize","cellPadding","cellRadius","domainGutter","domainMargin","domain","subDomain","colLimit","rowLimit","weekStartOnMonday","start","Date","minDate","maxDate","data","dataType","dataPostPayload","dataRequestHeaders","considerMissingDataAsZero","loadOnInit","verticalOrientation","domainDynamicDimension","label","position","align","x","y","rotate","width","height","legend","displayLegend","legendCellSize","legendCellPadding","legendMargin","legendVerticalPosition","legendHorizontalPosition","legendOrientation","legendColors","highlight","itemName","domainLabelFormat","subDomainTitleFormat","empty","filled","subDomainDateFormat","subDomainTextFormat","legendTitleFormat","lower","inner","upper","animationDuration","nextSelector","previousSelector","itemNamespace","tooltip","onClick","afterLoad","afterLoadNextDomain","afterLoadPreviousDomain","onComplete","afterLoadData","timestamps","stdTimezoneOffset","date","jan","getFullYear","jul","Math","max","getTimezoneOffset","results","timestamp","value","parseInt","afterUpdate","onMaxDomainReached","onMinDomainReached","_domainType","min","name","level","maxItemNumber","defaultRowNumber","defaultColumnNumber","row","getSubDomainRowNumber","column","getSubDomainColumnNumber","floor","getMinutes","format","connector","extractUnit","getMonth","getDate","getHours","getTime","hour","getDayCountInMonth","getWeekDay","p","day","getDayCountInYear","getWeekNumber","getDayOfYear","week","getMonthWeekNumber","dt","weekDay","getDay","setDate","month","year","type","hasOwnProperty","lastInsertedSvg","_completed","_domains","map","graphDim","legendDim","NAVIGATE_LEFT","NAVIGATE_RIGHT","RESET_ALL_ON_UPDATE","RESET_SINGLE_ON_UPDATE","APPEND_ON_UPDATE","DEFAULT_LEGEND_MARGIN","root","_maxDomainReached","_minDomainReached","domainPosition","DomainPosition","Legend","legendScale","DSTDomain","_init","getDomain","set","getSubDomain","select","append","_initCalendar","call","verticalDomainLabel","domainVerticalLabelHeight","domainHorizontalLabelWidth","paint","on","event","preventDefault","loadNextDomain","loadPreviousDomain","redraw","domains","getDomainKeys","getDatas","length","pop","fill","checkIfMinDomainIsReached","checkIfMaxDomainIsReached","getNextDomain","w","outer","arguments","h","navigationDir","domainSvg","selectAll","reverse","enteringDomainDim","exitingDomainDim","svg","enter","getDomainPosition","classname","domainIndex","axis","domainDim","tmp","setPosition","getPositionFromIndex","shiftRightBy","getLast","shiftLeftBy","subDomainSvgGroup","rect","get","getHighlightClassName","positionSubDomainX","positionSubDomainY","selection","base","show","hide","text","formatDate","domainRotate","s","transition","duration","getPosition","tempWidth","tempHeight","exit","remove","resize","prototype","init","settings","parent","mergeRecursive","validateDomainType","validateSelector","indexOf","Error","error","console","log","message","getOptimalSubDomain","k","expandMarginSetting","expandDateSetting","expandItemName","parseColLimit","parseRowLimit","autoAddLegendMargin","autoAlignLabel","selector","canBeFalse","Element","substring","Array","isArray","slice","filter","addStyle","element","overflow","htmlClass","trim","split","pastDate","dateIsLessThan","sameDate","dateIsEqual","push","getClass","join","getSubDomainTitle","formatSubDomainText","rgb","formatStringWithObject","formatted","args","prop","regexp","RegExp","replace","triggerEvent","eventName","successArgs","skip","apply","itemNb","response","shift","reached","upperBound","minDomainIsReached","maxDomainIsReached","lowerBound","formatNumber","f","time","count","n","bound","loadNewDomains","end","newDomains","backward","i","total","buildSubDomain","datetimestamp","keys","sort","a","b","index","ceil","j","isNow","dateA","dateB","normalizedMillis","subdomain","monthFirstWeekNumber","getWeekNumberInYear","getEndOfMonth","jumpDate","step","setHours","setMonth","setFullYear","getMinuteDomain","stop","minutes","getHourDomain","hours","splice","abs","getDayDomain","days","getWeekDomain","weekStart","endDate","mondays","sundays","getMonthDomain","months","getYearDomain","years","computeDaySubDomainSize","computeMinSubDomainSize","computeHourSubDomainSize","computeWeekSubDomainSize","endOfMonth","endWeekNb","startWeekNb","getPreviousDomain","source","startDate","callback","updateMode","_callback","interpretCSV","parseDatas","url","parseURI","requestType","payload","xhr","json","csv","tsv","header","send","Object","forEach","key","array","temp","extractTime","domainUnit","has","isNaN","subDomainsData","str","toISOString","legendWidth","getDim","legendHeight","graphWidth","graphHeight","next","previous","jumpTo","reset","firstDomain","lastDomain","rewind","update","dataSource","setLegend","oldLegend","arrayEquals","buildColors","removeLegend","showLegend","destroy","each","getSVG","styles","whitelistStyles","filterStyles","attribute","property","getElement","e","dom","cs","getComputedStyle","item","getPropertyValue","css","currentStyle","string","style","l","XMLSerializer","serializeToString","positions","getKeys","dim","calendar","computeDim","legendItem","_legend","legendElement","insert","getLegendXPosition","getLegendYPosition","legendCellLayout","delay","legendCellRadius","down","up","round","isHorizontal","_colorRange","unshift","colorScale","scale","linear","interpolate","interpolateHcl","threshold","withCssClass","obj1","obj2","constructor","arrayA","arrayB"],"sources":["/Users/zhaorui/src/incubator-superset-internal/superset-frontend/plugins/legacy-plugin-chart-calendar/src/vendor/cal-heatmap.js"],"sourcesContent":["// [LICENSE TBD]\n/* Copied and altered from http://cal-heatmap.com/ , alterations around:\n * - tuning tooltips\n * - supporting multi-colors scales\n * - legend format\n * - UTC handling\n */\n\n/* eslint-disable */\n\nimport d3tip from 'd3-tip';\nimport { getContrastingColor, t } from '@superset-ui/core';\n\nvar d3 = typeof require === 'function' ? require('d3') : window.d3;\n\nvar d3 = typeof require === 'function' ? require('d3') : window.d3;\n\nvar CalHeatMap = function () {\n  'use strict';\n\n  var self = this;\n  self.tip = d3tip()\n    .attr('class', 'd3-tip')\n    .direction('n')\n    .offset([-5, 0])\n    .html(\n      d => `\n      ${self.options.timeFormatter(d.t)}: <strong>${self.options.valueFormatter(\n        d.v,\n      )}</strong>\n    `,\n    );\n  self.legendTip = d3tip()\n    .attr('class', 'd3-tip')\n    .direction('n')\n    .offset([-5, 0])\n    .html(d => self.options.valueFormatter(d));\n\n  this.allowedDataType = ['json', 'csv', 'tsv', 'txt'];\n\n  // Default settings\n  this.options = {\n    // selector string of the container to append the graph to\n    // Accept any string value accepted by document.querySelector or CSS3\n    // or an Element object\n    itemSelector: '#cal-heatmap',\n\n    // Whether to paint the calendar on init()\n    // Used by testsuite to reduce testing time\n    paintOnLoad: true,\n\n    // ================================================\n    // DOMAIN\n    // ================================================\n\n    // Number of domain to display on the graph\n    range: 12,\n\n    // Size of each cell, in pixel\n    cellSize: 10,\n\n    // Padding between each cell, in pixel\n    cellPadding: 2,\n\n    // For rounded subdomain rectangles, in pixels\n    cellRadius: 0,\n\n    domainGutter: 2,\n\n    domainMargin: [0, 0, 0, 0],\n\n    valueFormatter: d => d,\n\n    timeFormatter: d => d,\n\n    domain: 'hour',\n\n    subDomain: 'min',\n\n    // Number of columns to split the subDomains to\n    // If not null, will takes precedence over rowLimit\n    colLimit: null,\n\n    // Number of rows to split the subDomains to\n    // Will be ignored if colLimit is not null\n    rowLimit: null,\n\n    // First day of the week is Monday\n    // 0 to start the week on Sunday\n    weekStartOnMonday: true,\n\n    // Start date of the graph\n    // @default now\n    start: new Date(),\n\n    minDate: null,\n\n    maxDate: null,\n\n    // ================================================\n    // DATA\n    // ================================================\n\n    // Data source\n    // URL, where to fetch the original datas\n    data: '',\n\n    // Data type\n    // Default: json\n    dataType: this.allowedDataType[0],\n\n    // Payload sent when using POST http method\n    // Leave to null (default) for GET request\n    // Expect a string, formatted like \"a=b;c=d\"\n    dataPostPayload: null,\n\n    // Additional headers sent when requesting data\n    // Expect an object formatted like:\n    // { 'X-CSRF-TOKEN': 'token' }\n    dataRequestHeaders: null,\n\n    // Whether to consider missing date:value from the datasource\n    // as equal to 0, or just leave them as missing\n    considerMissingDataAsZero: false,\n\n    // Load remote data on calendar creation\n    // When false, the calendar will be left empty\n    loadOnInit: true,\n\n    // Calendar orientation\n    // false: display domains side by side\n    // true : display domains one under the other\n    verticalOrientation: false,\n\n    // Domain dynamic width/height\n    // The width on a domain depends on the number of\n    domainDynamicDimension: true,\n\n    // Domain Label properties\n    label: {\n      // valid: top, right, bottom, left\n      position: 'bottom',\n\n      // Valid: left, center, right\n      // Also valid are the direct svg values: start, middle, end\n      align: 'center',\n\n      // By default, there is no margin/padding around the label\n      offset: {\n        x: 0,\n        y: 0,\n      },\n\n      rotate: null,\n\n      // Used only on vertical orientation\n      width: 100,\n\n      // Used only on horizontal orientation\n      height: null,\n    },\n\n    // ================================================\n    // LEGEND\n    // ================================================\n\n    // Threshold for the legend\n    legend: [10, 20, 30, 40],\n\n    // Whether to display the legend\n    displayLegend: true,\n\n    legendCellSize: 10,\n\n    legendCellPadding: 2,\n\n    legendMargin: [0, 0, 0, 0],\n\n    // Legend vertical position\n    // top: place legend above calendar\n    // bottom: place legend below the calendar\n    legendVerticalPosition: 'bottom',\n\n    // Legend horizontal position\n    // accepted values: left, center, right\n    legendHorizontalPosition: 'left',\n\n    // Legend rotation\n    // accepted values: horizontal, vertical\n    legendOrientation: 'horizontal',\n\n    // Objects holding all the heatmap different colors\n    // null to disable, and use the default css styles\n    //\n    // Examples:\n    // legendColors: {\n    //    min: \"green\",\n    //    max: \"red\",\n    //    empty: \"#ffffff\",\n    //    base: \"grey\",\n    //    overflow: \"red\",\n    //    colorScaler: null,\n    // }\n    legendColors: null,\n\n    // ================================================\n    // HIGHLIGHT\n    // ================================================\n\n    // List of dates to highlight\n    // Valid values:\n    // - []: don't highlight anything\n    // - \"now\": highlight the current date\n    // - an array of Date objects: highlight the specified dates\n    highlight: [],\n\n    // ================================================\n    // TEXT FORMATTING / i18n\n    // ================================================\n\n    // Name of the items to represent in the calendar\n    itemName: ['item', 'items'],\n\n    // Formatting of the domain label\n    // @default: null, will use the formatting according to domain type\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    domainLabelFormat: null,\n\n    // Formatting of the title displayed when hovering a subDomain cell\n    subDomainTitleFormat: {\n      empty: '{date}',\n      filled: '{count} {name} {connector} {date}',\n    },\n\n    // Formatting of the {date} used in subDomainTitleFormat\n    // @default: null, will use the formatting according to subDomain type\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    subDomainDateFormat: null,\n\n    // Formatting of the text inside each subDomain cell\n    // @default: null, no text\n    // Accept a string used as specifier by d3.time.format()\n    // or a function\n    //\n    // Refer to https://github.com/mbostock/d3/wiki/Time-Formatting\n    // for accepted date formatting used by d3.time.format()\n    subDomainTextFormat: null,\n\n    // Formatting of the title displayed when hovering a legend cell\n    legendTitleFormat: {\n      lower: t('less than {min} {name}'),\n      inner: t('between {down} and {up} {name}'),\n      upper: t('more than {max} {name}'),\n    },\n\n    // Animation duration, in ms\n    animationDuration: 500,\n\n    nextSelector: false,\n\n    previousSelector: false,\n\n    itemNamespace: 'cal-heatmap',\n\n    tooltip: false,\n\n    // ================================================\n    // EVENTS CALLBACK\n    // ================================================\n\n    // Callback when clicking on a time block\n    onClick: null,\n\n    // Callback after painting the empty calendar\n    // Can be used to trigger an API call, once the calendar is ready to be filled\n    afterLoad: null,\n\n    // Callback after loading the next domain in the calendar\n    afterLoadNextDomain: null,\n\n    // Callback after loading the previous domain in the calendar\n    afterLoadPreviousDomain: null,\n\n    // Callback after finishing all actions on the calendar\n    onComplete: null,\n\n    // Callback after fetching the datas, but before applying them to the calendar\n    // Used mainly to convert the datas if they're not formatted like expected\n    // Takes the fetched \"data\" object as argument, must return a json object\n    // formatted like {timestamp:count, timestamp2:count2},\n    afterLoadData: function (timestamps) {\n      // See https://github.com/wa0x6e/cal-heatmap/issues/126#issuecomment-373301803\n      const stdTimezoneOffset = date => {\n        const jan = new Date(date.getFullYear(), 0, 1);\n        const jul = new Date(date.getFullYear(), 6, 1);\n        return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());\n      };\n      const offset = stdTimezoneOffset(new Date()) * 60;\n      let results = {};\n      for (let timestamp in timestamps) {\n        const value = timestamps[timestamp];\n        timestamp = parseInt(timestamp, 10);\n        results[timestamp + offset] = value;\n      }\n      return results;\n    },\n\n    // Callback triggered after calling and completing update().\n    afterUpdate: null,\n\n    // Callback triggered after calling next().\n    // The `status` argument is equal to true if there is no\n    // more next domain to load\n    //\n    // This callback is also executed once, after calling previous(),\n    // only when the max domain is reached\n    onMaxDomainReached: null,\n\n    // Callback triggered after calling previous().\n    // The `status` argument is equal to true if there is no\n    // more previous domain to load\n    //\n    // This callback is also executed once, after calling next(),\n    // only when the min domain is reached\n    onMinDomainReached: null,\n  };\n\n  this._domainType = {\n    min: {\n      name: 'minute',\n      level: 10,\n      maxItemNumber: 60,\n      defaultRowNumber: 10,\n      defaultColumnNumber: 6,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          return Math.floor(d.getMinutes() / self._domainType.min.row(d));\n        },\n        y: function (d) {\n          return d.getMinutes() % self._domainType.min.row(d);\n        },\n      },\n      format: {\n        date: '%H:%M, %A %B %-e, %Y',\n        legend: '',\n        connector: 'at',\n      },\n      extractUnit: function (d) {\n        return new Date(\n          d.getFullYear(),\n          d.getMonth(),\n          d.getDate(),\n          d.getHours(),\n          d.getMinutes(),\n        ).getTime();\n      },\n    },\n    hour: {\n      name: 'hour',\n      level: 20,\n      maxItemNumber: function (d) {\n        switch (self.options.domain) {\n          case 'day':\n            return 24;\n          case 'week':\n            return 24 * 7;\n          case 'month':\n            return (\n              24 *\n              (self.options.domainDynamicDimension\n                ? self.getDayCountInMonth(d)\n                : 31)\n            );\n        }\n      },\n      defaultRowNumber: 6,\n      defaultColumnNumber: function (d) {\n        switch (self.options.domain) {\n          case 'day':\n            return 4;\n          case 'week':\n            return 28;\n          case 'month':\n            return self.options.domainDynamicDimension\n              ? self.getDayCountInMonth(d)\n              : 31;\n        }\n      },\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          if (self.options.domain === 'month') {\n            if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n              return Math.floor(\n                (d.getHours() + (d.getDate() - 1) * 24) /\n                  self._domainType.hour.row(d),\n              );\n            }\n            return (\n              Math.floor(d.getHours() / self._domainType.hour.row(d)) +\n              (d.getDate() - 1) * 4\n            );\n          } else if (self.options.domain === 'week') {\n            if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n              return Math.floor(\n                (d.getHours() + self.getWeekDay(d) * 24) /\n                  self._domainType.hour.row(d),\n              );\n            }\n            return (\n              Math.floor(d.getHours() / self._domainType.hour.row(d)) +\n              self.getWeekDay(d) * 4\n            );\n          }\n          return Math.floor(d.getHours() / self._domainType.hour.row(d));\n        },\n        y: function (d) {\n          var p = d.getHours();\n          if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n            switch (self.options.domain) {\n              case 'month':\n                p += (d.getDate() - 1) * 24;\n                break;\n              case 'week':\n                p += self.getWeekDay(d) * 24;\n                break;\n            }\n          }\n          return Math.floor(p % self._domainType.hour.row(d));\n        },\n      },\n      format: {\n        date: '%Hh, %A %B %-e, %Y',\n        legend: '%H:00',\n        connector: 'at',\n      },\n      extractUnit: function (d) {\n        return new Date(\n          d.getFullYear(),\n          d.getMonth(),\n          d.getDate(),\n          d.getHours(),\n        ).getTime();\n      },\n    },\n    day: {\n      name: 'day',\n      level: 30,\n      maxItemNumber: function (d) {\n        switch (self.options.domain) {\n          case 'week':\n            return 7;\n          case 'month':\n            return self.options.domainDynamicDimension\n              ? self.getDayCountInMonth(d)\n              : 31;\n          case 'year':\n            return self.options.domainDynamicDimension\n              ? self.getDayCountInYear(d)\n              : 366;\n        }\n      },\n      defaultColumnNumber: function (d) {\n        d = new Date(d);\n        switch (self.options.domain) {\n          case 'week':\n            return 1;\n          case 'month':\n            return self.options.domainDynamicDimension &&\n              !self.options.verticalOrientation\n              ? self.getWeekNumber(\n                  new Date(d.getFullYear(), d.getMonth() + 1, 0),\n                ) -\n                  self.getWeekNumber(d) +\n                  1\n              : 6;\n          case 'year':\n            return self.options.domainDynamicDimension\n              ? self.getWeekNumber(new Date(d.getFullYear(), 11, 31)) -\n                  self.getWeekNumber(new Date(d.getFullYear(), 0)) +\n                  1\n              : 54;\n        }\n      },\n      defaultRowNumber: 7,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          switch (self.options.domain) {\n            case 'week':\n              return Math.floor(\n                self.getWeekDay(d) / self._domainType.day.row(d),\n              );\n            case 'month':\n              if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n                return Math.floor(\n                  (d.getDate() - 1) / self._domainType.day.row(d),\n                );\n              }\n              return (\n                self.getWeekNumber(d) -\n                self.getWeekNumber(new Date(d.getFullYear(), d.getMonth()))\n              );\n            case 'year':\n              if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n                return Math.floor(\n                  (self.getDayOfYear(d) - 1) / self._domainType.day.row(d),\n                );\n              }\n              return self.getWeekNumber(d);\n          }\n        },\n        y: function (d) {\n          var p = self.getWeekDay(d);\n          if (self.options.colLimit > 0 || self.options.rowLimit > 0) {\n            switch (self.options.domain) {\n              case 'year':\n                p = self.getDayOfYear(d) - 1;\n                break;\n              case 'week':\n                p = self.getWeekDay(d);\n                break;\n              case 'month':\n                p = d.getDate() - 1;\n                break;\n            }\n          }\n          return Math.floor(p % self._domainType.day.row(d));\n        },\n      },\n      format: {\n        date: '%A %B %-e, %Y',\n        legend: '%e %b',\n        connector: 'on',\n      },\n      extractUnit: function (d) {\n        return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();\n      },\n    },\n    week: {\n      name: 'week',\n      level: 40,\n      maxItemNumber: 54,\n      defaultColumnNumber: function (d) {\n        d = new Date(d);\n        switch (self.options.domain) {\n          case 'year':\n            return self._domainType.week.maxItemNumber;\n          case 'month':\n            return self.options.domainDynamicDimension\n              ? self.getWeekNumber(\n                  new Date(d.getFullYear(), d.getMonth() + 1, 0),\n                ) - self.getWeekNumber(d)\n              : 5;\n        }\n      },\n      defaultRowNumber: 1,\n      row: function (d) {\n        return self.getSubDomainRowNumber(d);\n      },\n      column: function (d) {\n        return self.getSubDomainColumnNumber(d);\n      },\n      position: {\n        x: function (d) {\n          switch (self.options.domain) {\n            case 'year':\n              return Math.floor(\n                self.getWeekNumber(d) / self._domainType.week.row(d),\n              );\n            case 'month':\n              return Math.floor(\n                self.getMonthWeekNumber(d) / self._domainType.week.row(d),\n              );\n          }\n        },\n        y: function (d) {\n          return self.getWeekNumber(d) % self._domainType.week.row(d);\n        },\n      },\n      format: {\n        date: '%B Week #%W',\n        legend: '%B Week #%W',\n        connector: 'in',\n      },\n      extractUnit: function (d) {\n        var dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n        // According to ISO-8601, week number computation are based on week starting on Monday\n        var weekDay = dt.getDay() - (self.options.weekStartOnMonday ? 1 : 0);\n        if (weekDay < 0) {\n          weekDay = 6;\n        }\n        dt.setDate(dt.getDate() - weekDay);\n        return dt.getTime();\n      },\n    },\n    month: {\n      name: 'month',\n      level: 50,\n      maxItemNumber: 12,\n      defaultColumnNumber: 12,\n      defaultRowNumber: 1,\n      row: function () {\n        return self.getSubDomainRowNumber();\n      },\n      column: function () {\n        return self.getSubDomainColumnNumber();\n      },\n      position: {\n        x: function (d) {\n          return Math.floor(d.getMonth() / self._domainType.month.row(d));\n        },\n        y: function (d) {\n          return d.getMonth() % self._domainType.month.row(d);\n        },\n      },\n      format: {\n        date: '%B %Y',\n        legend: '%B',\n        connector: 'in',\n      },\n      extractUnit: function (d) {\n        return new Date(d.getFullYear(), d.getMonth()).getTime();\n      },\n    },\n    year: {\n      name: 'year',\n      level: 60,\n      row: function () {\n        return self.options.rowLimit || 1;\n      },\n      column: function () {\n        return self.options.colLimit || 1;\n      },\n      position: {\n        x: function () {\n          return 1;\n        },\n        y: function () {\n          return 1;\n        },\n      },\n      format: {\n        date: '%Y',\n        legend: '%Y',\n        connector: 'in',\n      },\n      extractUnit: function (d) {\n        return new Date(d.getFullYear()).getTime();\n      },\n    },\n  };\n\n  for (var type in this._domainType) {\n    if (this._domainType.hasOwnProperty(type)) {\n      var d = this._domainType[type];\n      this._domainType['x_' + type] = {\n        name: 'x_' + type,\n        level: d.type,\n        maxItemNumber: d.maxItemNumber,\n        defaultRowNumber: d.defaultRowNumber,\n        defaultColumnNumber: d.defaultColumnNumber,\n        row: d.column,\n        column: d.row,\n        position: {\n          x: d.position.y,\n          y: d.position.x,\n        },\n        format: d.format,\n        extractUnit: d.extractUnit,\n      };\n    }\n  }\n\n  // Record the address of the last inserted domain when browsing\n  this.lastInsertedSvg = null;\n\n  this._completed = false;\n\n  // Record all the valid domains\n  // Each domain value is a timestamp in milliseconds\n  this._domains = d3.map();\n\n  this.graphDim = {\n    width: 0,\n    height: 0,\n  };\n\n  this.legendDim = {\n    width: 0,\n    height: 0,\n  };\n\n  this.NAVIGATE_LEFT = 1;\n  this.NAVIGATE_RIGHT = 2;\n\n  // Various update mode when using the update() API\n  this.RESET_ALL_ON_UPDATE = 0;\n  this.RESET_SINGLE_ON_UPDATE = 1;\n  this.APPEND_ON_UPDATE = 2;\n\n  this.DEFAULT_LEGEND_MARGIN = 10;\n\n  this.root = null;\n  this.tooltip = null;\n\n  this._maxDomainReached = false;\n  this._minDomainReached = false;\n\n  this.domainPosition = new DomainPosition();\n  this.Legend = null;\n  this.legendScale = null;\n\n  // List of domains that are skipped because of DST\n  // All times belonging to these domains should be re-assigned to the previous domain\n  this.DSTDomain = [];\n\n  /**\n   * Display the graph for the first time\n   * @return bool True if the calendar is created\n   */\n  this._init = function () {\n    self\n      .getDomain(self.options.start)\n      .map(function (d) {\n        return d.getTime();\n      })\n      .map(function (d) {\n        self._domains.set(\n          d,\n          self.getSubDomain(d).map(function (d) {\n            return {\n              t: self._domainType[self.options.subDomain].extractUnit(d),\n              v: null,\n            };\n          }),\n        );\n      });\n\n    self.root = d3\n      .select(self.options.itemSelector)\n      .append('svg')\n      .attr('class', 'cal-heatmap-container');\n\n    self.root.attr('x', 0).attr('y', 0).append('svg').attr('class', 'graph');\n\n    self.Legend = new Legend(self);\n\n    if (self.options.paintOnLoad) {\n      _initCalendar();\n    }\n    self.root.call(self.tip);\n    self.root.call(self.legendTip);\n\n    return true;\n  };\n\n  function _initCalendar() {\n    self.verticalDomainLabel =\n      self.options.label.position === 'top' ||\n      self.options.label.position === 'bottom';\n\n    self.domainVerticalLabelHeight =\n      self.options.label.height === null\n        ? Math.max(25, self.options.cellSize * 2)\n        : self.options.label.height;\n    self.domainHorizontalLabelWidth = 0;\n\n    if (\n      self.options.domainLabelFormat === '' &&\n      self.options.label.height === null\n    ) {\n      self.domainVerticalLabelHeight = 0;\n    }\n\n    if (!self.verticalDomainLabel) {\n      self.domainVerticalLabelHeight = 0;\n      self.domainHorizontalLabelWidth = self.options.label.width;\n    }\n\n    self.paint();\n\n    // =========================================================================//\n    // ATTACHING DOMAIN NAVIGATION EVENT                    //\n    // =========================================================================//\n    if (self.options.nextSelector !== false) {\n      d3.select(self.options.nextSelector).on(\n        'click.' + self.options.itemNamespace,\n        function () {\n          d3.event.preventDefault();\n          return self.loadNextDomain(1);\n        },\n      );\n    }\n\n    if (self.options.previousSelector !== false) {\n      d3.select(self.options.previousSelector).on(\n        'click.' + self.options.itemNamespace,\n        function () {\n          d3.event.preventDefault();\n          return self.loadPreviousDomain(1);\n        },\n      );\n    }\n\n    self.Legend.redraw(\n      self.graphDim.width -\n        self.options.domainGutter -\n        self.options.cellPadding,\n    );\n    self.afterLoad();\n\n    var domains = self.getDomainKeys();\n\n    // Fill the graph with some datas\n    if (self.options.loadOnInit) {\n      self.getDatas(\n        self.options.data,\n        new Date(domains[0]),\n        self.getSubDomain(domains[domains.length - 1]).pop(),\n        function () {\n          self.fill();\n          self.onComplete();\n        },\n      );\n    } else {\n      self.onComplete();\n    }\n\n    self.checkIfMinDomainIsReached(domains[0]);\n    self.checkIfMaxDomainIsReached(self.getNextDomain().getTime());\n  }\n\n  // Return the width of the domain block, without the domain gutter\n  // @param int d Domain start timestamp\n  function w(d, outer) {\n    var width =\n      self.options.cellSize *\n        self._domainType[self.options.subDomain].column(d) +\n      self.options.cellPadding *\n        self._domainType[self.options.subDomain].column(d);\n    if (arguments.length === 2 && outer === true) {\n      return (width +=\n        self.domainHorizontalLabelWidth +\n        self.options.domainGutter +\n        self.options.domainMargin[1] +\n        self.options.domainMargin[3]);\n    }\n    return width;\n  }\n\n  // Return the height of the domain block, without the domain gutter\n  function h(d, outer) {\n    var height =\n      self.options.cellSize * self._domainType[self.options.subDomain].row(d) +\n      self.options.cellPadding *\n        self._domainType[self.options.subDomain].row(d);\n    if (arguments.length === 2 && outer === true) {\n      height +=\n        self.options.domainGutter +\n        self.domainVerticalLabelHeight +\n        self.options.domainMargin[0] +\n        self.options.domainMargin[2];\n    }\n    return height;\n  }\n\n  /**\n   *\n   *\n   * @param int navigationDir\n   */\n  this.paint = function (navigationDir) {\n    var options = self.options;\n\n    if (arguments.length === 0) {\n      navigationDir = false;\n    }\n\n    // Painting all the domains\n    var domainSvg = self.root\n      .select('.graph')\n      .selectAll('.graph-domain')\n      .data(\n        function () {\n          var data = self.getDomainKeys();\n          return navigationDir === self.NAVIGATE_LEFT ? data.reverse() : data;\n        },\n        function (d) {\n          return d;\n        },\n      );\n    var enteringDomainDim = 0;\n    var exitingDomainDim = 0;\n\n    // =========================================================================//\n    // PAINTING DOMAIN                              //\n    // =========================================================================//\n\n    var svg = domainSvg\n      .enter()\n      .append('svg')\n      .attr('width', function (d) {\n        return w(d, true);\n      })\n      .attr('height', function (d) {\n        return h(d, true);\n      })\n      .attr('x', function (d) {\n        if (options.verticalOrientation) {\n          self.graphDim.width = Math.max(self.graphDim.width, w(d, true));\n          return 0;\n        } else {\n          return getDomainPosition(d, self.graphDim, 'width', w(d, true));\n        }\n      })\n      .attr('y', function (d) {\n        if (options.verticalOrientation) {\n          return getDomainPosition(d, self.graphDim, 'height', h(d, true));\n        } else {\n          self.graphDim.height = Math.max(self.graphDim.height, h(d, true));\n          return 0;\n        }\n      })\n      .attr('class', function (d) {\n        var classname = 'graph-domain';\n        var date = new Date(d);\n        switch (options.domain) {\n          case 'hour':\n            classname += ' h_' + date.getHours();\n          /* falls through */\n          case 'day':\n            classname += ' d_' + date.getDate() + ' dy_' + date.getDay();\n          /* falls through */\n          case 'week':\n            classname += ' w_' + self.getWeekNumber(date);\n          /* falls through */\n          case 'month':\n            classname += ' m_' + (date.getMonth() + 1);\n          /* falls through */\n          case 'year':\n            classname += ' y_' + date.getFullYear();\n        }\n        return classname;\n      });\n    self.lastInsertedSvg = svg;\n\n    function getDomainPosition(domainIndex, graphDim, axis, domainDim) {\n      var tmp = 0;\n      switch (navigationDir) {\n        case false:\n          tmp = graphDim[axis];\n\n          graphDim[axis] += domainDim;\n          self.domainPosition.setPosition(domainIndex, tmp);\n          return tmp;\n\n        case self.NAVIGATE_RIGHT:\n          self.domainPosition.setPosition(domainIndex, graphDim[axis]);\n\n          enteringDomainDim = domainDim;\n          exitingDomainDim = self.domainPosition.getPositionFromIndex(1);\n\n          self.domainPosition.shiftRightBy(exitingDomainDim);\n          return graphDim[axis];\n\n        case self.NAVIGATE_LEFT:\n          tmp = -domainDim;\n\n          enteringDomainDim = -tmp;\n          exitingDomainDim = graphDim[axis] - self.domainPosition.getLast();\n\n          self.domainPosition.setPosition(domainIndex, tmp);\n          self.domainPosition.shiftLeftBy(enteringDomainDim);\n          return tmp;\n      }\n    }\n\n    svg\n      .append('rect')\n      .attr('width', function (d) {\n        return w(d, true) - options.domainGutter - options.cellPadding;\n      })\n      .attr('height', function (d) {\n        return h(d, true) - options.domainGutter - options.cellPadding;\n      })\n      .attr('class', 'domain-background');\n\n    // =========================================================================//\n    // PAINTING SUBDOMAINS                            //\n    // =========================================================================//\n    var subDomainSvgGroup = svg\n      .append('svg')\n      .attr('x', function () {\n        if (options.label.position === 'left') {\n          return self.domainHorizontalLabelWidth + options.domainMargin[3];\n        } else {\n          return options.domainMargin[3];\n        }\n      })\n      .attr('y', function () {\n        if (options.label.position === 'top') {\n          return self.domainVerticalLabelHeight + options.domainMargin[0];\n        } else {\n          return options.domainMargin[0];\n        }\n      })\n      .attr('class', 'graph-subdomain-group');\n    var rect = subDomainSvgGroup\n      .selectAll('g')\n      .data(function (d) {\n        return self._domains.get(d);\n      })\n      .enter()\n      .append('g');\n    rect\n      .append('rect')\n      .attr('class', function (d) {\n        return (\n          'graph-rect' +\n          self.getHighlightClassName(d.t) +\n          (options.onClick !== null ? ' hover_cursor' : '')\n        );\n      })\n      .attr('width', options.cellSize)\n      .attr('height', options.cellSize)\n      .attr('x', function (d) {\n        return self.positionSubDomainX(d.t);\n      })\n      .attr('y', function (d) {\n        return self.positionSubDomainY(d.t);\n      })\n      .on('click', function (d) {\n        if (options.onClick !== null) {\n          return self.onClick(new Date(d.t), d.v);\n        }\n      })\n      .call(function (selection) {\n        if (options.cellRadius > 0) {\n          selection\n            .attr('rx', options.cellRadius)\n            .attr('ry', options.cellRadius);\n        }\n\n        if (\n          self.legendScale !== null &&\n          options.legendColors !== null &&\n          options.legendColors.hasOwnProperty('base')\n        ) {\n          selection.attr('fill', options.legendColors.base);\n        }\n\n        if (options.tooltip) {\n          selection\n            .on('mouseover', function (d) {\n              self.tip.show(d, this);\n            })\n            .on('mouseout', function () {\n              self.tip.hide(d);\n            });\n        }\n      });\n\n    // Appending a title to each subdomain\n    if (!options.tooltip) {\n      rect.append('title').text(function (d) {\n        return self.formatDate(new Date(d.t), options.subDomainDateFormat);\n      });\n    }\n\n    // =========================================================================//\n    // PAINTING LABEL                              //\n    // =========================================================================//\n    if (options.domainLabelFormat !== '') {\n      svg\n        .append('text')\n        .attr('class', 'graph-label')\n        .attr('y', function (d) {\n          var y = options.domainMargin[0];\n          switch (options.label.position) {\n            case 'top':\n              y += self.domainVerticalLabelHeight / 2;\n              break;\n            case 'bottom':\n              y += h(d) + self.domainVerticalLabelHeight / 2;\n          }\n\n          return (\n            y +\n            options.label.offset.y *\n              ((options.label.rotate === 'right' &&\n                options.label.position === 'right') ||\n              (options.label.rotate === 'left' &&\n                options.label.position === 'left')\n                ? -1\n                : 1)\n          );\n        })\n        .attr('x', function (d) {\n          var x = options.domainMargin[3];\n          switch (options.label.position) {\n            case 'right':\n              x += w(d);\n              break;\n            case 'bottom':\n            case 'top':\n              x += w(d) / 2;\n          }\n\n          if (options.label.align === 'right') {\n            return (\n              x +\n              self.domainHorizontalLabelWidth -\n              options.label.offset.x *\n                (options.label.rotate === 'right' ? -1 : 1)\n            );\n          }\n          return x + options.label.offset.x;\n        })\n        .attr('text-anchor', function () {\n          switch (options.label.align) {\n            case 'start':\n            case 'left':\n              return 'start';\n            case 'end':\n            case 'right':\n              return 'end';\n            default:\n              return 'middle';\n          }\n        })\n        .attr('dominant-baseline', function () {\n          return self.verticalDomainLabel ? 'middle' : 'top';\n        })\n        .text(function (d) {\n          return self.formatDate(new Date(d), options.domainLabelFormat);\n        })\n        .call(domainRotate);\n    }\n\n    function domainRotate(selection) {\n      switch (options.label.rotate) {\n        case 'right':\n          selection.attr('transform', function (d) {\n            var s = 'rotate(90), ';\n            switch (options.label.position) {\n              case 'right':\n                s += 'translate(-' + w(d) + ' , -' + w(d) + ')';\n                break;\n              case 'left':\n                s += 'translate(0, -' + self.domainHorizontalLabelWidth + ')';\n                break;\n            }\n\n            return s;\n          });\n          break;\n        case 'left':\n          selection.attr('transform', function (d) {\n            var s = 'rotate(270), ';\n            switch (options.label.position) {\n              case 'right':\n                s +=\n                  'translate(-' +\n                  (w(d) + self.domainHorizontalLabelWidth) +\n                  ' , ' +\n                  w(d) +\n                  ')';\n                break;\n              case 'left':\n                s +=\n                  'translate(-' +\n                  self.domainHorizontalLabelWidth +\n                  ' , ' +\n                  self.domainHorizontalLabelWidth +\n                  ')';\n                break;\n            }\n\n            return s;\n          });\n          break;\n      }\n    }\n\n    // =========================================================================//\n    // PAINTING DOMAIN SUBDOMAIN CONTENT                    //\n    // =========================================================================//\n    if (options.subDomainTextFormat !== null) {\n      rect\n        .append('text')\n        .attr('class', function (d) {\n          return 'subdomain-text' + self.getHighlightClassName(d.t);\n        })\n        .attr('x', function (d) {\n          return self.positionSubDomainX(d.t) + options.cellSize / 2;\n        })\n        .attr('y', function (d) {\n          return self.positionSubDomainY(d.t) + options.cellSize / 2;\n        })\n        .attr('text-anchor', 'middle')\n        .attr('dominant-baseline', 'central')\n        .text(function (d) {\n          return self.formatDate(new Date(d.t), options.subDomainTextFormat);\n        });\n    }\n\n    // =========================================================================//\n    // ANIMATION                                //\n    // =========================================================================//\n\n    if (navigationDir !== false) {\n      domainSvg\n        .transition()\n        .duration(options.animationDuration)\n        .attr('x', function (d) {\n          return options.verticalOrientation\n            ? 0\n            : self.domainPosition.getPosition(d);\n        })\n        .attr('y', function (d) {\n          return options.verticalOrientation\n            ? self.domainPosition.getPosition(d)\n            : 0;\n        });\n    }\n\n    var tempWidth = self.graphDim.width;\n    var tempHeight = self.graphDim.height;\n\n    if (options.verticalOrientation) {\n      self.graphDim.height += enteringDomainDim - exitingDomainDim;\n    } else {\n      self.graphDim.width += enteringDomainDim - exitingDomainDim;\n    }\n\n    // At the time of exit, domainsWidth and domainsHeight already automatically shifted\n    domainSvg\n      .exit()\n      .transition()\n      .duration(options.animationDuration)\n      .attr('x', function (d) {\n        if (options.verticalOrientation) {\n          return 0;\n        } else {\n          switch (navigationDir) {\n            case self.NAVIGATE_LEFT:\n              return Math.min(self.graphDim.width, tempWidth);\n            case self.NAVIGATE_RIGHT:\n              return -w(d, true);\n          }\n        }\n      })\n      .attr('y', function (d) {\n        if (options.verticalOrientation) {\n          switch (navigationDir) {\n            case self.NAVIGATE_LEFT:\n              return Math.min(self.graphDim.height, tempHeight);\n            case self.NAVIGATE_RIGHT:\n              return -h(d, true);\n          }\n        } else {\n          return 0;\n        }\n      })\n      .remove();\n\n    // Resize the root container\n    self.resize();\n  };\n};\n\nCalHeatMap.prototype = {\n  /**\n   * Validate and merge user settings with default settings\n   *\n   * @param  {object} settings User settings\n   * @return {bool} False if settings contains error\n   */\n  /* jshint maxstatements:false */\n  init: function (settings) {\n    'use strict';\n\n    var parent = this;\n\n    var options = (parent.options = mergeRecursive(parent.options, settings));\n\n    // Fatal errors\n    // Stop script execution on error\n    validateDomainType();\n    validateSelector(options.itemSelector, false, 'itemSelector');\n\n    if (parent.allowedDataType.indexOf(options.dataType) === -1) {\n      throw new Error(\n        \"The data type '\" + options.dataType + \"' is not valid data type\",\n      );\n    }\n\n    if (d3.select(options.itemSelector)[0][0] === null) {\n      throw new Error(\n        \"The node '\" +\n          options.itemSelector +\n          \"' specified in itemSelector does not exists\",\n      );\n    }\n\n    try {\n      validateSelector(options.nextSelector, true, 'nextSelector');\n      validateSelector(options.previousSelector, true, 'previousSelector');\n    } catch (error) {\n      console.log(error.message);\n      return false;\n    }\n\n    // If other settings contains error, will fallback to default\n\n    if (!settings.hasOwnProperty('subDomain')) {\n      this.options.subDomain = getOptimalSubDomain(settings.domain);\n    }\n\n    if (\n      typeof options.itemNamespace !== 'string' ||\n      options.itemNamespace === ''\n    ) {\n      console.log(\n        'itemNamespace can not be empty, falling back to cal-heatmap',\n      );\n      options.itemNamespace = 'cal-heatmap';\n    }\n\n    // Don't touch these settings\n    var s = [\n      'data',\n      'onComplete',\n      'onClick',\n      'afterLoad',\n      'afterLoadData',\n      'afterLoadPreviousDomain',\n      'afterLoadNextDomain',\n      'afterUpdate',\n    ];\n\n    for (var k in s) {\n      if (settings.hasOwnProperty(s[k])) {\n        options[s[k]] = settings[s[k]];\n      }\n    }\n\n    options.subDomainDateFormat =\n      typeof options.subDomainDateFormat === 'string' ||\n      typeof options.subDomainDateFormat === 'function'\n        ? options.subDomainDateFormat\n        : this._domainType[options.subDomain].format.date;\n    options.domainLabelFormat =\n      typeof options.domainLabelFormat === 'string' ||\n      typeof options.domainLabelFormat === 'function'\n        ? options.domainLabelFormat\n        : this._domainType[options.domain].format.legend;\n    options.subDomainTextFormat =\n      (typeof options.subDomainTextFormat === 'string' &&\n        options.subDomainTextFormat !== '') ||\n      typeof options.subDomainTextFormat === 'function'\n        ? options.subDomainTextFormat\n        : null;\n    options.domainMargin = expandMarginSetting(options.domainMargin);\n    options.legendMargin = expandMarginSetting(options.legendMargin);\n    options.highlight = parent.expandDateSetting(options.highlight);\n    options.itemName = expandItemName(options.itemName);\n    options.colLimit = parseColLimit(options.colLimit);\n    options.rowLimit = parseRowLimit(options.rowLimit);\n    if (!settings.hasOwnProperty('legendMargin')) {\n      autoAddLegendMargin();\n    }\n    autoAlignLabel();\n\n    /**\n     * Validate that a queryString is valid\n     *\n     * @param  {Element|string|bool} selector   The queryString to test\n     * @param  {bool}  canBeFalse  Whether false is an accepted and valid value\n     * @param  {string} name    Name of the tested selector\n     * @throws {Error}        If the selector is not valid\n     * @return {bool}        True if the selector is a valid queryString\n     */\n    function validateSelector(selector, canBeFalse, name) {\n      if (\n        ((canBeFalse && selector === false) ||\n          selector instanceof Element ||\n          typeof selector === 'string') &&\n        selector !== ''\n      ) {\n        return true;\n      }\n      throw new Error('The ' + name + ' is not valid');\n    }\n\n    /**\n     * Return the optimal subDomain for the specified domain\n     *\n     * @param  {string} domain a domain name\n     * @return {string}        the subDomain name\n     */\n    function getOptimalSubDomain(domain) {\n      switch (domain) {\n        case 'year':\n          return 'month';\n        case 'month':\n          return 'day';\n        case 'week':\n          return 'day';\n        case 'day':\n          return 'hour';\n        default:\n          return 'min';\n      }\n    }\n\n    /**\n     * Ensure that the domain and subdomain are valid\n     *\n     * @throw {Error} when domain or subdomain are not valid\n     * @return {bool} True if domain and subdomain are valid and compatible\n     */\n    function validateDomainType() {\n      if (\n        !parent._domainType.hasOwnProperty(options.domain) ||\n        options.domain === 'min' ||\n        options.domain.substring(0, 2) === 'x_'\n      ) {\n        throw new Error(\"The domain '\" + options.domain + \"' is not valid\");\n      }\n\n      if (\n        !parent._domainType.hasOwnProperty(options.subDomain) ||\n        options.subDomain === 'year'\n      ) {\n        throw new Error(\n          \"The subDomain '\" + options.subDomain + \"' is not valid\",\n        );\n      }\n\n      if (\n        parent._domainType[options.domain].level <=\n        parent._domainType[options.subDomain].level\n      ) {\n        throw new Error(\n          \"'\" +\n            options.subDomain +\n            \"' is not a valid subDomain to '\" +\n            options.domain +\n            \"'\",\n        );\n      }\n\n      return true;\n    }\n\n    /**\n     * Fine-tune the label alignement depending on its position\n     *\n     * @return void\n     */\n    function autoAlignLabel() {\n      // Auto-align label, depending on it's position\n      if (\n        !settings.hasOwnProperty('label') ||\n        (settings.hasOwnProperty('label') &&\n          !settings.label.hasOwnProperty('align'))\n      ) {\n        switch (options.label.position) {\n          case 'left':\n            options.label.align = 'right';\n            break;\n          case 'right':\n            options.label.align = 'left';\n            break;\n          default:\n            options.label.align = 'center';\n        }\n\n        if (options.label.rotate === 'left') {\n          options.label.align = 'right';\n        } else if (options.label.rotate === 'right') {\n          options.label.align = 'left';\n        }\n      }\n\n      if (\n        !settings.hasOwnProperty('label') ||\n        (settings.hasOwnProperty('label') &&\n          !settings.label.hasOwnProperty('offset'))\n      ) {\n        if (\n          options.label.position === 'left' ||\n          options.label.position === 'right'\n        ) {\n          options.label.offset = {\n            x: 10,\n            y: 15,\n          };\n        }\n      }\n    }\n\n    /**\n     * If not specified, add some margin around the legend depending on its position\n     *\n     * @return void\n     */\n    function autoAddLegendMargin() {\n      switch (options.legendVerticalPosition) {\n        case 'top':\n          options.legendMargin[2] = parent.DEFAULT_LEGEND_MARGIN;\n          break;\n        case 'bottom':\n          options.legendMargin[0] = parent.DEFAULT_LEGEND_MARGIN;\n          break;\n        case 'middle':\n        case 'center':\n          options.legendMargin[\n            options.legendHorizontalPosition === 'right' ? 3 : 1\n          ] = parent.DEFAULT_LEGEND_MARGIN;\n      }\n    }\n\n    /**\n     * Expand a number of an array of numbers to an usable 4 values array\n     *\n     * @param  {integer|array} value\n     * @return {array}        array\n     */\n    function expandMarginSetting(value) {\n      if (typeof value === 'number') {\n        value = [value];\n      }\n\n      if (!Array.isArray(value)) {\n        console.log('Margin only takes an integer or an array of integers');\n        value = [0];\n      }\n\n      switch (value.length) {\n        case 1:\n          return [value[0], value[0], value[0], value[0]];\n        case 2:\n          return [value[0], value[1], value[0], value[1]];\n        case 3:\n          return [value[0], value[1], value[2], value[1]];\n        case 4:\n          return value;\n        default:\n          return value.slice(0, 4);\n      }\n    }\n\n    /**\n     * Convert a string to an array like [singular-form, plural-form]\n     *\n     * @param  {string|array} value Date to convert\n     * @return {array}       An array like [singular-form, plural-form]\n     */\n    function expandItemName(value) {\n      if (typeof value === 'string') {\n        return [value, value + (value !== '' ? 's' : '')];\n      }\n\n      if (Array.isArray(value)) {\n        if (value.length === 1) {\n          return [value[0], value[0] + 's'];\n        } else if (value.length > 2) {\n          return value.slice(0, 2);\n        }\n\n        return value;\n      }\n\n      return ['item', 'items'];\n    }\n\n    function parseColLimit(value) {\n      return value > 0 ? value : null;\n    }\n\n    function parseRowLimit(value) {\n      if (value > 0 && options.colLimit > 0) {\n        console.log(\n          'colLimit and rowLimit are mutually exclusive, rowLimit will be ignored',\n        );\n        return null;\n      }\n      return value > 0 ? value : null;\n    }\n\n    return this._init();\n  },\n\n  /**\n   * Convert a keyword or an array of keyword/date to an array of date objects\n   *\n   * @param  {string|array|Date} value Data to convert\n   * @return {array}       An array of Dates\n   */\n  expandDateSetting: function (value) {\n    'use strict';\n\n    if (!Array.isArray(value)) {\n      value = [value];\n    }\n\n    return value\n      .map(function (data) {\n        if (data === 'now') {\n          return new Date();\n        }\n        if (data instanceof Date) {\n          return data;\n        }\n        return false;\n      })\n      .filter(function (d) {\n        return d !== false;\n      });\n  },\n\n  /**\n   * Fill the calendar by coloring the cells\n   *\n   * @param array svg An array of html node to apply the transformation to (optional)\n   *                  It's used to limit the painting to only a subset of the calendar\n   * @return void\n   */\n  fill: function (svg) {\n    'use strict';\n\n    var parent = this;\n    var options = parent.options;\n\n    if (arguments.length === 0) {\n      svg = parent.root.selectAll('.graph-domain');\n    }\n\n    var rect = svg\n      .selectAll('svg')\n      .selectAll('g')\n      .data(function (d) {\n        return parent._domains.get(d);\n      });\n    /**\n     * Colorize the cell via a style attribute if enabled\n     */\n    function addStyle(element) {\n      if (parent.legendScale === null) {\n        return false;\n      }\n\n      element.attr('fill', function (d) {\n        if (\n          d.v === null &&\n          options.hasOwnProperty('considerMissingDataAsZero') &&\n          !options.considerMissingDataAsZero\n        ) {\n          if (options.legendColors.hasOwnProperty('base')) {\n            return options.legendColors.base;\n          }\n        }\n\n        if (\n          options.legendColors !== null &&\n          options.legendColors.hasOwnProperty('empty') &&\n          (d.v === 0 ||\n            (d.v === null &&\n              options.hasOwnProperty('considerMissingDataAsZero') &&\n              options.considerMissingDataAsZero))\n        ) {\n          return options.legendColors.empty;\n        }\n\n        if (\n          d.v < 0 &&\n          options.legend[0] > 0 &&\n          options.legendColors !== null &&\n          options.legendColors.hasOwnProperty('overflow')\n        ) {\n          return options.legendColors.overflow;\n        }\n\n        return parent.legendScale(\n          Math.min(d.v, options.legend[options.legend.length - 1]),\n        );\n      });\n    }\n\n    rect\n      .transition()\n      .duration(options.animationDuration)\n      .select('rect')\n      .attr('class', function (d) {\n        var htmlClass = parent.getHighlightClassName(d.t).trim().split(' ');\n        var pastDate = parent.dateIsLessThan(d.t, new Date());\n        var sameDate = parent.dateIsEqual(d.t, new Date());\n\n        if (\n          parent.legendScale === null ||\n          (d.v === null &&\n            options.hasOwnProperty('considerMissingDataAsZero') &&\n            !options.considerMissingDataAsZero &&\n            !options.legendColors.hasOwnProperty('base'))\n        ) {\n          htmlClass.push('graph-rect');\n        }\n\n        if (sameDate) {\n          htmlClass.push('now');\n        } else if (!pastDate) {\n          htmlClass.push('future');\n        }\n\n        if (d.v !== null) {\n          htmlClass.push(\n            parent.Legend.getClass(d.v, parent.legendScale === null),\n          );\n        } else if (options.considerMissingDataAsZero && pastDate) {\n          htmlClass.push(\n            parent.Legend.getClass(0, parent.legendScale === null),\n          );\n        }\n\n        if (options.onClick !== null) {\n          htmlClass.push('hover_cursor');\n        }\n\n        return htmlClass.join(' ');\n      })\n      .call(addStyle);\n\n    rect\n      .transition()\n      .duration(options.animationDuration)\n      .select('title')\n      .text(function (d) {\n        return parent.getSubDomainTitle(d);\n      });\n\n    function formatSubDomainText(element) {\n      if (typeof options.subDomainTextFormat === 'function') {\n        element.text(function (d) {\n          return options.subDomainTextFormat(d.t, d.v);\n        });\n      }\n    }\n\n    /**\n     * Change the subDomainText class if necessary\n     * Also change the text, e.g when text is representing the value\n     * instead of the date\n     */\n    rect\n      .transition()\n      .duration(options.animationDuration)\n      .select('text')\n      .attr('class', function (d) {\n        return 'subdomain-text' + parent.getHighlightClassName(d.t);\n      })\n      .call(formatSubDomainText)\n      .attr('fill', d => {\n        if (!d.v) return '#000';\n        const rgb = parent.legendScale(\n          Math.min(d.v, options.legend[options.legend.length - 1]),\n        );\n        return getContrastingColor(rgb, 135);\n      });\n  },\n\n  /**\n   * Sprintf like function.\n   * Replaces placeholders {0} in string with values from provided object.\n   *\n   * @param string formatted String containing placeholders.\n   * @param object args Object with properties to replace placeholders in string.\n   *\n   * @return String\n   */\n  formatStringWithObject: function (formatted, args) {\n    'use strict';\n    for (var prop in args) {\n      if (args.hasOwnProperty(prop)) {\n        var regexp = new RegExp('\\\\{' + prop + '\\\\}', 'gi');\n        formatted = formatted.replace(regexp, args[prop]);\n      }\n    }\n    return formatted;\n  },\n\n  // =========================================================================//\n  // EVENTS CALLBACK                              //\n  // =========================================================================//\n\n  /**\n   * Helper method for triggering event callback\n   *\n   * @param  string  eventName       Name of the event to trigger\n   * @param  array  successArgs     List of argument to pass to the callback\n   * @param  boolean  skip      Whether to skip the event triggering\n   * @return mixed  True when the triggering was skipped, false on error, else the callback function\n   */\n  triggerEvent: function (eventName, successArgs, skip) {\n    'use strict';\n\n    if ((arguments.length === 3 && skip) || this.options[eventName] === null) {\n      return true;\n    }\n\n    if (typeof this.options[eventName] === 'function') {\n      if (typeof successArgs === 'function') {\n        successArgs = successArgs();\n      }\n      return this.options[eventName].apply(this, successArgs);\n    } else {\n      console.log('Provided callback for ' + eventName + ' is not a function.');\n      return false;\n    }\n  },\n\n  /**\n   * Event triggered on a mouse click on a subDomain cell\n   *\n   * @param  Date    d    Date of the subdomain block\n   * @param  int    itemNb  Number of items in that date\n   */\n  onClick: function (d, itemNb) {\n    'use strict';\n\n    return this.triggerEvent('onClick', [d, itemNb]);\n  },\n\n  /**\n   * Event triggered after drawing the calendar, byt before filling it with data\n   */\n  afterLoad: function () {\n    'use strict';\n\n    return this.triggerEvent('afterLoad');\n  },\n\n  /**\n   * Event triggered after completing drawing and filling the calendar\n   */\n  onComplete: function () {\n    'use strict';\n\n    var response = this.triggerEvent('onComplete', [], this._completed);\n    this._completed = true;\n    return response;\n  },\n\n  /**\n   * Event triggered after shifting the calendar one domain back\n   *\n   * @param  Date    start  Domain start date\n   * @param  Date    end    Domain end date\n   */\n  afterLoadPreviousDomain: function (start) {\n    'use strict';\n\n    var parent = this;\n    return this.triggerEvent('afterLoadPreviousDomain', function () {\n      var subDomain = parent.getSubDomain(start);\n      return [subDomain.shift(), subDomain.pop()];\n    });\n  },\n\n  /**\n   * Event triggered after shifting the calendar one domain above\n   *\n   * @param  Date    start  Domain start date\n   * @param  Date    end    Domain end date\n   */\n  afterLoadNextDomain: function (start) {\n    'use strict';\n\n    var parent = this;\n    return this.triggerEvent('afterLoadNextDomain', function () {\n      var subDomain = parent.getSubDomain(start);\n      return [subDomain.shift(), subDomain.pop()];\n    });\n  },\n\n  /**\n   * Event triggered after loading the leftmost domain allowed by minDate\n   *\n   * @param  boolean  reached True if the leftmost domain was reached\n   */\n  onMinDomainReached: function (reached) {\n    'use strict';\n\n    this._minDomainReached = reached;\n    return this.triggerEvent('onMinDomainReached', [reached]);\n  },\n\n  /**\n   * Event triggered after loading the rightmost domain allowed by maxDate\n   *\n   * @param  boolean  reached True if the rightmost domain was reached\n   */\n  onMaxDomainReached: function (reached) {\n    'use strict';\n\n    this._maxDomainReached = reached;\n    return this.triggerEvent('onMaxDomainReached', [reached]);\n  },\n\n  checkIfMinDomainIsReached: function (date, upperBound) {\n    'use strict';\n\n    if (this.minDomainIsReached(date)) {\n      this.onMinDomainReached(true);\n    }\n\n    if (arguments.length === 2) {\n      if (this._maxDomainReached && !this.maxDomainIsReached(upperBound)) {\n        this.onMaxDomainReached(false);\n      }\n    }\n  },\n\n  checkIfMaxDomainIsReached: function (date, lowerBound) {\n    'use strict';\n\n    if (this.maxDomainIsReached(date)) {\n      this.onMaxDomainReached(true);\n    }\n\n    if (arguments.length === 2) {\n      if (this._minDomainReached && !this.minDomainIsReached(lowerBound)) {\n        this.onMinDomainReached(false);\n      }\n    }\n  },\n\n  afterUpdate: function () {\n    'use strict';\n\n    return this.triggerEvent('afterUpdate');\n  },\n\n  // =========================================================================//\n  // FORMATTER                                //\n  // =========================================================================//\n\n  formatNumber: d3.format(',g'),\n\n  formatDate: function (d, format) {\n    'use strict';\n\n    if (arguments.length < 2) {\n      format = 'title';\n    }\n\n    if (typeof format === 'function') {\n      return format(d);\n    } else {\n      var f = d3.time.format(format);\n      return f(d);\n    }\n  },\n\n  getSubDomainTitle: function (d) {\n    'use strict';\n\n    if (d.v === null && !this.options.considerMissingDataAsZero) {\n      return this.formatStringWithObject(\n        this.options.subDomainTitleFormat.empty,\n        {\n          date: this.formatDate(\n            new Date(d.t),\n            this.options.subDomainDateFormat,\n          ),\n        },\n      );\n    } else {\n      var value = d.v;\n      // Consider null as 0\n      if (value === null && this.options.considerMissingDataAsZero) {\n        value = 0;\n      }\n\n      return this.formatStringWithObject(\n        this.options.subDomainTitleFormat.filled,\n        {\n          count: this.formatNumber(value),\n          name: this.options.itemName[value !== 1 ? 1 : 0],\n          connector: this._domainType[this.options.subDomain].format.connector,\n          date: this.formatDate(\n            new Date(d.t),\n            this.options.subDomainDateFormat,\n          ),\n        },\n      );\n    }\n  },\n\n  // =========================================================================//\n  // DOMAIN NAVIGATION                            //\n  // =========================================================================//\n\n  /**\n   * Shift the calendar one domain forward\n   *\n   * The new domain is loaded only if it's not beyond maxDate\n   *\n   * @param int n Number of domains to load\n   * @return bool True if the next domain was loaded, else false\n   */\n  loadNextDomain: function (n) {\n    'use strict';\n\n    if (this._maxDomainReached || n === 0) {\n      return false;\n    }\n\n    var bound = this.loadNewDomains(\n      this.NAVIGATE_RIGHT,\n      this.getDomain(this.getNextDomain(), n),\n    );\n\n    this.afterLoadNextDomain(bound.end);\n    this.checkIfMaxDomainIsReached(this.getNextDomain().getTime(), bound.start);\n\n    return true;\n  },\n\n  /**\n   * Shift the calendar one domain backward\n   *\n   * The previous domain is loaded only if it's not beyond the minDate\n   *\n   * @param int n Number of domains to load\n   * @return bool True if the previous domain was loaded, else false\n   */\n  loadPreviousDomain: function (n) {\n    'use strict';\n\n    if (this._minDomainReached || n === 0) {\n      return false;\n    }\n\n    var bound = this.loadNewDomains(\n      this.NAVIGATE_LEFT,\n      this.getDomain(this.getDomainKeys()[0], -n).reverse(),\n    );\n\n    this.afterLoadPreviousDomain(bound.start);\n    this.checkIfMinDomainIsReached(bound.start, bound.end);\n\n    return true;\n  },\n\n  loadNewDomains: function (direction, newDomains) {\n    'use strict';\n\n    var parent = this;\n    var backward = direction === this.NAVIGATE_LEFT;\n    var i = -1;\n    var total = newDomains.length;\n    var domains = this.getDomainKeys();\n\n    function buildSubDomain(d) {\n      return {\n        t: parent._domainType[parent.options.subDomain].extractUnit(d),\n        v: null,\n      };\n    }\n\n    // Remove out of bound domains from list of new domains to prepend\n    while (++i < total) {\n      if (backward && this.minDomainIsReached(newDomains[i])) {\n        newDomains = newDomains.slice(0, i + 1);\n        break;\n      }\n      if (!backward && this.maxDomainIsReached(newDomains[i])) {\n        newDomains = newDomains.slice(0, i);\n        break;\n      }\n    }\n\n    newDomains = newDomains.slice(-this.options.range);\n\n    for (i = 0, total = newDomains.length; i < total; i += 1) {\n      this._domains.set(\n        newDomains[i].getTime(),\n        this.getSubDomain(newDomains[i]).map(buildSubDomain),\n      );\n\n      this._domains.remove(backward ? domains.pop() : domains.shift());\n    }\n\n    domains = this.getDomainKeys();\n\n    if (backward) {\n      newDomains = newDomains.reverse();\n    }\n\n    this.paint(direction);\n\n    this.getDatas(\n      this.options.data,\n      newDomains[0],\n      this.getSubDomain(newDomains[newDomains.length - 1]).pop(),\n      function () {\n        parent.fill(parent.lastInsertedSvg);\n      },\n    );\n\n    return {\n      start: newDomains[backward ? 0 : 1],\n      end: domains[domains.length - 1],\n    };\n  },\n\n  /**\n   * Return whether a date is inside the scope determined by maxDate\n   *\n   * @param int datetimestamp The timestamp in ms to test\n   * @return bool True if the specified date correspond to the calendar upper bound\n   */\n  maxDomainIsReached: function (datetimestamp) {\n    'use strict';\n\n    return (\n      this.options.maxDate !== null &&\n      this.options.maxDate.getTime() < datetimestamp\n    );\n  },\n\n  /**\n   * Return whether a date is inside the scope determined by minDate\n   *\n   * @param int datetimestamp The timestamp in ms to test\n   * @return bool True if the specified date correspond to the calendar lower bound\n   */\n  minDomainIsReached: function (datetimestamp) {\n    'use strict';\n\n    return (\n      this.options.minDate !== null &&\n      this.options.minDate.getTime() >= datetimestamp\n    );\n  },\n\n  /**\n   * Return the list of the calendar's domain timestamp\n   *\n   * @return Array a sorted array of timestamp\n   */\n  getDomainKeys: function () {\n    'use strict';\n\n    return this._domains\n      .keys()\n      .map(function (d) {\n        return parseInt(d, 10);\n      })\n      .sort(function (a, b) {\n        return a - b;\n      });\n  },\n\n  // =========================================================================//\n  // POSITIONNING                                //\n  // =========================================================================//\n\n  positionSubDomainX: function (d) {\n    'use strict';\n\n    var index = this._domainType[this.options.subDomain].position.x(\n      new Date(d),\n    );\n    return index * this.options.cellSize + index * this.options.cellPadding;\n  },\n\n  positionSubDomainY: function (d) {\n    'use strict';\n\n    var index = this._domainType[this.options.subDomain].position.y(\n      new Date(d),\n    );\n    return index * this.options.cellSize + index * this.options.cellPadding;\n  },\n\n  getSubDomainColumnNumber: function (d) {\n    'use strict';\n\n    if (this.options.rowLimit > 0) {\n      var i = this._domainType[this.options.subDomain].maxItemNumber;\n      if (typeof i === 'function') {\n        i = i(d);\n      }\n      return Math.ceil(i / this.options.rowLimit);\n    }\n\n    var j = this._domainType[this.options.subDomain].defaultColumnNumber;\n    if (typeof j === 'function') {\n      j = j(d);\n    }\n    return this.options.colLimit || j;\n  },\n\n  getSubDomainRowNumber: function (d) {\n    'use strict';\n\n    if (this.options.colLimit > 0) {\n      var i = this._domainType[this.options.subDomain].maxItemNumber;\n      if (typeof i === 'function') {\n        i = i(d);\n      }\n      return Math.ceil(i / this.options.colLimit);\n    }\n\n    var j = this._domainType[this.options.subDomain].defaultRowNumber;\n    if (typeof j === 'function') {\n      j = j(d);\n    }\n    return this.options.rowLimit || j;\n  },\n\n  /**\n   * Return a classname if the specified date should be highlighted\n   *\n   * @param  timestamp date Date of the current subDomain\n   * @return String the highlight class\n   */\n  getHighlightClassName: function (d) {\n    'use strict';\n\n    d = new Date(d);\n\n    if (this.options.highlight.length > 0) {\n      for (var i in this.options.highlight) {\n        if (this.dateIsEqual(this.options.highlight[i], d)) {\n          return this.isNow(this.options.highlight[i])\n            ? ' highlight-now'\n            : ' highlight';\n        }\n      }\n    }\n    return '';\n  },\n\n  /**\n   * Return whether the specified date is now,\n   * according to the type of subdomain\n   *\n   * @param  Date d The date to compare\n   * @return bool True if the date correspond to a subdomain cell\n   */\n  isNow: function (d) {\n    'use strict';\n\n    return this.dateIsEqual(d, new Date());\n  },\n\n  /**\n   * Return whether 2 dates are equals\n   * This function is subdomain-aware,\n   * and dates comparison are dependent of the subdomain\n   *\n   * @param  Date dateA First date to compare\n   * @param  Date dateB Secon date to compare\n   * @return bool true if the 2 dates are equals\n   */\n  /* jshint maxcomplexity: false */\n  dateIsEqual: function (dateA, dateB) {\n    'use strict';\n\n    if (!(dateA instanceof Date)) {\n      dateA = new Date(dateA);\n    }\n\n    if (!(dateB instanceof Date)) {\n      dateB = new Date(dateB);\n    }\n\n    switch (this.options.subDomain) {\n      case 'x_min':\n      case 'min':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate() &&\n          dateA.getHours() === dateB.getHours() &&\n          dateA.getMinutes() === dateB.getMinutes()\n        );\n      case 'x_hour':\n      case 'hour':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate() &&\n          dateA.getHours() === dateB.getHours()\n        );\n      case 'x_day':\n      case 'day':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth() &&\n          dateA.getDate() === dateB.getDate()\n        );\n      case 'x_week':\n      case 'week':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          this.getWeekNumber(dateA) === this.getWeekNumber(dateB)\n        );\n      case 'x_month':\n      case 'month':\n        return (\n          dateA.getFullYear() === dateB.getFullYear() &&\n          dateA.getMonth() === dateB.getMonth()\n        );\n      default:\n        return false;\n    }\n  },\n\n  /**\n   * Returns wether or not dateA is less than or equal to dateB. This function is subdomain aware.\n   * Performs automatic conversion of values.\n   * @param dateA may be a number or a Date\n   * @param dateB may be a number or a Date\n   * @returns {boolean}\n   */\n  dateIsLessThan: function (dateA, dateB) {\n    'use strict';\n\n    if (!(dateA instanceof Date)) {\n      dateA = new Date(dateA);\n    }\n\n    if (!(dateB instanceof Date)) {\n      dateB = new Date(dateB);\n    }\n\n    function normalizedMillis(date, subdomain) {\n      switch (subdomain) {\n        case 'x_min':\n        case 'min':\n          return new Date(\n            date.getFullYear(),\n            date.getMonth(),\n            date.getDate(),\n            date.getHours(),\n            date.getMinutes(),\n          ).getTime();\n        case 'x_hour':\n        case 'hour':\n          return new Date(\n            date.getFullYear(),\n            date.getMonth(),\n            date.getDate(),\n            date.getHours(),\n          ).getTime();\n        case 'x_day':\n        case 'day':\n          return new Date(\n            date.getFullYear(),\n            date.getMonth(),\n            date.getDate(),\n          ).getTime();\n        case 'x_week':\n        case 'week':\n        case 'x_month':\n        case 'month':\n          return new Date(date.getFullYear(), date.getMonth()).getTime();\n        default:\n          return date.getTime();\n      }\n    }\n\n    return (\n      normalizedMillis(dateA, this.options.subDomain) <\n      normalizedMillis(dateB, this.options.subDomain)\n    );\n  },\n\n  // =========================================================================//\n  // DATE COMPUTATION                              //\n  // =========================================================================//\n\n  /**\n   * Return the day of the year for the date\n   * @param  Date\n   * @return  int Day of the year [1,366]\n   */\n  getDayOfYear: d3.time.format('%j'),\n\n  /**\n   * Return the week number of the year\n   * Monday as the first day of the week\n   * @return int  Week number [0-53]\n   */\n  getWeekNumber: function (d) {\n    'use strict';\n\n    var f =\n      this.options.weekStartOnMonday === true\n        ? d3.time.format('%W')\n        : d3.time.format('%U');\n    return f(d);\n  },\n\n  /**\n   * Return the week number, relative to its month\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Week number, relative to the month [0-5]\n   */\n  getMonthWeekNumber: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n\n    var monthFirstWeekNumber = this.getWeekNumber(\n      new Date(d.getFullYear(), d.getMonth()),\n    );\n    return this.getWeekNumber(d) - monthFirstWeekNumber - 1;\n  },\n\n  /**\n   * Return the number of weeks in the dates' year\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of weeks in the date's year\n   */\n  getWeekNumberInYear: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n  },\n\n  /**\n   * Return the number of days in the date's month\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of days in the date's month\n   */\n  getDayCountInMonth: function (d) {\n    'use strict';\n\n    return this.getEndOfMonth(d).getDate();\n  },\n\n  /**\n   * Return the number of days in the date's year\n   *\n   * @param  int|Date d Date or timestamp in milliseconds\n   * @return int Number of days in the date's year\n   */\n  getDayCountInYear: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n    return new Date(d.getFullYear(), 1, 29).getMonth() === 1 ? 366 : 365;\n  },\n\n  /**\n   * Get the weekday from a date\n   *\n   * Return the week day number (0-6) of a date,\n   * depending on whether the week start on monday or sunday\n   *\n   * @param  Date d\n   * @return int The week day number (0-6)\n   */\n  getWeekDay: function (d) {\n    'use strict';\n\n    if (this.options.weekStartOnMonday === false) {\n      return d.getDay();\n    }\n    return d.getDay() === 0 ? 6 : d.getDay() - 1;\n  },\n\n  /**\n   * Get the last day of the month\n   * @param  Date|int  d  Date or timestamp in milliseconds\n   * @return Date      Last day of the month\n   */\n  getEndOfMonth: function (d) {\n    'use strict';\n\n    if (typeof d === 'number') {\n      d = new Date(d);\n    }\n    return new Date(d.getFullYear(), d.getMonth() + 1, 0);\n  },\n\n  /**\n   *\n   * @param  Date date\n   * @param  int count\n   * @param  string step\n   * @return Date\n   */\n  jumpDate: function (date, count, step) {\n    'use strict';\n\n    var d = new Date(date);\n    switch (step) {\n      case 'hour':\n        d.setHours(d.getHours() + count);\n        break;\n      case 'day':\n        d.setHours(d.getHours() + count * 24);\n        break;\n      case 'week':\n        d.setHours(d.getHours() + count * 24 * 7);\n        break;\n      case 'month':\n        d.setMonth(d.getMonth() + count);\n        break;\n      case 'year':\n        d.setFullYear(d.getFullYear() + count);\n    }\n\n    return new Date(d);\n  },\n\n  // =========================================================================//\n  // DOMAIN COMPUTATION                            //\n  // =========================================================================//\n\n  /**\n   * Return all the minutes between 2 dates\n   *\n   * @param  Date  d  date  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of minutes\n   */\n  getMinuteDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(\n      d.getFullYear(),\n      d.getMonth(),\n      d.getDate(),\n      d.getHours(),\n    );\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(\n        range.getFullYear(),\n        range.getMonth(),\n        range.getDate(),\n        range.getHours(),\n      );\n    } else {\n      stop = new Date(+start + range * 1000 * 60);\n    }\n    return d3.time.minutes(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the hours between 2 dates\n   *\n   * @param  Date  d  A date\n   * @param  int|date  range  Number of hours in the range, or a stop date\n   * @return array  An array of hours\n   */\n  getHourDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(\n      d.getFullYear(),\n      d.getMonth(),\n      d.getDate(),\n      d.getHours(),\n    );\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(\n        range.getFullYear(),\n        range.getMonth(),\n        range.getDate(),\n        range.getHours(),\n      );\n    } else {\n      stop = new Date(start);\n      stop.setHours(stop.getHours() + range);\n    }\n\n    var domains = d3.time.hours(Math.min(start, stop), Math.max(start, stop));\n\n    // Passing from DST to standard time\n    // If there are 25 hours, let's compress the duplicate hours\n    var i = 0;\n    var total = domains.length;\n    for (i = 0; i < total; i += 1) {\n      if (i > 0 && domains[i].getHours() === domains[i - 1].getHours()) {\n        this.DSTDomain.push(domains[i].getTime());\n        domains.splice(i, 1);\n        break;\n      }\n    }\n\n    // d3.time.hours is returning more hours than needed when changing\n    // from DST to standard time, because there is really 2 hours between\n    // 1am and 2am!\n    if (typeof range === 'number' && domains.length > Math.abs(range)) {\n      domains.splice(domains.length - 1, 1);\n    }\n\n    return domains;\n  },\n\n  /**\n   * Return all the days between 2 dates\n   *\n   * @param  Date    d    A date\n   * @param  int|date  range  Number of days in the range, or a stop date\n   * @return array  An array of weeks\n   */\n  getDayDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), range.getMonth(), range.getDate());\n    } else {\n      stop = new Date(start);\n      stop = new Date(stop.setDate(stop.getDate() + parseInt(range, 10)));\n    }\n\n    return d3.time.days(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the weeks between 2 dates\n   *\n   * @param  Date  d  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of weeks\n   */\n  getWeekDomain: function (d, range) {\n    'use strict';\n\n    var weekStart;\n\n    if (this.options.weekStartOnMonday === false) {\n      weekStart = new Date(\n        d.getFullYear(),\n        d.getMonth(),\n        d.getDate() - d.getDay(),\n      );\n    } else {\n      if (d.getDay() === 1) {\n        weekStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n      } else if (d.getDay() === 0) {\n        weekStart = new Date(d.getFullYear(), d.getMonth(), d.getDate());\n        weekStart.setDate(weekStart.getDate() - 6);\n      } else {\n        weekStart = new Date(\n          d.getFullYear(),\n          d.getMonth(),\n          d.getDate() - d.getDay() + 1,\n        );\n      }\n    }\n\n    var endDate = new Date(weekStart);\n\n    var stop = range;\n    if (typeof range !== 'object') {\n      stop = new Date(endDate.setDate(endDate.getDate() + range * 7));\n    }\n\n    return this.options.weekStartOnMonday === true\n      ? d3.time.mondays(Math.min(weekStart, stop), Math.max(weekStart, stop))\n      : d3.time.sundays(Math.min(weekStart, stop), Math.max(weekStart, stop));\n  },\n\n  /**\n   * Return all the months between 2 dates\n   *\n   * @param  Date    d    A date\n   * @param  int|date  range  Number of months in the range, or a stop date\n   * @return array  An array of months\n   */\n  getMonthDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), d.getMonth());\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), range.getMonth());\n    } else {\n      stop = new Date(start);\n      stop = stop.setMonth(stop.getMonth() + range);\n    }\n\n    return d3.time.months(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Return all the years between 2 dates\n   *\n   * @param  Date  d  date  A date\n   * @param  int|date  range  Number of minutes in the range, or a stop date\n   * @return array  An array of hours\n   */\n  getYearDomain: function (d, range) {\n    'use strict';\n\n    var start = new Date(d.getFullYear(), 0);\n    var stop = null;\n    if (range instanceof Date) {\n      stop = new Date(range.getFullYear(), 0);\n    } else {\n      stop = new Date(d.getFullYear() + range, 0);\n    }\n\n    return d3.time.years(Math.min(start, stop), Math.max(start, stop));\n  },\n\n  /**\n   * Get an array of domain start dates\n   *\n   * @param  int|Date date A random date included in the wanted domain\n   * @param  int|Date range Number of dates to get, or a stop date\n   * @return Array of dates\n   */\n  getDomain: function (date, range) {\n    'use strict';\n\n    if (typeof date === 'number') {\n      date = new Date(date);\n    }\n\n    if (arguments.length < 2) {\n      range = this.options.range;\n    }\n\n    switch (this.options.domain) {\n      case 'hour':\n        var domains = this.getHourDomain(date, range);\n\n        // Case where an hour is missing, when passing from standard time to DST\n        // Missing hour is perfectly acceptabl in subDomain, but not in domains\n        if (typeof range === 'number' && domains.length < range) {\n          if (range > 0) {\n            domains.push(this.getHourDomain(domains[domains.length - 1], 2)[1]);\n          } else {\n            domains.shift(this.getHourDomain(domains[0], -2)[0]);\n          }\n        }\n        return domains;\n      case 'day':\n        return this.getDayDomain(date, range);\n      case 'week':\n        return this.getWeekDomain(date, range);\n      case 'month':\n        return this.getMonthDomain(date, range);\n      case 'year':\n        return this.getYearDomain(date, range);\n    }\n  },\n\n  /* jshint maxcomplexity: false */\n  getSubDomain: function (date) {\n    'use strict';\n\n    if (typeof date === 'number') {\n      date = new Date(date);\n    }\n\n    var parent = this;\n\n    /**\n     * @return int\n     */\n    var computeDaySubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'year':\n          return parent.getDayCountInYear(date);\n        case 'month':\n          return parent.getDayCountInMonth(date);\n        case 'week':\n          return 7;\n      }\n    };\n\n    /**\n     * @return int\n     */\n    var computeMinSubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'hour':\n          return 60;\n        case 'day':\n          return 60 * 24;\n        case 'week':\n          return 60 * 24 * 7;\n      }\n    };\n\n    /**\n     * @return int\n     */\n    var computeHourSubDomainSize = function (date, domain) {\n      switch (domain) {\n        case 'day':\n          return 24;\n        case 'week':\n          return 168;\n        case 'month':\n          return parent.getDayCountInMonth(date) * 24;\n      }\n    };\n\n    /**\n     * @return int\n     */\n    var computeWeekSubDomainSize = function (date, domain) {\n      if (domain === 'month') {\n        var endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);\n        var endWeekNb = parent.getWeekNumber(endOfMonth);\n        var startWeekNb = parent.getWeekNumber(\n          new Date(date.getFullYear(), date.getMonth()),\n        );\n\n        if (startWeekNb > endWeekNb) {\n          startWeekNb = 0;\n          endWeekNb += 1;\n        }\n\n        return endWeekNb - startWeekNb + 1;\n      } else if (domain === 'year') {\n        return parent.getWeekNumber(new Date(date.getFullYear(), 11, 31));\n      }\n    };\n\n    switch (this.options.subDomain) {\n      case 'x_min':\n      case 'min':\n        return this.getMinuteDomain(\n          date,\n          computeMinSubDomainSize(date, this.options.domain),\n        );\n      case 'x_hour':\n      case 'hour':\n        return this.getHourDomain(\n          date,\n          computeHourSubDomainSize(date, this.options.domain),\n        );\n      case 'x_day':\n      case 'day':\n        return this.getDayDomain(\n          date,\n          computeDaySubDomainSize(date, this.options.domain),\n        );\n      case 'x_week':\n      case 'week':\n        return this.getWeekDomain(\n          date,\n          computeWeekSubDomainSize(date, this.options.domain),\n        );\n      case 'x_month':\n      case 'month':\n        return this.getMonthDomain(date, 12);\n    }\n  },\n\n  /**\n   * Get the n-th next domain after the calendar newest (rightmost) domain\n   * @param  int n\n   * @return Date The start date of the wanted domain\n   */\n  getNextDomain: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.getDomain(\n      this.jumpDate(this.getDomainKeys().pop(), n, this.options.domain),\n      1,\n    )[0];\n  },\n\n  /**\n   * Get the n-th domain before the calendar oldest (leftmost) domain\n   * @param  int n\n   * @return Date The start date of the wanted domain\n   */\n  getPreviousDomain: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.getDomain(\n      this.jumpDate(this.getDomainKeys().shift(), -n, this.options.domain),\n      1,\n    )[0];\n  },\n\n  // =========================================================================//\n  // DATAS                                  //\n  // =========================================================================//\n\n  /**\n   * Fetch and interpret data from the datasource\n   *\n   * @param string|object source\n   * @param Date startDate\n   * @param Date endDate\n   * @param function callback\n   * @param function|boolean afterLoad function used to convert the data into a json object. Use true to use the afterLoad callback\n   * @param updateMode\n   *\n   * @return mixed\n   * - True if there are no data to load\n   * - False if data are loaded asynchronously\n   */\n  getDatas: function (\n    source,\n    startDate,\n    endDate,\n    callback,\n    afterLoad,\n    updateMode,\n  ) {\n    'use strict';\n\n    var self = this;\n    if (arguments.length < 5) {\n      afterLoad = true;\n    }\n    if (arguments.length < 6) {\n      updateMode = this.APPEND_ON_UPDATE;\n    }\n    var _callback = function (error, data) {\n      if (afterLoad !== false) {\n        if (typeof afterLoad === 'function') {\n          data = afterLoad(data);\n        } else if (typeof self.options.afterLoadData === 'function') {\n          data = self.options.afterLoadData(data);\n        } else {\n          console.log('Provided callback for afterLoadData is not a function.');\n        }\n      } else if (\n        self.options.dataType === 'csv' ||\n        self.options.dataType === 'tsv'\n      ) {\n        data = this.interpretCSV(data);\n      }\n      self.parseDatas(data, updateMode, startDate, endDate);\n      if (typeof callback === 'function') {\n        callback();\n      }\n    };\n\n    switch (typeof source) {\n      case 'string':\n        if (source === '') {\n          _callback(null, {});\n          return true;\n        } else {\n          var url = this.parseURI(source, startDate, endDate);\n          var requestType = 'GET';\n          if (self.options.dataPostPayload !== null) {\n            requestType = 'POST';\n          }\n          var payload = null;\n          if (self.options.dataPostPayload !== null) {\n            payload = this.parseURI(\n              self.options.dataPostPayload,\n              startDate,\n              endDate,\n            );\n          }\n\n          var xhr = null;\n          switch (this.options.dataType) {\n            case 'json':\n              xhr = d3.json(url);\n              break;\n            case 'csv':\n              xhr = d3.csv(url);\n              break;\n            case 'tsv':\n              xhr = d3.tsv(url);\n              break;\n            case 'txt':\n              xhr = d3.text(url, 'text/plain');\n              break;\n          }\n\n          // jshint maxdepth:5\n          if (self.options.dataRequestHeaders !== null) {\n            for (var header in self.options.dataRequestHeaders) {\n              if (self.options.dataRequestHeaders.hasOwnProperty(header)) {\n                xhr.header(header, self.options.dataRequestHeaders[header]);\n              }\n            }\n          }\n\n          xhr.send(requestType, payload, _callback);\n        }\n        return false;\n      case 'object':\n        if (source === Object(source)) {\n          _callback(null, source);\n          return false;\n        }\n      /* falls through */\n      default:\n        _callback(null, {});\n        return true;\n    }\n  },\n\n  /**\n   * Populate the calendar internal data\n   *\n   * @param object data\n   * @param constant updateMode\n   * @param Date startDate\n   * @param Date endDate\n   *\n   * @return void\n   */\n  parseDatas: function (data, updateMode, startDate, endDate) {\n    'use strict';\n\n    if (updateMode === this.RESET_ALL_ON_UPDATE) {\n      this._domains.forEach(function (key, value) {\n        value.forEach(function (element, index, array) {\n          array[index].v = null;\n        });\n      });\n    }\n\n    var temp = {};\n\n    var extractTime = function (d) {\n      return d.t;\n    };\n\n    /*jshint forin:false */\n    for (var d in data) {\n      var date = new Date(d * 1000);\n      var domainUnit = this.getDomain(date)[0].getTime();\n      // The current data belongs to a domain that was compressed\n      // Compress the data for the two duplicate hours into the same hour\n      if (this.DSTDomain.indexOf(domainUnit) >= 0) {\n        // Re-assign all data to the first or the second duplicate hours\n        // depending on which is visible\n        if (this._domains.has(domainUnit - 3600 * 1000)) {\n          domainUnit -= 3600 * 1000;\n        }\n      }\n\n      // Skip if data is not relevant to current domain\n      if (\n        isNaN(d) ||\n        !data.hasOwnProperty(d) ||\n        !this._domains.has(domainUnit) ||\n        !(domainUnit >= +startDate && domainUnit < +endDate)\n      ) {\n        continue;\n      }\n\n      var subDomainsData = this._domains.get(domainUnit);\n\n      if (!temp.hasOwnProperty(domainUnit)) {\n        temp[domainUnit] = subDomainsData.map(extractTime);\n      }\n\n      var index = temp[domainUnit].indexOf(\n        this._domainType[this.options.subDomain].extractUnit(date),\n      );\n\n      if (updateMode === this.RESET_SINGLE_ON_UPDATE) {\n        subDomainsData[index].v = data[d];\n      } else {\n        if (!isNaN(subDomainsData[index].v)) {\n          subDomainsData[index].v += data[d];\n        } else {\n          subDomainsData[index].v = data[d];\n        }\n      }\n    }\n  },\n\n  parseURI: function (str, startDate, endDate) {\n    'use strict';\n\n    // Use a timestamp in seconds\n    str = str.replace(/\\{\\{t:start\\}\\}/g, startDate.getTime() / 1000);\n    str = str.replace(/\\{\\{t:end\\}\\}/g, endDate.getTime() / 1000);\n\n    // Use a string date, following the ISO-8601\n    str = str.replace(/\\{\\{d:start\\}\\}/g, startDate.toISOString());\n    str = str.replace(/\\{\\{d:end\\}\\}/g, endDate.toISOString());\n\n    return str;\n  },\n\n  interpretCSV: function (data) {\n    'use strict';\n\n    var d = {};\n    var keys = Object.keys(data[0]);\n    var i, total;\n    for (i = 0, total = data.length; i < total; i += 1) {\n      d[data[i][keys[0]]] = +data[i][keys[1]];\n    }\n    return d;\n  },\n\n  /**\n   * Handle the calendar layout and dimension\n   *\n   * Expand and shrink the container depending on its children dimension\n   * Also rearrange the children position depending on their dimension,\n   * and the legend position\n   *\n   * @return void\n   */\n  resize: function () {\n    'use strict';\n\n    var parent = this;\n    var options = parent.options;\n    var legendWidth = options.displayLegend\n      ? parent.Legend.getDim('width') +\n        options.legendMargin[1] +\n        options.legendMargin[3]\n      : 0;\n    var legendHeight = options.displayLegend\n      ? parent.Legend.getDim('height') +\n        options.legendMargin[0] +\n        options.legendMargin[2]\n      : 0;\n\n    var graphWidth =\n      parent.graphDim.width - options.domainGutter - options.cellPadding;\n    var graphHeight =\n      parent.graphDim.height - options.domainGutter - options.cellPadding;\n\n    this.root\n      .transition()\n      .duration(options.animationDuration)\n      .attr('width', function () {\n        if (\n          options.legendVerticalPosition === 'middle' ||\n          options.legendVerticalPosition === 'center'\n        ) {\n          return graphWidth + legendWidth;\n        }\n        return Math.max(graphWidth, legendWidth);\n      })\n      .attr('height', function () {\n        if (\n          options.legendVerticalPosition === 'middle' ||\n          options.legendVerticalPosition === 'center'\n        ) {\n          return Math.max(graphHeight, legendHeight);\n        }\n        return graphHeight + legendHeight;\n      });\n\n    this.root\n      .select('.graph')\n      .transition()\n      .duration(options.animationDuration)\n      .attr('y', function () {\n        if (options.legendVerticalPosition === 'top') {\n          return legendHeight;\n        }\n        return 0;\n      })\n      .attr('x', function () {\n        if (\n          (options.legendVerticalPosition === 'middle' ||\n            options.legendVerticalPosition === 'center') &&\n          options.legendHorizontalPosition === 'left'\n        ) {\n          return legendWidth;\n        }\n        return 0;\n      });\n  },\n\n  // =========================================================================//\n  // PUBLIC API                                //\n  // =========================================================================//\n\n  /**\n   * Shift the calendar forward\n   */\n  next: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.loadNextDomain(n);\n  },\n\n  /**\n   * Shift the calendar backward\n   */\n  previous: function (n) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      n = 1;\n    }\n    return this.loadPreviousDomain(n);\n  },\n\n  /**\n   * Jump directly to a specific date\n   *\n   * JumpTo will scroll the calendar until the wanted domain with the specified\n   * date is visible. Unless you set reset to true, the wanted domain\n   * will not necessarily be the first (leftmost) domain of the calendar.\n   *\n   * @param Date date Jump to the domain containing that date\n   * @param bool reset Whether the wanted domain should be the first domain of the calendar\n   * @param bool True of the calendar was scrolled\n   */\n  jumpTo: function (date, reset) {\n    'use strict';\n\n    if (arguments.length < 2) {\n      reset = false;\n    }\n    var domains = this.getDomainKeys();\n    var firstDomain = domains[0];\n    var lastDomain = domains[domains.length - 1];\n\n    if (date < firstDomain) {\n      return this.loadPreviousDomain(this.getDomain(firstDomain, date).length);\n    } else {\n      if (reset) {\n        return this.loadNextDomain(this.getDomain(firstDomain, date).length);\n      }\n\n      if (date > lastDomain) {\n        return this.loadNextDomain(this.getDomain(lastDomain, date).length);\n      }\n    }\n\n    return false;\n  },\n\n  /**\n   * Navigate back to the start date\n   *\n   * @since  3.3.8\n   * @return void\n   */\n  rewind: function () {\n    'use strict';\n\n    this.jumpTo(this.options.start, true);\n  },\n\n  /**\n   * Update the calendar with new data\n   *\n   * @param  object|string    dataSource    The calendar's datasource, same type as this.options.data\n   * @param  boolean|function    afterLoad    Whether to execute afterLoad() on the data. Pass directly a function\n   * if you don't want to use the afterLoad() callback\n   */\n  update: function (dataSource, afterLoad, updateMode) {\n    'use strict';\n\n    if (arguments.length === 0) {\n      dataSource = this.options.data;\n    }\n    if (arguments.length < 2) {\n      afterLoad = true;\n    }\n    if (arguments.length < 3) {\n      updateMode = this.RESET_ALL_ON_UPDATE;\n    }\n\n    var domains = this.getDomainKeys();\n    var self = this;\n    this.getDatas(\n      dataSource,\n      new Date(domains[0]),\n      this.getSubDomain(domains[domains.length - 1]).pop(),\n      function () {\n        self.fill();\n        self.afterUpdate();\n      },\n      afterLoad,\n      updateMode,\n    );\n  },\n\n  /**\n   * Set the legend\n   *\n   * @param array legend an array of integer, representing the different threshold value\n   * @param array colorRange an array of 2 hex colors, for the minimum and maximum colors\n   */\n  setLegend: function () {\n    'use strict';\n\n    var oldLegend = this.options.legend.slice(0);\n    if (arguments.length >= 1 && Array.isArray(arguments[0])) {\n      this.options.legend = arguments[0];\n    }\n    if (arguments.length >= 2) {\n      if (Array.isArray(arguments[1]) && arguments[1].length >= 2) {\n        this.options.legendColors = [arguments[1][0], arguments[1][1]];\n      } else {\n        this.options.legendColors = arguments[1];\n      }\n    }\n\n    if (\n      (arguments.length > 0 && !arrayEquals(oldLegend, this.options.legend)) ||\n      arguments.length >= 2\n    ) {\n      this.Legend.buildColors();\n      this.fill();\n    }\n\n    this.Legend.redraw(\n      this.graphDim.width -\n        this.options.domainGutter -\n        this.options.cellPadding,\n    );\n  },\n\n  /**\n   * Remove the legend\n   *\n   * @return bool False if there is no legend to remove\n   */\n  removeLegend: function () {\n    'use strict';\n\n    if (!this.options.displayLegend) {\n      return false;\n    }\n    this.options.displayLegend = false;\n    this.Legend.remove();\n    return true;\n  },\n\n  /**\n   * Display the legend\n   *\n   * @return bool False if the legend was already displayed\n   */\n  showLegend: function () {\n    'use strict';\n\n    if (this.options.displayLegend) {\n      return false;\n    }\n    this.options.displayLegend = true;\n    this.Legend.redraw(\n      this.graphDim.width -\n        this.options.domainGutter -\n        this.options.cellPadding,\n    );\n    return true;\n  },\n\n  /**\n   * Highlight dates\n   *\n   * Add a highlight class to a set of dates\n   *\n   * @since  3.3.5\n   * @param  array Array of dates to highlight\n   * @return bool True if dates were highlighted\n   */\n  highlight: function (args) {\n    'use strict';\n\n    if ((this.options.highlight = this.expandDateSetting(args)).length > 0) {\n      this.fill();\n      return true;\n    }\n    return false;\n  },\n\n  /**\n   * Destroy the calendar\n   *\n   * Usage: cal = cal.destroy();\n   *\n   * @since  3.3.6\n   * @param function A callback function to trigger after destroying the calendar\n   * @return null\n   */\n  destroy: function (callback) {\n    'use strict';\n\n    this.root\n      .transition()\n      .duration(this.options.animationDuration)\n      .attr('width', 0)\n      .attr('height', 0)\n      .remove()\n      .each('end', function () {\n        if (typeof callback === 'function') {\n          callback();\n        } else if (typeof callback !== 'undefined') {\n          console.log('Provided callback for destroy() is not a function.');\n        }\n      });\n\n    return null;\n  },\n\n  getSVG: function () {\n    'use strict';\n\n    var styles = {\n      '.cal-heatmap-container': {},\n      '.graph': {},\n      '.graph-rect': {},\n      'rect.highlight': {},\n      'rect.now': {},\n      'rect.highlight-now': {},\n      'text.highlight': {},\n      'text.now': {},\n      'text.highlight-now': {},\n      '.domain-background': {},\n      '.graph-label': {},\n      '.subdomain-text': {},\n      '.q0': {},\n      '.qi': {},\n    };\n\n    for (\n      var j = 1, total = this.options.legend.length + 1;\n      j <= total;\n      j += 1\n    ) {\n      styles['.q' + j] = {};\n    }\n\n    var root = this.root;\n\n    var whitelistStyles = [\n      // SVG specific properties\n      'stroke',\n      'stroke-width',\n      'stroke-opacity',\n      'stroke-dasharray',\n      'stroke-dashoffset',\n      'stroke-linecap',\n      'stroke-miterlimit',\n      'fill',\n      'fill-opacity',\n      'fill-rule',\n      'marker',\n      'marker-start',\n      'marker-mid',\n      'marker-end',\n      'alignement-baseline',\n      'baseline-shift',\n      'dominant-baseline',\n      'glyph-orientation-horizontal',\n      'glyph-orientation-vertical',\n      'kerning',\n      'text-anchor',\n      'shape-rendering',\n\n      // Text Specific properties\n      'text-transform',\n      'font-family',\n      'font',\n      'font-size',\n      'font-weight',\n    ];\n\n    var filterStyles = function (attribute, property, value) {\n      if (whitelistStyles.indexOf(property) !== -1) {\n        styles[attribute][property] = value;\n      }\n    };\n\n    var getElement = function (e) {\n      return root.select(e)[0][0];\n    };\n\n    /* jshint forin:false */\n    for (var element in styles) {\n      if (!styles.hasOwnProperty(element)) {\n        continue;\n      }\n\n      var dom = getElement(element);\n\n      if (dom === null) {\n        continue;\n      }\n\n      // The DOM Level 2 CSS way\n      /* jshint maxdepth: false */\n      if ('getComputedStyle' in window) {\n        var cs = getComputedStyle(dom, null);\n        if (cs.length !== 0) {\n          for (var i = 0; i < cs.length; i += 1) {\n            filterStyles(element, cs.item(i), cs.getPropertyValue(cs.item(i)));\n          }\n\n          // Opera workaround. Opera doesn\"t support `item`/`length`\n          // on CSSStyleDeclaration.\n        } else {\n          for (var k in cs) {\n            if (cs.hasOwnProperty(k)) {\n              filterStyles(element, k, cs[k]);\n            }\n          }\n        }\n\n        // The IE way\n      } else if ('currentStyle' in dom) {\n        var css = dom.currentStyle;\n        for (var p in css) {\n          filterStyles(element, p, css[p]);\n        }\n      }\n    }\n\n    var string =\n      '<svg xmlns=\"http://www.w3.org/2000/svg\" ' +\n      'xmlns:xlink=\"http://www.w3.org/1999/xlink\"><style type=\"text/css\"><![CDATA[ ';\n\n    for (var style in styles) {\n      string += style + ' {\\n';\n      for (var l in styles[style]) {\n        string += '\\t' + l + ':' + styles[style][l] + ';\\n';\n      }\n      string += '}\\n';\n    }\n\n    string += ']]></style>';\n    string += new XMLSerializer().serializeToString(this.root[0][0]);\n    string += '</svg>';\n\n    return string;\n  },\n};\n\n// =========================================================================//\n// DOMAIN POSITION COMPUTATION                        //\n// =========================================================================//\n\n/**\n * Compute the position of a domain, relative to the calendar\n */\nvar DomainPosition = function () {\n  'use strict';\n\n  this.positions = d3.map();\n};\n\nDomainPosition.prototype.getPosition = function (d) {\n  'use strict';\n\n  return this.positions.get(d);\n};\n\nDomainPosition.prototype.getPositionFromIndex = function (i) {\n  'use strict';\n\n  var domains = this.getKeys();\n  return this.positions.get(domains[i]);\n};\n\nDomainPosition.prototype.getLast = function () {\n  'use strict';\n\n  var domains = this.getKeys();\n  return this.positions.get(domains[domains.length - 1]);\n};\n\nDomainPosition.prototype.setPosition = function (d, dim) {\n  'use strict';\n\n  this.positions.set(d, dim);\n};\n\nDomainPosition.prototype.shiftRightBy = function (exitingDomainDim) {\n  'use strict';\n\n  this.positions.forEach(function (key, value) {\n    this.set(key, value - exitingDomainDim);\n  });\n\n  var domains = this.getKeys();\n  this.positions.remove(domains[0]);\n};\n\nDomainPosition.prototype.shiftLeftBy = function (enteringDomainDim) {\n  'use strict';\n\n  this.positions.forEach(function (key, value) {\n    this.set(key, value + enteringDomainDim);\n  });\n\n  var domains = this.getKeys();\n  this.positions.remove(domains[domains.length - 1]);\n};\n\nDomainPosition.prototype.getKeys = function () {\n  'use strict';\n\n  return this.positions.keys().sort(function (a, b) {\n    return parseInt(a, 10) - parseInt(b, 10);\n  });\n};\n\n// =========================================================================//\n// LEGEND                                  //\n// =========================================================================//\n\nvar Legend = function (calendar) {\n  'use strict';\n\n  this.calendar = calendar;\n  this.computeDim();\n\n  if (calendar.options.legendColors !== null) {\n    this.buildColors();\n  }\n};\n\nLegend.prototype.computeDim = function () {\n  'use strict';\n\n  var options = this.calendar.options; // Shorter accessor for variable name mangling when minifying\n  this.dim = {\n    width:\n      options.legendCellSize * (options.legend.length + 1) +\n      options.legendCellPadding * options.legend.length,\n    height: options.legendCellSize,\n  };\n};\n\nLegend.prototype.remove = function () {\n  'use strict';\n\n  this.calendar.root.select('.graph-legend').remove();\n  this.calendar.resize();\n};\n\nLegend.prototype.redraw = function (width) {\n  'use strict';\n\n  if (!this.calendar.options.displayLegend) {\n    return false;\n  }\n\n  var parent = this;\n  var calendar = this.calendar;\n  var legend = calendar.root;\n  var legendItem;\n  var options = calendar.options; // Shorter accessor for variable name mangling when minifying\n\n  this.computeDim();\n\n  var _legend = options.legend.slice(0);\n  _legend.push(_legend[_legend.length - 1] + 1);\n\n  var legendElement = calendar.root.select('.graph-legend');\n  if (legendElement[0][0] !== null) {\n    legend = legendElement;\n    legendItem = legend.select('g').selectAll('rect').data(_legend);\n  } else {\n    // Creating the new legend DOM if it doesn't already exist\n    legend =\n      options.legendVerticalPosition === 'top'\n        ? legend.insert('svg', '.graph')\n        : legend.append('svg');\n\n    legend.attr('x', getLegendXPosition()).attr('y', getLegendYPosition());\n\n    legendItem = legend\n      .attr('class', 'graph-legend')\n      .attr('height', parent.getDim('height'))\n      .attr('width', parent.getDim('width'))\n      .append('g')\n      .selectAll()\n      .data(_legend);\n  }\n\n  legendItem\n    .enter()\n    .append('rect')\n    .call(legendCellLayout)\n    .attr('class', function (d) {\n      return calendar.Legend.getClass(d, calendar.legendScale === null);\n    })\n    .attr('fill-opacity', 0)\n    .call(function (selection) {\n      if (\n        calendar.legendScale !== null &&\n        options.legendColors !== null &&\n        options.legendColors.hasOwnProperty('base')\n      ) {\n        selection.attr('fill', options.legendColors.base);\n      }\n    })\n    .append('title');\n\n  legendItem\n    .exit()\n    .transition()\n    .duration(options.animationDuration)\n    .attr('fill-opacity', 0)\n    .remove();\n\n  legendItem\n    .transition()\n    .delay(function (d, i) {\n      return (options.animationDuration * i) / 10;\n    })\n    .call(legendCellLayout)\n    .attr('fill-opacity', 1)\n    .call(function (element) {\n      element.attr('fill', function (d, i) {\n        if (calendar.legendScale === null) {\n          return '';\n        }\n\n        if (i === 0) {\n          return calendar.legendScale(d - 1);\n        }\n        return calendar.legendScale(options.legend[i - 1]);\n      });\n\n      element.attr('class', function (d) {\n        return calendar.Legend.getClass(d, calendar.legendScale === null);\n      });\n    });\n\n  function legendCellLayout(selection) {\n    selection\n      .attr('width', options.legendCellSize)\n      .attr('height', options.legendCellSize)\n      .attr('rx', options.legendCellRadius)\n      .attr('ry', options.legendCellRadius)\n      .attr('x', function (d, i) {\n        return i * (options.legendCellSize + options.legendCellPadding);\n      });\n  }\n\n  legendItem.select('title').text(function (d, i) {\n    if (i === 0) {\n      return calendar.formatStringWithObject(options.legendTitleFormat.lower, {\n        min: options.legend[i],\n        name: options.itemName[1],\n      });\n    } else if (i === _legend.length - 1) {\n      return calendar.formatStringWithObject(options.legendTitleFormat.upper, {\n        max: options.legend[i - 1],\n        name: options.itemName[1],\n      });\n    } else {\n      return calendar.formatStringWithObject(options.legendTitleFormat.inner, {\n        down: options.legend[i - 1],\n        up: options.legend[i],\n        name: options.itemName[1],\n      });\n    }\n  });\n  legendItem\n    .on('mouseover', function (d) {\n      calendar.legendTip.show(d, this);\n    })\n    .on('mouseout', function () {\n      calendar.legendTip.hide();\n    });\n\n  legend\n    .transition()\n    .duration(options.animationDuration)\n    .attr('x', getLegendXPosition())\n    .attr('y', getLegendYPosition())\n    .attr('width', parent.getDim('width'))\n    .attr('height', parent.getDim('height'));\n\n  legend\n    .select('g')\n    .transition()\n    .duration(options.animationDuration)\n    .attr('transform', function () {\n      if (options.legendOrientation === 'vertical') {\n        return (\n          'rotate(90 ' +\n          options.legendCellSize / 2 +\n          ' ' +\n          options.legendCellSize / 2 +\n          ')'\n        );\n      }\n      return '';\n    });\n\n  function getLegendXPosition() {\n    switch (options.legendHorizontalPosition) {\n      case 'right':\n        if (\n          options.legendVerticalPosition === 'center' ||\n          options.legendVerticalPosition === 'middle'\n        ) {\n          return width + options.legendMargin[3];\n        }\n        return width - parent.getDim('width') - options.legendMargin[1];\n      case 'middle':\n      case 'center':\n        return Math.round(width / 2 - parent.getDim('width') / 2);\n      default:\n        return options.legendMargin[3];\n    }\n  }\n\n  function getLegendYPosition() {\n    if (options.legendVerticalPosition === 'bottom') {\n      return (\n        calendar.graphDim.height +\n        options.legendMargin[0] -\n        options.domainGutter -\n        options.cellPadding\n      );\n    }\n    return options.legendMargin[0];\n  }\n\n  calendar.resize();\n};\n\n/**\n * Return the dimension of the legend\n *\n * Takes into account rotation\n *\n * @param  string axis Width or height\n * @return int height or width in pixels\n */\nLegend.prototype.getDim = function (axis) {\n  'use strict';\n\n  var isHorizontal = this.calendar.options.legendOrientation === 'horizontal';\n\n  switch (axis) {\n    case 'width':\n      return this.dim[isHorizontal ? 'width' : 'height'];\n    case 'height':\n      return this.dim[isHorizontal ? 'height' : 'width'];\n  }\n};\n\nLegend.prototype.buildColors = function () {\n  'use strict';\n\n  var options = this.calendar.options; // Shorter accessor for variable name mangling when minifying\n\n  if (options.legendColors === null) {\n    this.calendar.legendScale = null;\n    return false;\n  }\n\n  var _colorRange = [];\n\n  if (Array.isArray(options.legendColors)) {\n    _colorRange = options.legendColors;\n  } else if (\n    options.legendColors.hasOwnProperty('min') &&\n    options.legendColors.hasOwnProperty('max')\n  ) {\n    _colorRange = [options.legendColors.min, options.legendColors.max];\n  } else {\n    options.legendColors = null;\n    return false;\n  }\n\n  var _legend = options.legend.slice(0);\n\n  if (_legend[0] > 0) {\n    _legend.unshift(0);\n  } else if (_legend[0] <= 0) {\n    // Let's guess the leftmost value, it we have to add one\n    _legend.unshift(\n      _legend[0] - (_legend[_legend.length - 1] - _legend[0]) / _legend.length,\n    );\n  }\n  var colorScale;\n  if (options.legendColors.hasOwnProperty('colorScale')) {\n    colorScale = options.legendColors.colorScale;\n  } else {\n    colorScale = d3.scale\n      .linear()\n      .range(_colorRange)\n      .interpolate(d3.interpolateHcl)\n      .domain([d3.min(_legend), d3.max(_legend)]);\n  }\n\n  var legendColors = _legend.map(function (element) {\n    return colorScale(element);\n  });\n  this.calendar.legendScale = d3.scale\n    .threshold()\n    .domain(options.legend)\n    .range(legendColors);\n\n  return true;\n};\n\n/**\n * Return the classname on the legend for the specified value\n *\n * @param integer n Value associated to a date\n * @param bool withCssClass Whether to display the css class used to style the cell.\n *                          Disabling will allow styling directly via html fill attribute\n *\n * @return string Classname according to the legend\n */\nLegend.prototype.getClass = function (n, withCssClass) {\n  'use strict';\n\n  if (n === null || isNaN(n)) {\n    return '';\n  }\n\n  var index = [this.calendar.options.legend.length + 1];\n\n  for (\n    var i = 0, total = this.calendar.options.legend.length - 1;\n    i <= total;\n    i += 1\n  ) {\n    if (this.calendar.options.legend[0] > 0 && n < 0) {\n      index = ['1', 'i'];\n      break;\n    }\n\n    if (n <= this.calendar.options.legend[i]) {\n      index = [i + 1];\n      break;\n    }\n  }\n\n  if (n === 0) {\n    index.push(0);\n  }\n\n  index.unshift('');\n  return (index.join(' r') + (withCssClass ? index.join(' q') : '')).trim();\n};\n\n/**\n * #source http://stackoverflow.com/a/383245/805649\n */\nfunction mergeRecursive(obj1, obj2) {\n  'use strict';\n\n  /*jshint forin:false */\n  for (var p in obj2) {\n    try {\n      // Property in destination object set; update its value.\n      if (obj2[p].constructor === Object) {\n        obj1[p] = mergeRecursive(obj1[p], obj2[p]);\n      } else {\n        obj1[p] = obj2[p];\n      }\n    } catch (e) {\n      // Property in destination object not set; create it and set its value.\n      obj1[p] = obj2[p];\n    }\n  }\n\n  return obj1;\n}\n\n/**\n * Check if 2 arrays are equals\n *\n * @link http://stackoverflow.com/a/14853974/805649\n * @param  array array the array to compare to\n * @return bool true of the 2 arrays are equals\n */\nfunction arrayEquals(arrayA, arrayB) {\n  'use strict';\n\n  // if the other array is a falsy value, return\n  if (!arrayB || !arrayA) {\n    return false;\n  }\n\n  // compare lengths - can save a lot of time\n  if (arrayA.length !== arrayB.length) {\n    return false;\n  }\n\n  for (var i = 0; i < arrayA.length; i += 1) {\n    // Check if we have nested arrays\n    if (arrayA[i] instanceof Array && arrayB[i] instanceof Array) {\n      // recurse into the nested arrays\n      if (!arrayEquals(arrayA[i], arrayB[i])) {\n        return false;\n      }\n    } else if (arrayA[i] !== arrayB[i]) {\n      // Warning - two different object instances will never be equal: {x:20} != {x:20}\n      return false;\n    }\n  }\n  return true;\n}\n\nexport default CalHeatMap;\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}