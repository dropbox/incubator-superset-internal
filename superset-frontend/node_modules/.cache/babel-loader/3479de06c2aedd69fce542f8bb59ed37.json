{"ast":null,"code":"(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { css, styled, SupersetClient, t } from '@superset-ui/core';\nimport Modal from 'src/components/Modal';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport Icons from 'src/components/Icons';\nimport Select from 'src/components/Select/Select';\nimport AsyncSelect from 'src/components/Select/AsyncSelect';\nimport rison from 'rison';\nimport { LabeledErrorBoundInput } from 'src/components/Form';\nimport { noBottomMargin } from 'src/components/ReportModal/styles';\nimport InfoTooltip from 'src/components/InfoTooltip';\nimport { useSingleViewResource } from 'src/views/CRUD/hooks';\nimport { FilterOptions } from './constants';\nimport { FilterType } from './types';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst StyledModal = styled(Modal)`\n  max-width: 1200px;\n  width: 100%;\n  .ant-modal-body {\n    overflow: initial;\n  }\n`;\nconst StyledIcon = (theme) => css`\n  margin: auto ${theme.gridUnit * 2}px auto 0;\n  color: ${theme.colors.grayscale.base};\n`;\nconst StyledSectionContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  padding: ${(_ref) => {let { theme } = _ref;return `${theme.gridUnit * 3}px ${theme.gridUnit * 4}px ${theme.gridUnit * 2}px`;}};\n\n  label {\n    font-size: ${(_ref2) => {let { theme } = _ref2;return theme.typography.sizes.s;}}px;\n    color: ${(_ref3) => {let { theme } = _ref3;return theme.colors.grayscale.light1;}};\n  }\n`;\nconst StyledInputContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  margin: ${(_ref4) => {let { theme } = _ref4;return theme.gridUnit;}}px;\n\n  margin-bottom: ${(_ref5) => {let { theme } = _ref5;return theme.gridUnit * 4;}}px;\n\n  .input-container {\n    display: flex;\n    align-items: center;\n\n    > div {\n      width: 100%;\n    }\n\n    label {\n      display: flex;\n      margin-right: ${(_ref6) => {let { theme } = _ref6;return theme.gridUnit * 2;}}px;\n    }\n  }\n\n  input,\n  textarea {\n    flex: 1 1 auto;\n  }\n\n  textarea {\n    height: 100px;\n    resize: none;\n  }\n\n  .required {\n    margin-left: ${(_ref7) => {let { theme } = _ref7;return theme.gridUnit / 2;}}px;\n    color: ${(_ref8) => {let { theme } = _ref8;return theme.colors.error.base;}};\n  }\n`;\nconst DEAFULT_RULE = {\n  name: '',\n  filter_type: FilterType.REGULAR,\n  tables: [],\n  roles: [],\n  clause: '',\n  group_key: '',\n  description: '' };\n\nfunction RowLevelSecurityModal(props) {\n  const { rule, addDangerToast, addSuccessToast, onHide, show } = props;\n  const [currentRule, setCurrentRule] = useState({\n    ...DEAFULT_RULE });\n\n  const [disableSave, setDisableSave] = useState(true);\n  const isEditMode = rule !== null;\n  // * hooks *\n  const { state: { loading, resource, error: fetchError }, fetchResource, createResource, updateResource, clearError } = useSingleViewResource(`rowlevelsecurity`, t('rowlevelsecurity'), addDangerToast);\n  // initialize\n  useEffect(() => {\n    if (!isEditMode) {\n      setCurrentRule({ ...DEAFULT_RULE });\n    } else\n    if ((rule == null ? void 0 : rule.id) !== null && !loading && !fetchError) {\n      fetchResource(rule.id);\n    }\n  }, [rule]);\n  useEffect(() => {\n    if (resource) {\n      setCurrentRule({ ...resource, id: rule == null ? void 0 : rule.id });\n      const selectedTableAndRoles = getSelectedData();\n      updateRuleState('tables', (selectedTableAndRoles == null ? void 0 : selectedTableAndRoles.tables) || []);\n      updateRuleState('roles', (selectedTableAndRoles == null ? void 0 : selectedTableAndRoles.roles) || []);\n    }\n  }, [resource]);\n  // find selected tables and roles\n  const getSelectedData = useCallback(() => {var _resource$tables, _resource$roles;\n    if (!resource) {\n      return null;\n    }\n    const tables = [];\n    const roles = [];\n    (_resource$tables = resource.tables) == null ? void 0 : _resource$tables.forEach((selectedTable) => {\n      tables.push({\n        key: selectedTable.id,\n        label: selectedTable.schema ?\n        `${selectedTable.schema}.${selectedTable.table_name}` :\n        selectedTable.table_name,\n        value: selectedTable.id });\n\n    });\n    (_resource$roles = resource.roles) == null ? void 0 : _resource$roles.forEach((selectedRole) => {\n      roles.push({\n        key: selectedRole.id,\n        label: selectedRole.name,\n        value: selectedRole.id });\n\n    });\n    return { tables, roles };\n  }, [resource == null ? void 0 : resource.tables, resource == null ? void 0 : resource.roles]);\n  // validate\n  const currentRuleSafe = currentRule || {};\n  useEffect(() => {\n    validate();\n  }, [currentRuleSafe.name, currentRuleSafe.clause, currentRuleSafe == null ? void 0 : currentRuleSafe.tables]);\n  const updateRuleState = (name, value) => {\n    setCurrentRule((currentRuleData) => ({\n      ...currentRuleData,\n      [name]: value }));\n\n  };\n  const onTextChange = (target) => {\n    updateRuleState(target.name, target.value);\n  };\n  const onFilterChange = (type) => {\n    updateRuleState('filter_type', type);\n  };\n  const onTablesChange = (tables) => {\n    updateRuleState('tables', tables || []);\n  };\n  const onRolesChange = (roles) => {\n    updateRuleState('roles', roles || []);\n  };\n  const hide = () => {\n    clearError();\n    setCurrentRule({ ...DEAFULT_RULE });\n    onHide();\n  };\n  const onSave = () => {var _currentRule$tables, _currentRule$roles;\n    const tables = [];\n    const roles = [];\n    (_currentRule$tables = currentRule.tables) == null ? void 0 : _currentRule$tables.forEach((table) => tables.push(table.key));\n    (_currentRule$roles = currentRule.roles) == null ? void 0 : _currentRule$roles.forEach((role) => roles.push(role.key));\n    const data = { ...currentRule, tables, roles };\n    if (isEditMode && currentRule.id) {\n      const updateId = currentRule.id;\n      delete data.id;\n      updateResource(updateId, data).then((response) => {\n        if (!response) {\n          return;\n        }\n        addSuccessToast(`Rule updated`);\n        hide();\n      });\n    } else\n    if (currentRule) {\n      createResource(data).then((response) => {\n        if (!response)\n        return;\n        addSuccessToast(t('Rule added'));\n        hide();\n      });\n    }\n  };\n  // * data loaders *\n  const loadTableOptions = useMemo(() => function (input, page, pageSize) {if (input === void 0) {input = '';}\n    const query = rison.encode({\n      filter: input,\n      page,\n      page_size: pageSize });\n\n    return SupersetClient.get({\n      endpoint: `/api/v1/rowlevelsecurity/related/tables?q=${query}` }).\n    then((response) => {\n      const list = response.json.result.map((item) => ({\n        label: item.text,\n        value: item.value }));\n\n      return { data: list, totalCount: response.json.count };\n    });\n  }, []);\n  const loadRoleOptions = useMemo(() => function (input, page, pageSize) {if (input === void 0) {input = '';}\n    const query = rison.encode({\n      filter: input,\n      page,\n      page_size: pageSize });\n\n    return SupersetClient.get({\n      endpoint: `/api/v1/rowlevelsecurity/related/roles?q=${query}` }).\n    then((response) => {\n      const list = response.json.result.map((item) => ({\n        label: item.text,\n        value: item.value }));\n\n      return { data: list, totalCount: response.json.count };\n    });\n  }, []);\n  // * state validators *\n  const validate = () => {var _currentRule$tables2;\n    if (currentRule != null && currentRule.name &&\n    currentRule != null && currentRule.clause && (_currentRule$tables2 =\n    currentRule.tables) != null && _currentRule$tables2.length) {\n      setDisableSave(false);\n    } else\n    {\n      setDisableSave(true);\n    }\n  };\n  return ___EmotionJSX(StyledModal, { className: \"no-content-padding\", responsive: true, show: show, onHide: hide, primaryButtonName: isEditMode ? t('Save') : t('Add'), disablePrimaryButton: disableSave, onHandledPrimaryAction: onSave, width: \"30%\", maxWidth: \"1450px\", title: ___EmotionJSX(\"h4\", { \"data-test\": \"rls-modal-title\" },\n    isEditMode ? ___EmotionJSX(Icons.EditAlt, { css: StyledIcon }) : ___EmotionJSX(Icons.PlusLarge, { css: StyledIcon }),\n    isEditMode ? t('Edit Rule') : t('Add Rule')) },\n\n  ___EmotionJSX(StyledSectionContainer, null,\n  ___EmotionJSX(\"div\", { className: \"main-section\" },\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(LabeledErrorBoundInput, { id: \"name\", name: \"name\", className: \"labeled-input\", value: currentRule ? currentRule.name : '', required: true, validationMethods: {\n      onChange: (_ref9) => {let { target } = _ref9;return onTextChange(target);} },\n    css: noBottomMargin, label: t('Rule Name'), \"data-test\": \"rule-name-test\" })),\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(\"div\", { className: \"control-label\" },\n  t('Filter Type'), ' ',\n  ___EmotionJSX(InfoTooltip, { tooltip: t('Regular filters add where clauses to queries if a user belongs to a role referenced in the filter, base filters apply filters to all queries except the roles defined in the filter, and can be used to define what users can see if no RLS filters within a filter group apply to them.') })),\n\n  ___EmotionJSX(\"div\", { className: \"input-container\" },\n  ___EmotionJSX(Select, { name: \"filter_type\", ariaLabel: t('Filter Type'), placeholder: t('Filter Type'), onChange: onFilterChange, value: currentRule == null ? void 0 : currentRule.filter_type, options: FilterOptions, \"data-test\": \"rule-filter-type-test\" }))),\n\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(\"div\", { className: \"control-label\" },\n  t('Tables'), \" \", ___EmotionJSX(\"span\", { className: \"required\" }, \"*\"),\n  ___EmotionJSX(InfoTooltip, { tooltip: t('These are the tables this filter will be applied to.') })),\n\n  ___EmotionJSX(\"div\", { className: \"input-container\" },\n  ___EmotionJSX(AsyncSelect, { ariaLabel: t('Tables'), mode: \"multiple\", onChange: onTablesChange, value: (currentRule == null ? void 0 : currentRule.tables) || [], options: loadTableOptions }))),\n\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(\"div\", { className: \"control-label\" },\n  currentRule.filter_type === FilterType.BASE ?\n  t('Excluded roles') :\n  t('Roles'), ' ',\n  ___EmotionJSX(InfoTooltip, { tooltip: t('For regular filters, these are the roles this filter will be applied to. For base filters, these are the roles that the filter DOES NOT apply to, e.g. Admin if admin should see all data.') })),\n\n  ___EmotionJSX(\"div\", { className: \"input-container\" },\n  ___EmotionJSX(AsyncSelect, { ariaLabel: t('Roles'), mode: \"multiple\", onChange: onRolesChange, value: (currentRule == null ? void 0 : currentRule.roles) || [], options: loadRoleOptions }))),\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(LabeledErrorBoundInput, { id: \"group_key\", name: \"group_key\", value: currentRule ? currentRule.group_key : '', validationMethods: {\n      onChange: (_ref10) => {let { target } = _ref10;return onTextChange(target);} },\n    css: noBottomMargin, label: t('Group Key'), hasTooltip: true, tooltipText: t(`Filters with the same group key will be ORed together within the group, while different filter groups will be ANDed together. Undefined group keys are treated as unique groups, i.e. are not grouped together. For example, if a table has three filters, of which two are for departments Finance and Marketing (group key = 'department'), and one refers to the region Europe (group key = 'region'), the filter clause would apply the filter (department = 'Finance' OR department = 'Marketing') AND (region = 'Europe').`), \"data-test\": \"group-key-test\" })),\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(\"div\", { className: \"control-label\" },\n  ___EmotionJSX(LabeledErrorBoundInput, { id: \"clause\", name: \"clause\", value: currentRule ? currentRule.clause : '', required: true, validationMethods: {\n      onChange: (_ref11) => {let { target } = _ref11;return onTextChange(target);} },\n    css: noBottomMargin, label: t('Clause'), hasTooltip: true, tooltipText: t('This is the condition that will be added to the WHERE clause. For example, to only return rows for a particular client, you might define a regular filter with the clause `client_id = 9`. To display no rows unless a user belongs to a RLS filter role, a base filter can be created with the clause `1 = 0` (always false).'), \"data-test\": \"clause-test\" }))),\n\n\n\n  ___EmotionJSX(StyledInputContainer, null,\n  ___EmotionJSX(\"div\", { className: \"control-label\" }, t('Description')),\n  ___EmotionJSX(\"div\", { className: \"input-container\" },\n  ___EmotionJSX(\"textarea\", { name: \"description\", value: currentRule ? currentRule.description : '', onChange: (event) => onTextChange(event.target), \"data-test\": \"description-test\" }))))));\n\n\n\n\n\n}__signature__(RowLevelSecurityModal, \"useState{[currentRule, setCurrentRule]({\\n        ...DEAFULT_RULE,\\n    })}\\nuseState{[disableSave, setDisableSave](true)}\\nuseSingleViewResource{{ state: { loading, resource, error: fetchError }, fetchResource, createResource, updateResource, clearError, }}\\nuseEffect{}\\nuseEffect{}\\nuseCallback{getSelectedData}\\nuseEffect{}\\nuseMemo{loadTableOptions}\\nuseMemo{loadRoleOptions}\", () => [useSingleViewResource]);const _default =\nRowLevelSecurityModal;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(StyledModal, \"StyledModal\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(StyledIcon, \"StyledIcon\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(StyledSectionContainer, \"StyledSectionContainer\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(StyledInputContainer, \"StyledInputContainer\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(DEAFULT_RULE, \"DEAFULT_RULE\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(RowLevelSecurityModal, \"RowLevelSecurityModal\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");reactHotLoader.register(_default, \"default\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"mappings":"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","names":["css","styled","SupersetClient","t","Modal","React","useCallback","useEffect","useMemo","useState","Icons","Select","AsyncSelect","rison","LabeledErrorBoundInput","noBottomMargin","InfoTooltip","useSingleViewResource","FilterOptions","FilterType","StyledModal","StyledIcon","theme","gridUnit","colors","grayscale","base","StyledSectionContainer","div","typography","sizes","s","light1","StyledInputContainer","error","DEAFULT_RULE","name","filter_type","REGULAR","tables","roles","clause","group_key","description","RowLevelSecurityModal","props","rule","addDangerToast","addSuccessToast","onHide","show","currentRule","setCurrentRule","disableSave","setDisableSave","isEditMode","state","loading","resource","fetchError","fetchResource","createResource","updateResource","clearError","id","selectedTableAndRoles","getSelectedData","updateRuleState","forEach","push","key","selectedTable","label","schema","table_name","value","selectedRole","currentRuleSafe","validate","currentRuleData","onTextChange","target","onFilterChange","type","onTablesChange","onRolesChange","hide","onSave","table","role","data","updateId","then","response","loadTableOptions","input","page","pageSize","query","encode","filter","page_size","get","endpoint","list","json","result","map","item","text","totalCount","count","loadRoleOptions","length","onChange","BASE","event"],"sourceRoot":"","sources":["/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/features/rls/RowLevelSecurityModal.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\nimport {\n  css,\n  styled,\n  SupersetClient,\n  SupersetTheme,\n  t,\n} from '@superset-ui/core';\nimport Modal from 'src/components/Modal';\nimport React, { useCallback, useEffect, useMemo, useState } from 'react';\nimport Icons from 'src/components/Icons';\nimport Select from 'src/components/Select/Select';\nimport AsyncSelect from 'src/components/Select/AsyncSelect';\nimport rison from 'rison';\nimport { LabeledErrorBoundInput } from 'src/components/Form';\nimport { noBottomMargin } from 'src/components/ReportModal/styles';\nimport InfoTooltip from 'src/components/InfoTooltip';\nimport { useSingleViewResource } from 'src/views/CRUD/hooks';\nimport { FilterOptions } from './constants';\nimport { FilterType, RLSObject, RoleObject, TableObject } from './types';\n\nconst StyledModal = styled(Modal)`\n  max-width: 1200px;\n  width: 100%;\n  .ant-modal-body {\n    overflow: initial;\n  }\n`;\nconst StyledIcon = (theme: SupersetTheme) => css`\n  margin: auto ${theme.gridUnit * 2}px auto 0;\n  color: ${theme.colors.grayscale.base};\n`;\n\nconst StyledSectionContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  padding: ${({ theme }) =>\n    `${theme.gridUnit * 3}px ${theme.gridUnit * 4}px ${theme.gridUnit * 2}px`};\n\n  label {\n    font-size: ${({ theme }) => theme.typography.sizes.s}px;\n    color: ${({ theme }) => theme.colors.grayscale.light1};\n  }\n`;\n\nconst StyledInputContainer = styled.div`\n  display: flex;\n  flex-direction: column;\n  margin: ${({ theme }) => theme.gridUnit}px;\n\n  margin-bottom: ${({ theme }) => theme.gridUnit * 4}px;\n\n  .input-container {\n    display: flex;\n    align-items: center;\n\n    > div {\n      width: 100%;\n    }\n\n    label {\n      display: flex;\n      margin-right: ${({ theme }) => theme.gridUnit * 2}px;\n    }\n  }\n\n  input,\n  textarea {\n    flex: 1 1 auto;\n  }\n\n  textarea {\n    height: 100px;\n    resize: none;\n  }\n\n  .required {\n    margin-left: ${({ theme }) => theme.gridUnit / 2}px;\n    color: ${({ theme }) => theme.colors.error.base};\n  }\n`;\n\nexport interface RowLevelSecurityModalProps {\n  rule: RLSObject | null;\n  addSuccessToast: (msg: string) => void;\n  addDangerToast: (msg: string) => void;\n  onAdd?: (alert?: any) => void;\n  onHide: () => void;\n  show: boolean;\n}\n\nconst DEAFULT_RULE = {\n  name: '',\n  filter_type: FilterType.REGULAR,\n  tables: [],\n  roles: [],\n  clause: '',\n  group_key: '',\n  description: '',\n};\n\nfunction RowLevelSecurityModal(props: RowLevelSecurityModalProps) {\n  const { rule, addDangerToast, addSuccessToast, onHide, show } = props;\n\n  const [currentRule, setCurrentRule] = useState<RLSObject>({\n    ...DEAFULT_RULE,\n  });\n  const [disableSave, setDisableSave] = useState<boolean>(true);\n\n  const isEditMode = rule !== null;\n\n  // * hooks *\n  const {\n    state: { loading, resource, error: fetchError },\n    fetchResource,\n    createResource,\n    updateResource,\n    clearError,\n  } = useSingleViewResource<RLSObject>(\n    `rowlevelsecurity`,\n    t('rowlevelsecurity'),\n    addDangerToast,\n  );\n\n  // initialize\n  useEffect(() => {\n    if (!isEditMode) {\n      setCurrentRule({ ...DEAFULT_RULE });\n    } else if (rule?.id !== null && !loading && !fetchError) {\n      fetchResource(rule.id as number);\n    }\n  }, [rule]);\n\n  useEffect(() => {\n    if (resource) {\n      setCurrentRule({ ...resource, id: rule?.id });\n      const selectedTableAndRoles = getSelectedData();\n      updateRuleState('tables', selectedTableAndRoles?.tables || []);\n      updateRuleState('roles', selectedTableAndRoles?.roles || []);\n    }\n  }, [resource]);\n\n  // find selected tables and roles\n  const getSelectedData = useCallback(() => {\n    if (!resource) {\n      return null;\n    }\n    const tables: TableObject[] = [];\n    const roles: RoleObject[] = [];\n\n    resource.tables?.forEach(selectedTable => {\n      tables.push({\n        key: selectedTable.id,\n        label: selectedTable.schema\n          ? `${selectedTable.schema}.${selectedTable.table_name}`\n          : selectedTable.table_name,\n        value: selectedTable.id,\n      });\n    });\n\n    resource.roles?.forEach(selectedRole => {\n      roles.push({\n        key: selectedRole.id,\n        label: selectedRole.name,\n        value: selectedRole.id,\n      });\n    });\n\n    return { tables, roles };\n  }, [resource?.tables, resource?.roles]);\n\n  // validate\n  const currentRuleSafe = currentRule || {};\n  useEffect(() => {\n    validate();\n  }, [currentRuleSafe.name, currentRuleSafe.clause, currentRuleSafe?.tables]);\n\n  // * event handlers *\n  type SelectValue = {\n    value: string;\n    label: string;\n  };\n\n  const updateRuleState = (name: string, value: any) => {\n    setCurrentRule(currentRuleData => ({\n      ...currentRuleData,\n      [name]: value,\n    }));\n  };\n\n  const onTextChange = (target: HTMLInputElement | HTMLTextAreaElement) => {\n    updateRuleState(target.name, target.value);\n  };\n\n  const onFilterChange = (type: string) => {\n    updateRuleState('filter_type', type);\n  };\n\n  const onTablesChange = (tables: Array<SelectValue>) => {\n    updateRuleState('tables', tables || []);\n  };\n\n  const onRolesChange = (roles: Array<SelectValue>) => {\n    updateRuleState('roles', roles || []);\n  };\n\n  const hide = () => {\n    clearError();\n    setCurrentRule({ ...DEAFULT_RULE });\n    onHide();\n  };\n\n  const onSave = () => {\n    const tables: number[] = [];\n    const roles: number[] = [];\n\n    currentRule.tables?.forEach(table => tables.push(table.key));\n    currentRule.roles?.forEach(role => roles.push(role.key));\n\n    const data: any = { ...currentRule, tables, roles };\n\n    if (isEditMode && currentRule.id) {\n      const updateId = currentRule.id;\n      delete data.id;\n      updateResource(updateId, data).then(response => {\n        if (!response) {\n          return;\n        }\n        addSuccessToast(`Rule updated`);\n        hide();\n      });\n    } else if (currentRule) {\n      createResource(data).then(response => {\n        if (!response) return;\n        addSuccessToast(t('Rule added'));\n        hide();\n      });\n    }\n  };\n\n  // * data loaders *\n  const loadTableOptions = useMemo(\n    () =>\n      (input = '', page: number, pageSize: number) => {\n        const query = rison.encode({\n          filter: input,\n          page,\n          page_size: pageSize,\n        });\n        return SupersetClient.get({\n          endpoint: `/api/v1/rowlevelsecurity/related/tables?q=${query}`,\n        }).then(response => {\n          const list = response.json.result.map(\n            (item: { value: number; text: string }) => ({\n              label: item.text,\n              value: item.value,\n            }),\n          );\n          return { data: list, totalCount: response.json.count };\n        });\n      },\n    [],\n  );\n\n  const loadRoleOptions = useMemo(\n    () =>\n      (input = '', page: number, pageSize: number) => {\n        const query = rison.encode({\n          filter: input,\n          page,\n          page_size: pageSize,\n        });\n        return SupersetClient.get({\n          endpoint: `/api/v1/rowlevelsecurity/related/roles?q=${query}`,\n        }).then(response => {\n          const list = response.json.result.map(\n            (item: { value: number; text: string }) => ({\n              label: item.text,\n              value: item.value,\n            }),\n          );\n          return { data: list, totalCount: response.json.count };\n        });\n      },\n    [],\n  );\n\n  // * state validators *\n  const validate = () => {\n    if (\n      currentRule?.name &&\n      currentRule?.clause &&\n      currentRule.tables?.length\n    ) {\n      setDisableSave(false);\n    } else {\n      setDisableSave(true);\n    }\n  };\n\n  return (\n    <StyledModal\n      className=\"no-content-padding\"\n      responsive\n      show={show}\n      onHide={hide}\n      primaryButtonName={isEditMode ? t('Save') : t('Add')}\n      disablePrimaryButton={disableSave}\n      onHandledPrimaryAction={onSave}\n      width=\"30%\"\n      maxWidth=\"1450px\"\n      title={\n        <h4 data-test=\"rls-modal-title\">\n          {isEditMode ? (\n            <Icons.EditAlt css={StyledIcon} />\n          ) : (\n            <Icons.PlusLarge css={StyledIcon} />\n          )}\n          {isEditMode ? t('Edit Rule') : t('Add Rule')}\n        </h4>\n      }\n    >\n      <StyledSectionContainer>\n        <div className=\"main-section\">\n          <StyledInputContainer>\n            <LabeledErrorBoundInput\n              id=\"name\"\n              name=\"name\"\n              className=\"labeled-input\"\n              value={currentRule ? currentRule.name : ''}\n              required\n              validationMethods={{\n                onChange: ({ target }: { target: HTMLInputElement }) =>\n                  onTextChange(target),\n              }}\n              css={noBottomMargin}\n              label={t('Rule Name')}\n              data-test=\"rule-name-test\"\n            />\n          </StyledInputContainer>\n\n          <StyledInputContainer>\n            <div className=\"control-label\">\n              {t('Filter Type')}{' '}\n              <InfoTooltip\n                tooltip={t(\n                  'Regular filters add where clauses to queries if a user belongs to a role referenced in the filter, base filters apply filters to all queries except the roles defined in the filter, and can be used to define what users can see if no RLS filters within a filter group apply to them.',\n                )}\n              />\n            </div>\n            <div className=\"input-container\">\n              <Select\n                name=\"filter_type\"\n                ariaLabel={t('Filter Type')}\n                placeholder={t('Filter Type')}\n                onChange={onFilterChange}\n                value={currentRule?.filter_type}\n                options={FilterOptions}\n                data-test=\"rule-filter-type-test\"\n              />\n            </div>\n          </StyledInputContainer>\n\n          <StyledInputContainer>\n            <div className=\"control-label\">\n              {t('Tables')} <span className=\"required\">*</span>\n              <InfoTooltip\n                tooltip={t(\n                  'These are the tables this filter will be applied to.',\n                )}\n              />\n            </div>\n            <div className=\"input-container\">\n              <AsyncSelect\n                ariaLabel={t('Tables')}\n                mode=\"multiple\"\n                onChange={onTablesChange}\n                value={(currentRule?.tables as SelectValue[]) || []}\n                options={loadTableOptions}\n              />\n            </div>\n          </StyledInputContainer>\n\n          <StyledInputContainer>\n            <div className=\"control-label\">\n              {currentRule.filter_type === FilterType.BASE\n                ? t('Excluded roles')\n                : t('Roles')}{' '}\n              <InfoTooltip\n                tooltip={t(\n                  'For regular filters, these are the roles this filter will be applied to. For base filters, these are the roles that the filter DOES NOT apply to, e.g. Admin if admin should see all data.',\n                )}\n              />\n            </div>\n            <div className=\"input-container\">\n              <AsyncSelect\n                ariaLabel={t('Roles')}\n                mode=\"multiple\"\n                onChange={onRolesChange}\n                value={(currentRule?.roles as SelectValue[]) || []}\n                options={loadRoleOptions}\n              />\n            </div>\n          </StyledInputContainer>\n          <StyledInputContainer>\n            <LabeledErrorBoundInput\n              id=\"group_key\"\n              name=\"group_key\"\n              value={currentRule ? currentRule.group_key : ''}\n              validationMethods={{\n                onChange: ({ target }: { target: HTMLInputElement }) =>\n                  onTextChange(target),\n              }}\n              css={noBottomMargin}\n              label={t('Group Key')}\n              hasTooltip\n              tooltipText={t(\n                `Filters with the same group key will be ORed together within the group, while different filter groups will be ANDed together. Undefined group keys are treated as unique groups, i.e. are not grouped together. For example, if a table has three filters, of which two are for departments Finance and Marketing (group key = 'department'), and one refers to the region Europe (group key = 'region'), the filter clause would apply the filter (department = 'Finance' OR department = 'Marketing') AND (region = 'Europe').`,\n              )}\n              data-test=\"group-key-test\"\n            />\n          </StyledInputContainer>\n\n          <StyledInputContainer>\n            <div className=\"control-label\">\n              <LabeledErrorBoundInput\n                id=\"clause\"\n                name=\"clause\"\n                value={currentRule ? currentRule.clause : ''}\n                required\n                validationMethods={{\n                  onChange: ({ target }: { target: HTMLInputElement }) =>\n                    onTextChange(target),\n                }}\n                css={noBottomMargin}\n                label={t('Clause')}\n                hasTooltip\n                tooltipText={t(\n                  'This is the condition that will be added to the WHERE clause. For example, to only return rows for a particular client, you might define a regular filter with the clause `client_id = 9`. To display no rows unless a user belongs to a RLS filter role, a base filter can be created with the clause `1 = 0` (always false).',\n                )}\n                data-test=\"clause-test\"\n              />\n            </div>\n          </StyledInputContainer>\n\n          <StyledInputContainer>\n            <div className=\"control-label\">{t('Description')}</div>\n            <div className=\"input-container\">\n              <textarea\n                name=\"description\"\n                value={currentRule ? currentRule.description : ''}\n                onChange={event => onTextChange(event.target)}\n                data-test=\"description-test\"\n              />\n            </div>\n          </StyledInputContainer>\n        </div>\n      </StyledSectionContainer>\n    </StyledModal>\n  );\n}\n\nexport default RowLevelSecurityModal;\n"]},"metadata":{},"sourceType":"module"}