{"ast":null,"code":"import _isEmpty from \"lodash/isEmpty\";import _debounce from \"lodash/debounce\";import _sortBy from \"lodash/sortBy\";import _isEqual from \"lodash/isEqual\";import _uniq from \"lodash/uniq\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { useEffect, useCallback, useMemo, useState, useRef } from 'react';\n\nimport { styled, SLOW_DEBOUNCE, t } from '@superset-ui/core';\nimport { useDispatch } from 'react-redux';\nimport { AntdForm } from 'src/components';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport { StyledModal } from 'src/components/Modal';\nimport { testWithId } from 'src/utils/testUtils';\nimport { updateCascadeParentIds } from 'src/dashboard/actions/nativeFilters';\nimport { useFilterConfigMap, useFilterConfiguration } from '../state';\nimport FilterConfigurePane from './FilterConfigurePane';\nimport FiltersConfigForm, { FilterPanels } from './FiltersConfigForm/FiltersConfigForm';\nimport Footer from './Footer/Footer';\nimport { useOpenModal, useRemoveCurrentFilter } from './state';\nimport { createHandleSave, createHandleRemoveItem, generateFilterId, getFilterIds, validateForm, NATIVE_FILTER_DIVIDER_PREFIX, hasCircularDependency } from './utils';\nimport DividerConfigForm from './DividerConfigForm';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst StyledModalWrapper = styled(StyledModal)`\n  min-width: 700px;\n  .ant-modal-body {\n    padding: 0px;\n  }\n`;\nexport const StyledModalBody = styled.div`\n  display: flex;\n  height: 700px;\n  flex-direction: row;\n  .filters-list {\n    width: ${(_ref) => {let { theme } = _ref;return theme.gridUnit * 50;}}px;\n    overflow: auto;\n  }\n`;\nexport const StyledForm = styled(AntdForm)`\n  width: 100%;\n`;\nexport const FILTERS_CONFIG_MODAL_TEST_ID = 'filters-config-modal';\nexport const getFiltersConfigModalTestId = testWithId(FILTERS_CONFIG_MODAL_TEST_ID);\nexport const ALLOW_DEPENDENCIES = [\n'filter_range',\n'filter_select',\n'filter_time'];\n\nconst DEFAULT_EMPTY_FILTERS = [];\nconst DEFAULT_REMOVED_FILTERS = {};\nconst DEFAULT_FORM_VALUES = {\n  filters: {} };\n\n/**\n * This is the modal to configure all the dashboard-native filters.\n * Manages modal-level state, such as what filters are in the list,\n * and which filter is currently being edited.\n *\n * Calls the `save` callback with the new FilterConfiguration object\n * when the user saves the filters.\n */\nfunction FiltersConfigModal(_ref2) {let { isOpen, initialFilterId, createNewOnOpen, onSave, onCancel } = _ref2;\n  const dispatch = useDispatch();\n  const [form] = AntdForm.useForm();\n  const configFormRef = useRef();\n  // the filter config from redux state, this does not change until modal is closed.\n  const filterConfig = useFilterConfiguration();\n  const filterConfigMap = useFilterConfigMap();\n  // new filter ids belong to filters have been added during\n  // this configuration session, and only exist in the form state until we submit.\n  const [newFilterIds, setNewFilterIds] = useState(DEFAULT_EMPTY_FILTERS);\n  // store ids of filters that have been removed with the time they were removed\n  // so that we can disappear them after a few secs.\n  // filters are still kept in state until form is submitted.\n  const [removedFilters, setRemovedFilters] = useState(DEFAULT_REMOVED_FILTERS);\n  const [saveAlertVisible, setSaveAlertVisible] = useState(false);\n  // The full ordered set of ((original + new) - completely removed) filter ids\n  // Use this as the canonical list of what filters are being configured!\n  // This includes filter ids that are pending removal, so check for that.\n  const filterIds = useMemo(() => _uniq([...getFilterIds(filterConfig), ...newFilterIds]).filter((id) => {var _removedFilters$id;return !removedFilters[id] || ((_removedFilters$id = removedFilters[id]) == null ? void 0 : _removedFilters$id.isPending);}), [filterConfig, newFilterIds, removedFilters]);\n  // open the first filter in the list to start\n  const initialCurrentFilterId = initialFilterId != null ? initialFilterId : filterIds[0];\n  const [currentFilterId, setCurrentFilterId] = useState(initialCurrentFilterId);\n  const [erroredFilters, setErroredFilters] = useState(DEFAULT_EMPTY_FILTERS);\n  // the form values are managed by the antd form, but we copy them to here\n  // so that we can display them (e.g. filter titles in the tab headers)\n  const [formValues, setFormValues] = useState(DEFAULT_FORM_VALUES);\n  const unsavedFiltersIds = newFilterIds.filter((id) => !removedFilters[id]);\n  // brings back a filter that was previously removed (\"Undo\")\n  const restoreFilter = useCallback((id) => {\n    const removal = removedFilters[id];\n    // gotta clear the removal timeout to prevent the filter from getting deleted\n    if (removal != null && removal.isPending)\n    clearTimeout(removal.timerId);\n    setRemovedFilters((current) => ({ ...current, [id]: null }));\n  }, [removedFilters]);\n  const initialFilterOrder = useMemo(() => Object.keys(filterConfigMap), [filterConfigMap]);\n  // State for tracking the re-ordering of filters\n  const [orderedFilters, setOrderedFilters] = useState(initialFilterOrder);\n  // State for rendered filter to improve performance\n  const [renderedFilters, setRenderedFilters] = useState([\n  initialCurrentFilterId]);\n\n  const getActiveFilterPanelKey = (filterId) => [\n  `${filterId}-${FilterPanels.configuration.key}`,\n  `${filterId}-${FilterPanels.settings.key}`];\n\n  const [activeFilterPanelKey, setActiveFilterPanelKey] = useState(getActiveFilterPanelKey(initialCurrentFilterId));\n  const handleTabChange = (filterId) => {\n    setCurrentFilterId(filterId);\n    setActiveFilterPanelKey(getActiveFilterPanelKey(filterId));\n  };\n  // generates a new filter id and appends it to the newFilterIds\n  const addFilter = useCallback((type) => {\n    const newFilterId = generateFilterId(type);\n    setNewFilterIds([...newFilterIds, newFilterId]);\n    setCurrentFilterId(newFilterId);\n    setSaveAlertVisible(false);\n    setOrderedFilters([...orderedFilters, newFilterId]);\n    setActiveFilterPanelKey(getActiveFilterPanelKey(newFilterId));\n  }, [\n  newFilterIds,\n  orderedFilters,\n  setCurrentFilterId,\n  setOrderedFilters,\n  setNewFilterIds]);\n\n  useOpenModal(isOpen, addFilter, createNewOnOpen);\n  useRemoveCurrentFilter(removedFilters, currentFilterId, orderedFilters, setCurrentFilterId);\n  const handleRemoveItem = createHandleRemoveItem(setRemovedFilters, setOrderedFilters, setSaveAlertVisible);\n  // After this, it should be as if the modal was just opened fresh.\n  // Called when the modal is closed.\n  const resetForm = function (isSaving) {if (isSaving === void 0) {isSaving = false;}\n    setNewFilterIds(DEFAULT_EMPTY_FILTERS);\n    setCurrentFilterId(initialCurrentFilterId);\n    setRemovedFilters(DEFAULT_REMOVED_FILTERS);\n    setSaveAlertVisible(false);\n    setFormValues(DEFAULT_FORM_VALUES);\n    setErroredFilters(DEFAULT_EMPTY_FILTERS);\n    if (filterIds.length > 0) {\n      setActiveFilterPanelKey(getActiveFilterPanelKey(filterIds[0]));\n    }\n    if (!isSaving) {\n      setOrderedFilters(initialFilterOrder);\n    }\n    setRenderedFilters([initialCurrentFilterId]);\n    form.resetFields(['filters']);\n    form.setFieldsValue({ changed: false });\n  };\n  const getFilterTitle = useCallback((id) => {\n    const formValue = formValues.filters[id];\n    const config = filterConfigMap[id];\n    return formValue && 'name' in formValue && formValue.name ||\n    formValue && 'title' in formValue && formValue.title ||\n    config && 'name' in config && config.name ||\n    config && 'title' in config && config.title ||\n    t('[untitled]');\n  }, [filterConfigMap, formValues.filters]);\n  const canBeUsedAsDependency = useCallback((filterId) => {var _form$getFieldValue;\n    if (removedFilters[filterId]) {\n      return false;\n    }\n    const component = ((_form$getFieldValue = form.getFieldValue('filters')) == null ? void 0 : _form$getFieldValue[filterId]) || filterConfigMap[filterId];\n    return component &&\n    'filterType' in component &&\n    _includesInstanceProperty(ALLOW_DEPENDENCIES).call(ALLOW_DEPENDENCIES, component.filterType);\n  }, [filterConfigMap, form, removedFilters]);\n  const getAvailableFilters = useCallback((filterId) => filterIds.\n  filter((id) => id !== filterId).\n  filter((id) => canBeUsedAsDependency(id)).\n  map((id) => {var _filterConfigMap$id;return {\n      label: getFilterTitle(id),\n      value: id,\n      type: (_filterConfigMap$id = filterConfigMap[id]) == null ? void 0 : _filterConfigMap$id.filterType };}),\n  [canBeUsedAsDependency, filterIds, getFilterTitle]);\n  const cleanDeletedParents = (values) => {\n    Object.keys(filterConfigMap).forEach((key) => {\n      const filter = filterConfigMap[key];\n      if (!('cascadeParentIds' in filter)) {\n        return;\n      }\n      const { cascadeParentIds } = filter;\n      if (cascadeParentIds) {\n        dispatch(updateCascadeParentIds(key, cascadeParentIds.filter((id) => canBeUsedAsDependency(id))));\n      }\n    });\n    const filters = values == null ? void 0 : values.filters;\n    if (filters) {\n      Object.keys(filters).forEach((key) => {\n        const filter = filters[key];\n        if (!('dependencies' in filter)) {\n          return;\n        }\n        const { dependencies } = filter;\n        if (dependencies) {\n          filter.dependencies = dependencies.filter((id) => canBeUsedAsDependency(id));\n        }\n      });\n    }\n  };\n  const handleErroredFilters = useCallback(() => {\n    // managing left pane errored filters indicators\n    const formValidationFields = form.getFieldsError();\n    const erroredFiltersIds = [];\n    formValidationFields.forEach((field) => {\n      const filterId = field.name[1];\n      if (field.errors.length > 0 && !_includesInstanceProperty(erroredFiltersIds).call(erroredFiltersIds, filterId)) {\n        erroredFiltersIds.push(filterId);\n      }\n    });\n    // no form validation issues found, resets errored filters\n    if (!erroredFiltersIds.length && erroredFilters.length > 0) {\n      setErroredFilters(DEFAULT_EMPTY_FILTERS);\n      return;\n    }\n    // form validation issues found, sets errored filters\n    if (erroredFiltersIds.length > 0 &&\n    !_isEqual(_sortBy(erroredFilters), _sortBy(erroredFiltersIds))) {\n      setErroredFilters(erroredFiltersIds);\n    }\n  }, [form, erroredFilters]);\n  const handleSave = async () => {\n    const values = await validateForm(form, currentFilterId, setCurrentFilterId);\n    handleErroredFilters();\n    if (values) {\n      cleanDeletedParents(values);\n      createHandleSave(filterConfigMap, orderedFilters, removedFilters, onSave, values)();\n      resetForm(true);\n    } else\n    {\n      configFormRef.current.changeTab('configuration');\n    }\n  };\n  const handleConfirmCancel = () => {\n    resetForm();\n    onCancel();\n  };\n  const handleCancel = () => {\n    const changed = form.getFieldValue('changed');\n    const didChangeOrder = orderedFilters.length !== initialFilterOrder.length ||\n    orderedFilters.some((val, index) => val !== initialFilterOrder[index]);\n    if (unsavedFiltersIds.length > 0 ||\n    form.isFieldsTouched() ||\n    changed ||\n    didChangeOrder) {\n      setSaveAlertVisible(true);\n    } else\n    {\n      handleConfirmCancel();\n    }\n  };\n  const handleRearrange = (dragIndex, targetIndex) => {\n    const newOrderedFilter = [...orderedFilters];\n    const removed = newOrderedFilter.splice(dragIndex, 1)[0];\n    newOrderedFilter.splice(targetIndex, 0, removed);\n    setOrderedFilters(newOrderedFilter);\n  };\n  const buildDependencyMap = useCallback(() => {\n    const dependencyMap = new Map();\n    const filters = form.getFieldValue('filters');\n    if (filters) {\n      Object.keys(filters).forEach((key) => {\n        const formItem = filters[key];\n        const configItem = filterConfigMap[key];\n        let array = [];\n        if (formItem && 'dependencies' in formItem) {\n          array = [...formItem.dependencies];\n        } else\n        if (configItem != null && configItem.cascadeParentIds) {\n          array = [...configItem.cascadeParentIds];\n        }\n        dependencyMap.set(key, array);\n      });\n    }\n    return dependencyMap;\n  }, [filterConfigMap, form]);\n  const validateDependencies = useCallback(() => {\n    const dependencyMap = buildDependencyMap();\n    filterIds.\n    filter((id) => !removedFilters[id]).\n    forEach((filterId) => {\n      const result = hasCircularDependency(dependencyMap, filterId);\n      const field = {\n        name: ['filters', filterId, 'dependencies'],\n        errors: result ? [t('Cyclic dependency detected')] : [] };\n\n      form.setFields([field]);\n    });\n    handleErroredFilters();\n  }, [\n  buildDependencyMap,\n  filterIds,\n  form,\n  handleErroredFilters,\n  removedFilters]);\n\n  const getDependencySuggestion = useCallback((filterId) => {\n    const dependencyMap = buildDependencyMap();\n    const possibleDependencies = orderedFilters.filter((key) => key !== filterId && canBeUsedAsDependency(key));\n    const found = possibleDependencies.find((filter) => {\n      const dependencies = dependencyMap.get(filterId) || [];\n      dependencies.push(filter);\n      if (hasCircularDependency(dependencyMap, filterId)) {\n        dependencies.pop();\n        return false;\n      }\n      return true;\n    });\n    return found || possibleDependencies[0];\n  }, [buildDependencyMap, canBeUsedAsDependency, orderedFilters]);\n  const handleValuesChange = useMemo(() => _debounce((changes, values) => {\n    const didChangeFilterName = changes.filters &&\n    Object.values(changes.filters).some((filter) => filter.name && filter.name !== null);\n    const didChangeSectionTitle = changes.filters &&\n    Object.values(changes.filters).some((filter) => filter.title && filter.title !== null);\n    if (didChangeFilterName || didChangeSectionTitle) {\n      // we only need to set this if a name/title changed\n      setFormValues(values);\n    }\n    setSaveAlertVisible(false);\n    handleErroredFilters();\n  }, SLOW_DEBOUNCE), [handleErroredFilters]);\n  useEffect(() => {\n    if (!_isEmpty(removedFilters)) {\n      setErroredFilters((prevErroredFilters) => prevErroredFilters.filter((f) => !removedFilters[f]));\n    }\n  }, [removedFilters]);\n  useEffect(() => {\n    if (!_includesInstanceProperty(renderedFilters).call(renderedFilters, currentFilterId)) {\n      setRenderedFilters([...renderedFilters, currentFilterId]);\n    }\n  }, [currentFilterId]);\n  const handleActiveFilterPanelChange = useCallback((key) => setActiveFilterPanelKey(key), [setActiveFilterPanelKey]);\n  const formList = useMemo(() => orderedFilters.map((id) => {\n    if (!_includesInstanceProperty(renderedFilters).call(renderedFilters, id))\n    return null;\n    const isDivider = id.startsWith(NATIVE_FILTER_DIVIDER_PREFIX);\n    const isActive = currentFilterId === id;\n    return ___EmotionJSX(\"div\", { key: id, style: {\n        height: '100%',\n        overflowY: 'auto',\n        display: isActive ? '' : 'none' } },\n\n    isDivider ? ___EmotionJSX(DividerConfigForm, { componentId: id, divider: filterConfigMap[id] }) : ___EmotionJSX(FiltersConfigForm, { ref: configFormRef, form: form, filterId: id, filterToEdit: filterConfigMap[id], removedFilters: removedFilters, restoreFilter: restoreFilter, getAvailableFilters: getAvailableFilters, key: id, activeFilterPanelKeys: activeFilterPanelKey, handleActiveFilterPanelChange: handleActiveFilterPanelChange, isActive: isActive, setErroredFilters: setErroredFilters, validateDependencies: validateDependencies, getDependencySuggestion: getDependencySuggestion }));\n\n  }), [\n  renderedFilters,\n  orderedFilters,\n  currentFilterId,\n  filterConfigMap,\n  form,\n  removedFilters,\n  restoreFilter,\n  getAvailableFilters,\n  activeFilterPanelKey,\n  validateDependencies,\n  getDependencySuggestion,\n  handleActiveFilterPanelChange]);\n\n  return ___EmotionJSX(StyledModalWrapper, { visible: isOpen, maskClosable: false, title: t('Add and edit filters'), width: \"50%\", destroyOnClose: true, onCancel: handleCancel, onOk: handleSave, centered: true, \"data-test\": \"filter-modal\", footer: ___EmotionJSX(Footer, { onDismiss: () => setSaveAlertVisible(false), onCancel: handleCancel, handleSave: handleSave, canSave: !erroredFilters.length, saveAlertVisible: saveAlertVisible, onConfirmCancel: handleConfirmCancel }) },\n  ___EmotionJSX(ErrorBoundary, null,\n  ___EmotionJSX(StyledModalBody, null,\n  ___EmotionJSX(StyledForm, { form: form, onValuesChange: handleValuesChange, layout: \"vertical\" },\n  ___EmotionJSX(FilterConfigurePane, { erroredFilters: erroredFilters, onRemove: handleRemoveItem, onAdd: addFilter, onChange: handleTabChange, getFilterTitle: getFilterTitle, currentFilterId: currentFilterId, removedFilters: removedFilters, restoreFilter: restoreFilter, onRearrange: handleRearrange, filters: orderedFilters },\n  formList)))));\n\n\n\n\n\n}__signature__(FiltersConfigModal, \"useDispatch{dispatch}\\nuseForm{[form]}\\nuseRef{configFormRef}\\nuseFilterConfiguration{filterConfig}\\nuseFilterConfigMap{filterConfigMap}\\nuseState{[newFilterIds, setNewFilterIds](DEFAULT_EMPTY_FILTERS)}\\nuseState{[removedFilters, setRemovedFilters](DEFAULT_REMOVED_FILTERS)}\\nuseState{[saveAlertVisible, setSaveAlertVisible](false)}\\nuseMemo{filterIds}\\nuseState{[currentFilterId, setCurrentFilterId](initialCurrentFilterId)}\\nuseState{[erroredFilters, setErroredFilters](DEFAULT_EMPTY_FILTERS)}\\nuseState{[formValues, setFormValues](DEFAULT_FORM_VALUES)}\\nuseCallback{restoreFilter}\\nuseMemo{initialFilterOrder}\\nuseState{[orderedFilters, setOrderedFilters](initialFilterOrder)}\\nuseState{[renderedFilters, setRenderedFilters]([\\n        initialCurrentFilterId,\\n    ])}\\nuseState{[activeFilterPanelKey, setActiveFilterPanelKey](getActiveFilterPanelKey(initialCurrentFilterId))}\\nuseCallback{addFilter}\\nuseOpenModal{}\\nuseRemoveCurrentFilter{}\\nuseCallback{getFilterTitle}\\nuseCallback{canBeUsedAsDependency}\\nuseCallback{getAvailableFilters}\\nuseCallback{handleErroredFilters}\\nuseCallback{buildDependencyMap}\\nuseCallback{validateDependencies}\\nuseCallback{getDependencySuggestion}\\nuseMemo{handleValuesChange}\\nuseEffect{}\\nuseEffect{}\\nuseCallback{handleActiveFilterPanelChange}\\nuseMemo{formList}\", () => [useDispatch, useFilterConfiguration, useFilterConfigMap, useOpenModal, useRemoveCurrentFilter]);const _default = /*#__PURE__*/\nReact.memo(FiltersConfigModal);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(StyledModalWrapper, \"StyledModalWrapper\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(StyledModalBody, \"StyledModalBody\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(StyledForm, \"StyledForm\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(FILTERS_CONFIG_MODAL_TEST_ID, \"FILTERS_CONFIG_MODAL_TEST_ID\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(getFiltersConfigModalTestId, \"getFiltersConfigModalTestId\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(ALLOW_DEPENDENCIES, \"ALLOW_DEPENDENCIES\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(DEFAULT_EMPTY_FILTERS, \"DEFAULT_EMPTY_FILTERS\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(DEFAULT_REMOVED_FILTERS, \"DEFAULT_REMOVED_FILTERS\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(DEFAULT_FORM_VALUES, \"DEFAULT_FORM_VALUES\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(FiltersConfigModal, \"FiltersConfigModal\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");reactHotLoader.register(_default, \"default\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"mappings":"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","names":["React","useEffect","useCallback","useMemo","useState","useRef","styled","SLOW_DEBOUNCE","t","useDispatch","AntdForm","ErrorBoundary","StyledModal","testWithId","updateCascadeParentIds","useFilterConfigMap","useFilterConfiguration","FilterConfigurePane","FiltersConfigForm","FilterPanels","Footer","useOpenModal","useRemoveCurrentFilter","createHandleSave","createHandleRemoveItem","generateFilterId","getFilterIds","validateForm","NATIVE_FILTER_DIVIDER_PREFIX","hasCircularDependency","DividerConfigForm","StyledModalWrapper","StyledModalBody","div","theme","gridUnit","StyledForm","FILTERS_CONFIG_MODAL_TEST_ID","getFiltersConfigModalTestId","ALLOW_DEPENDENCIES","DEFAULT_EMPTY_FILTERS","DEFAULT_REMOVED_FILTERS","DEFAULT_FORM_VALUES","filters","FiltersConfigModal","isOpen","initialFilterId","createNewOnOpen","onSave","onCancel","dispatch","form","useForm","configFormRef","filterConfig","filterConfigMap","newFilterIds","setNewFilterIds","removedFilters","setRemovedFilters","saveAlertVisible","setSaveAlertVisible","filterIds","filter","id","isPending","initialCurrentFilterId","currentFilterId","setCurrentFilterId","erroredFilters","setErroredFilters","formValues","setFormValues","unsavedFiltersIds","restoreFilter","removal","clearTimeout","timerId","current","initialFilterOrder","Object","keys","orderedFilters","setOrderedFilters","renderedFilters","setRenderedFilters","getActiveFilterPanelKey","filterId","configuration","key","settings","activeFilterPanelKey","setActiveFilterPanelKey","handleTabChange","addFilter","type","newFilterId","handleRemoveItem","resetForm","isSaving","length","resetFields","setFieldsValue","changed","getFilterTitle","formValue","config","name","title","canBeUsedAsDependency","component","getFieldValue","filterType","getAvailableFilters","map","label","value","cleanDeletedParents","values","forEach","cascadeParentIds","dependencies","handleErroredFilters","formValidationFields","getFieldsError","erroredFiltersIds","field","errors","push","handleSave","changeTab","handleConfirmCancel","handleCancel","didChangeOrder","some","val","index","isFieldsTouched","handleRearrange","dragIndex","targetIndex","newOrderedFilter","removed","splice","buildDependencyMap","dependencyMap","Map","formItem","configItem","array","set","validateDependencies","result","setFields","getDependencySuggestion","possibleDependencies","found","find","get","pop","handleValuesChange","changes","didChangeFilterName","didChangeSectionTitle","prevErroredFilters","f","handleActiveFilterPanelChange","formList","isDivider","startsWith","isActive","height","overflowY","display","memo"],"sourceRoot":"","sources":["/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FiltersConfigModal/FiltersConfigModal.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, {\n  useEffect,\n  useCallback,\n  useMemo,\n  useState,\n  useRef,\n} from 'react';\nimport { uniq, isEqual, sortBy, debounce, isEmpty } from 'lodash';\nimport {\n  Filter,\n  FilterConfiguration,\n  NativeFilterType,\n  Divider,\n  styled,\n  SLOW_DEBOUNCE,\n  t,\n} from '@superset-ui/core';\nimport { useDispatch } from 'react-redux';\nimport { AntdForm } from 'src/components';\nimport ErrorBoundary from 'src/components/ErrorBoundary';\nimport { StyledModal } from 'src/components/Modal';\nimport { testWithId } from 'src/utils/testUtils';\nimport { updateCascadeParentIds } from 'src/dashboard/actions/nativeFilters';\nimport { useFilterConfigMap, useFilterConfiguration } from '../state';\nimport FilterConfigurePane from './FilterConfigurePane';\nimport FiltersConfigForm, {\n  FilterPanels,\n} from './FiltersConfigForm/FiltersConfigForm';\nimport Footer from './Footer/Footer';\nimport { useOpenModal, useRemoveCurrentFilter } from './state';\nimport { FilterRemoval, NativeFiltersForm } from './types';\nimport {\n  createHandleSave,\n  createHandleRemoveItem,\n  generateFilterId,\n  getFilterIds,\n  validateForm,\n  NATIVE_FILTER_DIVIDER_PREFIX,\n  hasCircularDependency,\n} from './utils';\nimport DividerConfigForm from './DividerConfigForm';\n\nconst StyledModalWrapper = styled(StyledModal)`\n  min-width: 700px;\n  .ant-modal-body {\n    padding: 0px;\n  }\n`;\n\nexport const StyledModalBody = styled.div`\n  display: flex;\n  height: 700px;\n  flex-direction: row;\n  .filters-list {\n    width: ${({ theme }) => theme.gridUnit * 50}px;\n    overflow: auto;\n  }\n`;\n\nexport const StyledForm = styled(AntdForm)`\n  width: 100%;\n`;\n\nexport const FILTERS_CONFIG_MODAL_TEST_ID = 'filters-config-modal';\nexport const getFiltersConfigModalTestId = testWithId(\n  FILTERS_CONFIG_MODAL_TEST_ID,\n);\n\nexport interface FiltersConfigModalProps {\n  isOpen: boolean;\n  initialFilterId?: string;\n  createNewOnOpen?: boolean;\n  onSave: (filterConfig: FilterConfiguration) => Promise<void>;\n  onCancel: () => void;\n}\nexport const ALLOW_DEPENDENCIES = [\n  'filter_range',\n  'filter_select',\n  'filter_time',\n];\n\nconst DEFAULT_EMPTY_FILTERS: string[] = [];\nconst DEFAULT_REMOVED_FILTERS: Record<string, FilterRemoval> = {};\nconst DEFAULT_FORM_VALUES: NativeFiltersForm = {\n  filters: {},\n};\n\n/**\n * This is the modal to configure all the dashboard-native filters.\n * Manages modal-level state, such as what filters are in the list,\n * and which filter is currently being edited.\n *\n * Calls the `save` callback with the new FilterConfiguration object\n * when the user saves the filters.\n */\nfunction FiltersConfigModal({\n  isOpen,\n  initialFilterId,\n  createNewOnOpen,\n  onSave,\n  onCancel,\n}: FiltersConfigModalProps) {\n  const dispatch = useDispatch();\n\n  const [form] = AntdForm.useForm<NativeFiltersForm>();\n\n  const configFormRef = useRef<any>();\n\n  // the filter config from redux state, this does not change until modal is closed.\n  const filterConfig = useFilterConfiguration();\n  const filterConfigMap = useFilterConfigMap();\n\n  // new filter ids belong to filters have been added during\n  // this configuration session, and only exist in the form state until we submit.\n  const [newFilterIds, setNewFilterIds] = useState<string[]>(\n    DEFAULT_EMPTY_FILTERS,\n  );\n\n  // store ids of filters that have been removed with the time they were removed\n  // so that we can disappear them after a few secs.\n  // filters are still kept in state until form is submitted.\n  const [removedFilters, setRemovedFilters] = useState<\n    Record<string, FilterRemoval>\n  >(DEFAULT_REMOVED_FILTERS);\n\n  const [saveAlertVisible, setSaveAlertVisible] = useState<boolean>(false);\n\n  // The full ordered set of ((original + new) - completely removed) filter ids\n  // Use this as the canonical list of what filters are being configured!\n  // This includes filter ids that are pending removal, so check for that.\n  const filterIds = useMemo(\n    () =>\n      uniq([...getFilterIds(filterConfig), ...newFilterIds]).filter(\n        id => !removedFilters[id] || removedFilters[id]?.isPending,\n      ),\n    [filterConfig, newFilterIds, removedFilters],\n  );\n\n  // open the first filter in the list to start\n  const initialCurrentFilterId = initialFilterId ?? filterIds[0];\n  const [currentFilterId, setCurrentFilterId] = useState(\n    initialCurrentFilterId,\n  );\n  const [erroredFilters, setErroredFilters] = useState<string[]>(\n    DEFAULT_EMPTY_FILTERS,\n  );\n\n  // the form values are managed by the antd form, but we copy them to here\n  // so that we can display them (e.g. filter titles in the tab headers)\n  const [formValues, setFormValues] =\n    useState<NativeFiltersForm>(DEFAULT_FORM_VALUES);\n\n  const unsavedFiltersIds = newFilterIds.filter(id => !removedFilters[id]);\n  // brings back a filter that was previously removed (\"Undo\")\n  const restoreFilter = useCallback(\n    (id: string) => {\n      const removal = removedFilters[id];\n      // gotta clear the removal timeout to prevent the filter from getting deleted\n      if (removal?.isPending) clearTimeout(removal.timerId);\n      setRemovedFilters(current => ({ ...current, [id]: null }));\n    },\n    [removedFilters],\n  );\n  const initialFilterOrder = useMemo(\n    () => Object.keys(filterConfigMap),\n    [filterConfigMap],\n  );\n\n  // State for tracking the re-ordering of filters\n  const [orderedFilters, setOrderedFilters] =\n    useState<string[]>(initialFilterOrder);\n\n  // State for rendered filter to improve performance\n  const [renderedFilters, setRenderedFilters] = useState<string[]>([\n    initialCurrentFilterId,\n  ]);\n\n  const getActiveFilterPanelKey = (filterId: string) => [\n    `${filterId}-${FilterPanels.configuration.key}`,\n    `${filterId}-${FilterPanels.settings.key}`,\n  ];\n\n  const [activeFilterPanelKey, setActiveFilterPanelKey] = useState<\n    string | string[]\n  >(getActiveFilterPanelKey(initialCurrentFilterId));\n\n  const handleTabChange = (filterId: string) => {\n    setCurrentFilterId(filterId);\n    setActiveFilterPanelKey(getActiveFilterPanelKey(filterId));\n  };\n\n  // generates a new filter id and appends it to the newFilterIds\n  const addFilter = useCallback(\n    (type: NativeFilterType) => {\n      const newFilterId = generateFilterId(type);\n      setNewFilterIds([...newFilterIds, newFilterId]);\n      setCurrentFilterId(newFilterId);\n      setSaveAlertVisible(false);\n      setOrderedFilters([...orderedFilters, newFilterId]);\n      setActiveFilterPanelKey(getActiveFilterPanelKey(newFilterId));\n    },\n    [\n      newFilterIds,\n      orderedFilters,\n      setCurrentFilterId,\n      setOrderedFilters,\n      setNewFilterIds,\n    ],\n  );\n\n  useOpenModal(isOpen, addFilter, createNewOnOpen);\n\n  useRemoveCurrentFilter(\n    removedFilters,\n    currentFilterId,\n    orderedFilters,\n    setCurrentFilterId,\n  );\n\n  const handleRemoveItem = createHandleRemoveItem(\n    setRemovedFilters,\n    setOrderedFilters,\n    setSaveAlertVisible,\n  );\n\n  // After this, it should be as if the modal was just opened fresh.\n  // Called when the modal is closed.\n  const resetForm = (isSaving = false) => {\n    setNewFilterIds(DEFAULT_EMPTY_FILTERS);\n    setCurrentFilterId(initialCurrentFilterId);\n    setRemovedFilters(DEFAULT_REMOVED_FILTERS);\n    setSaveAlertVisible(false);\n    setFormValues(DEFAULT_FORM_VALUES);\n    setErroredFilters(DEFAULT_EMPTY_FILTERS);\n    if (filterIds.length > 0) {\n      setActiveFilterPanelKey(getActiveFilterPanelKey(filterIds[0]));\n    }\n    if (!isSaving) {\n      setOrderedFilters(initialFilterOrder);\n    }\n    setRenderedFilters([initialCurrentFilterId]);\n    form.resetFields(['filters']);\n    form.setFieldsValue({ changed: false });\n  };\n\n  const getFilterTitle = useCallback(\n    (id: string) => {\n      const formValue = formValues.filters[id];\n      const config = filterConfigMap[id];\n      return (\n        (formValue && 'name' in formValue && formValue.name) ||\n        (formValue && 'title' in formValue && formValue.title) ||\n        (config && 'name' in config && config.name) ||\n        (config && 'title' in config && config.title) ||\n        t('[untitled]')\n      );\n    },\n    [filterConfigMap, formValues.filters],\n  );\n\n  const canBeUsedAsDependency = useCallback(\n    (filterId: string) => {\n      if (removedFilters[filterId]) {\n        return false;\n      }\n      const component =\n        form.getFieldValue('filters')?.[filterId] || filterConfigMap[filterId];\n      return (\n        component &&\n        'filterType' in component &&\n        ALLOW_DEPENDENCIES.includes(component.filterType)\n      );\n    },\n    [filterConfigMap, form, removedFilters],\n  );\n\n  const getAvailableFilters = useCallback(\n    (filterId: string) =>\n      filterIds\n        .filter(id => id !== filterId)\n        .filter(id => canBeUsedAsDependency(id))\n        .map(id => ({\n          label: getFilterTitle(id),\n          value: id,\n          type: filterConfigMap[id]?.filterType,\n        })),\n    [canBeUsedAsDependency, filterIds, getFilterTitle],\n  );\n\n  const cleanDeletedParents = (values: NativeFiltersForm | null) => {\n    Object.keys(filterConfigMap).forEach(key => {\n      const filter = filterConfigMap[key];\n      if (!('cascadeParentIds' in filter)) {\n        return;\n      }\n      const { cascadeParentIds } = filter;\n      if (cascadeParentIds) {\n        dispatch(\n          updateCascadeParentIds(\n            key,\n            cascadeParentIds.filter(id => canBeUsedAsDependency(id)),\n          ),\n        );\n      }\n    });\n\n    const filters = values?.filters;\n    if (filters) {\n      Object.keys(filters).forEach(key => {\n        const filter = filters[key];\n        if (!('dependencies' in filter)) {\n          return;\n        }\n        const { dependencies } = filter;\n        if (dependencies) {\n          filter.dependencies = dependencies.filter(id =>\n            canBeUsedAsDependency(id),\n          );\n        }\n      });\n    }\n  };\n\n  const handleErroredFilters = useCallback(() => {\n    // managing left pane errored filters indicators\n    const formValidationFields = form.getFieldsError();\n    const erroredFiltersIds: string[] = [];\n\n    formValidationFields.forEach(field => {\n      const filterId = field.name[1] as string;\n      if (field.errors.length > 0 && !erroredFiltersIds.includes(filterId)) {\n        erroredFiltersIds.push(filterId);\n      }\n    });\n\n    // no form validation issues found, resets errored filters\n    if (!erroredFiltersIds.length && erroredFilters.length > 0) {\n      setErroredFilters(DEFAULT_EMPTY_FILTERS);\n      return;\n    }\n    // form validation issues found, sets errored filters\n    if (\n      erroredFiltersIds.length > 0 &&\n      !isEqual(sortBy(erroredFilters), sortBy(erroredFiltersIds))\n    ) {\n      setErroredFilters(erroredFiltersIds);\n    }\n  }, [form, erroredFilters]);\n\n  const handleSave = async () => {\n    const values: NativeFiltersForm | null = await validateForm(\n      form,\n      currentFilterId,\n      setCurrentFilterId,\n    );\n\n    handleErroredFilters();\n\n    if (values) {\n      cleanDeletedParents(values);\n      createHandleSave(\n        filterConfigMap,\n        orderedFilters,\n        removedFilters,\n        onSave,\n        values,\n      )();\n      resetForm(true);\n    } else {\n      configFormRef.current.changeTab('configuration');\n    }\n  };\n\n  const handleConfirmCancel = () => {\n    resetForm();\n    onCancel();\n  };\n\n  const handleCancel = () => {\n    const changed = form.getFieldValue('changed');\n    const didChangeOrder =\n      orderedFilters.length !== initialFilterOrder.length ||\n      orderedFilters.some((val, index) => val !== initialFilterOrder[index]);\n    if (\n      unsavedFiltersIds.length > 0 ||\n      form.isFieldsTouched() ||\n      changed ||\n      didChangeOrder\n    ) {\n      setSaveAlertVisible(true);\n    } else {\n      handleConfirmCancel();\n    }\n  };\n  const handleRearrange = (dragIndex: number, targetIndex: number) => {\n    const newOrderedFilter = [...orderedFilters];\n    const removed = newOrderedFilter.splice(dragIndex, 1)[0];\n    newOrderedFilter.splice(targetIndex, 0, removed);\n    setOrderedFilters(newOrderedFilter);\n  };\n\n  const buildDependencyMap = useCallback(() => {\n    const dependencyMap = new Map<string, string[]>();\n    const filters = form.getFieldValue('filters');\n    if (filters) {\n      Object.keys(filters).forEach(key => {\n        const formItem = filters[key];\n        const configItem = filterConfigMap[key];\n        let array: string[] = [];\n        if (formItem && 'dependencies' in formItem) {\n          array = [...formItem.dependencies];\n        } else if (configItem?.cascadeParentIds) {\n          array = [...configItem.cascadeParentIds];\n        }\n        dependencyMap.set(key, array);\n      });\n    }\n    return dependencyMap;\n  }, [filterConfigMap, form]);\n\n  const validateDependencies = useCallback(() => {\n    const dependencyMap = buildDependencyMap();\n    filterIds\n      .filter(id => !removedFilters[id])\n      .forEach(filterId => {\n        const result = hasCircularDependency(dependencyMap, filterId);\n        const field = {\n          name: ['filters', filterId, 'dependencies'],\n          errors: result ? [t('Cyclic dependency detected')] : [],\n        };\n        form.setFields([field]);\n      });\n    handleErroredFilters();\n  }, [\n    buildDependencyMap,\n    filterIds,\n    form,\n    handleErroredFilters,\n    removedFilters,\n  ]);\n\n  const getDependencySuggestion = useCallback(\n    (filterId: string) => {\n      const dependencyMap = buildDependencyMap();\n      const possibleDependencies = orderedFilters.filter(\n        key => key !== filterId && canBeUsedAsDependency(key),\n      );\n      const found = possibleDependencies.find(filter => {\n        const dependencies = dependencyMap.get(filterId) || [];\n        dependencies.push(filter);\n        if (hasCircularDependency(dependencyMap, filterId)) {\n          dependencies.pop();\n          return false;\n        }\n        return true;\n      });\n      return found || possibleDependencies[0];\n    },\n    [buildDependencyMap, canBeUsedAsDependency, orderedFilters],\n  );\n\n  const handleValuesChange = useMemo(\n    () =>\n      debounce((changes: any, values: NativeFiltersForm) => {\n        const didChangeFilterName =\n          changes.filters &&\n          Object.values(changes.filters).some(\n            (filter: any) => filter.name && filter.name !== null,\n          );\n        const didChangeSectionTitle =\n          changes.filters &&\n          Object.values(changes.filters).some(\n            (filter: any) => filter.title && filter.title !== null,\n          );\n        if (didChangeFilterName || didChangeSectionTitle) {\n          // we only need to set this if a name/title changed\n          setFormValues(values);\n        }\n        setSaveAlertVisible(false);\n        handleErroredFilters();\n      }, SLOW_DEBOUNCE),\n    [handleErroredFilters],\n  );\n\n  useEffect(() => {\n    if (!isEmpty(removedFilters)) {\n      setErroredFilters(prevErroredFilters =>\n        prevErroredFilters.filter(f => !removedFilters[f]),\n      );\n    }\n  }, [removedFilters]);\n\n  useEffect(() => {\n    if (!renderedFilters.includes(currentFilterId)) {\n      setRenderedFilters([...renderedFilters, currentFilterId]);\n    }\n  }, [currentFilterId]);\n\n  const handleActiveFilterPanelChange = useCallback(\n    key => setActiveFilterPanelKey(key),\n    [setActiveFilterPanelKey],\n  );\n\n  const formList = useMemo(\n    () =>\n      orderedFilters.map(id => {\n        if (!renderedFilters.includes(id)) return null;\n        const isDivider = id.startsWith(NATIVE_FILTER_DIVIDER_PREFIX);\n        const isActive = currentFilterId === id;\n        return (\n          <div\n            key={id}\n            style={{\n              height: '100%',\n              overflowY: 'auto',\n              display: isActive ? '' : 'none',\n            }}\n          >\n            {isDivider ? (\n              <DividerConfigForm\n                componentId={id}\n                divider={filterConfigMap[id] as Divider}\n              />\n            ) : (\n              <FiltersConfigForm\n                ref={configFormRef}\n                form={form}\n                filterId={id}\n                filterToEdit={filterConfigMap[id] as Filter}\n                removedFilters={removedFilters}\n                restoreFilter={restoreFilter}\n                getAvailableFilters={getAvailableFilters}\n                key={id}\n                activeFilterPanelKeys={activeFilterPanelKey}\n                handleActiveFilterPanelChange={handleActiveFilterPanelChange}\n                isActive={isActive}\n                setErroredFilters={setErroredFilters}\n                validateDependencies={validateDependencies}\n                getDependencySuggestion={getDependencySuggestion}\n              />\n            )}\n          </div>\n        );\n      }),\n    [\n      renderedFilters,\n      orderedFilters,\n      currentFilterId,\n      filterConfigMap,\n      form,\n      removedFilters,\n      restoreFilter,\n      getAvailableFilters,\n      activeFilterPanelKey,\n      validateDependencies,\n      getDependencySuggestion,\n      handleActiveFilterPanelChange,\n    ],\n  );\n\n  return (\n    <StyledModalWrapper\n      visible={isOpen}\n      maskClosable={false}\n      title={t('Add and edit filters')}\n      width=\"50%\"\n      destroyOnClose\n      onCancel={handleCancel}\n      onOk={handleSave}\n      centered\n      data-test=\"filter-modal\"\n      footer={\n        <Footer\n          onDismiss={() => setSaveAlertVisible(false)}\n          onCancel={handleCancel}\n          handleSave={handleSave}\n          canSave={!erroredFilters.length}\n          saveAlertVisible={saveAlertVisible}\n          onConfirmCancel={handleConfirmCancel}\n        />\n      }\n    >\n      <ErrorBoundary>\n        <StyledModalBody>\n          <StyledForm\n            form={form}\n            onValuesChange={handleValuesChange}\n            layout=\"vertical\"\n          >\n            <FilterConfigurePane\n              erroredFilters={erroredFilters}\n              onRemove={handleRemoveItem}\n              onAdd={addFilter}\n              onChange={handleTabChange}\n              getFilterTitle={getFilterTitle}\n              currentFilterId={currentFilterId}\n              removedFilters={removedFilters}\n              restoreFilter={restoreFilter}\n              onRearrange={handleRearrange}\n              filters={orderedFilters}\n            >\n              {formList}\n            </FilterConfigurePane>\n          </StyledForm>\n        </StyledModalBody>\n      </ErrorBoundary>\n    </StyledModalWrapper>\n  );\n}\n\nexport default React.memo(FiltersConfigModal);\n"]},"metadata":{},"sourceType":"module"}