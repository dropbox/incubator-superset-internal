{"ast":null,"code":"import _debounce from \"lodash/debounce\";import _isEqual from \"lodash/isEqual\";import _isEmpty from \"lodash/isEmpty\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();import _includesInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/includes\";var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n/* eslint-disable no-param-reassign */\nimport React, { useEffect, useState, useCallback, createContext } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { SLOW_DEBOUNCE, isNativeFilter, usePrevious, styled } from '@superset-ui/core';\nimport { useHistory } from 'react-router-dom';\nimport { updateDataMask, clearDataMask } from 'src/dataMask/actions';\nimport { useImmer } from 'use-immer';\n\nimport { getInitialDataMask } from 'src/dataMask/reducer';\nimport { URL_PARAMS } from 'src/constants';\nimport { getUrlParam } from 'src/utils/urlUtils';\nimport { useTabId } from 'src/hooks/useTabId';\nimport { FilterBarOrientation } from 'src/dashboard/types';\nimport { checkIsApplyDisabled } from './utils';\nimport { useNativeFiltersDataMask, useFilters, useFilterUpdates, useInitialization } from './state';\nimport { createFilterKey, updateFilterKey } from './keyValue';\nimport ActionButtons from './ActionButtons';\nimport Horizontal from './Horizontal';\nimport Vertical from './Vertical';\n// FilterBar is just being hidden as it must still\n// render fully due to encapsulated logics\nimport { jsx as ___EmotionJSX } from \"@emotion/react\";const HiddenFilterBar = styled.div`\n  display: none;\n`;\nconst EXCLUDED_URL_PARAMS = [\nURL_PARAMS.nativeFilters.name,\nURL_PARAMS.permalinkKey.name];\n\nconst publishDataMask = _debounce(async (history, dashboardId, updateKey, dataMaskSelected, tabId) => {var _context;\n  const { location } = history;\n  const { search } = location;\n  const previousParams = new URLSearchParams(search);\n  const newParams = new URLSearchParams();\n  let dataMaskKey;\n  previousParams.forEach((value, key) => {\n    if (!_includesInstanceProperty(EXCLUDED_URL_PARAMS).call(EXCLUDED_URL_PARAMS, key)) {\n      newParams.append(key, value);\n    }\n  });\n  const nativeFiltersCacheKey = getUrlParam(URL_PARAMS.nativeFiltersKey);\n  const dataMask = JSON.stringify(dataMaskSelected);\n  if (updateKey &&\n  nativeFiltersCacheKey && (\n  await updateFilterKey(dashboardId, dataMask, nativeFiltersCacheKey, tabId))) {\n    dataMaskKey = nativeFiltersCacheKey;\n  } else\n  {\n    dataMaskKey = await createFilterKey(dashboardId, dataMask, tabId);\n  }\n  if (dataMaskKey) {\n    newParams.set(URL_PARAMS.nativeFiltersKey.name, dataMaskKey);\n  }\n  // pathname could be updated somewhere else through window.history\n  // keep react router history in sync with window history\n  // replace params only when current page is /superset/dashboard\n  // this prevents a race condition between updating filters and navigating to Explore\n  if (_includesInstanceProperty(_context = window.location.pathname).call(_context, '/superset/dashboard')) {\n    history.location.pathname = window.location.pathname;\n    history.replace({\n      search: newParams.toString() });\n\n  }\n}, SLOW_DEBOUNCE);\nexport const FilterBarScrollContext = /*#__PURE__*/createContext(false);\nconst FilterBar = (_ref) => {let { orientation = FilterBarOrientation.VERTICAL, verticalConfig, hidden = false } = _ref;\n  const history = useHistory();\n  const dataMaskApplied = useNativeFiltersDataMask();\n  const [dataMaskSelected, setDataMaskSelected] = useImmer(dataMaskApplied);\n  const dispatch = useDispatch();\n  const [updateKey, setUpdateKey] = useState(0);\n  const tabId = useTabId();\n  const filters = useFilters();\n  const previousFilters = usePrevious(filters);\n  const filterValues = Object.values(filters);\n  const nativeFilterValues = filterValues.filter(isNativeFilter);\n  const dashboardId = useSelector((_ref2) => {let { dashboardInfo } = _ref2;return dashboardInfo == null ? void 0 : dashboardInfo.id;});\n  const previousDashboardId = usePrevious(dashboardId);\n  const canEdit = useSelector((_ref3) => {let { dashboardInfo } = _ref3;return dashboardInfo.dash_edit_perm;});\n  const handleFilterSelectionChange = useCallback((filter, dataMask) => {\n    setDataMaskSelected((draft) => {var _dataMask$filterState, _dataMaskSelected$fil, _dataMaskSelected$fil2;\n      // force instant updating on initialization for filters with `requiredFirst` is true or instant filters\n      if (\n      // filterState.value === undefined - means that value not initialized\n      ((_dataMask$filterState = dataMask.filterState) == null ? void 0 : _dataMask$filterState.value) !== undefined &&\n      ((_dataMaskSelected$fil = dataMaskSelected[filter.id]) == null ? void 0 : (_dataMaskSelected$fil2 = _dataMaskSelected$fil.filterState) == null ? void 0 : _dataMaskSelected$fil2.value) === undefined &&\n      filter.requiredFirst) {\n        dispatch(updateDataMask(filter.id, dataMask));\n      }\n      draft[filter.id] = {\n        ...getInitialDataMask(filter.id),\n        ...dataMask };\n\n    });\n  }, [dataMaskSelected, dispatch, setDataMaskSelected]);\n  useEffect(() => {\n    if (previousFilters && dashboardId === previousDashboardId) {\n      const updates = {};\n      Object.values(filters).forEach((currentFilter) => {\n        const previousFilter = previousFilters == null ? void 0 : previousFilters[currentFilter.id];\n        if (!previousFilter) {\n          return;\n        }\n        const currentType = currentFilter.filterType;\n        const currentTargets = currentFilter.targets;\n        const currentDataMask = currentFilter.defaultDataMask;\n        const previousType = previousFilter == null ? void 0 : previousFilter.filterType;\n        const previousTargets = previousFilter == null ? void 0 : previousFilter.targets;\n        const previousDataMask = previousFilter == null ? void 0 : previousFilter.defaultDataMask;\n        const typeChanged = currentType !== previousType;\n        const targetsChanged = !_isEqual(currentTargets, previousTargets);\n        const dataMaskChanged = !_isEqual(currentDataMask, previousDataMask);\n        if (typeChanged || targetsChanged || dataMaskChanged) {\n          updates[currentFilter.id] = getInitialDataMask(currentFilter.id);\n        }\n      });\n      if (!_isEmpty(updates)) {\n        setDataMaskSelected((draft) => ({ ...draft, ...updates }));\n        Object.keys(updates).forEach((key) => dispatch(clearDataMask(key)));\n      }\n    }\n  }, [\n  JSON.stringify(filters),\n  JSON.stringify(previousFilters),\n  previousDashboardId]);\n\n  const dataMaskAppliedText = JSON.stringify(dataMaskApplied);\n  useEffect(() => {\n    setDataMaskSelected(() => dataMaskApplied);\n  }, [dataMaskAppliedText, setDataMaskSelected]);\n  useEffect(() => {\n    publishDataMask(history, dashboardId, updateKey, dataMaskApplied, tabId);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [dashboardId, dataMaskAppliedText, history, updateKey, tabId]);\n  const handleApply = useCallback(() => {\n    const filterIds = Object.keys(dataMaskSelected);\n    setUpdateKey(1);\n    filterIds.forEach((filterId) => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(updateDataMask(filterId, dataMaskSelected[filterId]));\n      }\n    });\n  }, [dataMaskSelected, dispatch]);\n  const handleClearAll = useCallback(() => {\n    const filterIds = Object.keys(dataMaskSelected);\n    filterIds.forEach((filterId) => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(clearDataMask(filterId));\n        setDataMaskSelected((draft) => {var _draft$filterId$filte;\n          if (((_draft$filterId$filte = draft[filterId].filterState) == null ? void 0 : _draft$filterId$filte.value) !== undefined) {\n            draft[filterId].filterState.value = undefined;\n          }\n        });\n      }\n    });\n  }, [dataMaskSelected, dispatch, setDataMaskSelected]);\n  useFilterUpdates(dataMaskSelected, setDataMaskSelected);\n  const isApplyDisabled = checkIsApplyDisabled(dataMaskSelected, dataMaskApplied, nativeFilterValues);\n  const isInitialized = useInitialization();\n  const actions = ___EmotionJSX(ActionButtons, { filterBarOrientation: orientation, width: verticalConfig == null ? void 0 : verticalConfig.width, onApply: handleApply, onClearAll: handleClearAll, dataMaskSelected: dataMaskSelected, dataMaskApplied: dataMaskApplied, isApplyDisabled: isApplyDisabled });\n  const filterBarComponent = orientation === FilterBarOrientation.HORIZONTAL ? ___EmotionJSX(Horizontal, { actions: actions, canEdit: canEdit, dashboardId: dashboardId, dataMaskSelected: dataMaskSelected, filterValues: filterValues, isInitialized: isInitialized, onSelectionChange: handleFilterSelectionChange }) : verticalConfig ? ___EmotionJSX(Vertical, { actions: actions, canEdit: canEdit, dataMaskSelected: dataMaskSelected, filtersOpen: verticalConfig.filtersOpen, filterValues: filterValues, isInitialized: isInitialized, isDisabled: isApplyDisabled, height: verticalConfig.height, offset: verticalConfig.offset, onSelectionChange: handleFilterSelectionChange, toggleFiltersBar: verticalConfig.toggleFiltersBar, width: verticalConfig.width }) : null;\n  return hidden ? ___EmotionJSX(HiddenFilterBar, null, filterBarComponent) : filterBarComponent;\n};__signature__(FilterBar, \"useHistory{history}\\nuseNativeFiltersDataMask{dataMaskApplied}\\nuseImmer{[dataMaskSelected, setDataMaskSelected]}\\nuseDispatch{dispatch}\\nuseState{[updateKey, setUpdateKey](0)}\\nuseTabId{tabId}\\nuseFilters{filters}\\nusePrevious{previousFilters}\\nuseSelector{dashboardId}\\nusePrevious{previousDashboardId}\\nuseSelector{canEdit}\\nuseCallback{handleFilterSelectionChange}\\nuseEffect{}\\nuseEffect{}\\nuseEffect{}\\nuseCallback{handleApply}\\nuseCallback{handleClearAll}\\nuseFilterUpdates{}\\nuseInitialization{isInitialized}\", () => [useHistory, useNativeFiltersDataMask, useImmer, useDispatch, useTabId, useFilters, usePrevious, useSelector, usePrevious, useSelector, useFilterUpdates, useInitialization]);const _default = /*#__PURE__*/\nReact.memo(FilterBar);export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(HiddenFilterBar, \"HiddenFilterBar\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");reactHotLoader.register(EXCLUDED_URL_PARAMS, \"EXCLUDED_URL_PARAMS\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");reactHotLoader.register(publishDataMask, \"publishDataMask\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");reactHotLoader.register(FilterBarScrollContext, \"FilterBarScrollContext\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");reactHotLoader.register(FilterBar, \"FilterBar\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");reactHotLoader.register(_default, \"default\", \"/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"mappings":"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","names":["React","useEffect","useState","useCallback","createContext","useDispatch","useSelector","SLOW_DEBOUNCE","isNativeFilter","usePrevious","styled","useHistory","updateDataMask","clearDataMask","useImmer","getInitialDataMask","URL_PARAMS","getUrlParam","useTabId","FilterBarOrientation","checkIsApplyDisabled","useNativeFiltersDataMask","useFilters","useFilterUpdates","useInitialization","createFilterKey","updateFilterKey","ActionButtons","Horizontal","Vertical","HiddenFilterBar","div","EXCLUDED_URL_PARAMS","nativeFilters","name","permalinkKey","publishDataMask","history","dashboardId","updateKey","dataMaskSelected","tabId","location","search","previousParams","URLSearchParams","newParams","dataMaskKey","forEach","value","key","append","nativeFiltersCacheKey","nativeFiltersKey","dataMask","JSON","stringify","set","pathname","window","replace","toString","FilterBarScrollContext","FilterBar","orientation","VERTICAL","verticalConfig","hidden","dataMaskApplied","setDataMaskSelected","dispatch","setUpdateKey","filters","previousFilters","filterValues","Object","values","nativeFilterValues","filter","dashboardInfo","id","previousDashboardId","canEdit","dash_edit_perm","handleFilterSelectionChange","filterState","undefined","requiredFirst","draft","updates","previousFilter","currentFilter","currentType","filterType","currentTargets","targets","currentDataMask","defaultDataMask","previousType","previousTargets","previousDataMask","typeChanged","targetsChanged","dataMaskChanged","keys","dataMaskAppliedText","handleApply","filterIds","filterId","handleClearAll","isApplyDisabled","isInitialized","actions","width","filterBarComponent","HORIZONTAL","filtersOpen","height","offset","toggleFiltersBar","memo"],"sourceRoot":"","sources":["/Users/bogdankyryliuk/code/opensource/superset/superset-frontend/src/dashboard/components/nativeFilters/FilterBar/index.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\n/* eslint-disable no-param-reassign */\nimport React, { useEffect, useState, useCallback, createContext } from 'react';\nimport { useDispatch, useSelector } from 'react-redux';\nimport {\n  DataMaskStateWithId,\n  DataMaskWithId,\n  Filter,\n  DataMask,\n  SLOW_DEBOUNCE,\n  isNativeFilter,\n  usePrevious,\n  styled,\n} from '@superset-ui/core';\nimport { useHistory } from 'react-router-dom';\nimport { updateDataMask, clearDataMask } from 'src/dataMask/actions';\nimport { useImmer } from 'use-immer';\nimport { isEmpty, isEqual, debounce } from 'lodash';\nimport { getInitialDataMask } from 'src/dataMask/reducer';\nimport { URL_PARAMS } from 'src/constants';\nimport { getUrlParam } from 'src/utils/urlUtils';\nimport { useTabId } from 'src/hooks/useTabId';\nimport { FilterBarOrientation, RootState } from 'src/dashboard/types';\nimport { checkIsApplyDisabled } from './utils';\nimport { FiltersBarProps } from './types';\nimport {\n  useNativeFiltersDataMask,\n  useFilters,\n  useFilterUpdates,\n  useInitialization,\n} from './state';\nimport { createFilterKey, updateFilterKey } from './keyValue';\nimport ActionButtons from './ActionButtons';\nimport Horizontal from './Horizontal';\nimport Vertical from './Vertical';\n\n// FilterBar is just being hidden as it must still\n// render fully due to encapsulated logics\nconst HiddenFilterBar = styled.div`\n  display: none;\n`;\n\nconst EXCLUDED_URL_PARAMS: string[] = [\n  URL_PARAMS.nativeFilters.name,\n  URL_PARAMS.permalinkKey.name,\n];\n\nconst publishDataMask = debounce(\n  async (\n    history,\n    dashboardId,\n    updateKey,\n    dataMaskSelected: DataMaskStateWithId,\n    tabId,\n  ) => {\n    const { location } = history;\n    const { search } = location;\n    const previousParams = new URLSearchParams(search);\n    const newParams = new URLSearchParams();\n    let dataMaskKey: string | null;\n    previousParams.forEach((value, key) => {\n      if (!EXCLUDED_URL_PARAMS.includes(key)) {\n        newParams.append(key, value);\n      }\n    });\n\n    const nativeFiltersCacheKey = getUrlParam(URL_PARAMS.nativeFiltersKey);\n    const dataMask = JSON.stringify(dataMaskSelected);\n    if (\n      updateKey &&\n      nativeFiltersCacheKey &&\n      (await updateFilterKey(\n        dashboardId,\n        dataMask,\n        nativeFiltersCacheKey,\n        tabId,\n      ))\n    ) {\n      dataMaskKey = nativeFiltersCacheKey;\n    } else {\n      dataMaskKey = await createFilterKey(dashboardId, dataMask, tabId);\n    }\n    if (dataMaskKey) {\n      newParams.set(URL_PARAMS.nativeFiltersKey.name, dataMaskKey);\n    }\n\n    // pathname could be updated somewhere else through window.history\n    // keep react router history in sync with window history\n    // replace params only when current page is /superset/dashboard\n    // this prevents a race condition between updating filters and navigating to Explore\n    if (window.location.pathname.includes('/superset/dashboard')) {\n      history.location.pathname = window.location.pathname;\n      history.replace({\n        search: newParams.toString(),\n      });\n    }\n  },\n  SLOW_DEBOUNCE,\n);\n\nexport const FilterBarScrollContext = createContext(false);\nconst FilterBar: React.FC<FiltersBarProps> = ({\n  orientation = FilterBarOrientation.VERTICAL,\n  verticalConfig,\n  hidden = false,\n}) => {\n  const history = useHistory();\n  const dataMaskApplied: DataMaskStateWithId = useNativeFiltersDataMask();\n  const [dataMaskSelected, setDataMaskSelected] =\n    useImmer<DataMaskStateWithId>(dataMaskApplied);\n  const dispatch = useDispatch();\n  const [updateKey, setUpdateKey] = useState(0);\n  const tabId = useTabId();\n  const filters = useFilters();\n  const previousFilters = usePrevious(filters);\n  const filterValues = Object.values(filters);\n  const nativeFilterValues = filterValues.filter(isNativeFilter);\n  const dashboardId = useSelector<any, number>(\n    ({ dashboardInfo }) => dashboardInfo?.id,\n  );\n  const previousDashboardId = usePrevious(dashboardId);\n  const canEdit = useSelector<RootState, boolean>(\n    ({ dashboardInfo }) => dashboardInfo.dash_edit_perm,\n  );\n\n  const handleFilterSelectionChange = useCallback(\n    (\n      filter: Pick<Filter, 'id'> & Partial<Filter>,\n      dataMask: Partial<DataMask>,\n    ) => {\n      setDataMaskSelected(draft => {\n        // force instant updating on initialization for filters with `requiredFirst` is true or instant filters\n        if (\n          // filterState.value === undefined - means that value not initialized\n          dataMask.filterState?.value !== undefined &&\n          dataMaskSelected[filter.id]?.filterState?.value === undefined &&\n          filter.requiredFirst\n        ) {\n          dispatch(updateDataMask(filter.id, dataMask));\n        }\n\n        draft[filter.id] = {\n          ...(getInitialDataMask(filter.id) as DataMaskWithId),\n          ...dataMask,\n        };\n      });\n    },\n    [dataMaskSelected, dispatch, setDataMaskSelected],\n  );\n\n  useEffect(() => {\n    if (previousFilters && dashboardId === previousDashboardId) {\n      const updates = {};\n      Object.values(filters).forEach(currentFilter => {\n        const previousFilter = previousFilters?.[currentFilter.id];\n        if (!previousFilter) {\n          return;\n        }\n        const currentType = currentFilter.filterType;\n        const currentTargets = currentFilter.targets;\n        const currentDataMask = currentFilter.defaultDataMask;\n        const previousType = previousFilter?.filterType;\n        const previousTargets = previousFilter?.targets;\n        const previousDataMask = previousFilter?.defaultDataMask;\n        const typeChanged = currentType !== previousType;\n        const targetsChanged = !isEqual(currentTargets, previousTargets);\n        const dataMaskChanged = !isEqual(currentDataMask, previousDataMask);\n\n        if (typeChanged || targetsChanged || dataMaskChanged) {\n          updates[currentFilter.id] = getInitialDataMask(currentFilter.id);\n        }\n      });\n\n      if (!isEmpty(updates)) {\n        setDataMaskSelected(draft => ({ ...draft, ...updates }));\n        Object.keys(updates).forEach(key => dispatch(clearDataMask(key)));\n      }\n    }\n  }, [\n    JSON.stringify(filters),\n    JSON.stringify(previousFilters),\n    previousDashboardId,\n  ]);\n\n  const dataMaskAppliedText = JSON.stringify(dataMaskApplied);\n\n  useEffect(() => {\n    setDataMaskSelected(() => dataMaskApplied);\n  }, [dataMaskAppliedText, setDataMaskSelected]);\n\n  useEffect(() => {\n    publishDataMask(history, dashboardId, updateKey, dataMaskApplied, tabId);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [dashboardId, dataMaskAppliedText, history, updateKey, tabId]);\n\n  const handleApply = useCallback(() => {\n    const filterIds = Object.keys(dataMaskSelected);\n    setUpdateKey(1);\n    filterIds.forEach(filterId => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(updateDataMask(filterId, dataMaskSelected[filterId]));\n      }\n    });\n  }, [dataMaskSelected, dispatch]);\n\n  const handleClearAll = useCallback(() => {\n    const filterIds = Object.keys(dataMaskSelected);\n    filterIds.forEach(filterId => {\n      if (dataMaskSelected[filterId]) {\n        dispatch(clearDataMask(filterId));\n        setDataMaskSelected(draft => {\n          if (draft[filterId].filterState?.value !== undefined) {\n            draft[filterId].filterState!.value = undefined;\n          }\n        });\n      }\n    });\n  }, [dataMaskSelected, dispatch, setDataMaskSelected]);\n\n  useFilterUpdates(dataMaskSelected, setDataMaskSelected);\n  const isApplyDisabled = checkIsApplyDisabled(\n    dataMaskSelected,\n    dataMaskApplied,\n    nativeFilterValues,\n  );\n  const isInitialized = useInitialization();\n\n  const actions = (\n    <ActionButtons\n      filterBarOrientation={orientation}\n      width={verticalConfig?.width}\n      onApply={handleApply}\n      onClearAll={handleClearAll}\n      dataMaskSelected={dataMaskSelected}\n      dataMaskApplied={dataMaskApplied}\n      isApplyDisabled={isApplyDisabled}\n    />\n  );\n\n  const filterBarComponent =\n    orientation === FilterBarOrientation.HORIZONTAL ? (\n      <Horizontal\n        actions={actions}\n        canEdit={canEdit}\n        dashboardId={dashboardId}\n        dataMaskSelected={dataMaskSelected}\n        filterValues={filterValues}\n        isInitialized={isInitialized}\n        onSelectionChange={handleFilterSelectionChange}\n      />\n    ) : verticalConfig ? (\n      <Vertical\n        actions={actions}\n        canEdit={canEdit}\n        dataMaskSelected={dataMaskSelected}\n        filtersOpen={verticalConfig.filtersOpen}\n        filterValues={filterValues}\n        isInitialized={isInitialized}\n        isDisabled={isApplyDisabled}\n        height={verticalConfig.height}\n        offset={verticalConfig.offset}\n        onSelectionChange={handleFilterSelectionChange}\n        toggleFiltersBar={verticalConfig.toggleFiltersBar}\n        width={verticalConfig.width}\n      />\n    ) : null;\n\n  return hidden ? (\n    <HiddenFilterBar>{filterBarComponent}</HiddenFilterBar>\n  ) : (\n    filterBarComponent\n  );\n};\nexport default React.memo(FilterBar);\n"]},"metadata":{},"sourceType":"module"}