{"ast":null,"code":"/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React from 'react';\nimport rison from 'rison';\nimport querystring from 'query-string';\nimport { isFeatureEnabled, FeatureFlag, isDefined, styled, SupersetClient, t } from '@superset-ui/core';\nimport { getUrlParam } from 'src/utils/urlUtils';\nimport { URL_PARAMS } from 'src/constants';\nimport { Link, withRouter } from 'react-router-dom';\nimport Button from 'src/components/Button';\nimport { AsyncSelect, Steps } from 'src/components';\nimport { Tooltip } from 'src/components/Tooltip';\nimport withToasts from 'src/components/MessageToasts/withToasts';\nimport VizTypeGallery, { MAX_ADVISABLE_VIZ_GALLERY_WIDTH } from 'src/explore/components/controls/VizTypeControl/VizTypeGallery';\nimport { findPermission } from 'src/utils/findPermission';\nimport getBootstrapData from 'src/utils/getBootstrapData';import { jsx as ___EmotionJSX } from \"@emotion/react\";\nconst ESTIMATED_NAV_HEIGHT = 56;\nconst ELEMENTS_EXCEPT_VIZ_GALLERY = ESTIMATED_NAV_HEIGHT + 250;\nconst bootstrapData = getBootstrapData();\nconst denyList = bootstrapData.common.conf.VIZ_TYPE_DENYLIST || [];\nif (isFeatureEnabled(FeatureFlag.DASHBOARD_NATIVE_FILTERS) &&\n!('filter_box' in denyList)) {\n  denyList.push('filter_box');\n}\nconst StyledContainer = styled.div`\n  ${(_ref) => {let { theme } = _ref;return `\n    flex: 1 1 auto;\n    display: flex;\n    flex-direction: column;\n    justify-content: space-between;\n    width: 100%;\n    max-width: ${MAX_ADVISABLE_VIZ_GALLERY_WIDTH}px;\n    max-height: calc(100vh - ${ESTIMATED_NAV_HEIGHT}px);\n    border-radius: ${theme.gridUnit}px;\n    background-color: ${theme.colors.grayscale.light5};\n    margin-left: auto;\n    margin-right: auto;\n    padding-left: ${theme.gridUnit * 4}px;\n    padding-right: ${theme.gridUnit * 4}px;\n    padding-bottom: ${theme.gridUnit * 4}px;\n\n    h3 {\n      padding-bottom: ${theme.gridUnit * 3}px;\n    }\n\n    & .dataset {\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n\n      & > div {\n        min-width: 200px;\n        width: 300px;\n      }\n\n      & > span {\n        color: ${theme.colors.grayscale.light1};\n        margin-left: ${theme.gridUnit * 4}px;\n      }\n    }\n\n    & .viz-gallery {\n      border: 1px solid ${theme.colors.grayscale.light2};\n      border-radius: ${theme.gridUnit}px;\n      margin: ${theme.gridUnit}px 0px;\n      max-height: calc(100vh - ${ELEMENTS_EXCEPT_VIZ_GALLERY}px);\n      flex: 1;\n    }\n\n    & .footer {\n      flex: 1;\n      display: flex;\n      flex-direction: row;\n      justify-content: flex-end;\n      align-items: center;\n\n      & > span {\n        color: ${theme.colors.grayscale.light1};\n        margin-right: ${theme.gridUnit * 4}px;\n      }\n    }\n\n    /* The following extra ampersands (&&&&) are used to boost selector specificity */\n\n    &&&& .ant-steps-item-tail {\n      display: none;\n    }\n\n    &&&& .ant-steps-item-icon {\n      margin-right: ${theme.gridUnit * 2}px;\n      width: ${theme.gridUnit * 5}px;\n      height: ${theme.gridUnit * 5}px;\n      line-height: ${theme.gridUnit * 5}px;\n    }\n\n    &&&& .ant-steps-item-title {\n      line-height: ${theme.gridUnit * 5}px;\n    }\n\n    &&&& .ant-steps-item-content {\n      overflow: unset;\n\n      .ant-steps-item-description {\n        margin-top: ${theme.gridUnit}px;\n      }\n    }\n\n    &&&& .ant-tooltip-open {\n      display: inline;\n    }\n\n    &&&& .ant-select-selector {\n      padding: 0;\n    }\n\n    &&&& .ant-select-selection-placeholder {\n      padding-left: ${theme.gridUnit * 3}px;\n    }\n  `;}}\n`;\nconst TooltipContent = styled.div`\n  ${(_ref2) => {let { theme, hasDescription } = _ref2;return `\n    .tooltip-header {\n      font-size: ${hasDescription ? theme.typography.sizes.l : theme.typography.sizes.s}px;\n      font-weight: ${hasDescription ?\n  theme.typography.weights.bold :\n  theme.typography.weights.normal};\n    }\n\n    .tooltip-description {\n      margin-top: ${theme.gridUnit * 2}px;\n      display: -webkit-box;\n      -webkit-line-clamp: 20;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n      text-overflow: ellipsis;\n    }\n  `;}}\n`;\nconst StyledLabel = styled.span`\n  ${(_ref3) => {let { theme } = _ref3;return `\n    position: absolute;\n    left: ${theme.gridUnit * 3}px;\n    right: ${theme.gridUnit * 3}px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  `;}}\n`;\nconst StyledStepTitle = styled.span`\n  ${(_ref4) => {let { theme: { typography: { sizes, weights } } } = _ref4;return `\n      font-size: ${sizes.m}px;\n      font-weight: ${weights.bold};\n    `;}}\n`;\nconst StyledStepDescription = styled.div`\n  ${(_ref5) => {let { theme: { gridUnit } } = _ref5;return `\n    margin-top: ${gridUnit * 4}px;\n    margin-bottom: ${gridUnit * 3}px;\n  `;}}\n`;\nexport class ChartCreation extends React.PureComponent {\n  constructor(props) {\n    super(props);\n    this.state = {\n      vizType: null,\n      canCreateDataset: findPermission('can_write', 'Dataset', props.user.roles) };\n\n    this.changeDatasource = this.changeDatasource.bind(this);\n    this.changeVizType = this.changeVizType.bind(this);\n    this.gotoSlice = this.gotoSlice.bind(this);\n    this.newLabel = this.newLabel.bind(this);\n    this.loadDatasources = this.loadDatasources.bind(this);\n    this.onVizTypeDoubleClick = this.onVizTypeDoubleClick.bind(this);\n  }\n  componentDidMount() {var _querystring$parse;\n    const params = (_querystring$parse = querystring.parse(window.location.search)) == null ? void 0 : _querystring$parse.dataset;\n    if (params) {\n      this.loadDatasources(params, 0, 1).then((r) => {\n        const datasource = r.data[0];\n        // override here to force styling of option label\n        // which expects a reactnode instead of string\n        // @ts-expect-error\n        datasource.label = datasource.customLabel;\n        this.setState({ datasource });\n      });\n      this.props.addSuccessToast(t('The dataset has been saved'));\n    }\n  }\n  exploreUrl() {var _this$state$datasourc;\n    const dashboardId = getUrlParam(URL_PARAMS.dashboardId);\n    let url = `/explore/?viz_type=${this.state.vizType}&datasource=${(_this$state$datasourc = this.state.datasource) == null ? void 0 : _this$state$datasourc.value}`;\n    if (isDefined(dashboardId)) {\n      url += `&dashboard_id=${dashboardId}`;\n    }\n    return url;\n  }\n  gotoSlice() {\n    this.props.history.push(this.exploreUrl());\n  }\n  changeDatasource(datasource) {\n    this.setState({ datasource });\n  }\n  changeVizType(vizType) {\n    this.setState({ vizType });\n  }\n  isBtnDisabled() {var _this$state$datasourc2;\n    return !((_this$state$datasourc2 = this.state.datasource) != null && _this$state$datasourc2.value && this.state.vizType);\n  }\n  onVizTypeDoubleClick() {\n    if (!this.isBtnDisabled()) {\n      this.gotoSlice();\n    }\n  }\n  newLabel(item) {\n    return ___EmotionJSX(Tooltip, { mouseEnterDelay: 1, placement: \"right\", title: ___EmotionJSX(TooltipContent, { hasDescription: !!item.description },\n      ___EmotionJSX(\"div\", { className: \"tooltip-header\" }, item.table_name),\n      item.description && ___EmotionJSX(\"div\", { className: \"tooltip-description\" }, item.description)) },\n\n    ___EmotionJSX(StyledLabel, null, item.table_name));\n\n  }\n  loadDatasources(search, page, pageSize) {\n    const query = rison.encode({\n      columns: ['id', 'table_name', 'description', 'datasource_type'],\n      filters: [{ col: 'table_name', opr: 'ct', value: search }],\n      page,\n      page_size: pageSize,\n      order_column: 'table_name',\n      order_direction: 'asc' });\n\n    return SupersetClient.get({\n      endpoint: `/api/v1/dataset/?q=${query}` }).\n    then((response) => {\n      const list = response.json.result.map((item) => ({\n        id: item.id,\n        value: `${item.id}__${item.datasource_type}`,\n        customLabel: this.newLabel(item),\n        label: item.table_name }));\n\n      return {\n        data: list,\n        totalCount: response.json.count };\n\n    });\n  }\n  render() {var _this$state$datasourc3;\n    const isButtonDisabled = this.isBtnDisabled();\n    const VIEW_INSTRUCTIONS_TEXT = t('view instructions');\n    const datasetHelpText = this.state.canCreateDataset ? ___EmotionJSX(\"span\", null,\n    ___EmotionJSX(Link, { to: \"/dataset/add/\" },\n    t('Add a dataset'), ' '),\n\n    t('or'), ' ',\n    ___EmotionJSX(\"a\", { href: \"https://superset.apache.org/docs/creating-charts-dashboards/creating-your-first-dashboard/#registering-a-new-table\", rel: \"noopener noreferrer\", target: \"_blank\" },\n    `${VIEW_INSTRUCTIONS_TEXT} `,\n    ___EmotionJSX(\"i\", { className: \"fa fa-external-link\" })), \".\") :\n\n\n    ___EmotionJSX(\"span\", null,\n    ___EmotionJSX(\"a\", { href: \"https://superset.apache.org/docs/creating-charts-dashboards/creating-your-first-dashboard/#registering-a-new-table\", rel: \"noopener noreferrer\", target: \"_blank\" },\n    `${VIEW_INSTRUCTIONS_TEXT} `,\n    ___EmotionJSX(\"i\", { className: \"fa fa-external-link\" })), \".\");\n\n\n\n    return ___EmotionJSX(StyledContainer, null,\n    ___EmotionJSX(\"h3\", null, t('Create a new chart')),\n    ___EmotionJSX(Steps, { direction: \"vertical\", size: \"small\" },\n    ___EmotionJSX(Steps.Step, { title: ___EmotionJSX(StyledStepTitle, null, t('Choose a dataset')), status: (_this$state$datasourc3 = this.state.datasource) != null && _this$state$datasourc3.value ? 'finish' : 'process', description: ___EmotionJSX(StyledStepDescription, { className: \"dataset\" },\n      ___EmotionJSX(AsyncSelect, { autoFocus: true, ariaLabel: t('Dataset'), name: \"select-datasource\", onChange: this.changeDatasource, options: this.loadDatasources, optionFilterProps: ['id', 'label'], placeholder: t('Choose a dataset'), showSearch: true, value: this.state.datasource }),\n      datasetHelpText) }),\n\n    ___EmotionJSX(Steps.Step, { title: ___EmotionJSX(StyledStepTitle, null, t('Choose chart type')), status: this.state.vizType ? 'finish' : 'process', description: ___EmotionJSX(StyledStepDescription, null,\n      ___EmotionJSX(VizTypeGallery, { denyList: denyList, className: \"viz-gallery\", onChange: this.changeVizType, onDoubleClick: this.onVizTypeDoubleClick, selectedViz: this.state.vizType })) })),\n\n\n    ___EmotionJSX(\"div\", { className: \"footer\" },\n    isButtonDisabled && ___EmotionJSX(\"span\", null,\n    t('Please select both a Dataset and a Chart type to proceed')),\n\n    ___EmotionJSX(Button, { buttonStyle: \"primary\", disabled: isButtonDisabled, onClick: this.gotoSlice },\n    t('Create new chart'))));\n\n\n\n  }}\n\nexport default withRouter(withToasts(ChartCreation));","map":{"version":3,"mappings":"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","names":["React","rison","querystring","isFeatureEnabled","FeatureFlag","isDefined","styled","SupersetClient","t","getUrlParam","URL_PARAMS","Link","withRouter","Button","AsyncSelect","Steps","Tooltip","withToasts","VizTypeGallery","MAX_ADVISABLE_VIZ_GALLERY_WIDTH","findPermission","getBootstrapData","ESTIMATED_NAV_HEIGHT","ELEMENTS_EXCEPT_VIZ_GALLERY","bootstrapData","denyList","common","conf","VIZ_TYPE_DENYLIST","DASHBOARD_NATIVE_FILTERS","push","StyledContainer","div","theme","gridUnit","colors","grayscale","light5","light1","light2","TooltipContent","hasDescription","typography","sizes","l","s","weights","bold","normal","StyledLabel","span","StyledStepTitle","m","StyledStepDescription","ChartCreation","PureComponent","constructor","props","state","vizType","canCreateDataset","user","roles","changeDatasource","bind","changeVizType","gotoSlice","newLabel","loadDatasources","onVizTypeDoubleClick","componentDidMount","params","parse","window","location","search","dataset","then","datasource","r","data","label","customLabel","setState","addSuccessToast","exploreUrl","dashboardId","url","value","history","isBtnDisabled","item","description","table_name","page","pageSize","query","encode","columns","filters","col","opr","page_size","order_column","order_direction","get","endpoint","response","list","json","result","map","id","datasource_type","totalCount","count","render","isButtonDisabled","VIEW_INSTRUCTIONS_TEXT","datasetHelpText"],"sourceRoot":"","sources":["/Users/zhaorui/src/incubator-superset-internal/superset-frontend/src/pages/ChartCreation/index.tsx"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport React, { ReactNode } from 'react';\nimport rison from 'rison';\nimport querystring from 'query-string';\nimport {\n  isFeatureEnabled,\n  FeatureFlag,\n  isDefined,\n  JsonResponse,\n  styled,\n  SupersetClient,\n  t,\n} from '@superset-ui/core';\nimport { getUrlParam } from 'src/utils/urlUtils';\nimport { URL_PARAMS } from 'src/constants';\nimport { Link, withRouter, RouteComponentProps } from 'react-router-dom';\nimport Button from 'src/components/Button';\nimport { AsyncSelect, Steps } from 'src/components';\nimport { Tooltip } from 'src/components/Tooltip';\nimport withToasts from 'src/components/MessageToasts/withToasts';\n\nimport VizTypeGallery, {\n  MAX_ADVISABLE_VIZ_GALLERY_WIDTH,\n} from 'src/explore/components/controls/VizTypeControl/VizTypeGallery';\nimport { findPermission } from 'src/utils/findPermission';\nimport { UserWithPermissionsAndRoles } from 'src/types/bootstrapTypes';\nimport getBootstrapData from 'src/utils/getBootstrapData';\n\ntype Dataset = {\n  id: number;\n  table_name: string;\n  description: string;\n  datasource_type: string;\n};\n\nexport interface ChartCreationProps extends RouteComponentProps {\n  user: UserWithPermissionsAndRoles;\n  addSuccessToast: (arg: string) => void;\n}\n\nexport type ChartCreationState = {\n  datasource?: { label: string; value: string };\n  datasetName?: string | string[] | null;\n  vizType: string | null;\n  canCreateDataset: boolean;\n};\n\nconst ESTIMATED_NAV_HEIGHT = 56;\nconst ELEMENTS_EXCEPT_VIZ_GALLERY = ESTIMATED_NAV_HEIGHT + 250;\n\nconst bootstrapData = getBootstrapData();\nconst denyList: string[] = bootstrapData.common.conf.VIZ_TYPE_DENYLIST || [];\n\nif (\n  isFeatureEnabled(FeatureFlag.DASHBOARD_NATIVE_FILTERS) &&\n  !('filter_box' in denyList)\n) {\n  denyList.push('filter_box');\n}\n\nconst StyledContainer = styled.div`\n  ${({ theme }) => `\n    flex: 1 1 auto;\n    display: flex;\n    flex-direction: column;\n    justify-content: space-between;\n    width: 100%;\n    max-width: ${MAX_ADVISABLE_VIZ_GALLERY_WIDTH}px;\n    max-height: calc(100vh - ${ESTIMATED_NAV_HEIGHT}px);\n    border-radius: ${theme.gridUnit}px;\n    background-color: ${theme.colors.grayscale.light5};\n    margin-left: auto;\n    margin-right: auto;\n    padding-left: ${theme.gridUnit * 4}px;\n    padding-right: ${theme.gridUnit * 4}px;\n    padding-bottom: ${theme.gridUnit * 4}px;\n\n    h3 {\n      padding-bottom: ${theme.gridUnit * 3}px;\n    }\n\n    & .dataset {\n      display: flex;\n      flex-direction: row;\n      align-items: center;\n\n      & > div {\n        min-width: 200px;\n        width: 300px;\n      }\n\n      & > span {\n        color: ${theme.colors.grayscale.light1};\n        margin-left: ${theme.gridUnit * 4}px;\n      }\n    }\n\n    & .viz-gallery {\n      border: 1px solid ${theme.colors.grayscale.light2};\n      border-radius: ${theme.gridUnit}px;\n      margin: ${theme.gridUnit}px 0px;\n      max-height: calc(100vh - ${ELEMENTS_EXCEPT_VIZ_GALLERY}px);\n      flex: 1;\n    }\n\n    & .footer {\n      flex: 1;\n      display: flex;\n      flex-direction: row;\n      justify-content: flex-end;\n      align-items: center;\n\n      & > span {\n        color: ${theme.colors.grayscale.light1};\n        margin-right: ${theme.gridUnit * 4}px;\n      }\n    }\n\n    /* The following extra ampersands (&&&&) are used to boost selector specificity */\n\n    &&&& .ant-steps-item-tail {\n      display: none;\n    }\n\n    &&&& .ant-steps-item-icon {\n      margin-right: ${theme.gridUnit * 2}px;\n      width: ${theme.gridUnit * 5}px;\n      height: ${theme.gridUnit * 5}px;\n      line-height: ${theme.gridUnit * 5}px;\n    }\n\n    &&&& .ant-steps-item-title {\n      line-height: ${theme.gridUnit * 5}px;\n    }\n\n    &&&& .ant-steps-item-content {\n      overflow: unset;\n\n      .ant-steps-item-description {\n        margin-top: ${theme.gridUnit}px;\n      }\n    }\n\n    &&&& .ant-tooltip-open {\n      display: inline;\n    }\n\n    &&&& .ant-select-selector {\n      padding: 0;\n    }\n\n    &&&& .ant-select-selection-placeholder {\n      padding-left: ${theme.gridUnit * 3}px;\n    }\n  `}\n`;\n\nconst TooltipContent = styled.div<{ hasDescription: boolean }>`\n  ${({ theme, hasDescription }) => `\n    .tooltip-header {\n      font-size: ${\n        hasDescription ? theme.typography.sizes.l : theme.typography.sizes.s\n      }px;\n      font-weight: ${\n        hasDescription\n          ? theme.typography.weights.bold\n          : theme.typography.weights.normal\n      };\n    }\n\n    .tooltip-description {\n      margin-top: ${theme.gridUnit * 2}px;\n      display: -webkit-box;\n      -webkit-line-clamp: 20;\n      -webkit-box-orient: vertical;\n      overflow: hidden;\n      text-overflow: ellipsis;\n    }\n  `}\n`;\n\nconst StyledLabel = styled.span`\n  ${({ theme }) => `\n    position: absolute;\n    left: ${theme.gridUnit * 3}px;\n    right: ${theme.gridUnit * 3}px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  `}\n`;\n\nconst StyledStepTitle = styled.span`\n  ${({\n    theme: {\n      typography: { sizes, weights },\n    },\n  }) => `\n      font-size: ${sizes.m}px;\n      font-weight: ${weights.bold};\n    `}\n`;\n\nconst StyledStepDescription = styled.div`\n  ${({ theme: { gridUnit } }) => `\n    margin-top: ${gridUnit * 4}px;\n    margin-bottom: ${gridUnit * 3}px;\n  `}\n`;\n\nexport class ChartCreation extends React.PureComponent<\n  ChartCreationProps,\n  ChartCreationState\n> {\n  constructor(props: ChartCreationProps) {\n    super(props);\n    this.state = {\n      vizType: null,\n      canCreateDataset: findPermission(\n        'can_write',\n        'Dataset',\n        props.user.roles,\n      ),\n    };\n\n    this.changeDatasource = this.changeDatasource.bind(this);\n    this.changeVizType = this.changeVizType.bind(this);\n    this.gotoSlice = this.gotoSlice.bind(this);\n    this.newLabel = this.newLabel.bind(this);\n    this.loadDatasources = this.loadDatasources.bind(this);\n    this.onVizTypeDoubleClick = this.onVizTypeDoubleClick.bind(this);\n  }\n\n  componentDidMount() {\n    const params = querystring.parse(window.location.search)?.dataset as string;\n    if (params) {\n      this.loadDatasources(params, 0, 1).then(r => {\n        const datasource = r.data[0];\n        // override here to force styling of option label\n        // which expects a reactnode instead of string\n        // @ts-expect-error\n        datasource.label = datasource.customLabel;\n        this.setState({ datasource });\n      });\n      this.props.addSuccessToast(t('The dataset has been saved'));\n    }\n  }\n\n  exploreUrl() {\n    const dashboardId = getUrlParam(URL_PARAMS.dashboardId);\n    let url = `/explore/?viz_type=${this.state.vizType}&datasource=${this.state.datasource?.value}`;\n    if (isDefined(dashboardId)) {\n      url += `&dashboard_id=${dashboardId}`;\n    }\n    return url;\n  }\n\n  gotoSlice() {\n    this.props.history.push(this.exploreUrl());\n  }\n\n  changeDatasource(datasource: { label: string; value: string }) {\n    this.setState({ datasource });\n  }\n\n  changeVizType(vizType: string | null) {\n    this.setState({ vizType });\n  }\n\n  isBtnDisabled() {\n    return !(this.state.datasource?.value && this.state.vizType);\n  }\n\n  onVizTypeDoubleClick() {\n    if (!this.isBtnDisabled()) {\n      this.gotoSlice();\n    }\n  }\n\n  newLabel(item: Dataset) {\n    return (\n      <Tooltip\n        mouseEnterDelay={1}\n        placement=\"right\"\n        title={\n          <TooltipContent hasDescription={!!item.description}>\n            <div className=\"tooltip-header\">{item.table_name}</div>\n            {item.description && (\n              <div className=\"tooltip-description\">{item.description}</div>\n            )}\n          </TooltipContent>\n        }\n      >\n        <StyledLabel>{item.table_name}</StyledLabel>\n      </Tooltip>\n    );\n  }\n\n  loadDatasources(search: string, page: number, pageSize: number) {\n    const query = rison.encode({\n      columns: ['id', 'table_name', 'description', 'datasource_type'],\n      filters: [{ col: 'table_name', opr: 'ct', value: search }],\n      page,\n      page_size: pageSize,\n      order_column: 'table_name',\n      order_direction: 'asc',\n    });\n    return SupersetClient.get({\n      endpoint: `/api/v1/dataset/?q=${query}`,\n    }).then((response: JsonResponse) => {\n      const list: {\n        customLabel: ReactNode;\n        id: number;\n        label: string;\n        value: string;\n      }[] = response.json.result.map((item: Dataset) => ({\n        id: item.id,\n        value: `${item.id}__${item.datasource_type}`,\n        customLabel: this.newLabel(item),\n        label: item.table_name,\n      }));\n      return {\n        data: list,\n        totalCount: response.json.count,\n      };\n    });\n  }\n\n  render() {\n    const isButtonDisabled = this.isBtnDisabled();\n    const VIEW_INSTRUCTIONS_TEXT = t('view instructions');\n    const datasetHelpText = this.state.canCreateDataset ? (\n      <span data-test=\"dataset-write\">\n        <Link to=\"/dataset/add/\" data-test=\"add-chart-new-dataset\">\n          {t('Add a dataset')}{' '}\n        </Link>\n        {t('or')}{' '}\n        <a\n          href=\"https://superset.apache.org/docs/creating-charts-dashboards/creating-your-first-dashboard/#registering-a-new-table\"\n          rel=\"noopener noreferrer\"\n          target=\"_blank\"\n          data-test=\"add-chart-new-dataset-instructions\"\n        >\n          {`${VIEW_INSTRUCTIONS_TEXT} `}\n          <i className=\"fa fa-external-link\" />\n        </a>\n        .\n      </span>\n    ) : (\n      <span data-test=\"no-dataset-write\">\n        <a\n          href=\"https://superset.apache.org/docs/creating-charts-dashboards/creating-your-first-dashboard/#registering-a-new-table\"\n          rel=\"noopener noreferrer\"\n          target=\"_blank\"\n        >\n          {`${VIEW_INSTRUCTIONS_TEXT} `}\n          <i className=\"fa fa-external-link\" />\n        </a>\n        .\n      </span>\n    );\n\n    return (\n      <StyledContainer>\n        <h3>{t('Create a new chart')}</h3>\n        <Steps direction=\"vertical\" size=\"small\">\n          <Steps.Step\n            title={<StyledStepTitle>{t('Choose a dataset')}</StyledStepTitle>}\n            status={this.state.datasource?.value ? 'finish' : 'process'}\n            description={\n              <StyledStepDescription className=\"dataset\">\n                <AsyncSelect\n                  autoFocus\n                  ariaLabel={t('Dataset')}\n                  name=\"select-datasource\"\n                  onChange={this.changeDatasource}\n                  options={this.loadDatasources}\n                  optionFilterProps={['id', 'label']}\n                  placeholder={t('Choose a dataset')}\n                  showSearch\n                  value={this.state.datasource}\n                />\n                {datasetHelpText}\n              </StyledStepDescription>\n            }\n          />\n          <Steps.Step\n            title={<StyledStepTitle>{t('Choose chart type')}</StyledStepTitle>}\n            status={this.state.vizType ? 'finish' : 'process'}\n            description={\n              <StyledStepDescription>\n                <VizTypeGallery\n                  denyList={denyList}\n                  className=\"viz-gallery\"\n                  onChange={this.changeVizType}\n                  onDoubleClick={this.onVizTypeDoubleClick}\n                  selectedViz={this.state.vizType}\n                />\n              </StyledStepDescription>\n            }\n          />\n        </Steps>\n        <div className=\"footer\">\n          {isButtonDisabled && (\n            <span>\n              {t('Please select both a Dataset and a Chart type to proceed')}\n            </span>\n          )}\n          <Button\n            buttonStyle=\"primary\"\n            disabled={isButtonDisabled}\n            onClick={this.gotoSlice}\n          >\n            {t('Create new chart')}\n          </Button>\n        </div>\n      </StyledContainer>\n    );\n  }\n}\n\nexport default withRouter(withToasts(ChartCreation));\n"]},"metadata":{},"sourceType":"module"}