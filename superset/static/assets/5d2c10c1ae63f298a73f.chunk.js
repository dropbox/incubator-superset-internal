"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[5772,5378],{63295:(t,e,o)=>{o.d(e,{Z:()=>l});var r=o(78918),i=o(71761),s=o(83518),a=o(39450);function n(t,e){const o={};for(const r in t)e.includes(r)||(o[r]=t[r]);return o}class l extends r.Z{initializeState(t){super.initializeState(),this.setState({ignoreProps:n(this.constructor._propTypes,t.data.props),dimensions:t})}updateState(t){super.updateState(t);const{changeFlags:e}=t;if(e.extensionsChanged){const t=this.getShaders({});t&&t.defines&&(t.defines.NON_INSTANCED_MODEL=1),this.updateShaders(t)}this._updateAttributes(t.props)}updateAttributes(t){this.setState({changedAttributes:t})}getAttributes(){return this.getAttributeManager().getShaderAttributes()}getModuleSettings(){const{viewport:t,mousePosition:e,gl:o}=this.context;return Object.assign(Object.create(this.props),{viewport:t,mousePosition:e,pickingActive:0,devicePixelRatio:(0,a.w)(o)})}updateShaders(t){}isAggregationDirty(t,e={}){const{props:o,oldProps:r,changeFlags:s}=t,{compareAll:a=!1,dimension:n}=e,{ignoreProps:l}=this.state,{props:u,accessors:h=[]}=n,{updateTriggersChanged:c}=s;if(s.dataChanged)return!0;if(c){if(c.all)return!0;for(const t of h)if(c[t])return!0}if(a)return!!s.extensionsChanged||(0,i.tg)({oldProps:r,newProps:o,ignoreProps:l,propTypes:this.constructor._propTypes});for(const t of u)if(o[t]!==r[t])return!0;return!1}isAttributeChanged(t){const{changedAttributes:e}=this.state;return t?e&&void 0!==e[t]:!function(t){let e=!0;for(const o in t){e=!1;break}return e}(e)}_getAttributeManager(){return new s.Z(this.context.gl,{id:this.props.id,stats:this.context.stats})}}l.layerName="AggregationLayer"},4516:(t,e,o)=>{o.d(e,{K:()=>r,P:()=>i});const r=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function i(t,e=!1,o=Float32Array){let r;if(Number.isFinite(t[0]))r=new o(t);else{r=new o(4*t.length);let e=0;for(let o=0;o<t.length;o++){const i=t[o];r[e++]=i[0],r[e++]=i[1],r[e++]=i[2],r[e++]=Number.isFinite(i[3])?i[3]:255}}if(e)for(let t=0;t<r.length;t++)r[t]/=255;return r}},78918:(t,e,o)=>{o.d(e,{Z:()=>a});var r=o(95772),i=o(63803),s=o(61855);class a extends r.Z{get isComposite(){return!0}get isLoaded(){return super.isLoaded&&this.getSubLayers().every((t=>t.isLoaded))}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(){}setState(t){super.setState(t),this.setNeedsUpdate()}getPickingInfo({info:t}){const{object:e}=t;return e&&e.__source&&e.__source.parent&&e.__source.parent.id===this.id?(t.object=e.__source.object,t.index=e.__source.index,t):t}renderLayers(){return null}filterSubLayer(t){return!0}shouldRenderSubLayer(t,e){const{_subLayerProps:o}=this.props;return e&&e.length||o&&o[t]}getSubLayerClass(t,e){const{_subLayerProps:o}=this.props;return o&&o[t]&&o[t].type||e}getSubLayerRow(t,e,o){return t.__source={parent:this,object:e,index:o},t}getSubLayerAccessor(t){if("function"==typeof t){const e={data:this.props.data,target:[]};return(o,r)=>o&&o.__source?(e.index=o.__source.index,t(o.__source.object,e)):t(o,r)}return t}getSubLayerProps(t={}){const{opacity:e,pickable:o,visible:r,parameters:i,getPolygonOffset:s,highlightedObjectIndex:a,autoHighlight:n,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:c,positionFormat:p,modelMatrix:g,extensions:d,fetch:m,_subLayerProps:f}=this.props,y={opacity:e,pickable:o,visible:r,parameters:i,getPolygonOffset:s,highlightedObjectIndex:a,autoHighlight:n,highlightColor:l,coordinateSystem:u,coordinateOrigin:h,wrapLongitude:c,positionFormat:p,modelMatrix:g,extensions:d,fetch:m},x=f&&f[t.id],_=x&&x.updateTriggers,b=t.id||"sublayer";if(x){const e=this.constructor._propTypes,o=t.type?t.type._propTypes:{};for(const t in x){const r=o[t]||e[t];r&&"accessor"===r.type&&(x[t]=this.getSubLayerAccessor(x[t]))}}Object.assign(y,t,x),y.id="".concat(this.props.id,"-").concat(b),y.updateTriggers={all:this.props.updateTriggers.all,...t.updateTriggers,..._};for(const t of d){const e=t.getSubLayerProps.call(this,t);e&&Object.assign(y,e,{updateTriggers:Object.assign(y.updateTriggers,e.updateTriggers)})}return y}_updateAutoHighlight(t){for(const e of this.getSubLayers())e.updateAutoHighlight(t)}_getAttributeManager(){return null}_renderLayers(){let{subLayers:t}=this.internalState;const e=!t||this.needsUpdate();e&&(t=this.renderLayers(),t=(0,s.x)(t,Boolean),this.internalState.subLayers=t),(0,i.Z)("compositeLayer.renderLayers",this,e,t);for(const e of t)e.parent=this}}a.layerName="CompositeLayer"},36665:(t,e,o)=>{o.d(e,{Z:()=>d});var r=o(78580),i=o.n(r),s=o(67294),a=o(45697),n=o.n(a),l=o(51995),u=o(67190),h=o(11965);const c=l.iK.div`
  ${t=>{let{theme:e}=t;return`\n    font-size: ${e.typography.sizes.s}px;\n    position: absolute;\n    background: ${e.colors.grayscale.light5};\n    box-shadow: 0 0 ${e.gridUnit}px ${e.colors.grayscale.light2};\n    margin: ${6*e.gridUnit}px;\n    padding: ${3*e.gridUnit}px ${5*e.gridUnit}px;\n    outline: none;\n    overflow-y: scroll;\n    max-height: 200px;\n\n    & ul {\n      list-style: none;\n      padding-left: 0;\n      margin: 0;\n\n      & li a {\n        color: ${e.colors.grayscale.base};\n        text-decoration: none;\n\n        & span {\n          margin-right: ${3*e.gridUnit}px;\n        }\n      }\n    }\n  `}}
`,p=" - ",g={categories:n().object,forceCategorical:n().bool,format:n().string,position:n().oneOf([null,"tl","tr","bl","br"]),showSingleCategory:n().func,toggleCategory:n().func};class d extends s.PureComponent{format(t){if(!this.props.format||this.props.forceCategorical)return t;const e=parseFloat(t);return(0,u.uf)(this.props.format,e)}formatCategoryLabel(t){if(!this.props.format)return t;if(i()(t).call(t,p)){const e=t.split(p);return this.format(e[0])+p+this.format(e[1])}return this.format(t)}render(){if(0===Object.keys(this.props.categories).length||null===this.props.position)return null;const t=Object.entries(this.props.categories).map((t=>{let[e,o]=t;const r={color:`rgba(${o.color.join(", ")})`},i=o.enabled?"◼":"◻";return(0,h.tZ)("li",{key:e},(0,h.tZ)("a",{href:"#",onClick:()=>this.props.toggleCategory(e),onDoubleClick:()=>this.props.showSingleCategory(e)},(0,h.tZ)("span",{style:r},i)," ",this.formatCategoryLabel(e)))})),e={position:"absolute",["t"===this.props.position.charAt(0)?"top":"bottom"]:"0px",["r"===this.props.position.charAt(1)?"right":"left"]:"10px"};return(0,h.tZ)(c,{style:e},(0,h.tZ)("ul",null,t))}}d.propTypes=g,d.defaultProps={categories:{},forceCategorical:!1,format:null,position:"tr",showSingleCategory:()=>{},toggleCategory:()=>{}}},26331:(t,e,o)=>{o.d(e,{B:()=>v,G:()=>b});var r=o(18446),i=o.n(r),s=o(67294),a=o(84502),n=o(45697),l=o.n(n),u=o(28062),h=o(85531),c=o(36665),p=o(64106),g=o(66911),d=o(21207),m=o(40461),f=o(11965);const{getScale:y}=u,x={datasource:l().object.isRequired,formData:l().object.isRequired,getLayer:l().func.isRequired,getPoints:l().func.isRequired,height:l().number.isRequired,mapboxApiKey:l().string.isRequired,onAddFilter:l().func,payload:l().object.isRequired,setControlValue:l().func.isRequired,viewport:l().object.isRequired,width:l().number.isRequired};class _ extends s.PureComponent{constructor(t){super(t),this.containerRef=s.createRef(),this.setTooltip=t=>{const{current:e}=this.containerRef;e&&e.setTooltip(t)},this.state=this.getStateFromProps(t),this.getLayers=this.getLayers.bind(this),this.onValuesChange=this.onValuesChange.bind(this),this.toggleCategory=this.toggleCategory.bind(this),this.showSingleCategory=this.showSingleCategory.bind(this)}UNSAFE_componentWillReceiveProps(t){t.payload.form_data!==this.state.formData&&this.setState({...this.getStateFromProps(t)})}onValuesChange(t){this.setState({values:Array.isArray(t)?t:[t,t+this.state.getStep(t)]})}getStateFromProps(t,e){const o=t.payload.data.features||[],r=o.map((t=>t.__timestamp)),i=function(t,e){const o=t.color_picker||{r:0,g:0,b:0,a:1},r=[o.r,o.g,o.b,255*o.a],i=y(t.color_scheme),s={};return e.forEach((e=>{if(null!=e.cat_color&&!s.hasOwnProperty(e.cat_color)){let a;a=t.dimension?(0,p.hexToRGB)(i(e.cat_color,t.sliceId),255*o.a):r,s[e.cat_color]={color:a,enabled:!0}}})),s}(t.formData,o);if(e&&t.payload.form_data===e.formData)return{...e,categories:i};const s=t.payload.form_data.time_grain_sqla||t.payload.form_data.granularity||"P1D",{start:a,end:n,getStep:l,values:u,disabled:h}=(0,g.g)(r,s),{width:c,height:d,formData:f}=t;let{viewport:x}=t;return f.autozoom&&(x=(0,m.Z)(x,{width:c,height:d,points:t.getPoints(o)})),x.zoom<0&&(x.zoom=0),{start:a,end:n,getStep:l,values:u,disabled:h,viewport:x,selected:[],lastClick:0,formData:t.payload.form_data,categories:i}}getLayers(t){const{getLayer:e,payload:o,formData:r,onAddFilter:i}=this.props;let s=o.data.features?[...o.data.features]:[];s=this.addColor(s,r),r.js_data_mutator&&(s=(0,d.Z)(r.js_data_mutator)(s)),s=t[0]===t[1]||t[1]===this.end?s.filter((e=>e.__timestamp>=t[0]&&e.__timestamp<=t[1])):s.filter((e=>e.__timestamp>=t[0]&&e.__timestamp<t[1]));const a=this.state.categories;return r.dimension&&(s=s.filter((t=>a[t.cat_color]&&a[t.cat_color].enabled))),[e(r,{...o,data:{...o.data,features:s}},i,this.setTooltip,this.props.datasource)]}addColor(t,e){const o=e.color_picker||{r:0,g:0,b:0,a:1},r=y(e.color_scheme);return t.map((t=>{let i;return e.dimension?(i=(0,p.hexToRGB)(r(t.cat_color,e.sliceId),255*o.a),{...t,color:i}):t}))}toggleCategory(t){const e=this.state.categories[t],o={...this.state.categories,[t]:{...e,enabled:!e.enabled}};Object.values(o).every((t=>!t.enabled))&&Object.values(o).forEach((t=>{t.enabled=!0})),this.setState({categories:o})}showSingleCategory(t){const e={...this.state.categories};Object.values(e).forEach((t=>{t.enabled=!1})),e[t].enabled=!0,this.setState({categories:e})}render(){return(0,f.tZ)("div",{style:{position:"relative"}},(0,f.tZ)(h.Z,{ref:this.containerRef,getLayers:this.getLayers,start:this.state.start,end:this.state.end,getStep:this.state.getStep,values:this.state.values,disabled:this.state.disabled,viewport:this.state.viewport,mapboxApiAccessToken:this.props.mapboxApiKey,mapStyle:this.props.formData.mapbox_style,setControlValue:this.props.setControlValue,width:this.props.width,height:this.props.height},(0,f.tZ)(c.Z,{forceCategorical:!0,categories:this.state.categories,format:this.props.formData.legend_format,position:this.props.formData.legend_position,showSingleCategory:this.showSingleCategory,toggleCategory:this.toggleCategory})))}}function b(t,e){class o extends s.PureComponent{constructor(t){super(t),this.containerRef=s.createRef(),this.setTooltip=t=>{const{current:e}=this.containerRef;e&&(null==e||e.setTooltip(t))};const{width:o,height:r,formData:i}=t;let{viewport:a}=t;i.autozoom&&(a=(0,m.Z)(a,{width:o,height:r,points:e(t.payload.data.features)})),this.state={viewport:a,layer:this.computeLayer(t)},this.onViewportChange=this.onViewportChange.bind(this)}UNSAFE_componentWillReceiveProps(t){const e={...t.formData,viewport:null},o={...this.props.formData,viewport:null};i()(e,o)&&t.payload===this.props.payload||this.setState({layer:this.computeLayer(t)})}onViewportChange(t){this.setState({viewport:t})}computeLayer(e){const{formData:o,payload:r,onAddFilter:i}=e;return t(o,r,i,this.setTooltip)}render(){const{formData:t,payload:e,setControlValue:o,height:r,width:i}=this.props,{layer:s,viewport:n}=this.state;return(0,f.tZ)(a.F,{ref:this.containerRef,mapboxApiAccessToken:e.data.mapboxApiKey,viewport:n,layers:[s],mapStyle:t.mapbox_style,setControlValue:o,width:i,height:r,onViewportChange:this.onViewportChange})}}return o}function v(t,e){return function(o){const{datasource:r,formData:i,height:s,payload:a,setControlValue:n,viewport:l,width:u}=o;return(0,f.tZ)(_,{datasource:r,formData:i,mapboxApiKey:a.data.mapboxApiKey,setControlValue:n,viewport:l,getLayer:t,payload:a,getPoints:e,width:u,height:s})}}_.propTypes=x},16091:(t,e,o)=>{o.r(e),o.d(e,{default:()=>E,getLayer:()=>O});var r=o(39450);const i=new Float32Array(12);function s(t,e=2){let o=0;for(const r of t)for(let t=0;t<e;t++)i[o++]=r[t]||0;return i}var a=o(6948),n=o(44211),l=o(4912),u=o(63346),h=o(53478),c=o(80744),p=o(24088),g=o(83518),d=o(27870),m=o(1113),f=o(53982),y=o(95772),x=o(93844);class _ extends y.Z{getShaders(){return{vs:"#define SHADER_NAME heatp-map-layer-vertex-shader\n\nuniform sampler2D maxTexture;\nuniform float intensity;\nuniform vec2 colorDomain;\nuniform float threshold;\nuniform float aggregationMode;\n\nattribute vec3 positions;\nattribute vec2 texCoords;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvoid main(void) {\n  gl_Position = project_position_to_clipspace(positions, vec3(0.0), vec3(0.0));\n  vTexCoords = texCoords;\n  vec4 maxTexture = texture2D(maxTexture, vec2(0.5));\n  float maxValue = aggregationMode < 0.5 ? maxTexture.r : maxTexture.g;\n  float minValue = maxValue * threshold;\n  if (colorDomain[1] > 0.) {\n    maxValue = colorDomain[1];\n    minValue = colorDomain[0];\n  }\n  vIntensityMax = intensity / maxValue;\n  vIntensityMin = intensity / minValue;\n}\n",fs:"#define SHADER_NAME triangle-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D texture;\nuniform sampler2D colorTexture;\nuniform float aggregationMode;\n\nvarying vec2 vTexCoords;\nvarying float vIntensityMin;\nvarying float vIntensityMax;\n\nvec4 getLinearColor(float value) {\n  float factor = clamp(value * vIntensityMax, 0., 1.);\n  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));\n  color.a *= min(value * vIntensityMin, 1.0);\n  return color;\n}\n\nvoid main(void) {\n  vec4 weights = texture2D(texture, vTexCoords);\n  float weight = weights.r;\n\n  if (aggregationMode > 0.5) {\n    weight /= max(1.0, weights.a);\n  }\n  if (weight <= 0.) {\n     discard;\n  }\n\n  vec4 linearColor = getLinearColor(weight);\n  linearColor.a *= opacity;\n  gl_FragColor =linearColor;\n}\n",modules:[x.Z]}}initializeState(){const{gl:t}=this.context;this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(t)})}_getModel(t){const{vertexCount:e}=this.props;return new m.Z(t,{...this.getShaders(),id:this.props.id,geometry:new f.Z({drawMode:6,vertexCount:e})})}draw({uniforms:t}){const{model:e}=this.state,{texture:o,maxTexture:r,colorTexture:i,intensity:s,threshold:a,aggregationMode:n,colorDomain:l}=this.props;e.setUniforms({...t,texture:o,maxTexture:r,colorTexture:i,intensity:s,threshold:a,aggregationMode:n,colorDomain:l}).draw()}}_.layerName="TriangleLayer";var b=o(63295),v=o(4516);const T={mipmaps:!1,parameters:{10240:9729,10241:9729,10242:33071,10243:33071},dataFormat:6408},w=[0,0],S={SUM:0,MEAN:1},C={getPosition:{type:"accessor",value:t=>t.position},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:v.K,threshold:{type:"number",min:0,max:1,value:.05},colorDomain:{type:"array",value:null,optional:!0},aggregation:"SUM"},L=[a.h.BLEND_EQUATION_MINMAX,a.h.TEXTURE_FLOAT],P={data:{props:["radiusPixels"]}};class A extends b.Z{initializeState(){const{gl:t}=this.context;if(!(0,n.ag)(t,L))return this.setState({supported:!1}),void c.Z.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))();super.initializeState(P),this.setState({supported:!0,colorDomain:w}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()}shouldUpdateState({changeFlags:t}){return t.somethingChanged}updateState(t){if(!this.state.supported)return;super.updateState(t);const{props:e,oldProps:o}=t,r=this._getChangeFlags(t);r.viewportChanged&&(r.boundsChanged=this._updateBounds(),this._updateTextureRenderingBounds()),r.dataChanged||r.boundsChanged?(clearTimeout(this.state.updateTimer),this.setState({isWeightMapDirty:!0})):r.viewportZoomChanged&&this._debouncedUpdateWeightmap(),e.colorRange!==o.colorRange&&this._updateColorTexture(t),this.state.isWeightMapDirty&&this._updateWeightmap(),this.setState({zoom:t.context.viewport.zoom})}renderLayers(){if(!this.state.supported)return[];const{weightsTexture:t,triPositionBuffer:e,triTexCoordBuffer:o,maxWeightsTexture:r,colorTexture:i,colorDomain:s}=this.state,{updateTriggers:a,intensity:n,threshold:l,aggregation:u}=this.props;return new(this.getSubLayerClass("triangle",_))(this.getSubLayerProps({id:"triangle-layer",updateTriggers:a}),{coordinateSystem:p.Df.DEFAULT,data:{attributes:{positions:e,texCoords:o}},vertexCount:4,maxTexture:r,colorTexture:i,aggregationMode:S[u]||0,texture:t,intensity:n,threshold:l,colorDomain:s})}finalizeState(){super.finalizeState();const{weightsTransform:t,weightsTexture:e,maxWeightTransform:o,maxWeightsTexture:r,triPositionBuffer:i,triTexCoordBuffer:s,colorTexture:a,updateTimer:n}=this.state;null==t||t.delete(),null==e||e.delete(),null==o||o.delete(),null==r||r.delete(),null==i||i.delete(),null==s||s.delete(),null==a||a.delete(),n&&clearTimeout(n)}_getAttributeManager(){return new g.Z(this.context.gl,{id:this.props.id,stats:this.context.stats})}_getChangeFlags(t){const e={},{dimensions:o}=this.state;e.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(t,{compareAll:!0,dimension:o.data}),e.viewportChanged=t.changeFlags.viewportChanged;const{zoom:r}=this.state;return t.context.viewport&&t.context.viewport.zoom===r||(e.viewportZoomChanged=!0),e}_createTextures(){const{gl:t}=this.context,{textureSize:e,format:o,type:r}=this.state;this.setState({weightsTexture:new l.Z(t,{width:e,height:e,format:o,type:r,...T}),maxWeightsTexture:new l.Z(t,{format:o,type:r,...T})})}_setupAttributes(){this.getAttributeManager().add({positions:{size:3,type:5130,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}}),this.setState({positionAttributeName:"positions"})}_setupTextureParams(){const{gl:t}=this.context,e=Math.min(2048,(0,r.ZS)(t,3379)),o=(0,n.ag)(t,a.h.COLOR_ATTACHMENT_RGBA32F),{format:i,type:s}=function({gl:t,floatTargetSupport:e}){return{format:(0,r.D0)(t)?34836:6408,type:e?5126:5121}}({gl:t,floatTargetSupport:o}),l=o?1:1/255;this.setState({textureSize:e,format:i,type:s,weightsScale:l}),o||c.Z.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}_createWeightsTransform(t={}){var e;const{gl:o}=this.context;let{weightsTransform:r}=this.state;const{weightsTexture:i}=this.state;null===(e=r)||void 0===e||e.delete();const s=(0,d.l)({vs:"attribute vec3 positions;\nattribute vec3 positions64Low;\nattribute float weights;\nvarying vec4 weightsTexture;\nuniform float radiusPixels;\nuniform float textureWidth;\nuniform vec4 commonBounds;\nuniform float weightsScale;\nvoid main()\n{\n  weightsTexture = vec4(weights * weightsScale, 0., 0., 1.);\n\n  float radiusTexels  = project_pixel_size(radiusPixels) * textureWidth / (commonBounds.z - commonBounds.x);\n  gl_PointSize = radiusTexels * 2.;\n\n  vec3 commonPosition = project_position(positions, positions64Low);\n  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;\n  gl_Position.xy = (gl_Position.xy * 2.) - (1.);\n}\n",_fs:"varying vec4 weightsTexture;\nfloat gaussianKDE(float u){\n  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);\n}\nvoid main()\n{\n  float dist = length(gl_PointCoord - vec2(0.5, 0.5));\n  if (dist > 0.5) {\n    discard;\n  }\n  gl_FragColor = weightsTexture * gaussianKDE(2. * dist);\n  DECKGL_FILTER_COLOR(gl_FragColor, geometry);\n}\n"},t);r=new u.Z(o,{id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:i,_targetTextureVarying:"weightsTexture",...s}),this.setState({weightsTransform:r})}_setupResources(){const{gl:t}=this.context;this._createTextures();const{textureSize:e,weightsTexture:o,maxWeightsTexture:r}=this.state;this._createWeightsTransform();const i=new u.Z(t,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:o},_targetTexture:r,_targetTextureVarying:"outTexture",vs:"attribute vec4 inTexture;\nvarying vec4 outTexture;\n\nvoid main()\n{\noutTexture = inTexture;\ngl_Position = vec4(0, 0, 0, 1.);\ngl_PointSize = 1.0;\n}\n",_fs:"varying vec4 outTexture;\nvoid main() {\n  gl_FragColor = outTexture;\n  gl_FragColor.g = outTexture.r / max(1.0, outTexture.a);\n}\n",elementCount:e*e});this.setState({weightsTexture:o,maxWeightsTexture:r,maxWeightTransform:i,zoom:null,triPositionBuffer:new h.Z(t,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new h.Z(t,{byteLength:48,accessor:{size:2}})})}updateShaders(t){this._createWeightsTransform(t)}_updateMaxWeightValue(){const{maxWeightTransform:t}=this.state;t.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}_updateBounds(t=!1){const{viewport:e}=this.context,o=[e.unproject([0,0]),e.unproject([e.width,0]),e.unproject([e.width,e.height]),e.unproject([0,e.height])].map((t=>t.map(Math.fround))),r=function(t){const e=t.map((t=>t[0])),o=t.map((t=>t[1])),r=Math.min.apply(null,e),i=Math.max.apply(null,e);return[r,Math.min.apply(null,o),i,Math.max.apply(null,o)]}(o),i={visibleWorldBounds:r,viewportCorners:o};let s=!1;if(t||!this.state.worldBounds||(a=this.state.worldBounds,!((n=r)[0]>=a[0]&&n[2]<=a[2]&&n[1]>=a[1]&&n[3]<=a[3]))){const t=this._worldToCommonBounds(r),e=this._commonToWorldBounds(t);this.props.coordinateSystem===p.Df.LNGLAT&&(e[1]=Math.max(e[1],-85.051129),e[3]=Math.min(e[3],85.051129),e[0]=Math.max(e[0],-360),e[2]=Math.min(e[2],360));const o=this._worldToCommonBounds(e);i.worldBounds=e,i.normalizedCommonBounds=o,s=!0}var a,n;return this.setState(i),s}_updateTextureRenderingBounds(){const{triPositionBuffer:t,triTexCoordBuffer:e,normalizedCommonBounds:o,viewportCorners:r}=this.state,{viewport:i}=this.context;t.subData(s(r,3));const a=r.map((t=>function(t,e){const[o,r,i,s]=e;return[(t[0]-o)/(i-o),(t[1]-r)/(s-r)]}(i.projectPosition(t),o)));e.subData(s(a,2))}_updateColorTexture(t){const{colorRange:e}=t.props;let{colorTexture:o}=this.state;const r=(0,v.P)(e,!1,Uint8Array);o?o.setImageData({data:r,width:e.length}):o=new l.Z(this.context.gl,{data:r,width:e.length,height:1,...T}),this.setState({colorTexture:o})}_updateWeightmap(){const{radiusPixels:t,colorDomain:e,aggregation:o}=this.props,{weightsTransform:r,worldBounds:i,textureSize:s,weightsTexture:a,weightsScale:n}=this.state;this.state.isWeightMapDirty=!1;const l=this._worldToCommonBounds(i,{useLayerCoordinateSystem:!0});if(e&&"SUM"===o){const{viewport:t}=this.context,o=t.distanceScales.metersPerUnit[2]*(l[2]-l[0])/s;this.state.colorDomain=e.map((t=>t*o*n))}else this.state.colorDomain=e||w;const u={radiusPixels:t,commonBounds:l,textureWidth:s,weightsScale:n};r.update({elementCount:this.getNumInstances()}),r.run({uniforms:u,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:this.getAttributes(),moduleSettings:this.getModuleSettings()}),this._updateMaxWeightValue(),a.setParameters({10240:9729,10241:9729})}_debouncedUpdateWeightmap(t=!1){let{updateTimer:e}=this.state;t?(e=null,this._updateBounds(!0),this._updateTextureRenderingBounds(),this.setState({isWeightMapDirty:!0})):(this.setState({isWeightMapDirty:!1}),clearTimeout(e),e=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),500)),this.setState({updateTimer:e})}_worldToCommonBounds(t,e={}){const{useLayerCoordinateSystem:o=!1}=e,[r,i,s,a]=t,{viewport:n}=this.context,{textureSize:l}=this.state,{coordinateSystem:u}=this.props,h=o&&(u===p.Df.LNGLAT_OFFSETS||u===p.Df.METER_OFFSETS),c=h?n.projectPosition(this.props.coordinateOrigin):[0,0],g=2*l/n.scale;let d,m;return o&&!h?(d=this.projectPosition([r,i,0]),m=this.projectPosition([s,a,0])):(d=n.projectPosition([r,i,0]),m=n.projectPosition([s,a,0])),function(t,e,o){const[r,i,s,a]=t,n=s-r,l=a-i;let u=n,h=l;n/l<e/o?u=e/o*l:h=o/e*n,u<e&&(u=e,h=o);const c=(s+r)/2,p=(a+i)/2;return[c-u/2,p-h/2,c+u/2,p+h/2]}([d[0]-c[0],d[1]-c[1],m[0]-c[0],m[1]-c[1]],g,g)}_commonToWorldBounds(t){const[e,o,r,i]=t,{viewport:s}=this.context,a=s.unprojectPosition([e,o]),n=s.unprojectPosition([r,i]);return a.slice(0,2).concat(n.slice(0,2))}}A.layerName="HeatmapLayer",A.defaultProps=C,o(67294);var D=o(55867),M=o(45511),R=o(52154),Z=o(21207),j=o(64106),B=o(26331),F=o(1740),z=o(11965);function W(t){return(0,z.tZ)("div",{className:"deckgl-tooltip"},(0,z.tZ)(F.Z,{label:(0,D.t)("Centroid (Longitude and Latitude): "),value:`(${t.coordinate[0]}, ${t.coordinate[1]})`}))}const O=(t,e,o,r)=>{var i,s,a,n;const l=t,{intensity:u=1,radius_pixels:h=30,aggregation:c="SUM",js_data_mutator:p,linear_color_scheme:g}=l;let d=e.data.features;p&&(d=(0,Z.Z)(l.js_data_mutator)(d));const m=null==(i=(0,M.Z)())||null==(s=i.get(g))?void 0:s.createLinearScale([0,6]),f=null==m||null==(a=m.range())||null==(n=a.map((t=>(0,j.hexToRGB)(t))))?void 0:n.reverse();return new A({id:`heatmp-layer-${l.slice_id}`,data:d,intensity:u,radiusPixels:h,colorRange:f,aggregation:c.toUpperCase(),getPosition:t=>t.position,getWeight:t=>t.weight?t.weight:1,...(0,R.N)(l,r,W)})},E=(0,B.G)(O,(function(t){return t.map((t=>t.position))}))}}]);
//# sourceMappingURL=5d2c10c1ae63f298a73f.chunk.js.map