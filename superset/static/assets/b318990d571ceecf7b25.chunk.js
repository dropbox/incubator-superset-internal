"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[3037],{83265:(e,t,i)=>{i.r(t),i.d(t,{default:()=>M,getLayer:()=>j});var a=i(67294),r=i(45697),o=i.n(r),s=i(78918),n=i(80744),l=i(38550),d=i(71435),c=i(62112),h=i(99890),g=i(98452);const p=[0,0,0,255],u={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:e=>e.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:p},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class m extends s.Z{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&n.Z.removed("getLineDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:i}){const a=i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon);if(a&&Array.isArray(i.dataChanged)){const e=this.state.paths.slice(),t=i.dataChanged.map((t=>(0,g.b)({data:e,getIndex:e=>e.__source.index,dataRange:t,replace:this._getPaths(t)})));this.setState({paths:e,pathsDiff:t})}else a&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:i,positionFormat:a,_normalize:r}=this.props,o=[],s="XY"===a?2:3,{startRow:n,endRow:d}=e,{iterable:c,objectInfo:g}=(0,l.jB)(t,n,d);for(const e of c){g.index++;let t=i(e,g);r&&(t=h.F(t,s));const{holeIndices:a}=t,n=t.positions||t;if(a)for(let t=0;t<=a.length;t++){const i=n.slice(a[t-1]||0,a[t]||n.length);o.push(this.getSubLayerRow({path:i},e,g.index))}else o.push(this.getSubLayerRow({path:n},e,g.index))}return o}renderLayers(){const{data:e,_dataDiff:t,stroked:i,filled:a,extruded:r,wireframe:o,_normalize:s,_windingOrder:n,elevationScale:l,transitions:h,positionFormat:g}=this.props,{lineWidthUnits:u,lineWidthScale:m,lineWidthMinPixels:f,lineWidthMaxPixels:y,lineJointRounded:_,lineMiterLimit:b,lineDashJustified:v}=this.props,{getFillColor:C,getLineColor:L,getLineWidth:S,getLineDashArray:w,getElevation:x,getPolygon:P,updateTriggers:k,material:F}=this.props,{paths:A,pathsDiff:D}=this.state,R=this.getSubLayerClass("fill",d.Z),E=this.getSubLayerClass("stroke",c.Z),j=this.shouldRenderSubLayer("fill",A)&&new R({_dataDiff:t,extruded:r,elevationScale:l,filled:a,wireframe:o,_normalize:s,_windingOrder:n,getElevation:x,getFillColor:C,getLineColor:r&&o?L:p,material:F,transitions:h},this.getSubLayerProps({id:"fill",updateTriggers:{getPolygon:k.getPolygon,getElevation:k.getElevation,getFillColor:k.getFillColor,lineColors:r&&o,getLineColor:k.getLineColor}}),{data:e,positionFormat:g,getPolygon:P});return[!r&&j,!r&&i&&this.shouldRenderSubLayer("stroke",A)&&new E({_dataDiff:D&&(()=>D),widthUnits:u,widthScale:m,widthMinPixels:f,widthMaxPixels:y,jointRounded:_,miterLimit:b,dashJustified:v,_pathType:"loop",transitions:h&&{getWidth:h.getLineWidth,getColor:h.getLineColor,getPath:h.getPolygon},getColor:this.getSubLayerAccessor(L),getWidth:this.getSubLayerAccessor(S),getDashArray:this.getSubLayerAccessor(w)},this.getSubLayerProps({id:"stroke",updateTriggers:{getWidth:k.getLineWidth,getColor:k.getLineColor,getDashArray:k.getLineDashArray}}),{data:A,positionFormat:g,getPath:e=>e.path}),r&&j]}}m.layerName="PolygonLayer",m.defaultProps=u;var f=i(89759),y=i(50600),_=i(57981),b=i(4065),v=i(92802),C=i(90606),L=i(67542),S=i(15191);function w(e,t,i){let{break_points:a,num_buckets:r}=e;if(!t)return[];if(void 0===a||0===a.length){const e=r?parseInt(r,10):10,[a,o]=(0,b.extent)(t,i);if(void 0===a)return[];const s=(o-a)/e,n=0===s?0:Math.max(0,Math.ceil(Math.log10(1/s))),l=o>o.toFixed(n)?1:0;return new Array(e+1+l).fill().map(((e,t)=>(a+t*s).toFixed(n)))}return a.sort(((e,t)=>parseFloat(e)-parseFloat(t)))}function x(e,t,i){let{break_points:a,num_buckets:r,linear_color_scheme:o,opacity:s}=e;const n=a||r?w({break_points:a,num_buckets:r},t,i):null,l=Array.isArray(o)?new C.Z({colors:o,id:"custom"}):(0,L.Z)().get(o);let d,c;if(null!==n){const e=n.length-1,t=e>1?l.getColors(e):[l.colors[l.colors.length-1]],i=t[0],a=t[t.length-1];t.unshift(i),t.push(a);const r=n.map((e=>parseFloat(e)));d=(0,v.Z)().domain(r).range(t),c=t=>t>n[e]||t<n[0]}else d=l.createLinearScale((0,b.extent)(t,i)),c=()=>!1;return e=>{const t=i(e),a=(0,S.hexToRGB)(d(t));return c(t)?a[3]=0:a[3]=s/100*255,a}}var P=i(37032),k=i(57485),F=i(88574);function A(e){return"geometry"in e.polygon?e.polygon.geometry.coordinates[0]:e.polygon}var D=i(50980);function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function E(){return E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},E.apply(this,arguments)}function j(e,t,i,r,o,s,n){const l=e,d=l.fill_color_picker,c=l.stroke_color_picker;let h=[...t.data.features];if(null!=n&&n.forEach((e=>{h=h.filter((t=>e(t)))})),l.js_data_mutator){const e=(0,F.Z)(l.js_data_mutator);h=e(h)}const g=l.metric?l.metric.label||l.metric:null,p=null===l.metric?()=>[d.r,d.g,d.b,255*d.a]:x(l,h,(e=>e[g])),u=e=>{const t=p(e);return o.length>0&&!o.includes(e[l.line_column])&&(t[3]/=2),t},f=l.line_column&&l.metric&&["json","geohash","zipcode"].includes(l.line_type)?function(e){return t=>{const i=e.metric.label||e.metric;return a.createElement("div",{className:"deckgl-tooltip"},t.object.name&&a.createElement(_.Z,{label:"name: ",value:""+t.object.name}),t.object[e.line_column]&&a.createElement(_.Z,{label:e.line_column+": ",value:""+t.object[e.line_column]}),e.metric&&a.createElement(_.Z,{label:i+": ",value:""+t.object[i]}))}}(l):void 0;return new m(E({id:"path-layer-"+l.slice_id,data:h,pickable:!0,filled:l.filled,stroked:l.stroked,getPolygon:A,getFillColor:u,getLineColor:[c.r,c.g,c.b,255*c.a],getLineWidth:l.line_width,extruded:l.extruded,getElevation:e=>function(e,t){return 0===t(e)[3]?0:e.elevation}(e,u),elevationScale:l.multiplier,fp64:!0},(0,P.N)(l,r,f,s)))}const W={formData:o().object.isRequired,payload:o().object.isRequired,setControlValue:o().func.isRequired,viewport:o().object.isRequired,onAddFilter:o().func,width:o().number.isRequired,height:o().number.isRequired},T={onAddFilter(){}};class Z extends a.Component{constructor(e){super(e),R(this,"containerRef",a.createRef()),R(this,"setTooltip",(e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)})),this.state=Z.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onSelect=this.onSelect.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){const{width:i,height:a,formData:r,payload:o}=e;if(t&&o.form_data===t.formData)return null;const s=o.data.features||[],n=s.map((e=>e.__timestamp)),l=o.form_data.time_grain_sqla||o.form_data.granularity||"P1D",{start:d,end:c,getStep:h,values:g,disabled:p}=(0,k.g)(n,l);let{viewport:u}=e;return r.autozoom&&(u=(0,D.Z)(u,{width:i,height:a,points:s.flatMap(A)})),{start:d,end:c,getStep:h,values:g,disabled:p,viewport:u,selected:[],lastClick:0,formData:o.form_data}}onSelect(e){const{formData:t,onAddFilter:i}=this.props,a=new Date,r=a-this.state.lastClick<=250,o=[...this.state.selected];if(r)o.splice(0,o.length,e);else if(t.toggle_polygons){const t=o.indexOf(e);-1===t?o.push(e):o.splice(t,1)}else o.splice(0,1,e);this.setState({selected:o,lastClick:a}),t.table_filter&&i(t.line_column,o,!1,!0)}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){if(void 0===this.props.payload.data.features)return[];const t=[];return e[0]===e[1]||e[1]===this.end?t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1])):t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<e[1])),[j(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip,this.state.selected,this.onSelect,t)]}render(){const{payload:e,formData:t,setControlValue:i}=this.props,{start:r,end:o,getStep:s,values:n,disabled:l,viewport:d}=this.state,c=t,h=c.metric?c.metric.label||c.metric:null,g=function(e,t,i){const a=w(e,t,i),r=x(e,t,i),o={};return a.slice(1).forEach(((t,i)=>{const s=a[i]+" - "+a[i+1],n=.5*(parseFloat(a[i])+parseFloat(a[i+1])),l=e.metric?e.metric.label||e.metric:null;o[s]={color:r({[l||e.metric]:n}),enabled:!0}})),o}(t,e.data.features,(e=>e[h]));return a.createElement("div",{style:{position:"relative"}},a.createElement(f.Z,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:r,end:o,getStep:s,values:n,disabled:l,viewport:d,width:this.props.width,height:this.props.height,mapboxApiAccessToken:e.data.mapboxApiKey,mapStyle:t.mapbox_style,setControlValue:i,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange},null!==t.metric&&a.createElement(y.Z,{categories:g,position:t.legend_position,format:t.legend_format})))}}Z.propTypes=W,Z.defaultProps=T;const M=Z}}]);